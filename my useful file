                                                                Important info at PPD
From 2022-9-19:
1.	Register the SAS Ondemand free sever for practicing the SAS code: https://welcome.oda.sas.com/home  User: yzly20040  can use my gmail to log in too  yzly2004@gmail.com -> Yzle2010! 
2.	设置Thermo Fisher Scientific 公司Benefit center website Online: Smart-Choice Accounts at https://benefits.thermofisher.com的账号密码： yzly2004->Yzle201005!  Phone PIN:197308  
2023-10-06 修改密码为Yzle20100503! 2024-5-13 密码修改为 Yzh19730828! 2024-12-07 改密码为 Yzle201005!
Security question:1. What’s your father’s middle name?: Zhong  2. As a child,what was your favorite animal? : dog  3. Where did you meet your spouse for the first time? : Beijing  4. What was your grandfather’s occupation? : doctor 5. What was your best friend’s last name? :Yuan
Website link is: Home-Thermo Fisher Benefits (alight.com)
https://benefits.thermofisher.com 

FSA 报销网站  Register With This Site | Alight Smart-Choice Accounts (wealthcareportal.com)
不能自主注册账号
3.	 PPD SAS Studio login :   yuanz -> Yzle2010!
4.	Clarity tool log in:  via the link  https://clarity.ppdi.com/niku/nu#action:homeActionId   Use my personal User ID:  yuanz (not my email address) and password 
5.	每次从公司回家，再把电脑连上家里的网络时，ctrl+alt+delete -> 密码，然后会出来一个CRG login的窗口，yuanz-> 输入MobilePASS+ APP 提供的6个数字的密码。2022-11-01晚，我竟然忘记了，老是输入我的开机密码，怎么也通不过，还以为是公司的服务器在维护呢。我现在的开机密码是Yzle2010!, 三个月一换。
Ppd-quality.veevavault.com login password: User Name: Zhenhua.Yuan@ppdi.com -> 
6.	My 401K: Log In to Fidelity NetBenefits  yzly2004 -> Yzle2010!
7. My microsoft account password changed to Yzle201005! on 2024-12-27.

2023-05-09周二 PPD Office cubic

2023-5-30 周二
今日2am起床，恶习萌发，耐不住开始看YouTube, 很容易地半个小时就过去了，然后又在皮沙发上躺了半小时，3am才开始看ADaM材料。看新闻，看视频，关心俄乌冲突，关心国内局势，浪费了太多太多的时间和精力，收益基本为零，这是何苦。这些都是远在我的影响力范围之外事情，以我微弱的地位与影响力， 关注这些事情对这些事情的走向毫无影响。故此，从今日起，只在周末看新闻，工作时间绝对不看消遣性的新闻和视频，学习类材料和视频是可以看的。实在空虚和无聊时，看看纸质书，专业书和杂书都可。要有计划，一日之计在于晨，要规划每天的日程，用笔写或画图以助思考，记录时间使用情况。

《极限人生》的作者朱彦夫：对于自己所获得的成就与荣誉，朱老显得云淡风轻，在他眼里，生命的意义在于奋斗，“人活着，就得奋斗；奋斗着，就是幸福；奋斗不止，幸福就不断。”
“父亲在我眼中是一位自立自强的勇士，他一辈子就像一个军人一样。在战场上打仗就豁上命去打，当村支书就豁上命去干，写书的时候就豁上命去写。”朱彦夫的女儿朱向欣这样形容他。
“一个连的消亡在战争史上算不上什么，但把这壮举记录成文，传给今人后代却很有意义。”朝鲜战场上，连队指导员的临终托付，朱彦夫始终铭记在心。
1987年，朱彦夫儿女买来笔墨纸张和参考书，他坐在床上，用一双残臂向《极限人生》发起了进攻。
一开始，朱彦夫把棉被叠成方块，把残腿放在上面，再把写字板放在残腿上，用嘴含着笔写。可写不了几个字，口水便顺着笔杆往下流，浸湿了稿纸。后来，他就嘴、臂并用，每天能写几百字。
冬天写作，朱彦夫只能披着衣服，让两只抱笔的残臂裸露在外，残臂因此经常冻得失去知觉。双臂夹笔用力时间过长，伤口被磨破流出血水，他就把消炎药片碾碎，敷在伤口上包扎一下继续写。夏天炎热难耐，写不了几个字两臂就汗水淋漓，他只好不断地用毛巾擦拭。一个夏天下来，不知多少汗水和血水浸到稿纸上。
不会写小说，朱彦夫就“啃”下100多本中外名著给自己积累经验，几年间4本字典被他舔烂。为了构思情节，他常常茶饭不思，发呆到深夜。有时想得出神，嘴上叼着的笔被他当成烟去点；有时因为陷入沉思，掉下的烟灰引燃棉被，直到冒起浓烟才回神发觉……
看到父亲写作苦，儿女们多次要求他口述，帮着他记录。但这个倔强的战士拒绝了，他认为这样就跟自己的书隔了层什么，表达不出真情实感，也对不住长眠的战友。
由于日夜煎熬，朱彦夫视力持续下降，伤口发炎，心脏病加重。不论医生怎么劝，家人怎么拦，他始终笔耕不辍。从1987年到1995年，朱彦夫共写下200多万字。在七易其稿后，1996年，33万字的自传体小说《极限人生》最终出版。时任中央政治局委员、中央军委副主席、国防部部长迟浩田亲笔题写书名并题词“铁骨扬正气，热血书春秋”
对一生充满苦难的朱彦夫，有人曾好奇地问他“你幸福吗？”
对此，朱彦夫满脸淡然地回答道：“和牺牲的战友相比，我至少还活着，坐过火车、飞机，看过手机、电脑，享受过胜利果实；我还有子女，享受了天伦之乐。把肢体的一部分献给了祖国，这是战士无上的光荣；还有机会用剩下的一部分发挥余热，这就是双份的幸福了。”
每一件事都历经百般磨难，每一段人生都洋溢着不屈的精神意志和不竭的冲劲闯劲。“只要信念不倒，精神不垮，什么都能扛过去！”凭着这股坚强的信念，参加过上百次战斗、动过47次手术的朱彦夫从未向命运低头，如今年近九旬的他仍然保持着冲锋的姿态和心态。
2010年2月，操劳了一生的陈希永，永远离开了这个世界。
很多人为她平凡而伟大的一生而感动，大家自发地为她送行，默默地为她垂泪。
作为丈夫的朱彦夫，这位在战场上从没有流过一滴泪，在厄运面前从未低过头的钢铁战士，此刻悲痛欲绝，他感觉自己的心好像被掏空了一样，俯在妻子的棺材上，嚎啕大哭。
“我亏欠她的真是太多了，是我拖累了她啊！”朱彦夫一整天把自己关在屋里，不吃不喝，反复念叨着这句话。
在妻子出殡那天，朱彦夫不顾所有人的反对，坚持要为照顾了自己一辈子的妻子“披麻戴孝”!
我们的国家正是有了朱彦夫这样的人，才撑起了我们中华民族的脊梁，使我们克服重重艰难险阻，傲立世界东方。
“捆得再紧点、再紧点”，一个特制的钢夹扎在朱彦夫的残臂上，他会让旁边的亲属一点点拧紧螺丝，直到夹子深深扎进肉里。然后，一笔一画、一勾一捺……他就是这样靠残臂书写的。
　年事已高，他辞去村支书工作，回家不久，却再次迎难而上，他要写书，用文字记录这种生的力量。他把棉被叠成方块，把两腿放在上面，把写字板放在大腿上，然后用嘴含着笔写，口水顺着笔杆往下流，稿纸就湿透了，写不了几个字，眼就疼。之后，又用双臂抱着笔写，时间一久，残臂的伤口处就疼。写错了，他就重新再写，无论在做什么，只要有了灵感，就马上写。写好的书稿，一张一张的挂在床前，每天都要仔细看一遍。
‘用人难，求人更难，人活着得靠自己’“一个人只要有生命，就会发光，就能以他所散发出来的光热，去改造他周围的自然环境。”
40多年作了1000多场报告，右半边身体瘫痪的朱彦夫打趣地说：“如今，我成了六肢不全的人了，但我不后悔，我要用我的经历教育青少年，让他们懂得，只要信念不倒，意志不垮，心无旁骛，任何奇迹都可以创造出来。”
泰山“挑山工”不管山高路远，始终以奋斗姿态往前走、向上攀，风雨无阻，无怨无悔；在重担面前，挑山工们步调一致、众志成城，心往一处想，劲往一处使，征服“十八盘”，登上“南天门”，到达“玉皇顶”。
谎言加暴力得势一时没问题，但肯定的是不会多长的。
2023-6-15 ZY:昨天看朱彦夫写的《极限人生-》，进而看了相关的视频和文章，确实是一个了不起的人。其学习精神和扎实做事的精神确实值得我学习。我一贯不相信共产党的宣传，总是无限拔高和无限美化，非常令人讨厌。他被统治阶级派到朝鲜去当炮灰，被打成这样一个极为严重的残废，是个人的悲哀。一将成名万骨枯，作为老百姓，就是盛世的骡马乱世的炮灰，这是历史的铁律。作为个人，还是要有自己特立独行的思想，不要轻易地去相信党国的宣传，那些东西他们自己都不信，那么多高层都把自己的子女移民到国外，就是在用脚投票，不要看他们说了什么，而是要看他们做了什么。美国政治如此黑暗，黑墨化一天天在加速，各路牛鬼蛇神都在狂欢，这个国家在不可阻止地衰落。纵观世界历史，哪有几百年不衰的霸权国家。人性决定国家强大一段时间后就必然走下坡路，不以人的意志为转移。我很可能在接下来的余生里不得不目睹生存环境得不断恶化，甚至不得不另谋生存得土地。不要随着那些黑暗得势力的得逞而放纵自己，要坚决地抵制那些歪风邪气，任何再衰落的国家也有坚持走正道的人，寻求真理的人，没有哪个统治阶级能真正垄断真理的。
向朱彦夫学习，学习他在如此的逆境中依然寻找自己的人生价值，努力做一个对社会对家庭有用的人。特别要学习他的高度专注地去做事的精神，他六十多岁开始写书，用嘴用残肢绑着笔来写，字虽然写得歪七扭八，写一个字都费劲,但他就这么坚持着，从一天写几十个字慢慢进步到写几百个字，历时七年，终于写成了三十多万字得《极限人生》，后来还写了另一本《男儿无悔》，当然后一本是有人代笔得，成名了后，攀附得人就多了，但极限人生那一本书应该是他写得，文字水平很一般，但一个没有受过正规教育得人能写出这样得书，还是很了不起得，这一点必须要敬佩。他老了之后还每天读报看书，就更是难能可贵了，真正做到了活到老学到老，这种精神更是值得我学习，何况人家还是没有四肢只有一只右眼得特残军人。由此可见，只有将精力高度集中于一件有意义的事情，日思夜想，绞尽脑汁地想方设法地做好，就一定能做到超过绝大多数普通人的水平。作为像我这样智力和体力都很平庸的普通人，要想做出一点不同寻常的成绩，唯一的策略就是高度集中精力于自己设定的目标，舍弃大量的分散精力的次要目标，通过精力和时间的高度聚焦，在一个核心目标上投入远超一般人的巨量时间，就是凭着普通的智力和精力，也能做出不同凡响的事业。要高度集中精力，就一定要抵制现实生活中的各种分散精力的事情。如层出不穷的吸引眼球的国际国内新闻，各种名人明星的花边新闻，震撼人心的社会新闻，还有微信上的海量信息，一个人就是不干正事，也关注不过来。理性去分析，我关注这些时政和社会新闻对我个人的意义大吗? 说阅读这些文章毫无用处也不客观，但对个人的发展而言实在是帮助不大，这些事情都远在我的影响力范围之外，我就是再生气也不能对事情的发展方向产生丝毫影响，我关注了俄乌战争有一年多，花在看视频看相关文章上的时间那是天量，如果用这些时间来学习英文，那我的英文水平就不会是现在这个样子。我花费了如此多的时间关注俄乌战争，对俄乌战争的走向有哪怕亿分之一的影响吗？没有！人家做自媒体的如碎片记忆等频道，好歹人家还赚钱养家了，或者让更多的人支持乌克兰，起到了非常微小的影响。看那些不良信息，更是毒害思想，影响健康，有百害而无一利。牛顿之所以取得那么高的成就，他的法宝就是盯着一个可能突破的创新点，集中尽可能多的时间和精力，围绕着这个课题阅读，做笔记，和高水平的同行交流请教，最关键的是，长时间地高强度地不间断地思考，一点点地接近最终找到解决方案的那个突破点。他用这个法宝，敲开了一道道横在别的一流科学家面前的堡垒，取得了令人难以置信的伟大成就。不容置疑，牛顿是一个天才，智力达到了人类的极限，但他的方法依然值得我这样的普通人学习。
我远离那些时政新闻，可能会有一些损失，可能跟不上时代的变迁，对新事物不了解，但这些损失是完全可以接受的。要做成任何事情都必须要有代价，只要取得的成就足够补偿所付出的代价，那这个代价是绝对值得付出的。就如同做生意，必须投入本钱，投入大量的时间和艰苦劳动，别人在享受，你却在流汗，别人在空调房里舒服地生活，你却在操纵的市场里奔波，这些都是代价，但如果做生意赚了钱，而且还不少，那么那些代价就是非常值得的。天下没有免费的午餐，不可能你整天躺在床上，天上突然掉下来一笔巨款给你。就是那些官二代和富二代，要守住那些特权和财富，也需要付出一定的代价，也要去寻求保护伞，动脑筋维持荣华富贵。
我现在就是分心太厉害了，老是欺骗自己以后会奋发的，其实我都度过了人生的三分之二了，几十年来，期待的奋发一直都没有出现，这样下去，到离世的那一天也不会出现。我为什么要骗自己？我现在已经能接受自己的平庸，也能接受周边人的优秀，我这样的生活和工作方式，失败是一定的，是绝对不可能取得自己想要的成就的。冷静下来思考，我就不得不要承认这个推论。坦然接受自己的失败和平庸，也许是改变的开始。我既然已经落后这么多了，已经在谷底了，看以前的同路人，人家都在前面了，我还有什么面子放不下的，要做的就是最大程度地集中精力，放弃消遣娱乐和看时政新闻不良信息的时间，作为必要的代价，把可以支配的时间最大可能地集中到主要目标上。我现在的主要目标就是成为一个做临床试验的高水平的统计师，能真正把临床试验统计做好的人，在这方面知识积累丰富，技能超群的人，在努力提高自己理论水平和实际操作能力的同时，尽可能把工作做好，对得起这份工资，对得起聘用我的公司和经理。以后要走的时候能找到下一个好职位，能在职业上取得上升空间。利用一切可能的业余时间学习和请教。极力减少看励志文章书籍的时间，大幅降低阅读方法论方面文字材料方面的时间。我智力太平庸，必须集中精力才能突破，精力一分散，我就什么成就都达不成了。而且，各种方法学而不用，于我毫无价值。读各种优秀人物的事迹，感动之余却没有丝毫行动，那就是完完全全地浪费时间。在思想上解决了这个舍弃以往分心行为的顾虑之后，就能坦然接受放弃的代价，不后悔，不怕别人嘲笑，不懂就保持沉默，就虚心向别人请教。
看Youtube和B站，近些年来，浪费了我太多的时间，收获是有的，但非常有限，对改善我的人生几乎没有正面的作用。大力减少用在这方面的时间就是我现在就要做的，是必须要付出的代价，非常必要。看这些视频，关键就是不能开始，一开始看，就会很快沉迷其中，不能自拔，不经意之间，几个小时就过去了，醒悟过来之后，正事没做，后悔莫及。
要经常思考如何才能把工作尽可能做好，寻找各种有效的提高策略，并努力地去实行，做到知行合一。
要在内心反复告诫自己，要做出任何像样的成就，都必须要付出相应的代价。看《高考逆袭》里的女主杨婷婷，虽是虚构，可信度极低，但她的逆袭是建立在她放弃心爱的打游戏，把尽可能多的时间和精力投入到学习中的前提下，她还利用一切机会问老师问题，向厉害的同学请教，总之，就是寻求一切可能的帮助，想尽一切办法提高自己的实力，这种努力和奋斗精神，老师同学和家长都是看在眼里的，她的努力感动了老师和周边的同学，于是，各种帮助都纷沓而至，助力她的成绩在一年之内有了突飞猛进的提升，最终考上了北大清华中的一所。考上之后，那种如同古代考上进士一样的荣光和锦绣前程就是对那一年艰苦努力的巨大回报，那一刻，所有的付出和努力都是非常值得的。如果她在高三还打游戏，看视频，把时间用在与学习无关的方面，作为一个后进生，她是不可能翻盘的。黑马其实是利用了跑在前面的快马的松懈而追上的，如果一贯成绩好基础扎实的优等生也如她一般地努力和拼命，她是没有机会的。这是个例，是比较少见的，故才被写成案例来给后进生打鸡血。考上清华北大的更多的是那些一贯优秀的学生，必须认识到这一点。而且，这个故事还不一定是真的，太多骗人的假故事了。
我必须要做计划，记录时间的使用，养成每晚睡前写简短日记并列出第二天事务清单的习惯，早上再看事务清单，排出优先次序，然后记录每项任务实际使用的时间，记于纸上，晚上总结时再把时间使用情况写到日记里去。根据过去的经验，浑浑噩噩地过了一天后，不敢也不愿意去反省自己，就不写日记了，一中断，写日记的习惯就废掉了。其实，越是浪费时间无所事事的一天过去后，更应该写日记反省，为什么会这样？怎样才能避免或减少以后重犯这类错误？正是写日记纠正自己的好时机，千万要咬牙写。
我的拖延恶习，其实就是起始于不能动手做，首先就是要再头脑里思考这件事情，必要性，如何才能做好？思想先行，开始动手做就不那么困难了。钟道隆说，任何时候手头要有一本陪伴自己的书，最好是非小说类的专业书，有点空余时间就打开看几行，这样不是为了学多少知识，看多少页书，而是为了把自己的注意力和兴趣点保持再设定的轨道上，不至于偏离预定目标太远。我在初二时，有一边捡来的数学辅导书，这次回家还找到了，没带来，那时一有点空就看一会儿，其实页没学到多少知识，但让我一直保持了学习数学的劲头，我甚至能偶尔体验到那种在做正事的愉悦感和充实感，那时一段宝贵的时光，人生中难忘的一段旅程。
我已落后别人太多，而且年纪又大了，不指望赶上和超越别人了，只能和自己的过去比，努力使自己进步，希望临死前不为虚度年华而悔恨，也不为碌碌无为而羞耻。

2023-06-16 周五
今天是凌越19岁生日，岁月如梭啊！我已经年过半百了，却事业无成，特别感慨，我的工作系统是有巨大的问题的，必须要尽快改正，不然还会出大问题，后果不堪设想，
鲁迅很早就说过：“要灭一个人，一是骂杀，二是捧杀。”这个时代热衷于造神，更喜欢毁神。
很多人还抨击张桂梅，真的不要在乎别人的评论，做自己认为对的事情。“你只有读书、疯狂的学习，才能走出大山，逆天改命。这是唯一的出路。”
饶毅说两院院士增选行贿，这是人所共知的事情，根本用不着去讨论。他这样做，只怕哪天会被别人灭口。他性格偏激，得罪的人太多了，只怕哪天在中国也混不下去。
昨晚快速读完了朱彦夫写的<极限人生>，大跃进后的大饥荒和文革大浩劫那几章不忍卒读，对于这样一个伤残严重的老兵都那么残忍，这个民族是有问题的，这个党更加是有问题，这几十年来的大发展，掩盖了所有的这些问题，全民亢奋，民族主义甚嚣尘上，才吃饱饭没几天就看不起人。我觉得他这个人值得学习的是那种逆境奋斗的精神和那种全神贯注废寝忘食做事以达成目标的方法。这个党的统治能力惊人，这个民族也是几千年逆向淘汰后的顺民愚民。这个统治短期内不会出问题，债务和房地产都不是大问题。我为什么对这些事情感兴趣，而我又不能对这些国家大事起到丝毫的影响。关注这些就是浪费时间，浪费生命。以后一走神想起这方面的事情就要尽快把思绪拉回搞好工作的正轨。
要目标驱动，我要每天想着自己的核心目标，那就是成为一个优秀的临床试验统计师，所有的时间和精力要优先投入到这个目标上，放弃关注时政新闻，这些都是必须要付出的代价，一定要有这个决心和意志。我初二初三时放弃了很多享受，冬天在楼上学习，耳朵都冻坏了，就那么坚持着，学习效率并不高，但只要坐在那里学习，就能学到一点知识，后来还是有所回报，考上了中专，那是一次成功的逆袭。我那时在内心里有非常明确和强烈的目标，考上中专或高中，走出农村，看更大的世界，那时的学习动力是很强的，所有事情都给学习让路，回家就是看书做题，那时学习方法并不对头，但架不住投入的时间和精力比很多同学多，结果成绩进步明显。参加报送考试上大学，那时也有非常明确的目标，上大学，也是动力十足。考研究生，目标明确，全力投入，除了上几节课以外，几乎所有时间都投入到了考研准备中去了。考博士，也是专注了一段时间，都没回家过年，算是考上了，其实那时经常头昏眼花，身体并不好。后来就没有目标明确并全力投入过，科研没做好，统计工作没做好，甚至一度失业。深刻反省，最主要的就是目标不专一不明确，时间精力没有集中起来，关心时政新闻和不良信息浪费了太多太多的时间，消磨了太多的斗志，丧失了以往为了目标而拼命努力的劲头，故失败一个接一个，搞得生活很落魄，生活质量很差。要改变自己，唯有从现在开始，设立非常清晰的而且经过努力奋斗可以实现的目标，经常在脑子里强化这个目标，所有的时间和精力都要围绕这个目标配置。我年过五十，精力日衰，不可能再去换职业赛道了，就咬定临床试验统计师这个职业方向了，哪怕失业也不要放弃，千万不能再换了。先在这个公司把工作做好，争取能在工作两年之际升到Senior II, 就是不升，也要走了，要去基因或细胞治疗方面的药厂寻找职位。抓紧一切时间学习临床试验相关的知识和技能，努力提高编程技能，努力紧跟人工智能的应用，和自己的工作结合起来，努力提高自己的效率。一有空闲就要学习专业知识，这才是求生存的砝码，而花时间去关心国家大事，关心社会新闻，对自己的求生存根本没有什么明显的用处。要开始听写英文，结合专业来听写，逐词逐句地听写，不求速度，只求听写质量，还是用笔写的方式听写比较好，记忆更深刻。每天要挤出至少半个小时的时间来听写，就是听写一句也好，不断积累，从量变到质变，也许英文听力就会有所提高，我若不努力提高英语的听说读写水平，就一定实现不了我的上述目标。听会议录音，找出自己听不明白的地方，做笔记，查单词，反复听，直到搞明白为止。努力减少中文使用，尽量少看中文材料，我这个中文水平，哪怕五年不看一个中文字，下降的幅度都不会太大，而且如有需要，我就能够在短期内再恢复过来。故现在为了能快一点提高英文水平，就一定要减少中文的使用，包括以后写日记，也要慢慢过渡到用英文写几句，中英文夹杂使用。这是必要的代价，把我听中文YouTube, B站的时间用来听英语材料，我的英文水平就会有长进，就不会和现在一样，说几句话都困难，英文没学好，还是时间投入不够，单词积累不多，要用有道词典和手机上的词典积累单词，经常复习，要系统地学习语音和词汇。所有这些都需要时间，唯有从减少看新闻看中文视频看微信等活动中节约时间，另外就是利用碎片时间记单词，记一个是一个，慢慢提高词汇量。我的英文阅读量太少，中文阅读占比太大，是词汇量积累太少的原因。要学好英文，必须要付出足够的代价，绝对不可能用以前的方式学好。早上要朗读英文，要记下心得体会，不时复习，温故而知新。
我下载了好的技术类的书，都没有时间阅读，总是欺骗自己以后或许能找到大块的时间来阅读，结果这么多年过去了，一本像样的大部头书都没有读过，原因就是时间花在忧国忧民和各类时政社会新闻上了。给自己定个规矩，我这50-60岁，远离时政新闻，专心工作，努力提升职业技能，等我六十岁后再投入大量时间关心国家大事也不晚。我是一个不足重轻的普通人，何苦去浪费时间关心那些东西，又改变不了什么，贪腐是古今中外的普遍现象，是人性的必然表现，有什么值得奇怪的，极左政策以前也有，因道德堕落而亡国灭种的事情在史书上多的是，罗马帝国灭亡，古埃及灭亡，巴比伦灭亡，太多了，美国有一天灭亡奇怪吗，一点也不奇怪，而且目前看来不可避免，何必关心这些呢？我若实现不了自己的目标，后果就很恐怖，失业，婚姻家庭出大问题，这些严重后果是实实在在的，比美国百年后灭亡要现实的多，严重的多。
我看手机视频和新闻好像上瘾了，必须摆脱，就是不要开始，一旦开始就防线马上崩溃。就是崩溃后也要尽快恢复到自己定的规矩。只在周六看一下新闻和视频，时间不超过两小时，其余时间都要用来做正事。反复提醒自己，这是必要的代价。
每晚都要学习专业知识，看公司培训材料或专业书，这是自救的必要手段。周末更是要拿出大块的时间来学习。上班时间更是不能看时政新闻，无关信息，搜索工作不相关的网页。
每晚写日记，列事务清单，每早安排事情次序和分配时间。周日整理一周日记，感悟，学习笔记等。
读纸质书和电子书都要做笔记，在周日整理归类，写内容提要。

2024-03-25 Monday
找一张白纸，先划两条竖线用来区隔时间：现在（今年、五年、十年；然后再画两条横线，用来区隔：现实工作和未来理想，这样你会得到六个格子。将你所有要学习的所有内容填写在格子里面，然后开始做减法，只保留与现实工作或者未来理想目标密切相关、有资源实现的项目，建议每年的目标不超过三个，项目可以围绕这些目标次序展开。再多的工作，只要埋头开始做，你能看到的就是秩序，不会再有心烦意乱。这就是工具的价值和魅力。
学习是最容易产生愉悦心流的事情，学习就是人之天性。甚至学习不仅是人的天性，也是人类近亲猴子的天性。有研究发现，猴子在没有任何外部奖惩的机制下，自己就会投入精力研究如何打开笼子里的一把锁。而作为人类，正是由于有探索奥秘、发现新知识的天性，才在一代又一代人的努力下，积累创造了今天的丰富知识。事实上，世界上本没有知识，人探索的多了，才产生了知识。

可是，为什么我们现在一提到学习，就觉得是一个很辛苦、逆人性的事情呢？我想，很大程度上是因为，我们总觉得学习最重要的能力是掌握知识，因此要头悬梁，锥刺股。然而对于真正会学习的人而言，其实他们并不是简单地靠着毅力来学知识--相反他们有一个隐形的关键能力，这个能力往往把“会学习的人”和“想学习的人”区分了出来。这就是：提出问题的能力。记住：真正要学习往往不是如何记住知识， 而是如何提出问题。学习真正的动力不是来自记住知识，而是发现未知，探索好奇，研究问题，克服困难。我们在解答疑惑的过程中，会聚精会神，会充满斗志，会沉浸其中。我们在记忆概念答案的时候，却抓耳挠腮。你一定有这样的经验，当你专注于研究探索你好奇事情时，你真的会沉溺于学习无法自拔，感觉不到时间的流逝。而让你死记硬背的时候，你一定更多地是充满绝望。所以，如果我们只能提升一个学习能力的话，那就聚焦在如何提出感兴趣的问题。因为，提出你感兴趣的问题，将是你开展学习的第一推动力 ，剩下的学习过程，都可以因此自然发生。所以，当我们遇到很多知识，不知道该学哪个的时候，我的答案总是：如果你不知道你该学什么，就去学你最好奇的。


如果要解决的这个问题解决周期很长，甚至需要分成几段来解决，那我们可以优先学习第一阶段马上就用的内容。

在定范围这个步骤，最最关键的是：一定要控制住自己的贪心！

不要总是想学更多的东西，一定围绕解决问题的需要，用什么学什么。这样才能避免耽误了解决问题的时间，又浪费了非常有限、非常宝贵的时间和精力。

在确定学习范围之后，就可以进入第三步——实际用，也就是把自己所学的内容，马上实际应用一下，去解决问题。

作者在这里提醒大家，应用新学的内容去解决工作问题，如果之前并没有这方面的经验，第一次应用务必严格遵循所学方法，不要随意的改动，要严格的去套用。做为一个新手，对新方法了解还很粗浅，对改动的后果，常常没有足够的判断和预测能力，很容易导致结果是失败的。

还用找抽奖软件这件事来说，我通过咨询一位组织过公司年会的朋友，问到他曾用过的一款软件，评估了一下，应该可以满足领导的要求，同时也咨询了如何设置参数，如何操作。软件参数有很多选项，可以实现不同效果。为了保险起见，我咨询了朋友是如何设置的，原封不动复制过来。这样做解决问题最快，成功的把握也最大。

等以后有时间，完全可以再对软件操作进行深入学习，测试不同参数设置的效果和稳定性，下一次使用，就可以达成更好效果。

以上就是功利性学习的三个步骤：选问题，定范围，实际用。简简单单，却可以快速解决大问题。

在实际工作中，如果我们能把这三步很好的运用起来，相信可以大大减少学习的压力，更有效率的解决问题，边学边用，个人能力也会得到持续提升。

《学习力》笔记

《学习力》这本书中，还有很多高效的方法，能够帮助我们更加高效的学习和解决问题，比如怎样科学的做笔记，怎样建立个人知识体系，如何快速学会不同类别的技能等等，每一个方法，都是在工作中必不可少的能力。

当然，这本书读完不用，那不会有任何用处，我们一定要遵循功利性学习原则，把每个学到的方法，马上用起来。

让我们一起来功利性学习吧~知识焦虑？不存在的！从此可以与它说拜拜啦~

那我们应该怎么改变呢？
答案很简单，介入 “天人交战” 的战场中，动手给他们划定阵地。

早上 9:00 - 12:00，是学习的时间。
中午 12:00 - 14:00，是吃饭、休息的时间。
下午 14:00 - 16:00，我可以理直气壮玩两个小时游戏！
下午 16:00 - 18:00 或许你应该陪陪家人
晚上 18:00 - 20:00 总结，输出一些文字
诸如此类...

当然，可以根据当前的状态或学习进度来调整时间，但这种仪式上的限制，其实是非常有必要的。
为什么？
因为你可以每一件事都做得 “理直气壮且专注”！
当你学习时，你知道，接下来可以拥有两个小时尽情游玩，因此有了安抚 “天性” 的资本和理由。
我总是一遍遍听到有人跟我说，他怀念 “高三年级” 的日子，那是他一生中少有的高光时刻，上知天文、下知地理。
这样的 “高光”，是因为自由吗？恐怕不是。
那段日子对于任何人而言，都是不自由的，但它目标清晰，只需要全神贯注地去做一件肯定对未来有益的事情，那就是——“学习”。
相反的，很多人到了大学里，反而无所事事，终日一事无成。
也许，在高中毕业后，我们许多人心中的自己，从 “不可限量的神” 变成 “普普通通的凡人”，正是因为生活中多了太多太多的选择。
因而，少了太多太多的纯粹。
而这种纯粹，大约正是我等凡人，和 “大神” 之间的鸿沟吧？

https://www.reddit.com/r/datascience/comments/e4ji5y/a_source_to_learnpractice_r_by_doing_projects/?rdt=46073
Here are a bunch of open, free online resources. The first couple of resources listed under each heading are generally the most recommended resources.

R programming

Beginner

Hands-on Programming with R - text + examples; intro to common programming tasks using R

R Programming for Data Science - text + examples; fundamentals of R programming

The Tidynomicon - text + examples; an intro to R for people coming from other programming languages

Field Guide to the R Ecosystem - intended to offer a high level overview of the R ecosystem

Data Processing and Visualization - text + examples; tools, tips, packages that make data processing and visualization in R easier, oriented toward those who have had some exposure to R in an applied data analysis fashion, but would also be useful to someone coming to R from another programming language

Advanced

Advanced R - text + examples; for R users to improve programming skills and users coming from other programming languages

Efficient R Programming - text + examples; to increase computational and programmer efficiency

Data Science at the Command Line

Data Science

General

R for Data Science - most recommended intro for R

Data Skills for Reproducible Science

Introduction to Data Exploration and Analysis with R

Data Science Live Book

Introduction to Data Science: Data Analysis and Prediction Algorithms in R - class notes for the Harvard edx Data Science series course

Statistical Inference via Data Science: A modern dive into R and the tidyverse

Classical Statistics

swirl package - text + package + examples; learn statistics and R programming at the same time.

OpenIntro Statistics (alternatively there is Statistics with Randomization and Simulation for same material presented differently) - text + package + examples; learn statistics and R programming at the same time

Machine Learning

Introduction to Statistical Learning - gold standard

Elements of Statistical Learning

The caret package - intro to the caret (classification and regression training**) machine learning package.

Caret Package - a practical guide to machine learning - guide to using the caret package

Machine Learning in R tutorial - guide to using the mlr package

Interpretable Machine Learning

Introduction to Machine Learning

Hands-on Machine Learning with R

useR Machine Learning Tutorials

Advanced Statistical Computing

Other Useful Resources

Bookdown.org - repository of free texts created in R using the bookdown package. Most of the above resources are stored here. Scroll through the archive or click on Tags at the top and find a topic that interests you.

Learn the Tidyverse

RStudio cheat sheets

RStudio online learning

RStudio FAQs

data.table wiki
https://www.interviewbit.com/blog/r-projects/
2022-10-14 Friday
Preview the follow link associated webpage to prepare for the following risk management training
Risk Management (Biostats Hub)
Definition of Risk and issue:
A risk is defined an uncertain event or condition, that if it occurs, may have a positive or negative effect on a project’s objectives. In contrast, an issue is an event or condition that has already happened, whether previously identified as a risk or not. (YZ): risk is expected to happen with some possibility, issue is those events or conditions that have already happened. Y

RISK/ISSUE MANAGEMENT includes:
1.Risk/issue identification and categorization
2.Risk/issue assessment and escalation via pre-defined pathways
3.Action plan development
4.Risk/issue monitoring and mitigation.

Lyon provide us two link for exploring as follow:
https://wiki.ppdi.com/BioWiki/index.php/Secondary_Landing:_Risk_Management_%26_QTL
https://wiki.ppdi.com/BioWiki/index.php/Reporting_Issues_and_Getting_Help



From <https://wiki.ppdi.com/BioWiki/index.php/Risk_and_Issue_Management> 

2022-10-17 Monday
下面的长句写得好，可以借鉴。
It is with great pride that I share the exciting news that CRG has been awarded the Society for Clinical Research’s (SCRC) Eagle Award for the second consecutive year for our outstanding leadership, professionalism, integrity and dedication to advancing the clinical research profession through strong partnerships with research sites. 
Our close relationships with research sites contribute to our ability to help deliver on the ambition we all share – helping deliver life-changing therapies to patients around the globe. 
the business offers Accelerated Enrollment Solutions (AES)。
Receiving the Eagle Award for these two consecutive years as we worked closely with our sites to maintain clinical research through the challenges of the pandemic is a powerful example of CRG colleagues living Thermo Fisher’s 4i Values of integrity, intensity, innovation and involvement, and staying focused on the Company’s Mission to enable our customers to make the world healthier, cleaner and safer. 
Thermo Fisher Scientific Inc. is the world leader in serving science, with annual revenue of approximately $40 billion. Our Mission is to enable our customers to make the world healthier, cleaner and safer. Whether our customers are accelerating life sciences research, solving complex analytical challenges, increasing productivity in their laboratories, improving patient health through diagnostics or the development and manufacture of life-changing therapies, we are here to support them. 

2022-10-18 Tuesday

读《SAS Certification Prep Guide—Advanced Programming for SAS 9, Fourth Edition》part2 
Chapter 9:Introducing Macro Variables
Whether automatic or user-defined, a macro variable is independent of a SAS data set and contains one text string value that remains constant until you change it. The value of a macro variable is substituted into your program wherever the macro variable is referenced.

In order to substitute the value of a macro variable in your program, you must reference the macro variable. A macro variable reference is created by preceding the macro variable name with an ampersand (&). The reference causes the macro processor to search for the named variable in the symbol table and to return the value of the variable if the variable exists. If you need to reference a macro variable within quotation marks, such as in a title, you must use double quotation marks. The macro processor does not resolve macro variable references that appear within single quotation marks.

the keyword _NULL_ is often used in place of the data set name in sample programs. Using _NULL_ suppresses the creation of an output data set.
The simplest way to define your own macro variables is to use a %LET statement. The %LET statement enables you to define a macro variable and to assign a value to it.
General form, %LET statement:%LET variable=value;
1).All values are stored as character strings.
2)Mathematical expressions are not evaluated.
3)The case of the value is preserved.
4)Quotation marks that enclose literals are stored as part of the value.
5)Leading and trailing blanks are removed from the value before the assignment is made.
The word scanner recognizes the following token sequences as macro triggers:
% followed immediately by a name token (such as %let)
& followed immediately by a name token (such as &amt).
Remember that if you need to reference a macro variable within a literal token, such as the title text in a TITLE statement, you must enclose the text string in double quotation marks or the macro variable reference is not resolved.
The %PUT statement writes text to the SAS log.

读：
<SAS Programming Standards Guideline>
 The form section will cover the layout and readability of programs. The content section will describe programming efficiencies to eliminate unnecessary code, warnings in the log file, and difficulty in debugging. 形式与内容方面的规范
 For example, /* Sort data by USUBJID */ before a PROC SORT step is not particularly insightful. Conversely, /* Sort data by date to identify baseline records*/ indicates why the procedure will be called.
要仔细看Biowiki相关网页，把今天培训的PPT文件作为超链接放在这里，以便今后参考。

From <https://wiki.ppdi.com/BioWiki/index.php/SAS_Programming_Standards_Guideline> 

From <https://wiki.ppdi.com/BioWiki/index.php/SAS_Programming_Standards_Guideline> 



2022-11-02 Wednesday
https://sascrunch.com/topic/creating-sdtm-data-set/    一个非常简单实用的小项目，用于学习如何create SDTM dataset
	1.  open the SDTM specification file in the Documentations folder, go to the tab named DM, which lists the definition of each of the variables in the SDTM DM data set. We can simply create the variables, based on the requirement specified.
ORDER	DOMAIN	OBSERVATION CLASS	VARIABLE NAME	VARIABLE LABEL	DATA TYPE	LENGTH	ROLE	DERIVATION                                                                                                  	ADITIONAL EXPLANATIONS
1	DM	Special-Purpose	STUDYID 	Study Identifier 	Text	21	Identifier	STUDYID = "XYZ"	 
2	DM	Special-Purpose	DOMAIN 	Domain Abbreviation 	Text	8	Identifier	DOMAIN = "DM"	 
3	DM	Special-Purpose	USUBJID 	Unique Subject Identifier 	Text	30	Identifier	Concatenate STUDYID and SUBJECT with a '/' as a separator, for example: "XYZ/101"	 
这是一个简化版的SDTM Specification，可以一阅，获得一些感性认识。

晚，阅读ANCOVA 相关的网页，An Introduction to ANCOVA (Analysis of Variance) - Statology
An ANCOVA is an extension of an ANOVA in which we’d like to determine if there is a statistically significant difference between three or more independent groups after accounting for one or more covariates.
A covariate is a continuous variable that co-varies with the response variable.
For example, suppose we want to know whether or not studying technique has an impact on exam scores, but we want to account for the grade that the student already has in the class. We can use their current grade as a covariate and conduct an ANCOVA to determine if there is a statistically significant difference between the mean exam scores of the three groups.This allows us to test whether or not studying technique has an impact on exam scores after the influence of the covariate has been removed.
Thus, if we find that there is a statistically significant difference in exam scores between the three studying techniques, we can be sure that this difference exists even after accounting for the students current grade in the class (i.e. if they’re already doing well or not in the class).

Assumption:
	1. The covariate(s) and the factor variable(s) are independent.
	2. The covariate(s) are continuous data.The covariates should be continuous (i.e. either interval or ratio data).
	3. Homogeneity of variances – The variances among the groups should be roughly equal.
	4. Independence – The observations in each group should be independent.
	5. Normality – The data should be roughly normally distributed in each group.
	6. No extreme outliers – There should be no extreme outliers in any of the groups that could significantly affect the results of the ANCOVA.
Procedures:
She will perform an ANCOVA using the following variables:
	• Factor variable: studying technique
	• Covariate: current grade
	• Response variable: exam score

2022-11-09 Wednesday
Multiple Imputation in SAS Part 1 (ucla.edu)

Goals of statistical analysis with missing data:
	a. Minimize bias
	b. Maximize use of available information
	c. Obtain appropriate estimates of uncertainty
Exploring missing data mechanisms: 1. Missing completely at random(MCAR)   2. Missing at random(MAR) 3. Missing not at random(MNAR).data are said to be missing not at random if the value of the unobserved variable itself predicts missingness. 
analyzing only complete cases for data that are either missing at random, or missing not at random can lead to biased parameter estimates. Multiple imputation and other modern methods such as direct maximum likelihood generally assumes that the data are at least MAR, meaning that this procedure can also be used on data that are missing completely at random. 

Common techniques for dealing with missing data: 
	a. Complete case analysis (listwise deletion)
	b. Available case analysis (pairwise deletion)
	c. Mean Imputation(Unconditional Mean Imputation)
	d. Single Imputation
	e. Stochastic Imputation

A common misconception of missing data methods is the assumption that imputed values should represent “real” values. The purpose when addressing missing data is to correctly reproduce the variance/covariance matrix we would have observed had our data not had any missing information.

2022-11-10 Thursday
Watch a video: 
Data set with missing data + Imputation model  => Imputed Data(1 to n) => Analysis Model like ANCOVA, GLM etc( 1 to n) => Pooled Results(Pool estimates and standard errors to get overall confidence interval and p-value)
The idea is uncertainties we have which we try to do imputation try to alleviate it by multiple imputation 
Case study in Ulcerative Colitis(溃疡性结肠炎）
Exploring Missing Data: What reasons for missing data have you found in your studies?
	® Early withdrawal due to Adverse Events.
	® Early withdrawal/Discharged early due to speedy recovery
	® Early withdrawal due to lack of efficacy
	® Considered "irrelevant" to estimand of interest
	® Inability to use equipment properly
	® Unmeasurable due to technical issue
	® Missed visits due to schedule or logistics

Missing data patterns:
   Monotone:  have full data before the visit with missing data.
   Arbitrary:  like randomly missing.
SAS Code to explore patterns of missing data:
Ods output MissPattern = mpattern;
Proc mi data = ADB.ADIN  nimpute=0;
  var TRTEDY RBS0N RBS1N RBS2N RBS4N RBS8N RBS12N;
Run;

Notes:
   (1) nimpute=0; This code is set to not perform any imputations.
   (2) may make sense to explore by treatment arm or sub group.
   (3) Requires data in wide format with 1 record per subject
Missing Data Pattern -  SAS Output1:   each "Group" is a different missing data pattern, has Frequency and Percent.
Missing Data Pattern -  SAS Output2: Each group has a mean for each variable(assessment at different visit)
Example of Missing data at week 12:   Subject  discontinues treatment at Day 72(week10, between week8 and week 12), how could we impute week12 data?   (1). BOCF=Baseline observation carry forward (2) LOCF=Last observation carry forward. (3) Multiple imputations(30 times of imputation), generate 30 different datasets, then calculate the average of 3-component Mayo score , Change from baseline.

Multiple imputation process:
Model response Y with other variables and use to "predict" missing values, better to include more variables: those key variables and correlated variables , other variables you think may predict the missing data.=> Imputed Data,30 datasets=> Analysis Model, Model response Y, such as ANCOVA, GLM, Logistic, mixed effect , get 30 different analysis results. => Pooled Results: Rubin's method, Total variability(T) includes variability between as well as within imputed datasets: T=W+(1+1/m)B YZ: 不知道这个W, m 和B是怎么算出来的，要是有个实例就好了,m看来是impute的次数。什么是between variablility? 可参考文献：D. Rubin, Multiple Imputation for Nonresponse in Surveys, New York: John Wiley & Sons, 1987

Sample SAS code:
Imputation Model. Requires data in wide format with 1 record per subject
PROC MI DATA = adb.vadin NIMPUTE=30 OUT=admiout SEED=8238946;
   CLASS low_dose hi_dose cort tnf;
   FCS REGPMM(rbs0n sfs0n fes0n pga0n
                           rbs1n sfs1n 
                           rbs2n sfs2n
                           rbs4n sfs4n
                           rbs8n sfs8n
                           rbs12n sf12n fes12n pga12n/DETAILS K=10) NBITER=200;
    VAR low_dose hi_dose trtedy cort tnf rbson rbs1n rbs2n …pga12n;
RUN;

Analysis Model:
Proc MIXED DATA=admi (where=(PARAM=…));
    ODS OUTPUT LSMEANS=lsmeans DIFFS=diffs;
    BY impute; *-- mi imputation data set number --;
    CLASS trtp;
    MODEL aval = …/SOLUTION ALPHA=0.05;
    LSMEANS trtp / PDIFF=control("Placebo") CL;
RUN;

Combine Estimates(using Rubin's method):
*** Combine results to give overall estimate, SE and p-value(similar code for combining lsmeans);
PROC MIANALYZE DATA=diffs alpha=0.1;
     MODELEFFECTS estimate;
     STDERR stderr;
     ODS OUTPUT parameterestimates=parest;
Run;

Data Flow: ADIN => MI Model => ADMIOUT => Transpose/ derive MCS => ADMI => Analysis models => Pool

Results -  Case study in Ulcerative colitis
Descriptive Summary: multiple imputation(MI) Summary of 3-component mayo clinic score at week12;
ANCOVA Model: MI Analysis of change from Baseline in 3-component mayo clinic score at week 12, ANCOVA Model
Tipping point analysis: Exploring robustness with Tipping point analysis.Imputed values in active group are increased by delta up to maximum possible score of 9, analysis repeated for delta=1,2,…9;Exploring robustness with tipping point analysis. Tipping point is just below delta=3. Impact of number of imputations on estimation of mean difference from placebo;
Focus on 2mg vs placebo

Flavours of multiple imputation models; considering data types and missing data patterns: 有一个表，missing data pattern : montone, arbitrary. Variable type: continuous, Binary/ordinal, nominal. PMM: Predictive mean matching. MCMC: Markov Chain Monte Carlo; FCS: Fully condithional specification
General Theory: multiple imputation steps: P-Step, I-step

ICH E9(R1) Addendum on Estimands and sensitivity analysis: How you "take account " of missing data/intercurrent events should reflect what you want to estimate: the estimand.
Consider a "Woorse than Average" Subject in active arm with missing data-What are plausible imputed values?
Effect diminishes rapidly(JUMP TO REFERENCE); Effect diminishes slowly(COPY REFERENCE) ;benefit retained(COPY INCREMENT); as if continued treatment(MAR).
Copy reference(CR): Subject gradually moves closer to placebo.
SAS 9.4 has MNAR option in PROC MI:
MNAR model(RBS1N/MODELOBS=(arm='Placebo'));
Etc (in order)
MNAR model(FES12N/ MODELOBS=(arm='Placebo'));
MNAR model(RBS12N/ MODELOBS=(arm='Placebo'));
MNAR model(SFS12N/ MODELOBS=(arm='Placebo'));

Proc mianalyze output: MAR versus MNAR "Copy Reference" Approach
MNAR SE increased and treatment effect reduced. 1 sided p-values of 0.0091 vs 0.0139

The Practicalities of using Multiple Imputation:
Objectives: Estimand needs to be clear to understand what data are relevant and how to impute?
PLAN: Need to think through approach in protocol(as well as SAP); Check approach before break blind and update SAP.
DATA: a. Wide format for MI model; b. Derive endpoints + transpose back to stacked format. c. Bigger than standard data    
           set. 
Table specs: Interest in summary stats on imputed values as well as observed.
Validation: Many PROC MI options so specify code in SAP and ensure senior review of code prior to breaking blind.
Sensitivity: Consider how data are influenced by choice of model and how to test assumptions.

Conclusion:
Cons of casewise deletion, mean imputation, weighting, single imputation, locf, bocf:
	® Does not preserve valid statistical inference
	® Estimates of treatment effects may be biased
	® Confidence intervals too narrow
	® Anti-conservative p-values
	® No account of uncertainty of imputation

Pros of Multiple imputation:
	® Model-based: imputation model broader than analysis
	® Stochastic: draws of parameters and errors
	® Multivariate: preserves observed distribution properties and associations
	® Multiple independent imputation: within and between variance
	® Robust: Preserves valid statistical inference, proper CI coverage and accurate p-values
	® Usable: SAS PROC MI
	
Complex Missing Data Initiative:
 please contact us with your questions and experiences:
Elaine Hoffman, Statistical Science Director
Leiya Han, Associate statistical science director
Sue McKendrick, Associate statistical science director

2022-11-13 
                                                 MULTIPLE IMPUTATION IN SAS PART 1
https://stats.oarc.ucla.edu/sas/seminars/multiple-imputation-in-sas/mi_new_1/
Goals of statistical analysis with missing data:
	a. Minimize bias
	b. Maximize use of available information
	c. Obtain appropriate estimates of uncertainty
Exploring missing data mechanisms: 1. Missing completely at random(MCAR)   2. Missing at random(MAR) 3. Missing not at random(MNAR).data are said to be missing not at random if the value of the unobserved variable itself predicts missingness. 
analyzing only complete cases for data that are either missing at random, or missing not at random can lead to biased parameter estimates. Multiple imputation and other modern methods such as direct maximum likelihood generally assumes that the data are at least MAR, meaning that this procedure can also be used on data that are missing completely at random. 

Common techniques for dealing with missing data: 
	a. Complete case analysis (listwise deletion)
	b. Available case analysis (pairwise deletion)
	c. Mean Imputation(Unconditional Mean Imputation)
	d. Single Imputation
	e. Stochastic Imputation

A common misconception of missing data methods is the assumption that imputed values should represent “real” values. The purpose when addressing missing data is to correctly reproduce the variance/covariance matrix we would have observed had our data not had any missing information.

Note of watching the YouTube video "Multiple Imputation using SAS"

Flow Chart for Multiple Imputation:
  1.Step1: Data steps: Create data set with one row per subject and sort them by Treatment group.
/* Step1: Convert data as a single observation per patient */
Proc sort data=original; by subjectid trt weightcat; run;
Proc transpose data=original out=transpose_step1_MI;
  var col1;/* Aval is stored in this variable */
  id _LABEL_; /* Visits are stored in this variable*/
  by subjectid trt weightcat;
Run;

	2. Step2: Proc MI: Create Multiple Imputation datasets using MI procedure.
/*Step2: Sorting data by TRT and create multiple imputation dataset using PROC MI*/
Proc sort data=transpose_step1_MI out=tran_step1; by trt; run;    why we need to sort by trt? Because the need to use "by trt" in the following PROC MI;
Proc MI data=tran_step1 out=mi_imp seed=1234 nimpute=100;
   EM converge=1E-2 MAXITER=1000; MCMC PRIOR=RIDGE=2;
   Var baseline week_4--week_52;
   by trt;
Run;
/* using by treatment: so it will consider different distribution by treatment group to impute the variables

The missing values was replaced by values drawn from each treatment group. (by trt)
Generate 100 number of data sets with different values for each treatment group where we have missing values

	3. Step3: Perform planned analysis as per requirement. Perform this analysis by imputation number so that we will have estimates by imputation number. Store estimates and std. error in SAS datset.
	/* step3: perform analysis which was planned as per SAP for the endpoint./
	PROC SORT data=mi_imp/ by _Imputation_; run;
    Proc mixed data=mi_imp;
	   by _Imputation_;
	   class trt weightcat;
	   model week_52=baseline weightcat trt;
	   lsmeans trt/pdiff CL;
	   ods output diffs=estimates;
      run;
  4. Step4: Combine results for all imputation(Estimate and std. Err.) using Mianalyze procedure. Rubin's Rule applied.
/* Step4: Combining Results using MIANALYZE */
ODS TRACE ON;
PROC MIANALYZE data=estimates;
     modeleffects estimate;
     stderr StdErr;
     ods ouput ParameterEstimates=Estimates_MI;
Run;
Ods trace off;

Points to remember multiple imputation:
	1. MI is time consuming when we have large number of imputation in long term studies.
	2. In case of large number of variables, we may face convergence issues.Those can be rectified before final results using additional options in SAS.
	3. Generally, MI should not be used for Primary analysis, it should be used as sensitivity analysis.
	4. We need to pay attention while interpreting results when we have >30% data missing.
	5. None of the method is appropriate in case of large missing data.  

	1. PROC SORT: Sort multiple imputed data sets by imputation number.
	
	2. SAS PROC: Perform pre-specified analysis, e.g. PROC MIXED, Save estimates and standard errors using ODS OUTPUT.
	3. PROC MIANALYZE: Combine the results using PROC MIANALYZE(Rubin's rule), Give overall estimates ,with confidence intervals that adequately reflect the uncertainty due to missing data.

2024-04-11
	1. R Programming for Data Science https://bookdown.org/rdpeng/rprogdatascience/
	2. Creating simulated data sets in R https://stirlingcodingclub.github.io/simulating_data/index.html
	3. simulating a multiple comparisons problem using R and bonferroni correction  https://stats.stackexchange.com/questions/135279/simulating-a-multiple-comparisons-problem-using-r-and-bonferroni-correction
	4. An introduction to multiplicity issues in clinical trials: the what, why, when and how 
	5. Why care about mulitplicity https://rpubs.com/WhataBurger/care_about_multiplicity
	6. Statistical distributions in R https://www.huber.embl.de/users/kaspar/biostat_2021/2-demo.html
	7. How to Visualize and Compare Distributions in R https://flowingdata.com/2012/05/15/how-to-visualize-and-compare-distributions/
	8. How To R: Visualizing Distributions https://medium.com/@nickmartin812/how-to-r-visualizing-distributions-49ea4141fb32
	9. A simple-to-use R package for mimicking study data by simulations file://vdurntxafs001.americas.ppdi.local/W10-home/yuanz/Downloads/10-1055-a-2048-7692-s22010082-1.pdf https://www.ncbi.nlm.nih.gov/pmc/articles/PMC10462429/pdf/10-1055-a-2048-7692.pdf
	10. R for Data Science: Exercise Solutions https://jrnold.github.io/r4ds-exercise-solutions/
	11. R for Data Science https://r4ds.hadley.nz/
	12. Statistical Inference via Data Science https://moderndive.com/
	13. ggplot2: Elegant Graphics for Data Analysis (3e) https://ggplot2-book.org/annotations
	14. Introduction to Survival Analysis https://towardsdatascience.com/introduction-to-survival-analysis-in-cows-using-r-28b82c2821fb
	15. Statistical Rethinking — Bayesian Analysis in R https://medium.com/@marc.jacobs012/statistical-rethinking-bayesian-analysis-in-r-e1e25aeb9a5c
	16. Bayesian Analysis in R https://marissabarlaz.github.io/portfolio/bayesian/
	17. Multiple comparisons problem https://en.wikipedia.org/wiki/Multiple_comparisons_problem#:~:text=In%20statistics%2C%20the%20multiple%20comparisons,based%20on%20the%20observed%20values.
	18. Multiplicity adjustments in parallel-group multi-arm trials sharing a control group: Clear guidance https://www.ncbi.nlm.nih.gov/pmc/articles/PMC8844584/?report=printable
	19. Best (but oft-forgotten) practices: the multiple problems of multiplicity—whether and how to correct for many statistical tests 
	20. Multiple Hypothesis Testing in R https://rviews.rstudio.com/2019/10/02/multiple-hypothesis-testing/
	21. Online SAS Code Generator https://www.codeconvert.ai/sas-code-generator
	22. FREE AI Code Generator https://zzzcode.ai/  初步测试这个网站非常好用。 Yzly2004@gmail.com ->yzle201005 

First of all, we have to look at table shell and determines what information is needed. Then search related information from in CRF and SDTM. If there is already a variable containing this required information, we can copy variables from SDTM into ADaM directly. Otherwise, we have to establish a rule that can be used to derive ADaM variable from SDTM. These rules regarding how to get ADaM varaibles have to be written into ADaM Specification. Sometimes, we also have to check SAP (Statistical Analysis Plan) for rules such as how to impute for missing data. The rules from SAP have also to be written into ADaM Specification. With ADaM Specification and SDTM datasets available, we can start programming ADaM. The developed ADaM can be used to create TFL (Table, Figure and Listing).
Here is where you can find all the documents. ADaMIG (ADaM Implementation Guide) describles the organization, structure and format of analysis datasets and related metadata (another name is ADaM Specification). Two types of data stuctures – the subject-level analysis dataset (ADSL) and the Basic Data Structure (BDS) – are included in ADaMIG. And the third one which is OCCDS (Occurrence Data) is described in document titled “ADaM structure for Occurrence Data”. From this webpage, you can also find document titled “ADaM Basic Data Structure (BDS) for Time-to-Event (TTE) Analyses”. This document is useful when developing ADTTE domain. In order to download these files, you have to register first. Below figure listed name and structure of several common domains. In the right part of the figure, I also listed the corresponding document. For example, ADTTE domain is a BDS domain and you have to read document – ADaM BDS for TTE Analyse.
Variable label for TRTEMFL is “Treatment Emergent Analysis Flag”. This variable is to be used for any analysis of treatment-emergent AEs. The derivation is something like below:
If ADSL.TRTSDT <= ADAE.ASTDT <=ADSL.TRTEDT + x days then TRTEMFL = “Y”
Label for ONTRTFL is “On-Treatment Flag”. It is to be used to indicate whether the record occurred while the subject was on treatment. Here is an example derivation:
If ADSL.TRTSDT <= ADCM.ASTDT <= ADSL.TRTEDT then ONTRTFL = ‘Y’
Usually TRTSDT and TRTEDT will not be missing as long as the study has been completed. But AESTDTC or CMSTDTC may be completely missing or partial missing sometimes. This may lead to missing of ASTDT(Analysis Start Date) and thus we cannot make comparison. For most studies, timing imputation will be applied and imputation rules will be included in SAP. And due to complexity of real study, we may also have to impute AENDT (Analysis Stop Date). Supose that we have following rules for ASTDT and AENDT in ADCM domain:

If start date is completely missing, start date will have 2005 imputed for year, Jananuary for the missing month and 1 for the missing day. If month and date are missing, we will use Janauary to impute the missing month and 1 to impute the missing date. If only date is missing, we will use the 1 to impute missing date.
If stop date is completely missing, start date will have 2015 imputed for year, December for the missing month and 31 for the missing day. If month and date are missing, we will use December   to impute the missing month and 31 to impute the missing date. If only date is missing, we will use the last of day of that month to impute missing date.
For BDS domains such as ADLB, ADEG or ADVS, we may need to create a Baseline Record Flag variable ABLFL. It is to be used for identifying the baseline record for each subject, parameter. For each subject and each parameter, the latest non-missing record before start date of treatment will be identified as Baseline record. The most commonly related variables are BASE and CHG. BASE is AVAL from Baseline analysis record. CHG is to indicate change from baseline analysis value and equal to AVAL – BASE. 
I strongly recommend you to use RETAIN statement.
Suppose that we have a data named ADLB1. We can create a flag variable FF which will be populated as Y if the analysis observation occurred before start date of treatment. For other observations, FF will be populated as missing. Sort this data by USUBJID, PARCAT1, PARAM, FF and ADT. Observations meeting condition LAST.FF and FF = “Y” are exactly the Baseline analysis observations.
*ABLFL;
data adlb2;
set adlb1;
if (. < adt < trtsdt) then ff = “Y”;
else ff = “”;
if aval eq . and avalc eq “” then ff = “”;
run;
proc sort data = adlb2; by usubjid parcat1 param ff adt; run;
data adlb2(drop=ff);
set adlb2;
by usubjid parcat1 param paramcd ff adt;
if ff = “Y” and last.ff then ablfl = “Y”;
run;
After we get the baseline analysis record, we can sort the data by USUBJID, PARCAT1, PARAM and DESCENDING ABLFL at first. Then use RETAIN statement to get BASE.

*base;
proc sort data = adlb2; by usubjid parcat1 param descending ablfl; run;
data adlb3;
retain base;
set adlb2;
by usubjid parcat1 param descending ablfl;
if first.param and ablfl ne “Y” then base = .;
if ablfl =”Y” then base = aval;
run;
Similar method can be used to derive post baseline flag variable (POSTFL). Why do we need to derive POSTFL? That is because CHG is only populated for post baseline records for most studies. Here we created a tempary variable POSTFL_. It will be populated as Y for both baseline analysis observation and all post baseline analysis observations. Records having ABLFL equal to null and POSTFL_ equal to Y are exactly what we want – post baseline records only for which CHG will be populated.
*postfl & Chg;
proc sort data = adlb3; by usubjid parcat1 param adt; run;
data adlb3(drop=postfl_);
retain postfl_;
set adlb3;
by usubjid parcat1 param adt;
if ablfl =”Y” then postfl_ = “Y”;
if first.param and ablfl = “” then postfl_ = “”;
if first.param and ablfl = “Y” then postfl_ = “Y”;
if postfl_ = “Y” and ablfl ne “Y” then postfl = “Y”;
if aval ne . and base ne . and postfl = “Y” then chg = aval – base;
run;
PARAMN
PARAMN is a numeric representation of PARAM. There must be a one-to-one mapping to PARAM within a dataset. IF…ELSE IF… can be used to populate PARAMN. But what if there are a lot of parameters? The code will be lengthy and we may also have to update code as time goes on and more data are collected. Here we can use FORMAT and update format if new parameters emerge.


proc format;
invalue paramn
“ALB” = 1001
“ALP” = 1002
“ALT” = 1003
;
quit;
data adlb;
paramcd = “ALB”; output;
paramcd = “ALP”; output;
paramcd = “ALT”; output;
run;

data adlb ;
set adlb ;
paramn = input(paramcd, paramn.);
run;

DTYPE
For some studies, we may have to derive a new record which contains the mean of AVAL from all observations of a given paramter. In this case, I also recommend you to use RETAIN statement. Similar approach can be used to derive PARAMTYP.

proc sort data = adlb; by usubjid parcat1 param adt; run;
data adlb;
retain sum n;
set adlb;
by usubjid parcat1 param adt;
if first.param then do;
sum = 0;
n = 0;
end;
sum + aval;
n + 1;
if last.param;
aval = sum/n;
dtype = “AVERAGE”;
run;

需要抽时间阅读的四本书。
With scientific discoveries and technological advancements comes knowledge. This knowledge defines the scope and practices of the different fields of professions that they apply to. Due to the continuous nature of medical research, the medical sciences are not also behind on scientific discoveries. More often than not, there is a new field knowledge that changes the way people do their job. The change could be something in something routine as checking the blood pressure of a patient or measuring the body temperature. A smart clinical research scientist knows that they have to ensure that they stay up to date with scientific discoveries to help patients as well as themselves.
If you have been offered a clinical research job or you are interested in one, one thing you should know for sure is that to be successful in this field, you need to know your stuff. It is true what they say, to remain relevant in any field is to remain knowledgeable.
To help your cause, we have made a list of 6 books that will help you succeed in the clinical research field.
	• Fundamentals of Clinical Trials, by Lawrence M. Friedman, Curt D. Furberg, David DeMets. This book looks into key issues like assessment, reporting of results, randomization, interpretation etc. This book introduces clinical trials to you beautifully, with real life examples used to explain key features of clinical trial.
	• Designing Clinical Research, by Dr. Stephen B Hulley, MD, MPH, Steven R Cummings, MD, Warren S Browner, MD. This book is an important book for doctors, pharmacists, nurses and all medical professionals involved in medical research. It explains useful methods for designing, funding and implementing clinical research.
	• Publishing and Presenting Clinical Research, Third Edition, by Warren S. Browner MD. This book contains the essentials of clinical trials and publication. This book will come in handy for those who wants to know more about organizing, delivering, and publishing the results of their research in the best way possible.
	• Practical Guide to Clinical Data Management, Third Edition, by Susanne Prokscha. One issue that always pops up in clinical research is how to manage the large volumes of ever increasing data. If you are already working in the field, you could no doubt relate. This is a task that can be rightfully described as “extremely time consuming”. This book gives powerful insights on current industry tactics on the use of Electronic Data Capture (EDC) for clinical research. This book will help you solve the age-long problem of managing voluminous clinical research data.
Honorable mentions 
	• Basic Principles of Clinical Research and Methodology by S. K. Gupta
	• A Clinical Trial Manual from the Duke Clinical Research Institute. Kate Davis, Margaret Liu.
	• Handbook for Good Clinical Research Practice. WHO.
We have introduced many good reads for those who like to stay informed. Whether you are someone looking to get started in the field or someone who is looking for a refresher, these are the perfect places to start. If you need motivation to get reading, here are some clinical research positions to remind you of what is possible when you apply yourself. 
If you prefer online classes with professional guidance, check out CCRPS’ certification courses. They offer one of the only major ACCRE accredited courses in the US. The courses are created by real, senior professionals who skip the nonsense and get right into what you need to succeed in the field. 

From <https://ccrps.org/clinical-research-blog/clinical-research-books> 


*************************************************************************
*        CLIENT: SponsorXYZ
*      PROTOCOL: Prot001
*  PROGRAM NAME: vt14030201.SAS
*       PURPOSE: Summary Statistics and Change from Baseline
*                in Hematology Safety Analysis Set

*   INPUT FILES: ADAE
*  OUTPUT FILES: 
*   USAGE NOTES:  
************************************************************************* 
* Copyright 2017 PPD
* All Rights Reserved. 
*************************************************************************;

%let g_deliverableid = t14030201 ;
%let g_pgmname = vt14030201 ;
%let GET_TF_ID = t14030201 ;

** Include Study Defaults;
%include "C773_defaults.sas";

proc format;
  value trtpl
    1='1'
    2='2'
    3='3'
    ;
value $trtdspH
    '1'= "Active Dose 1"
    '2'= "Active Dose 2"
    '3' = "Placebo";

run;


*************************************************************************************;
**                     SETUP AND/OR OVERRIDE TABLE DEFAULTS                        **;
*************************************************************************************;

%let _default_trtvar = TRT01PN;
%let _default_bign_in_where = %str(saffl='Y');
%let _default_below_bign = ;
%let _DEFAULT_TRTVAR_PRELOADFMT = TRTPL.;
%let _DEFAULT_DISPLAY_FMT = $trtdspH.;
%let _default_interleave_trt_sequence = 1 2 3 ;
%let _DEFAULT_DEFINE_TOTAL_GROUPS = 1 2 3 ;

** overrides **;
%let _default_debug = N; 
%let _default_help = N; 

** parameters for this table **;
%Let Where = PARCAT1 = 'HEMATOLOGY' and PARAMCD in ('HCT','HGB','MCV','PLAT','RBCH', 'BASO', 'EOS', 'LYM', 'MONO', 'NEUT')
       and SAFFL = 'Y' and (ABLFL = 'Y' or (ANL01FL = 'Y' and AVISITN >= 4)) ;

%let _default_in_data = adlb; 

*************************************************************************************;
**                              MANIPULATE DATA                                    **;
*************************************************************************************;

libname adb "\\wilbtib\wilbtia10\PPD DummyStudy\ADaM Programming\Databases\Analysis Database\Output" ;

data &_default_in_data.;
  set adb.&_default_in_data. (where = (&where.)) ;
  if ablfl = "Y" then do;
     avisit = 'Baseline';
     avisitn = 0;
   end;
run ;

proc sort ; by usubjid avisitn ;

data &_default_in_data.;
  set &_default_in_data. ;
 /* if avisitn lt 0 then delete ;
    if avisitn > 99 then avisitn = 99 ;
 */


   **** Client keeps changing their mind ***;
   if paramcd = "BASO" then paramn = 1 ;
   if paramcd = "EOS" then paramn = 2 ;
      if paramcd = "MCV" then paramn = 3 ;
   if paramcd = "RBCH" then paramn = 4 ;
 if paramcd = "HCT" then paramn = 5 ;
   if paramcd = "HGB" then paramn = 6 ;
   if paramcd = "LYM" then paramn = 7 ;
   if paramcd = "MONO" then paramn = 8 ;
   if paramcd = "NEUT" then paramn = 9 ; 
   if paramcd = "PLAT" then paramn = 10 ; 

a = input(substr(lbdtc, 1, 10), ?? yymmdd10.) ;


proc sort data = &_default_in_data. nodupkey ;     by usubjid paramn avisitn ;   run ;


. . .

*************************************************************************************;
**                                PAGEBY VARIABLE                                  **;
** This variable will be used in the macros ma_summ_stats, ma_summ_stats_rules,    **; 
** ma_summ_stats_display, mr_subgroup_tile, mr_pagebreak_table and mr_report_basic **; 
** PAGEBYs categorize the analysis data and control the pagination in the output.  **;
*************************************************************************************;
** Pageby variable. e.g., paramcd;
        %let pageby_var = paramn; 
        %let pageby_title = %str(Parameter: ); 

** Format that will be used to PRELOAD values of PAGEBY variable in the report.;
** Used when not all of the values that are to be displayed are available in the data (unusual);
** If no preloading is needed, enter BLANK;
        %let pageby_preloadfmt = BLANK; 

** Sort order;
  ** I(internal) or F(ormatted) value;
        %let pageby_var_sort_order = I; 
  ** A(scending) or D(escending) order;
        %let pageby_var_sort_asc_or_desc = ASCENDING; 


. . .

*!*!*!*!*!*!*!*!*!*!*!*!*! MODIFY BELOW WITH CAUTION *!*!*!*!*!*!*!*!*!*!;

** BIG N;
%ma_bign
(in_data                = &_DEFAULT_BIGN_IN_DATA.
,in_where               = &_DEFAULT_BIGN_IN_WHERE.
,subgroup               = &subgroup.
,trigger_bign_in_colhead = YES /* Set to NO if you DO NOT want to display the N= in the column header */ 
,trigger_split_bign     = YES  /* insert a prcode_split into the column header so that the (N=xxx) is forced to the next line*/
,trigger_parentheses    = &_DEFAULT_TRIGGER_PARENTHESES /* surround N=xxx with parentheses i.e, (N=xxx) */
,help                   = &_DEFAULT_HELP
,debug                  = &_DEFAULT_DEBUG
) ;

. . .


** Get Titles and Footnotes, Count usuable lines per page;
%get_tf
(tlf_progname           = &get_tf_id. /* keyword in the .TF file which identifies titles and footnotes for this report */
,escapechar             = &_default_escapechar /* the ODS escape character */
,use_parse_char         = yes /* yes/no to add 'a0'x at the end of titles and footnotes. 
                                Invisiible character used for DEL_SUBSTR in RTF_PARSE */
,write_titles           = yes /* indicates whether or not SAS TITLE statements should be exectued using the titles from the TF file */
,write_footnotes        = yes /* indicates whether or not SAS FOOTNOTE statements should be exectued using the footnotes from the TF file */
,out_tf_dataset         = yes /* indicates whether or not you want an output data set created */
);      

. . . 

** this macro uses the dataset produced by get_tf
** if using spanning headers and/or subgroup titles, enter the total
** number of these extra lines into SPANNER_SUBGROUP_LINES;
%mu_lines_per_page
(metadata_filepath      = &get_tf_id._tf  /* the data set that GET_TF produced */
,tlf_progname           = &get_tf_id.
,spanner_lines          = &_extra_lines /* the number of extra lines that will be taken up by the Actual and CFB column headers */
,linesperpage           = &_default_page_length_lines. /* the number of lines that will fit on a page - 
                                                        - this should have been set in the DEFAULTS */
,in_data                = SUMM_PACK
,escapechar             = &_default_escapechar.
,prcode_split           = &_default_prcode_split.
,rtfwidth               = &_default_page_width_chars./* the width of the page in characters 
                                                        - this should have been set in the DEFAULTS */
,subgroup_var           = &subgroup.
,debug                  = &_default_debug
);

%let G_LINESLEFT = 20 ;

** Apply page break;
%mu_get_sort_order(summ_pack);
%mu_wordscan(string=&byvar, root=bv, numw=numbv, delim=%str() )
**bv&numbv will resolve to the last variable listed in the BYVAR string;

%mr_pagebreak_table
(vartx                  = pack_stat_label 
,lines_left_on_page     = 20 /* the number of lines left on the page was derived in MU_LINES_PER_PAGE */
,in_data                = SUMM_PACK
,out_data               = SUMM_PAGEBRK
,escapechar             = &_default_escapechar.
,orderby                = &sort_order /* the sort order of the input data set was obtained from the call to MU_GET_SORT_ORDER above*/
,subgrp                 = &pageby_var /* new pages at each FIRST.SUBGRP value */
,section                = &&bv&numbv /* lines will be skipped at FIRST.BYVAR */
,lineskip               = 1 /* how many lines to skip when BYVAR changes - use 0, 0.5 or 1 */
,section_protection     = y /* keep sections together on the page */
);


/*
data SUMM_PAGEBRK;
	set SUMM_PAGEBRK;
	if AVISITN=0 and STAT_LABEL='n' then call missing(STAT_VALUE_1_2,STAT_VALUE_2_2,STAT_VALUE_3_2);
run;

proc sort data=SUMM_PAGEBRK;
	by &SORT_ORDER;
run;
*/

** Call ODSOUT macro to create RTF file and select ODS style;

%mr_odsout;

** Basic proc report ;
%mr_report_basic
(in_data                = FINAL

,original_in_data       = &_default_in_data. /* in case the original subsetted data was zero obs */
,original_where         = &where.

,subgroup               = &subgroup
,show_blank_subgroup    = no
,subgroup_order_data_set= subgroup_order_data_set /* data set that controls the order of the subgroups.  
                                                        If no data set is provided, then the subgroups will be presented 
                                                        in default ascending sort order */
,nosubgroups_subgroup_title = &nodata_subgroup_title  /* subgroup subtitle for reports when there is no data */
,no_subjects_text       = &_default_no_subjects_table. /* text to use when there are no subjects in the subset for this table */
,un_interleave          = yes /* in case there are no subjects and this table was to be interleaved, 
                                do you want to compress it down to one page */

,bygroup                = &pageby_var /* The variable in the PAGEBY position */

,pagenum                = pagenum /* name of the variable containing the page numbers */
,interleave_trt_sequence= &_default_interleave_trt_sequence. /* how to display the treatments across the page(s) */
,column1                = pack_stat_label /* the variable to use in the first column */
,col1_width_pcnt        = &_default_col1_width_pcnt. /* width of the first column */

,trt_col_root           = stat_value_ /* root or prefix of the variables to use for the rest of the columns */
,trt_colhead_macvars    = colhead_ /* root of the macro variable names that will be used for the column headers (except column 1) */

,skip_var               = &&bv&numbv /* when to skip a line */
,prcode_split           = &_default_prcode_split.

,catvar                 = DUMMY /* DUMMY placeholder to tell the macro that there will be a categorical variable displayed 
                               as subcolumns beneath each treatment */
,catvar_sequence        = &_DEFAULT_STAT_SEQUENCE /* sequence of the categories (1=Actual 2=CFB) */ 
,catvar_dsp_fmt         = &_DEFAULT_ACT_CFB_LABEL_FMT /*format to control the text in the subheaders for the categories */


,skip_line_cell_height  = &_DEFAULT_SKIP_LINE_CELL_HEIGHT /*height of a skipped line */
,help                   = &_default_help
,debug                  = &_default_debug
);

** Call ODSCLOSE macro to close RTF session ;
%mr_odsclose;

** read main and validation side outputs and compare - this will only run when validation_yn = Y;
   %mr_rtf_parse
   ( validation_yn    = &validation_yn            /* Yes/No flag for validation */
   , val_path         = &val_path                  /* output path for validation rtf */
   , scan_delim       = "*"
   , del_substr_1     = &_default_substr1.                     /* what lines to ignore when reading RTF files */
   , del_substr_2     = "(N="    /* what lines to ignore when reading RTF files*/
   , report_comp      = N
   , report_base      = N
   ) *;
把自己在工作中行之有效的经验记录下来，也把工作中错误行事引起不良后果的教训记录下来，不时复习，滴水穿石，希冀能提高自己。
2022-10-16 Wednesday
做Simulation时，同样的seed, 用不同的SAS服务器得到的结果都是一样的，但用R语言时，即使使用和SAS同样的Seed, 得到的结果也是不一样的。结果取决于所使用的软件。

2022-12-08 Thursday
今天想commit 一个修改后的文件到top tier,一直搞不成。早上因为又早前预约的补牙，与今早的KYMAB project 会议冲突，没有参加今早8点多的会议，以后预约活动时一定要以工作为重，避开重要的工作相关会议和其他重要事项。早上测出血压很高，150/100, 达到了典型的高血压阈值，估计与昨晚睡得太晚，今晨起得太早有关，这种不规律的作息极易引起高血压和心血管意外，一定要引起注意，要早睡早起，规律运动。牙齿老是出问题，要赶快买电动牙刷和冲牙器，常规刷牙不行了。
我现在对BTI commit的流程有了进一步的认识，首先要用PSI把上层的公共的项目区域里的Trunk check out 到自己的User area, 右击想要修改的文件-> Get lock->这时就容许你修改了，修改后，保存，-> SVN commit ,这个时候别人就能看到我的user area里更新后的文件了。->那些有权限的Lead stats , Programmer lead, BPL 就可以在上层同步了，右击空白区域->SVN Commit.这样，我修改后的文件就存到了上层公共区域了，课题组所有的人都能看到并check out。
如何删除自己user area 和课题公共区域的-一个文件？ 在自己的user area->右击文件名->TortoiseSVN->"Delete"->右击空白区域->SVN Commit, 这样就算时SVN delete了一个文件。->有权限的人SVN commit上层公共区域，这样此文件就从公开区域消失了，别人再也看不到这个文件了。
我估计自己也可以到别人的user area, -> get lock 一个文件，修改，commit, 要尝试一下，并看以前的培训资料，看是否可行。我去试了一下，发现还是不能lock 别的user area里的文件，那些文件都是只读的。
今天和Lily Ma请教，又得到了很多有用的信息，以后一定要多向别人请教。Aron的User Area里有最近更新后的文档，我在top level trunk里是看不到的，只有少数leader有权更新。但我可以在自己的User Area里右击文件夹->SVN update, 这样同项目组别人更新后的最新文档我也能看到了。Get lock一个文件，然后修改，保存，commit,这样别人就能看到我做的修改了。

2023-01-20 Friday
我和Alexis合作validate Marco ANCOVA_SUBGRP,过程中给她转发了一封与专家探讨interaction term p value 的邮件，其中包括我用到的模型，结果Alexis看到后威胁要把我告发到Lyon那里，搞得我很不高兴。教训是：以后绝对不能看对方的CODE, 绝对不要和对方分享任何关于编程思路及解决方案之类的信息，只要联系到Specs developer就行了，把SPECS更新一下就可以了，大家都按照SPECS来，同事之间何谈什么友谊，就是合作混口饭吃而已。不该分享的资料和信息，是绝对不能分享的。这次就是告到Lyon那里，我也可以解释。要先和Aron说一下，看此事如何解决。我给Aron发了邮件和信息，但一直没有回复，不知为何。总之，一定要严格遵守公司的规定，千万不可造次。

2023-2-16 Thursday
使用%if 来规避Numeric values have been converted to character values.
 data _null_;
	    set vm_lsmeans;
		call symput('subgrp_typ',vtype(&SUBGRP.));
      run;

 	  data vm_lsmeans_eff01(drop=&SUBGRP.);
		length Subgrp $ 8 SUBGRPLV $100 result $ 39 est $15;
		set vm_lsmeans;
		  SUBGRP="&SUBGRP.";
          %if &subgrp_typ.= N %then %do;SUBGRPLV=PUT(&SUBGRP.,8.);%end;
	      %else %if &subgrp_typ.= C %then %do;SUBGRPLV=&SUBGRP.;%end;
		  resultn=1;
		  result="LS Adjusted Mean (SE)[a]";
		  est=strip(put(estimate,9.1))||" ("||strip(put(stderr,9.2))||")";
 	   	  output;
	  run;

2023-5-9 Tuesday
如何在Clarity上看我的工作时间安排表
进入Clarity页面->鼠标悬停于Home之上->第三列Resource Management->Resources->在第一个搜索框Resource/Role name: 输入Yuan, Joshua, 回车可见屏幕底部有带有我名字Yuan, Joshua的一行， 点击名字旁边的小人icon, 即可见我的工作时间分配情况。

2022-11-29 Tuesday
昨天突然发现我登录不了SAS Server, 吃了晚饭后又发现连电脑也登录不进去了，尝试多次，直到看到警告再尝试输入密码就要锁定账户了。今早来公司IT，一个老头Steve Futrell帮我解决了问题，说我昨天修改了账户密码，可我根本就没有修改，又说可能是密码过期了，可我的密码还不到三个月，他也不知道到底出了什么问题，为何密码会突然失效。我重设了密码：Yzle201005!  发现BTI 还是连不上SAS server, 后来Steve打电话问了别人，说要再BTI 重新设置密码，如下：
From the VPN Desktop: Start =>CMD=> C:\WINDOWS\system32> lspasswd =》Please enter user AMERICAS\yuanz's LSF Password: Yzle201005! => Confirm by reenter ther password
以后每次更改密码后都要在BTI 重新设置密码，不然用不了SAS EG.      Steve建议我以后遇到这种开不了机，登录不进电脑时，最好还是带着电脑来公司，这样解决问题会快很多。
2023-02-27 I changed my password, and could not access to SAS server, I did not remember this note, so, I wasted several hours waiting for the IT. 下次一定要牢记！！！
Your password has been saved in LSF.
LSF will use this password for starting your jobs.
If you change your Windows password, you must run lspasswd to update LSF.
2023-6-1 改了密码后又遇到上述情况，这次还算是突然想起来了，找到了这个解决方案。


2023-8-28 Monday
密码又在周末过期，先试着用ctrl+alt+delete,设置密码，结果老是说新密码不符合规定，我试了好多不同的密码，还是不行。随后联系IT,一个印度女士Gemlyn Soterro 来帮助我， 她先说让我用pwchange.ppdi.com/my.policy 来重设密码，但还是不行，她为我设了一个密码，然后让我输入zhenhua.yuan@ppd.com, 再输入我要设的新密码Zyw197610!, 结果报错。她让我SIGN OUT, 看刚才设的新密码是否是可用的， 我ctrl+alt+del -> sign out, 然后重新用刚才报错的密码Zyw197610! 登录，结果成功。浪费时间一小时。以后绝对不能等到密码过期后才重设密码，新密码要写下来贴在显示器底座上。后来尝试登录BTI, 发现Citrix Workspace 报错： There was a failure with the mapped account, Gem让我log out 再login, 运行Citrix, 又报错说can not connect to the server. Gem让我点retry, 同样的报错信息，她说我的账号被lock了，让我再重启电脑，重启之后用新密码登录，然后运行Citrix，这次没又报错，顺利进入VPN桌面，只是费时比较长，估计有3分钟。然后参照以前的办法再VPN 桌面用lspasswd命令重设密码，如下，再运行SAS,发现正常。至此，这次修改密码的过程顺利结束，费时近两小时。My employee number 1781751


2023-6-8 周四
必须要努力学习如何高效使用人工智能：最有利的情况是：留下员工继续工作，让他们使用ChatGPT等人工智能工具作为辅助。即便如此，这也排除了那些不具备使用ChatGPT技能的普通员工。显而易见，那些具有高重复性的工作类别，已经处于危险之中了。AI代替码农这种说法，无非是基于其能大大提高效率，减少类似于CV式程序员，当效率提高、需要的人就相对要少了，需求减少，那么固然有一批程序员就要面临失业被替代了。当然，熟练的程序员和编程人员可以采用AI来提高生产力，并帮助保持就业市场的可持续性。
虽然很多人认为，无限制地使用AI取代人类的工作是不道德的。但事实上，AI给就业市场带来了前所未有的变化，肯定会取代一些工作岗位。就像以往出现的其他创新技术一样，它会不断适应和平衡可以帮助人们平稳过渡。政府、组织和个人必须大力投资教育和再培训项目，以尽量减少AI对劳动力的影响，并优化人力资源。通过专注的思考，人类的聪明才智、创造力和适应性不仅可以被保留，而且可以通过AI技术得到增强。
这里面就有两个很关键的部分。一是在机器学习领域，语言模型的数学基础其实是概率论。简单来说就是用已知的文本作为条件，来预测在类似条件下出现不同词语的概率。也就是说，ChatGPT给你的答案是根据数据集来“摘取”和“猜”出来的，虽然它可能出现很高的正确率，但绝对不可能保证100%的准确。但很多的工作对于准确性的要求很高，就以我们的工作为例，你可能因为写出一个bug就给公司带来巨额损失，所以在这个过程中一定是需要懂技术的人来进行监督和验证，因此从这个角度来说，程序员这个职业是不可能消失的。首先ChatGPT是基于互联网数据训练的，但我们在工作中很多需要用到的资料或者工具都只局限于公司内部，这些资料ChatGPT根本没学过，所以也无法产出直接拿来可用的东西。还有就是大家都知道当它遇到复杂问题的时候它都在一本正经的胡说八道，与其去花时间去查验和修正它给出的解决方案，不如自己去写。而且如果只是为了提高写代码的效率，很多公司内部其实早就在用自动填充、自动联想的代码辅助工具，这些工具是公司基于内部的资料和代码库开发的，所以针对性和准确性都更强，所以也不需要去使用ChatGPT。
最后，关于 ChatGPT之类的AI工具会不会取代程序员这个问题，我觉得在至少在未来几年里不会大范围的取代，它可能会更多的作为一个辅助的工具来帮助提高工程师的开发效率。但影响一定也会循序渐进的发生，那些重复性工作比较多的岗位很有可能会被AI彻底淘汰，比如简单的前端网页开发、CRUD类的工作或者部分数据分析类的工作。对于Senior级别的程序员来说，虽然可替代性不是那么强，但岗位精简或许也在所难免，比如过去需要2、3个人做的事情，由于有了AI的帮助现在一个人也可以完成。而且如果行业一直保持当前这种火热度的话，在资金的支持下，技术的进步速度可能会比我们想象的还要更快，很有可能10年之后，已经不存在所谓的Junior程序员了，你的水平至少要达到如今的Senior以上才能进入这个行业。ChatGTP或其他人工智能工具不会直接取代程序员，但未来那些能够熟练使人工智能工具的程序员可能会取代其他程序员。我之前看到一张图觉得很形象，就是说ChatGPT就像是出现了一个挖掘机来代替铲子一样，仍然需要人来执行挖土这个过程，但对挖土的人提出了更高的要求，他需要去学习如何操作挖掘机，而那些只能做体力劳动的人就会被淘汰。ChatGPT也是一样的，它的出现不是要淘汰程序员，而是对程序员提出了新的要求。虽然现在看起来好像通过描述就能让一个技术小白生成专业的代码了，但对于这些代码你不可能照单全收，至少需要具备判别ChatGPT返回答案正确性的能力，也就是说当你不具备一定的技术能力，你也绝不可能做出超出你能力范围以外的创新。但在同一技能水平上，能够善用AI的技术人员肯定会比其他人更有效率、更有优势。我自己在用ChatGPT之后，觉得目前至少自己应该提升是学会如何提问题的能力，把你想要解决的问题描述的越清楚，AI能返回给你的答案就越准确。另外就是在系统设计、与人交流沟通这些人工智能比较难替代的部分培养核心竞争力。
目前我自己的想法还是继续投投简历，把ChatGPT作为一种学习工具。ChatGPT现在就像是我的一个老师一样，我可以从它给出的答案中去开启思路，同时也能减少大量过去我在网上去提问和搜索答案的时间。令人惊叹的ChatGPT，只不过是AI初生儿，就近乎无所不能。等它进一步成长，必然会对劳动力市场造成天翻地覆的变化。届时，绝大部分人，会不会成为没有任何经济价值的“无用阶层”？
每次科技进步都会迅速淘汰一批人——而它对人类社会产生的收益，往往要在一代人以后，才能显现。当然，至少以后来者的视角，科技进步的结果，总是好的。在全民步入中产阶级的背景下，60年代的美国，贫富差距达到历史最低值，黑人平权、嬉皮士等社会运动风起云涌。
从结果来看，虽然控制住了失业率，却无法保住注定成为“代价”的那批人。随着各种机器的自动化程度迈入了新台阶，作为美国社会中流砥柱的大批蓝领（大部分是机器操作员），重要性越来越低。反之，受过大学教育的白领阶层，更受就业市场青睐；同时，美国的教育系统，并没有将更多人培养成适应新时代的高技术员工。造成的结果，是低收入、高收入群体越来越大，只有中产阶级越发弱小，加速了阶层分化，从而导致美国今天的社会危机。
那么，即将开始，或者说已经开始的工业4.0——智能化变革，是哪种类型？很遗憾，大部分AI技术，都是“劳动替代型”。
尽管ChatGPT的“无所不能”，只表现在部分领域，但鉴于其学习、进化的速度，我们可以客观和确定地说：人工智能，已经并将深远地改变我们的生活。就目前而言，AI对各行各业的改变，可以概括为两方面：定制化和自动化。未来，随着人工智能、物联网进一步发展，所有人的业余生活将更加丰富，看到的、听到的也更加复合自己的心意。带来的结果，必然是大型媒体越来越难做，互联网内容更加碎片化、去中心化，从而进入Web3.0时代，我们可以简单将之看作进化版抖音。前三次工业革命，已经让绝大部分手工生产实现了流水化生产。而AI带来的，是决策自动化。总体估算，现代社会将有47%的职业被自动化机器取代，主要是低收入、低技术职业。比如在英国，过去50年里，没有大学学历的劳工实际收入并无增长。而最富有的1%人口，收入翻了3倍。在即将到来的人工智能时代中，这种两极分化的趋势，很可能继续维持。哈佛经济学教授劳伦斯·卡茨的观点：只有教育水平超过科技进步对职业的需求，将更多人训练成高技术人才，他们才有工作可做，从而使劳工阶层变得富裕。
毫无疑问，科技的进步，必然有利于人类社会的整体发展。只是在这个过程中，必须要有一部分上个时代的残留品，为之牺牲。话虽如此，肯定没人想被牺牲的。那么，在人工智能高度发展的未来，那些不容易被取代的职业，又有哪些特征？或者说，人类继续存在的意义在哪里？即便AI再进化几个时代，它所能带给我们的，也只会是更多的快感和便利，而不是真正的“意义”。
简而言之，未来最稀缺的东西，是意义，不是效率。这份意义感，是人区别于机器，作为个体存在最后的证明。珍惜你的独特性，它将是你在未来闪耀的最强武器。假如你创造出的东西能够让一部分人感觉到，它是不可替代的，这段时间没有白白浪费。那你就是人生赢家。当然，万事万物都是与时俱进的。无论如何，AI会渗透到所有人的工作中，未来的世界，一定是人机共生的。显然，除了最危险的情况，其他三种，人类都是不可或缺的角色。而随着人与AI的合作逐渐加深，必然会催生出越来越多新的职业。
归根结底，从商业的角度而言，ChatGPT是巨大的机遇；但从生产的角度而言，AI始终是是工具的一种。工具，要为人服务。至少在目前，相比起敌视AI，不如抢先学会怎么利用它。在AI卷死人类之前，那些擅长工具的人，就会利用工具带来的效率，把不肯用工具的人先卷出局。不要做最先出局的那批人。当某种科技创新足够解放大批劳动力，但这些劳动力还没有得到合理安置的情况下，就草率投入应用，需要付出的代价，或许远远不是些许经济数据，就能衡量的。等到技术真正成熟，人类能完全享受技术带来的便利时，或许是下一代的事情了。
一方面，我们要意识到人的独特价值，就像有些工作需要与生俱来的人类素质，例如建立关系、创造力和情商。
另一方面，我们要向前看，与其焦虑，不如花更多时间了解 AI，让它在职场起作用，而不被自己的想象吓到。
贝内迪克特的《技术陷阱》或许能够解惑。本书提出的一个主要观点是，技术进步的本质是创造性毁灭。也就是说，长期来看，新技术会让所有人受益，最贫困的家庭也能够保持一定的生活水平。但是短期之内，部分劳动者将被时代抛下，失业或收入减少，陷入“技术陷阱”之中。
历史的沙落在人的身上便是一座山，所谓的短期，可能就是人的一生。
但在机械化后期，工厂出现了更复杂的机器，工人也需要懂更多的技术，技术变革从取代性变成使能性，技术工人的议价能力因此提高了，劳动者的整体收入也提高了。乐观地说，刚刚开启的 AI 革命，整体可能更偏向于“使能技术”，而不是“取代技术”。
因为 AI 还不够完美，它暂时也不需要完美，只是为某些工作流程节省时间，门槛依然存在，并不是傻瓜式操作就可以达到理想效果。就像让 AI 帮忙写稿，它可能无法直接生成惊才绝艳的稿件，但它可以帮我们完善大纲和草稿，也可以做我们的第一个读者给出反馈意见。但“使能技术”也足以让一部分人被替代了。先别急着灰心，焦虑的可不只是我们。陆奇还提出了一个有趣的基本假设，码农成本会降低，但对码农的需求会大量增加，码农不必太担心，因为我们需要软件，软件永远可以解决更多问题，当软件便宜了，买的人也就多了。总之，每个行业都会有结构性影响、系统性重组，但仍会留下机会。我们能够做的是学习如何与技术共处，将 AI 视为一种资源而不是威胁。
当有人因为 AI 愁云惨淡，也有人坚信着“长板理论”：AI 不会取代你，而是扩展你所能提供的最有价值的东西。
在深思熟虑之后，他决定调整技能，好好开发剩下的 10%。现在，借助 ChatGPT 等 AI 工具，Kent Beck 可以自动执行日常任务，并将精力集中在更需要专业知识和创造力的领域。
首先，ChatGPT 很适合在头脑风暴的时候给出备选方案、分析和理解复杂的代码库等等。其次，Kent Beck 自认为也有 ChatGPT 无法替代的部分：创造力、专业知识和批判性思维。在他看来，最成功的软件开发项目，应该是由人类创造力和专业知识相结合，并使用 ChatGPT 等工具驱动的项目。
我们无需打败 AI，但仍然可以找到属于我们的那个位置。不过，麦克卢汉有言，“用后视镜看现在，倒退着走向未来”，我们永远都在用“过去”的标准认识“现在”。且行且看，面对不可名状之物，至少不要因为焦虑而原地踏步。

2023-6-9 周五
突然发现KYMAB AERO-tracker 有问题， 
Jessie 告诉了我解决此问题的办法，如下：
1.点击BTI 桌面顶部的Ctrl_Alt_Del =>end task of EXCEL
	2. Open new excel. File->More->Options->Trust Center->Trust Center Settings->left column: Trusted Documents->Clear->OK

2023-6-21 周三
早晨发现ACER显示器不能显示电脑上的内容，包括one note和Edge网页，刚开始怀疑是显示器坏掉了，反复插拔电源线接口和HDMI接口，打开和关掉电源键，都不能解决问题。于是，换上了另一个Acer显示器，同样的问题。于是，可以推断很大可能不是显示器的问题而是电脑的问题，于是开始存Edge上打开的PDF文件，关掉各种应用，重启，发现不能显示的问题解决了。然后又发现用Ctrix space登录BTI时又不行，点那个图标或点击Start都运转一会儿就停下来了，用右上角的下拉菜单refresh,也fail了。后来尝试右下角的上拉菜单，点地球图标->Best available, 然后再run citrix workspace, 问题得到完美解决。以后遇到类似问题照此办理。
Online: Smart-Choice Accounts at https://benefits.thermofisher.com 

Phone: 8:00 a.m. to 8:00 p.m., Eastern Time, Monday through Friday 1-833-423-6387 

2023-10-9 Monday
想进入BTI, 发现没有连上ClobalProtect, 点击那个地球ICON, 电脑页面弹出要求输入开机登陆密码，输入后，弹出页面给了俩位数的密码，同时手机的Authenticator App 启动，输入这个两位数，结果出现报错：

再次点击地球ICON, 选US Eastern, connect, 结果就成功连接上了，如下：

不知为何总是报错。

2024-4-3
我Review Den301 Part4 DBL 的TLF， 发现没有check out Part4 DBL文件夹到我的USER area, 导致还是用的以前的ADFIA VERSION,以后一定要注意检查是否用的是正确的adb dataset, 这是一个需要牢记的教训。

2024-04-05 周五
今天突然发现连不上BTI， 后来找IT的人，点restart后就可以了，以后一定牢记就此应对。
2023-4-5 Wednesday
闻三舅家两孙子有严重抑郁症，从三舅的种种行为来看，其有非常明显的精神病迹象，我的母系是带有精神病相关基因，在老妈身上也有明显体现，愚蠢和易怒，头脑简单，学习能力极其低下，为人处世能力也很低下。父系这边好像没有精神病基因，但又有很多重大慢性疾病基因，总之，我的遗传背景非常不好，这也是这些年来一直困顿没有出息的一个基础性的原因，一定要充分认识到这个不可改变的背景，主动和这种精神疾病做斗争，这个是可以发挥一定的主观能动性的，采用各种方法，如做计划，心里有点谱，就不会那么焦虑，就不会经常拖延，造成精神上的压力。要善于给自己解压，放过自己，我这么差的遗传背景，只能尽力而为了，能进步一点算一点。
看手机浪费了许多的时间，是我失败的一个重要原因。另外一个就是不专注：
挖一米见方的坑，挖一百米深，你就成功了。做事业绝对不能贪大求全，什么都想做，什么都做不好，浅尝辄止，试一试很快就放弃了，这样的人是很难有所作为的。要想成功，瞄准一个领域，深耕几年，必定能成为这个领域的专家，你就成功了。这就像挖坑一样，不要东挖一个西挖一个，一米见方一直往下挖，挖一百米深，地下水就会源源不断冒出来。有一项研究表明，如果你每天花10分钟去研究一个领域的东西，三年以后在这个领域你就能比90%的人都懂。现在如果你花3年时间每天都在某一个领域研究，3年后的你，一定会让人望尘莫及。集中精力，专注于做一件事情，事业必定能够反败为胜。
ZY感想: 我其实是吃了做事不专注的大亏，如果我做研究的那些年能够认真钻研基因治疗，就一定能搞出有价值的研究成功，不至于后来被迫改行，我现在为以前的得过且过，浪费时光而深深地自责，来美国这么多年，英语也还是这个臭水平，下的功夫太少了。在Verasci三年，浪费了多少宝贵的时间，以前种种，我恨不得给自己打几个大嘴巴，抽醒一直在混日子的我。我的大脑不能理性地思考问题，不能克制自己的冲动，特别是看手机，那是一种逃避现实以获得暂时麻醉的可悲的手段。我必须反省自己，努力对抗这些恶习，用行动来克制自己，珍惜已然不多的时光，我已经50岁了，各方面都走下坡路了。我现在一边后悔而又一边走和以往同样的道路，这样一点意义也没有。我必须对自己要狠才行，这才是打破这个恶习惯性的有效手段。如何狠呢： 1. 长时间做工作相关的重要事情，比如，很专心地写程序4个小时，每个小时休息10分钟。连续4个小时写作，尽量写得好一点。晚上抽出时间看书，至少看2小时。抽空背一些公式，想一些与工作相关的事情，把这些思想火花记录下来，凡事问凡事多总结。把自己的本职工作做好才是最重要的，我既然已经改行了，那就是抛弃了以前的基因治疗领域，就不要再留恋了，我不可能再回去做基因治疗相关的研究了，这条心必须要死了，有兴趣可以去看看药物开发的相关新闻，我还是要走生物统计师的道路，努力提高自己的理论和实际操作水平，哪怕最后只能做到Principal统计师，只要能称职，成为一个优秀的统计师，那我也就满意了。我这个年龄已经非常尴尬了，体力精力都不行了，学习能力下降了，总结这半生，之前的二十年让我痛悔，这也许与我的劣质遗传基因有关。但我没有足够地主观努力，也是一个重要的原因。现在到了痛改前非的时候了。我其实根本就不应该关心国际新闻国家大事，周末关心一下就足够了。现在一定要优先专注于把工作做好，这才是安身立命的根本，不然以后的日子会更难过，在家庭里面也会是被老婆孩子看不起，整个人就是一副无精打采毫无进取心，让人一看生厌弃。我根本没有管理人和当官的才能，这是我的能力禀赋所决定了的，不服气都不行。我老爸就是一事无成，我身上有他非常明显的特质，不钻研，不努力，经常拖延，毫无进取心，我那老妈更是不行。我家的姐妹也都非常缺乏领导才能，不得不相信遗传的力量。我曾经能够努力考上中专大学，说明我在高度集中精力于一个重要目标上时，还是能把一件事情做成的，这一点一定要自信。如果完全丧失自信，那么我这一辈子就真的彻底完蛋了，现在就是我以后十年的样子。我现在就是要努力抽空学习临床试验相关的知识和技能，让自己成为这个小领域的水平比较高的人。其实那些统计专业博士毕业的人，也就是数学基础好一些，理解得比较透彻，临床试验的东西，他们也不一定就那么超越常人，不要迷信他们。我年纪大了，要承认这个现实，接受自己就是非常努力地学习也赶不上别人，但努力总比不努力好，我若不努力，也许工作都保不住，婚姻都保不住，这样一个失败者让人看不起，自己都看不起自己。我还能再工作至少10年，如果我能在两年后晋升为Senior II, 再努力奋斗两年，争取把自己提升为principal I, 要获得职位提升，就一定要把工作做好，尽量让合作的人满意。这样才能有资格和Lyon提晋升的事情。有真本事的话，我完全可以在几年后去小药厂工作，特别是基因治疗或生物药相关的初创公司，这是我的一个比较好的出路，甚至可以考虑进入中国的生物药企工作。我其实还是有很好的机会的，让我在退休前还能奋斗一把，不至于带着遗憾和悔恨离开这个世界。在PPD，我有很好的学习机会，要弄清楚他们是如何管理的，尽量从中学习。最要紧的是把任务高质量完成，不断总结，不断提高。这是我的最好出路。只有奋斗，才能保证我已经非常脆弱的自尊心，维持住这个家庭。虽然没有成就，但只要学习态度和工作态度还行，人家也不至于抛弃，两个儿子也会给与一丝尊重。到了给儿子树立良好榜样的时候了。拼命学英语，再也不要给自己找借口了。承认自己的落后地位，虚心向那些强者学习，一种到死。晚上学习，远离手机新闻。

2023-10-17  Tuesday
今日与Lyon开一对一会议，就时间安排交谈，气氛不舒服，这就是职场， 同事之间，上下级之间仅仅就是个工作关系，哪天离开公司了，就是路人而已，何必为那些说话的语气而不高兴。但确实需要总结自己在工作中出现的失误和种种不足，努力加以针对性的改正，提高自己的工作效率和质量。把Lyon作为一个资源，有不懂的地方或需要咨询的事情，就向他求助，他也就是个打工的，这是其职责所在，他是有责任管的。今天开会，他竟然写了个备忘录如下：
Hi Zhenhua,
 
Thanks for joining our weekly call. This is to summarize what we have discussed. Please let me know if you have any questions.
 
	· Please monitor your workload by reviewing your hours in clarity, for current month and future months, regularly and escalate to leads ahead of time if hours are not accurate or resourcing completing.
	· Escalate to line manager if you have confirmed availability in the future month with detailed information of your availability.
	· If you have unexpected availability please first check on your other study activities and see if anything can be worked on during this time. If no other study activities can be worked on, please escalate to line manager ahead of time with the detailed information of your availability. 
	· Utilization target for individual contributor is 86%, fully booked staff is expected to meet the utilization target for the given month. 
	· Time card hours should be accurately billed to reflect the hours spend on each task. 
 
Thanks,
 
· 请定期通过查看您在Clarity系统中的工时，监控您的工作量，包括本月和未来几个月，并且如果工时不准确或资源分配有问题，请提前向负责人汇报。

· 如果您已确认在未来月份里有空闲时间，请将详细的可用时间信息升级至直线经理处。
· 如果您有意外的空闲时间，请首先检查您是否有其他研究活动可以处理。如果没有其他研究活动可用，请提前将详细的可用时间信息升级至直线经理处。
· 个人贡献者的利用率目标为86%，已满复合工作的员工应该在给定月份达到利用率目标。
· 时间卡上的工时应准确计时，以反映每项任务所花费的时间。


我用Chatgpt生成的回信：
Thank you for summarizing our discussion from the weekly call. I appreciate the clarity on the expectations and guidelines for workload management. I have noted the points discussed and will adhere to the outlined procedures. If I have any questions or need further clarification in the future, I will not hesitate to reach out.
I understand the importance of monitoring my workload in Clarity, ensuring accurate time card hours, and meeting the utilization target of 86%. Rest assured, I will diligently review my hours in Clarity for both the current month and future months, and I will escalate to the leads or my line manager ahead of time if there are any discrepancies or resourcing conflicts.
Additionally, I will follow the protocol of checking for unexpected availability and exploring other study activities before escalating to my line manager. I am committed to accurately reflecting my hours spent on each task in the time card, and I will ensure that they are billed appropriately.
Once again, thank you for the clear guidelines. I appreciate your support and guidance in managing my workload effectively.

以后还是要多关注每个项目的timeline和Clarity, 争取少出现或不出现Lyon指出的问题，他提及这些，也是他的职责所在，我唯有努力改进，尽量把工作做得好一些。这里不是久留之地，再过几年估计都找不到地方要我了，年纪在不意之间就这么大了，现在的上级都是小我这么多岁的人。我这么多年工作不扎实，后果很严重，唯有努力纠正自己的错误，产生敌对情绪和消极情绪都是不对的。我身上的缺点一大堆，必须直面，在退休或去世之前能改进一点是一点，进步再小也是进步，总是比原地踏步或退步要好一些。每周一要看每个项目的时间分配，timeline, 制定一个自己的表格，包括与BPL的沟通，timeline里的任务截止时间点，不断优化，每周二开会前发给Lyon, 就此进行讨论。根本不需要有多完美，哪怕再粗糙和简陋，也比没有的好。每天写工作总结，分项目来写，找出存在的问题，提出解决的方法，任务是什么？做了什么？出了什么问题？如何补救？今后如何避免出现同样或类似的问题？这种工作总结要写在私人电脑上。在职场上没有人因为你家里怎样而可怜你，老板看中的是你的工作能力与工作态度，还有你给公司带来什么价值。认真工作，少管闲事，把工作做精做细，做到不容易被替代你就赢了。

2023-10-20 周五
又到了填时间的时候，这次要科学地填：
先看Clarity:

2023-11-28 周二
昨天中午和YW 吵架，气不顺影响工作，全天忙于
若真的想成为生物统计师，无论最终是去了甲方还是乙方，都不妨踏实下来跟几个项目。保持自我的稀缺性和高价值其实并不难：临床试验设计里真正成熟的生物统计师是凤毛麟角，既然踏上了这一目前尚为小众的职业就是成功了半；只要踏实积累经验，便能让职业更“高贵”一步。
而对于有工作经验、想要转行做生物统计师的求职朋友，衡量数学能力是否扎实、统计思维如何是先决条件；项目经验或许可以通过读硕+去乙方接项目“曲线救国”。不过最重要的，还是“薪酬之外的职业热情”。
“试想一下：如果有一款药，从最初的方案设计一直到成功上市造福病人，都有你的全阶段参与——这是一件多么有价值、值得骄傲的事情。”姜昕感慨道。

2022-10-26 Wednesday
遇到那本CIDISC SAS实现的书，只有不到300页，可以考虑再BTI SandBoxPhil我的work area 实现一遍，不要拷贝代码，要不辞繁琐自己敲定所有代码，以加深记忆。代码上用自己的语言注释难懂之处和自己的心得体会。只有持续地去做，总能完成，并能消化汲取书中的营养，滋养自己的知识之树。
必须从现在起，培养自己利用点滴时间阅读的习惯，哪怕是几分钟，也能看几句话，也能为自己的知识大厦加一块瓦或至少做一丁点的改进。阅读必须做笔记，哪怕是读一小段，也要写一两句心得体会。笔记是一定要回顾和阅读的，只记而不回顾复习，那就如将果实收回而不用，最后烂掉一样，没什么意义。 昨晚听那个耶鲁学姐讲学习方法，她说的三明治记忆法值得借鉴，睡前把需要记忆的适量的工作相关重要材料认真记忆一遍，然后早起后，再用自己的语言复述一遍内容，大致相符即可，不要追求一字不差，意思到了即可。一份材料可以自己先做个思维导图，一日记不住，就几天一直记那份资料，直到能复述个八九不离十。然后开始记下一份资料。
周末两天，是复习一周写的读书笔记和各类心得体会的时间，就不要再看新东西了，把手机和工作电脑里的各类笔记认真阅读一遍，重要的有价值的内容，标记一下。月末那个周末，用四天的时间温习一个月来所记的笔记。学习钟道隆先生的做事方法，把笔记内容归类，以便今后将这些杂乱无章的笔记条理化，系统化，用R语言的编书package编成一本一本的小册子，供自己今后参考，努力建设自己的知识技能库，要学习人家是如何整理笔记的。在Z library上下载名人的读书笔记，<达尔文自传>，《钱锺书读书笔记》，《毛泽东读书笔记》，参考早安英文的笔记整理方法。有个想法，我可以将早安英文的笔记保存下来，加上自己对生词的注解，再加几个例句，查找语法书把相关的语法知识点也列出来。联想到的英文知识也写在上面，每天成一篇，如因事错过，以后补上，保证不缺漏，一年至少有300篇，结集后就是一本自己的英文学习笔记，今后可以反复阅读，成为自己知识库中有用的组成部分。用手机，平板或电脑学英文，也要一边读一边做电子笔记，周末时归类整理，积累到一定程度，归拢起来编成自己的一本小册子，取个书名，编个目录即可。现在尤其需要积累工作相关的笔记，笔记上应该时摘录的要点，加上自己的理解，心得和总结，成为自己以后工作参考的指南。以后做项目，要把Protocol和SAP搞得很熟，把要点和自己的理解写成笔记，不断丰富，反复记忆，一段时间后就会对这个项目有比较全面的了解，同时把工作过程中遇到的难点和可能的解决办法，实际采取的解决策略都记录下来，总结这么做的得失，有没有更好的解决方案，教训是什么？ 从今日起，周末要把主要精力用来复习笔记，尽量消化已经记入笔记中的知识，成为滋养自己的养分。。

20222-11-03 Thursday
下午在室内来回走，又是满脑子想着怎么搞塑料暖棚。突然想起，如果我也能这样投入地想着项目的方法面面，并把各种想法记录下来，不管是可行的还是不可行的，加上不断地看书看网络资料，向别人请教，这样我就会对项目有全面深刻的了解，更可能想出高效做事的方法，并显著提高自己的工作质量，这样的人生才是有意义的，我以往干不好本职工作，论文发表记录很差，也就找不到好工作，也没有晋升的机会，这几十年经历了很多的挫折，究其根本原因，就是因为没有全身心地投入到工作中去。干好工作，其实就是为了自己，是活在这个世界上的谋生手段和自我价值实现的最重要的方式。
学习数学，数据分析，人工智能等知识和技能，非常有意思，这是投入自己业余时间并乐在其中的好方向。我小时候想做土枪，首先要觉得这个事情非常有意思，不时观想制作的过程以及制作成功后使用并为别的小孩所赞许的情景，这样就充满了动力。兴趣就是最好的老师，催人奋进，能聚精会神地投入其中，一点也不觉得累，能体验到那种精神层面的充实感和幸福感，这种体验是人生幸福的重要组成部分。要有意识地主动地去体验，刚开始也许这种充实感并不强烈，但只要持续地去体验，积极地思考，时间长了，这种感觉就会强烈，就会觉得生活很有意思。如能在我的下半生能过上这种高质量的生活，那我就非常非常满足了。这么做，我会把工作做好，最终会成为一个称职的优秀的principal statistician, 成为临床试验领域的一个专家水平的人，但鉴于我很差的领导能力和管理能力，我不太可能在管理岗位上有什么晋升空间，这样也没关系，成为一个技术性人才也不错。一定要记得输出，要写技术性文章，挂在网络上供人阅读，哪怕读的人很少，也是对这个领域的微薄的贡献，写多了，也许水平就有所提高，读的人就会多起来，这也是人生价值的一种体现。

2023-02-22 Wednesday
最近我被分配了一些KYMAB Biomarker review TLFs的任务，需要拟定一个自用的review的操作规程：1. 先打开BIOMARKER TOC_statinf EXCEL文件, 知道这个TLF对应哪几个validated datasets, 然后打开文件"KY1005CT05 Biomarker TLF Specs" , 对照specs,逐一检查TLFs是否与其一致。 检查数字是否搞错，对于Table, 每个biomarker,每个visit,每个dataset, 检查两个数据，对得上得话，就应该每大问题。2.仔细读一遍Title, footnotes, 图表注释等，尽量找出问题。 3. 如没查出问题，就PASS.
今日完成两个Tables的review, 在onenote上做笔记。

Transcribe 语音转录 (支持长视频）
	• 如果有Youtube视频，只需要有链接，就可以生成字幕，准确率极高
https://github.com/lewangdev/autotranslate
	• AI字幕已经出第三代 Whisper啦，这次Whisper Jax更厉害 30秒转录一小时
https://youtube.com/shorts/gZEN_Lnji1Y
	• 新出的 Whisper Jax, 神速转录 1小时语音只需要30秒

Can you fill the col C in the attached file with the tasks you have performed on the study to the best of your memory/knowledge, like ADAM/TLF review, SAP , Shells , Blinding Plan or anything else you might have done.

20.354	BIO TLF Programming	Programming, Production and validation and packaging of tables, listings, and/or figures.  Includes delivery to client (TLFs, ADB, TOC, Cover Memo, etc.).
		
		Inferential Statistical Analysis: Generating either an inferential macro or dataset.  Communication/discussion regarding the inferential programming that would not otherwise be part of normal SAP development.  Specifications for inferential analyses should be billed to 20.094.
20.357	BIO Transfer Activities	Only use 20.357 if CDM is not in the contracted scope. 
		If the raw transfer is a planned/scheduled deliverable indicated in the budgets under the CDM Export unit then this is done by Biostat if they are scoped for CDISC SDTM and/or analysis [use code 25.357]. If Bios is not scoped then the CDM Programmer will post the raw deliverables. 
		The Data Transfer Agreement (DTA) is only done once for all transfer categories and again created and owned by the group delivering (Bios if sdtm/analisys; CDM if no Bios) [use task code 25.308] .  Analysis database transfer work as part of a deliverable should be charged to task code 20.354.
20.359	BIO TLF Review	Senior and non-Senior statistical review of tables, listings, and/or figures.

20.088	BIO Derived Datasets Programming	Activities related to programming the Analysis Database, including programming, validation, production, delivery and filing related documentation.  If Analysis Datasets are delivered along with the TLF package, charge sending of the deliverable to task code 20.354.
20.087	BIO Derived Datasets Specifications	Creation and review of analysis dataset specifications and definition of derived variables to facilitate programming of tables, listings and/or figures.
20.350	BIO Statistical Analysis Plan	All tasks related to creation, validation, review of and revisions to the SAP text and shells, or review of client-developed SAP and shells.  Also includes DSMB Charter Review.

如何写自动回复信？
Greetings, and thanks for your message! I am currently out of the office on my PTO and will be back in office on Monday,  Oct 2nd, 2023. During my OOTO, I will check my email periodically and respond for urgent needs only. If you have an immediate request, please feel free to call me at 910-386-8355, may leave your brief message, I will get back to you ASAP. Best regards and have a wonderful day! Leiya

2022-10-31 Monday
Focusing on your ongoing development and training is a priority across our organization. Continuous learning and improvement are critical to help colleagues enhance your knowledge and skills, which will also better serve our customers and patients. You can leverage this training in a just-in-time fashion – as you are assigned to a relevant study.   YZ: 动名词做主语。指出持续学习提高的重要性，对员工个人，客户与病人。此培训的特色：just-in-time fashion.
The growth of mid-sized pharma and biotech companies into rare disease research has seen a rapid expansion. For colleagues who participate in rare disease proposals or studies, this series of five   modules will provide more information on: 
•What a rare disease is
•How regulatory agencies define and assess rare disease trials
•Key operational considerations to support rare disease studies
YZ: The growth has seen a rapid expansion.以后可以借用这个句型。
To learn about the importance of diversity in clinical trials and what can be done to address the challenges that have historically led to underrepresentation among certain demographics in research, a new Patient Diversity module is available in CRG Learns. 
YZ: 这是一个长句，但结构清晰。To do 目的， 主句（something is available 来达到那个目的）
Clinical trial participants should adequately represent the real-world population of patients affected by a specific disease or condition to ensure the delivery of safe and effective interventions for everyone who will use them. 
YZ: 此句写得好，值得琢磨和学习使用。

2022-11-01 周二
Kim突然发给我一个Training assignment, 我checked 这个邮件时，培训已经开始20分钟了，登录上去后，主讲人Song Wang已经在说会议结束时的套话了。邮件里有一些链接，估计Song Wang也没有讲太多东西，靠自己点击链接去阅读这些材料。
-----Original Appointment-----
From: Kim Sturgen On Behalf Of BST-Onboarding (SM)
Sent: Monday, October 18, 2021 12:22 PM
To: BST-Onboarding (SM); Song Wang
Cc: John Peterson III; David Farkas; Renee Barbiche; Surya Kommuru
Subject: BST: Onboarding > Statistical Sciences and Statistical Training Overview
When: Tuesday, November 1, 2022 11:00 AM-11:30 AM (UTC-05:00) Eastern Time (US & Canada).
Where: Microsoft Teams Meeting
 This Statistical Science live overview is primarily for statisticians.  Although some of the topics under statistical training may be of interest to programmers as well.
 Please click on the links below to review the materials before attending the session: 
	· Statistical Science
	· Therapeutic Area Knowledge
	· Statistical Training

2022-11-04 Friday
上午11点和Lyon 一对一MS Teams meeting,录了音，会议备忘要点如下：
	1. 这个Eli Lilly的项目估计是二期，时间比较短，明年一月份准备好SAP, 好像3月份第一个病人入组，，要准备shell specs, SDTM specs, ADaM specs, ADaM TFL programs, 2023-09 the first dry run, 2023-11 the second dry run. 2024-01 DRM, Database Lock.(听录音再补正）
	2. 不知道这个项目的BTI set up 好了没有，要找人去问，特别是要问一下meiling.
	3. 关于填时间，Lyon给我指导了一遍，比较清楚： 把项目的BC number拷贝后，粘贴入"Project" 一栏，backspace一个字符，就会搜索出KYMAB项目，选取，"Service Area"一栏选“20-Bio”, "Task"一栏，如昨天开的会议，选  “20.071 - BIO Internal Meeting”; 如为自己阅读protocol 和 SAP, 可选“20.049-BIO Project-specific training”, 然后填入每天的时间。其他时间，继续填“000001-60_NONB_ZZ_Administrative”-> "99" -> "99.925 - Training"->"Regular US". 与Lyon 一对一的会议，“000001-61_NONB_ZZ_Performance Management”-> "99" ->"99.900 - General"->"Regular US" ; 填入时间，保证每天8小时。SAVE -> Next s-> Submit。
	4. Lyon 分享了几个重要的链接，有大量与工作十分相关的信息，必须要抽空阅读并做笔记。
           (1) Listing of All BTI Areas-BioWiki   https://wiki.ppdi.com/BioWiki/index.php/Listing_of_All_BTI_Areas
              (2）Statistical Training - Technical  https://wiki.ppdi.com/BioWiki/index.php/Statistical_Training_-_Technical
             (3)   Statistical Training - Process  https://wiki.ppdi.com/BioWiki/index.php/Statistical_Training_-_Process
             (4). Lyon shared his Onenote - TeamSite to me via email. Very important information!

2022-11-15 Tuesday
9:30am to 10:00am I had a meeting with Aron and Alexis Vasconez, I still have problem to understand Aron's English, I need to rehear the recorded audio.  和PPD stat science expert 联系，寻求专家的帮助，about the multiple imputation and tipping point analysis. ADQS is still under development, Alexis说她那里有tipping point analysis SAS code, 要找她要才行。

10:00am to 11:00am  meet Lyon, 1. 搞清楚inferential analysis 用的是哪个approach, data set or macro, 两个approach的流程很不一样的，dataset 方法，SAS programmer 可以直接从我们的结果dataset中获得p-value用来制作表格，统计师可以不断地改进。Macro法则不然，两个统计师必须先对上，确保结果无误后SAS programmer 才能基于统计师的结果制作表格。  2. 下次会谈时performance evluation, 他已经写了个goal放在我的mosaic里了。3. 给我展示了如何用BTI Project area 里的unversioned Aero Tracker来看每个task的进展及每个dataset的状态，adb_compare那个文件能看到这个dataset是否已经validated了没有。需要自己再认真操作一遍。4. 提醒我要提前发邮件给专家，并可以找他们要SAS code。录音要再听一遍。

2022-11-17 Thursday
Kymab Weekly Bios&Prog meeting, ask the following questions:
1). The ADQS is not completed.
2). Who will perform the WOCF and derive the variables: 
"EASISA
EASISC
IGA01
SCRAD20A
SCRAD06A
POEM08A
DLQI111A
ADCTTOTA
HAD0116A
SCRAD14A
	3) Who will do the following inferential analysis?

与Lyon Li的一对一会谈纪要：录了音，可以事后会看。
关于performance evaluation,已经把评价goal 发到我的mosaic里了， 
	1. About participating meeting, presenting at meeting.
	2. Proactive action。Understand the task expectation, deadline, where is the resource, files.
	3. Build ability, it's OK to spend more time on the tasks at the beginning term at PPD. For example, Usually, a statistician is expected to finish a ADaM spec in 5h, but at the beginning , you can spend 10 hours on it. However, after you have done it for several times, you need to finish it in 5 hours, within budget goal.
	4. Understand assigned hours,时间不够用，和people manager , resource manager反映，时间有富余，也要让people manager and resource manager 知道。 通过Clarity 看自己的work load and time assainment.
	5. 及时esclate。刚开始接到任务时以为时小活，但很快发现不那么简单， 有很多问题需要解决，时间不够，这时候要尽快escalate,,不要等到最后一天或几小时才让经理知道。根据情况，把遇到的困难告知BPL, LS, SR, LP(若涉及programming)。最好先和People manager通气，商量一下看有没有必要escalate, 有没有其他更好的解决方案。有时需要加班赶截止日期很常见，但需要长期加班的话，那就要找原因，是工作量太多了，还是工作效率太低了？要寻求work life balance, 不要长期处于加班状态。
	6. Establish quality first mindset，善于使用公司提供的tools, 提高工作效率，保证工作质量，及时escalate risk, 无论是lead statistician or support statistician, 发现risk, 一定要及时escalate, =>BPL => Group lead =>PL head =>VP. 善于识别potential reisk.
	7. Maintain  good relationship with team member, master skillful communication ability, usually we are working with the colleague in a long term, actually we are fighting the same battle to strive for victory.
Self assessment,3 box to fill: a. 目标完成情况 b. Strength c. Opportunities that you could use to improve your career。
Do not write too many words, it's better to use the bulletin points to show key points.
Other team members who have cooperated with me will provide feedback, Lyon show me how to use the biowiki page to do this job. Find the people manager name=>find the person you want to provide feedback=> fill out the forms, pay attention to no.5, give suggestion and No. 6 too.  https://wiki.ppdi.com/BioWiki/index.php/Provide_Feedback
Lyon showed me how to use Clarity to track my work load and hour assignment> go to Clarity webpage => Resource => Filter 姓，名  Yuan Joshua => 点击那个小人图标 => 出来一表，显示每个月的分配时间，hard book time, actual time(collected from my timecard).只能看上个月的实际时间。My resource manager is Betha xxxx。 需要调整时间时， 与resource manager说，抄送Lyon。最好先和Lyon商量，分析一下情况看要不要找resource manager.我一月份只有40小时的富余时间，再找个任务就能达到85%的工作时间用于项目。15%的时间时拥有其他事务如培训，管理等。与项目密切相关的specific research, 所花费的时间是可以记在项目上的，general learning or research 的时间就记在nonbillable genral training 上了。
SAS EG 出问题要找IT Connect, Lyon 给我发了网页快照。Log a ticket with "ITConnect" using categoty online tools>SAS GRID Software(Not BTI Subcategory) https://wiki.ppdi.com/BioWiki/index.php/Reporting_Issues_and_Getting_Help
和Validation 方对结果，不能告诉对方CODE, 用来哪些option, 但可以讨论对SPEC的理解。
下周四周五放假，周三下午可以提前到3点下班，time card 填38小时.
Lyon 手机号；681-285-8599

2022-12-01 Thursday
8:00am 参加KYMAB project meeting, Lyon wanted me to draft the ADTTE spec, add the KM spec to the inferential specs. 要问他关于ADMI的问题，问ALEXIS 如何validate the dataset.
9:00am 参加CDSD meeting, 没太听明白。
11：00 am 与Lyon一对一交谈：1.搞明白了direct macro approach到底是怎么一回事，互相能看到对方的code, 完全靠自觉，这样不是个事情，完全可以在理解了对方的code后稍加修改就是validation code了。 2. 12月5号后，把self-review贴到mosaic上。3.告诉他我会在19，20，21休假三天，如恢复不太好，就多休。22，23 这两天要工作。26号，27号放假两天，28，29，30还是上班。4. 提醒我要如何给合作的伙伴发邮件告知他们我的休假计划，如何在calender 上设置提醒。设置自动回复邮件。他发给我一个怎么操作的邮件。 会谈录了音，备回看。

2023-4-4 Tuesday.
10:30am 与Lyon一对一会议，简要备忘录如下，
	1. Lyon checked my clarity, 我4月份有三个project to work on, 已经是Fully booked, 不需要找活了，5月份没有给我安排时间在TRENT project上，需要找Jessie说一下，等我把ADaM搞定后再和她说。Lyon 说了已经和Deepthi说了要给我找个project 来lead,就不需要我来再和她说了。
	2. 让我想有没有要在Growth上讨论的topic, 今天下午发给他，我不太想去讲。
	3. 休假后要设置自动回复邮件，并写上自己的手机号。
	4. Lyon五一期间去佛罗里达迪士尼玩，已经给他岳母买了单程机票，下周抵达。

2022-11-11 Friday
填时间表的重要信息
	• KYMAB Project:  103557-01_GCDV_NA_KYMAB_KY1005-CT05_EXC  Service Area: 20-BIO; Task:20.071 - BIO Internal Meetings; 20.049 - BIO Project-specific training; Time Type: Regular US 
	• 000001-60_NONB_ZZ_Administrative   Service Area: 99;  Task:99.925 - Training;  Time Type: Regular US
	• 000001-61_NONB_ZZ_Performance Management  Service Area: 99 ;Task: 99.900 - General; Time Type: Regular US
	• ELI LILLY project: 116083-02_GCDV_NA_ELILILL_J2N-MC-KLAA_EXC
	• Sanofi Trent project: 106176-01_GCDV_NA_SANOFI_LPS17007_EXC
	• 063565-01_GCDV_NA_ARRAY_MEK162 2110_EXC
	• Meiling new project Sanofi Soliswitch: 104881-01_GCDV_NA_SANOFI_LPS17008_EXC
	• Takeda project: 058367-01_GCDV_NA_TAKEDA_DEN-301_EXC  contact person: Joy Wu
	• Lilly GPIL project: 117065-01_GCDV_NA_ELILILL_I8F-MC-GPIL_EXC
	• Takeda project:105039-01 (105039-01_GCDV_NA_TAKEDA_TAK-079-1006-IGAN_EXC) contact person: Palpasa Manandhar 
	• Celgene Corporation project: 030 112752-01(112752-01_GCDV_NA_CELGENE_IM047-030_EXC)
	• Takeda Pharmaceuticals International ITP 91761-01 (091761-01_GCDV_NA_MILLENN_TAK-079-1004_EXC)
	• Takeda Pharmaceuticals International 303 90335-01   DEN-303
	• GSK219075  116177-01
	• Shionog Obesity: 117331-01_GCDV_NA_SHIONOG_2201N1121

	• Internal meeting should be charged as 
	1	117065-01_GCDV_NA_ELILILL_I8F-MC-GPIL_EXC	20-BIO	20.009 - BIO Project Management
	
		Project	Service Area	Task	Time Type	Days						
					Mon,Nov 14	Tue,Nov 15	Wed,Nov 16	Thu,Nov 17	Fri,Nov 18	Sat,Nov 19	Sun,Nov 20
					Quantity	Quantity	Quantity	Quantity	Quantity	Quantity	Quantity
	103557-01_GCDV_NA_KYMAB_KY1005-CT05_EXC	20-BIO	20.071 - BIO Internal Meetings	Regular US		0.50		1.00			
	103557-01_GCDV_NA_KYMAB_KY1005-CT05_EXC	20-BIO	20.049 - BIO Project-specific training	Regular US	1.00				1.00		
	000001-61_NONB_ZZ_Performance Management	99	99.900 - General	Regular US		1.00		1.00			
	000001-60_NONB_ZZ_Administrative	99	99.925 - Training	Regular US	7.00	6.50	8.00	6.00	7.00		
	
	Project	Service Area	Task	Time Type	Days								
					Mon,May 08	Tue,May 09	Wed,May 10	Thu,May 11	Fri,May 12	Sat,May 13	Sun,May 14	Comments	Time Entry Total Hours
					Quantity	Quantity	Quantity	Quantity	Quantity	Quantity	Quantity		
	103557-01_GCDV_NA_KYMAB_KY1005-CT05_EXC	20-BIO	20.354 - BIO TLF Programming	Regular US	4.00	2.00	2.00						8.00
	116083-02_GCDV_NA_ELILILL_J2N-MC-KLAA_EXC	20-BIO	20.350 - BIO Statistical Analysis Plan	Regular US			2.00	3.00	3.00				8.00
	106176-01_GCDV_NA_SANOFI_LPS17007_EXC	20-BIO	20.087 - BIO Derived Datasets Specifications	Regular US	1.00	4.00	3.00	1.00					9.00
	104881-01_GCDV_NA_SANOFI_LPS17008_EXC	20-BIO	20.071 - BIO Internal Meetings	Regular US				0.50					0.50
	058367-01_GCDV_NA_TAKEDA_DEN-301_EXC	20-BIO	20.071 - BIO Internal Meetings	Regular US					1.50				1.50
	058367-01_GCDV_NA_TAKEDA_DEN-301_EXC	20-BIO	20.049 - BIO Project-specific training	Regular US				3.50	3.50				7.00
	000001-61_NONB_ZZ_Performance Management	99	99.900 - General	Regular US		0.50							0.50
	000001-60_NONB_ZZ_Administrative	99	99.900 - General	Regular US	3.00	1.50	1.00						5.50
	
	116083-02_GCDV_NA_ELILILL_J2N-MC-KLAA_EXC

	

20.354	BIO TLF Programming	Programming, Production and validation and packaging of tables, listings, and/or figures.  Includes delivery to client (TLFs, ADB, TOC, Cover Memo, etc.).
		
		Inferential Statistical Analysis: Generating either an inferential macro or dataset.  Communication/discussion regarding the inferential programming that would not otherwise be part of normal SAP development.  Specifications for inferential analyses should be billed to 20.094.
20.357	BIO Transfer Activities	Only use 20.357 if CDM is not in the contracted scope. 
		If the raw transfer is a planned/scheduled deliverable indicated in the budgets under the CDM Export unit then this is done by Biostat if they are scoped for CDISC SDTM and/or analysis [use code 25.357]. If Bios is not scoped then the CDM Programmer will post the raw deliverables. 
		The Data Transfer Agreement (DTA) is only done once for all transfer categories and again created and owned by the group delivering (Bios if sdtm/analisys; CDM if no Bios) [use task code 25.308] .  Analysis database transfer work as part of a deliverable should be charged to task code 20.354.
20.359	BIO TLF Review	Senior and non-Senior statistical review of tables, listings, and/or figures.

20.088	BIO Derived Datasets Programming	Activities related to programming the Analysis Database, including programming, validation, production, delivery and filing related documentation.  If Analysis Datasets are delivered along with the TLF package, charge sending of the deliverable to task code 20.354.
20.087	BIO Derived Datasets Specifications	Creation and review of analysis dataset specifications and definition of derived variables to facilitate programming of tables, listings and/or figures.
20.350	BIO Statistical Analysis Plan	All tasks related to creation, validation, review of and revisions to the SAP text and shells, or review of client-developed SAP and shells.  Also includes DSMB Charter Review.

Mosaic Task Code	Mosaic Task name	Task Description
20.001	BIO Protocol Design and Review	Protocol review and incorporation of comments at study start-up.  Does not include review by staff added to the study after start-up or not involved in the study team review of the document (hours related to this should be billed to project-specific training).  The Biostatistician may write or edit the protocol, or protocol amendments.  Includes sample-size calculations.   
		  
20.003	BIO CRF Review/Design	Review of CRF, eCRF, and/or RDC screens during study start-up for appropriate programming variables and consistency.  This code is used only by staff approving or involved in the initial review. (Individuals added later to the team, should charge to project-specific training).
20.009	BIO Project Management	Includes internal and client communications outside of regularly scheduled meetings, (where not task specific, e.g., SAP changes) timeline management, resource management, risk management, scope and budget review, BVA updates, out-of-scope estimates and contract modifications, Clarity unit grid and team tab updates, BTI set-up and maintenance, updates to electronic project master file/eTMF, etc.  This also includes project handoff activities due to transition from one lead/site to another.
20.049	BIO Project-specific training	Study-related training including therapeutic and indication training.  Also includes protocol, SAP, CRF, aCRF/DST and DVM review for staff not assigned at study start-up or not involved in the initial review of these documents.
20.051	BIO Travel for Meetings/Training	Travel to and from an off-site study-related meeting and/or training.
20.060	BIO Final Report	Preparation, review and validation of interim and/or final CSR. Also includes set-up, programming and validation of programmed narratives for medical writing.
20.061	BIO Data Import Setup	Includes meetings with external vendors to identify import processes and specifications, development of the import agreement, specifications, programming/validation of the test and production imports, and filing related documentation.  Includes any modifications required after production
		Use the 20.061 for unblinded imports captured in the bios budget.  For bios and programming support of CDM import tasks, bill to 25.061.  
20.071	BIO Internal Meetings	Includes preparation, attendance and follow-up for cross-functional and departmental study-specific internal team meetings and teleconferences. 
20.086	BIO Data Validation Manual	Review ofDVM at start-up and after DVM updates. 
20.087	BIO Derived Datasets Specifications	Creation and review of analysis dataset specifications and definition of derived variables to facilitate programming of tables, listings and/or figures.
20.088	BIO Derived Datasets Programming	Activities related to programming the Analysis Database, including programming, validation, production, delivery and filing related documentation.  If Analysis Datasets are delivered along with the TLF package, charge sending of the deliverable to task code 20.354.
20.094	BIO TLF Specifications	Creation and/or review of TLF specifications.  Specifications for inferential analyses including the inferential macro or dataset and accompanying TLFs.
20.096	BIO Consulting	Provision of consultancy services to Client. General advising on approaches and methods of solving statistical analysis problems by a statistician or other individual not on the project team. 
20.102	BIO Client Meetings	Time spent in meetings/teleconferences with the client.  Kick-off meetings, virtual and face-to-face meetings.  If applicable, also includes time for DSMB meetings including time for preparation, materials review, travel, attendance and follow-up.  Note, time spent by the blinded/unblinded teams to develop and run ADB and TLFs to support the DSMB should still be coded to applicable ADB and TLF task codes. 
20.312	BIO Archive	Archiving of study files at the conclusion of departmental study involvement.  Filing of documentation during the course of the study should fall under the appropriate task. 
20.350	BIO Statistical Analysis Plan	All tasks related to creation, validation, review of and revisions to the SAP text and shells, or review of client-developed SAP and shells.  Also includes DSMB Charter Review.
20.354	BIO TLF Programming	Programming, Production and validation and packaging of tables, listings, and/or figures.  Includes delivery to client (TLFs, ADB, TOC, Cover Memo, etc.).
		
		Inferential Statistical Analysis: Generating either an inferential macro or dataset.  Communication/discussion regarding the inferential programming that would not otherwise be part of normal SAP development.  Specifications for inferential analyses should be billed to 20.094.
20.357	BIO Transfer Activities	Only use 20.357 if CDM is not in the contracted scope. 
		If the raw transfer is a planned/scheduled deliverable indicated in the budgets under the CDM Export unit then this is done by Biostat if they are scoped for CDISC SDTM and/or analysis [use code 25.357]. If Bios is not scoped then the CDM Programmer will post the raw deliverables. 
		The Data Transfer Agreement (DTA) is only done once for all transfer categories and again created and owned by the group delivering (Bios if sdtm/analisys; CDM if no Bios) [use task code 25.308] .  Analysis database transfer work as part of a deliverable should be charged to task code 20.354.
20.359	BIO TLF Review	Senior and non-Senior statistical review of tables, listings, and/or figures.
20.362	BIO SDTM Specifications	Start up activities including set-up, creation and review of SDTM dataset mapping specifications and patient data dashobard automation set-up, if applicable. 
20.363	BIO SDTM Programming, Production, Delivery	Programming/ validation and production of SDTM domains.  Includes running/reviewing Pinnacle21 reports and refreshing patient data dashboard if applicable.
20.401	BIO SDTM eCRT	Includes setup, creation/validation/production and delivery of SDTM DEFINE files, reformatting specifications, incorporation of client comments after each delivery, hyperlinking and bookmarking, and SDTM electronic Case Report Tabulations (eCRT) Reviewer's Guide.  
20.402	BIO ADaM eCRT	Includes setup, creation/validation/production and delivery of ADaM DEFINE files, reformatting specifications, incorporation of client comments after each delivery, hyperlinking and bookmarking, and ADaM eCRT Reviewer's Guide.  
20.405	BIO SDTM aCRF	Annotated Case Report Form (aCRF) production and validation
20.441	BIO Miscellaneous Task 1	Study specific code to be assigned, as needed, with BIOS project oversight approval
20.442	BIO Miscellaneous Task 2	Study specific code to be assigned, as needed, with BIOS project oversight approval
20.443	BIO Miscellaneous Task 3	Study specific code to be assigned, as needed, with BIOS project oversight approval
20.444	BIO Miscellaneous Task 4	Study specific code to be assigned, as needed, with BIOS project oversight approval
20.445	BIO Miscellaneous Task 5	Study specific code to be assigned, as needed, with BIOS project oversight approval
20.756	BIO Patient Randomization	Preparation/validation/review of randomization schedule and IRT specification review. All unblinding activitiesshould be charged to the associated analysis output code.
20.779	BIO QTL Setup and Planning	Working cross-functionally for identification of variables targeted for QTLs, providing justification, adding expectations and providing information on the methodology used to construct the tolerance limits
20.780	BIO QTL Dataset Development	Development effort for QTL and parameter datasets including developing the target variables for QTLs and derived statistical limits based on agreed specifications in the centralized monitoring plan and assessing raw data sources and corresponding SDTM domains to identify components required to derive variables targeted for QTLs. If SDTM is not provided, this code should also be used for development effort to generate SDTM domains needed to generate the subject level dataset needed for QTLs.
20.781	BIO QTL Production Runs	Running and validating programs to generate derived outputs supporting QTLs for review
20.782	BIO QTL Report Support	Collaboration with medical writer to help craft a narrative for QTLs in the CSR
20.910	BIO PPDPP	Patient Profiles(not PDD)setup, review and update activities.  Includes meetings with recipient (client or other) to identify processes and specifications, development of process, specifications and programming/validation of the test outputs.  Any modifications required after production are also included here.
25.37	Data Listings/Report Programming	Specify, develop, modify, program, validate, and review initial output for the Missing Page Report or Patient Data Projection Tool · Setup and modification of PVG Automated Notification Report (ANR) · Specify, develop, modify, program, validate and review initial output for ALL DM Listings (including third party vendor reconciliation listings)

Project	Service Area	Task	Time Type	Days								
				Mon,Jan 16	Tue,Jan 17	Wed,Jan 18	Thu,Jan 19	Fri,Jan 20	Sat,Jan 21	Sun,Jan 22	Comments	Time Entry Total Hours
				Quantity	Quantity	Quantity	Quantity	Quantity	Quantity	Quantity		
103557-01_GCDV_NA_KYMAB_KY1005-CT05_EXC	20-BIO	20.071 - BIO Internal Meetings	Regular US		0.50		0.50					1.00
103557-01_GCDV_NA_KYMAB_KY1005-CT05_EXC	20-BIO	20.354 - BIO TLF Programming	Regular US	6.00	4.00	5.00	4.00	4.00				23.00
103557-01_GCDV_NA_KYMAB_KY1005-CT05_EXC	20-BIO	20.359 - BIO TLF Review	Regular US	1.00	2.00	1.00	2.50	3.00				9.50
000001-61_NONB_ZZ_Performance Management	99	99.900 - General	Regular US		0.50	0.50						1.00
000001-60_NONB_ZZ_Administrative	99	99.925 - Training	Regular US	1.00	1.00	1.50	1.00	1.00				5.50

103557-01_GCDV_NA_KYMAB_KY1005-CT05_EXC	20-BIO	20.071 - BIO Internal Meetings	Regular US
106176-01_GCDV_NA_SANOFI_LPS17007_EXC	20-BIO	20.071 - BIO Internal Meetings	Regular US
103557-01_GCDV_NA_KYMAB_KY1005-CT05_EXC	20-BIO	20.354 - BIO TLF Programming	Regular US
103557-01_GCDV_NA_KYMAB_KY1005-CT05_EXC	20-BIO	20.359 - BIO TLF Review	Regular US
106176-01_GCDV_NA_SANOFI_LPS17007_EXC	20-BIO	20.087 - BIO Derived Datasets Specifications	Regular US
000001-60_NONB_ZZ_Administrative	99	99.900 - General	Regular US
000001-61_NONB_ZZ_Performance Management	99	99.900 - General	Regular US
063565-01_GCDV_NA_ARRAY_MEK162 2110_EXC	20-BIO	20.354 - BIO TLF Programming	Regular US


My SAS EG have problem to scroll down the dataset. They helped me solve the problem by using the libname , then open the dataset in the library. SAS universal viewer, I cannot remember how they solved the problem of not starting, next time, I need to take a note, I can trust my memory anymore. Find the dataset, right click and open with SAS Universal Viewer, can open the dataset.

What's my SAS studio user ID and password?

SAS EG log in: 
User:   americas\yuanz  Password: Yzle2010!   
2022-11-28 can not log in using the above password, weird. The warning message says "user id or password is invalid". Need to find somebody to fix it. Then changed to Yzle201005!

STUDYID	USUBJID	IMPMOD	IMPMODN	DELTA 	P	AVISIT	AVISITN	PARAM	PARAMCD	DTYPE	IMPNUM	AVAL	BASE	CHG	PCHG

2022-11-29 Tuesday
昨天突然发现我登录不了SAS Server, 吃了晚饭后又发现连电脑也登录不进去了，尝试多次，直到看到警告再尝试输入密码就要锁定账户了。今早来公司IT，一个老头Steve Futrell帮我解决了问题，说我昨天修改了账户密码，可我根本就没有修改，又说可能是密码过期了，可我的密码还不到三个月，他也不知道到底出了什么问题，为何密码会突然失效。我重设了密码：Yzle201005!  发现BTI 还是连不上SAS server, 后来Steve打电话问了别人，说要再BTI 重新设置密码，如下：
From the VPN Desktop: Start =>CMD=> C:\WINDOWS\system32> lspasswd =》Please enter user AMERICAS\yuanz's LSF Password: Yzle201005! => Confirm by reenter ther password
以后每次更改密码后都要在BTI 重新设置密码，不然用不了SAS EG.      Steve建议我以后遇到这种开不了机，登录不进电脑时，最好还是带着电脑来公司，这样解决问题会快很多。
2023-02-27 I changed my password, and could not access to SAS server, I did not remember this note, so, I wasted several hours waiting for the IT. 下次一定要牢记！！！
Your password has been saved in LSF.
LSF will use this password for starting your jobs.
If you change your Windows password, you must run lspasswd to update LSF.
2023-6-1 改了密码后又遇到上述情况，这次还算是突然想起来了，找到了这个解决方案。
2023-11-27 Changed password, found that the SAS94 server could not be connected, failed to think about this issue again, why so dumb. Need to remember very clearly.

登录SAS Studio:    yuanz-> Yzle201005!  User is Zhenhua Yuan,以后可以尝试使用这个工具。以后在解决了技术问题后，一定要写一个类似今天写的备忘录，记忆在衰退，好记性不如烂笔头，不得不要用这个方法。

2023-01-03 Tuesday  突然发现又登录不了SAS9.4 Server, 试了好几次都不行，后来disconnect, 再登录，还是不行， 后来重新用Citrix workspace登录，再输入Yzle201005!, 能成功登录SAS server了，很奇怪。



2022-12-06 Tuesday

Hi all, 

This is just a reminder/update about upcoming holiday PTO.
pI will take off next Friday, Dec 16th and then Friday, Dec 23rd – Monday, Jan 2nd (PPD holiday). 
During this time, I will serve as my own backup where needed for the studies below:
•	Sanofi LPS17007
•	Pfizer MEK2110
•	Sanofi KYMAB CT1005 –
•	Between Dec 28-30 you can also contact Zhenhua Yuan for issues related to the biomarker analysis

Thanks,
Jessie 

How to set up PTO notice:
To add your PTO to the ‘RS RTP Bios PTO’ calendar do the following:

1)	From your  Outlook calendar double click the start date of your PTO to bring up a meeting.
2)	Make the subject of the meeting your name or “your name – PTO”
3)	Check the All day Event box
4)	Set the start end dates
5)	Set the “Show As” to free time
6)	Turn off any reminder
7)	Go to the Scheduling assistant page
8)	Add “RS RTP BIOS PTO” as one of the attendees. Be sure it is marked as a “Resource (Room or Equipment)”. Icon is a green circle with house in it.
9)	Add any other people you would like to receive the notification.
10)	Hit send
\
My own template:

Hi all,

I'm leaving for vacation from Dec. 19 to Dec. 23. I will return to work on [Return date].

I've discussed this issue with my manager Lyon Li who accepted my request.  Jessie Fussell will be my replacement for issues related to Sanofi KYMAB CT1005 project biomarker study when I am gone. Also, please contact Aron Anton for issues related to the main study of this project. 
Let me know your thoughts on this.

Thanks,
Zhenhua Yuan


What I shall do for year end performance:
All Tasks
	Worker Self-Evaluation
	Manager Evaluation of Workers
	Share Performance Document
	Provide Final Feedback

Out of office
Thank you for your email. I am currently out of the office and will return to work Thursday, 15th December. I will have intermittent access to emails so there may be a delay in responding to your message. For urgent matters, please reach out to alternative study leads.Kind Regards,Yichun

2022-12-09  Friday
从SAS 演义作者谷鸿秋的微信群里的到一个人工智能搜统计知识的网站，非常强大，不禁感慨人类的智慧，一定要多加利用。
https://chat.openai.com/chat   yzly2004@gmail.com -> Yzle2010!

使用Wordvice AI Proofreader来辅  助英文写作，我现在急需这种服务，我的写作水平实在是太差了。
https://wordvice.ai/demo  yzly2004@gmail.com->Yzle2010!
https://wordvice.ai/account/profile  yzly2004@gmail.com->Yzle2010!
https://www.grammarly.com/  use googe account to sign in. ->yzle201005 individual premium fee is 12 dollars per month.

2022-12-15  Thursday
今日早上突然发现连不上BTI了，后来在Aron的指导下才解决问题，点右下角的向上的箭头，里面有个地球一样的标记，点击，就会connect to global VPN, 要求输入6位数的动态密码。

2023-01-04 Wednesday


2023-2-1  Growth Meeting 
eTMF filing and project planning and resourcing seems good topic we can discuss.  Looking forward to discussing with you in the afternoon.

Can use 'Snipping Tool' to perform screen snapshot and highlight the important content too.

Aero Tracker link:
Kymab CT1005 Biomarker Analysis Tracker.xlsm https://ppdcentral.sharepoint.com/:x:/r/sites/KymabBiosandProgramming/Shared%20Documents/Kymab%20CT1005%20Biomarker%20Analysis%20Tracker.xlsm?d=wf47cd1bc05024e6799bf25593667c73d&csf=1&web=1&e=80uASM

https://ppdcentral.sharepoint.com/sites/KymabBiosandProgramming/Shared%20Documents/Forms/AllItems.aspx 
 
Link to current AERO tracker: 


 Kymab CT1005 Biomarker Analysis Tracker.xlsm

Please let @Lakshmi Koyaor @June Bonserknow when you need outputs run on top level and they can update the tracker to indicate outputs are ready for review as normal. 
 
\\wilbtia\wilbtia03\Kymab KY1005CT05\Unversioned Files
 

 
Thanks,
Jessie 

2023-02-28 Tuesday
Known my clarity account was locked:
Welcome to Clarity! 
Your account is now active. 
Please log in using your personal User ID (not your email address) and password at your earliest convenience via the link below. 
https://clarity.ppdi.com/niku/nu#action:homeActionId 
*Please note it may take up to 3 hours before you are able to run standardized reports in Clarity* 

2023-4-11 发现my Clarity was locked again.



https://people.duke.edu/~ccc14/sta-663/index.html   Computational Statistics in Python
 
Clinical Trials In Rare Diseases 2023
September 13-14, 2023
Princeton, New Jersey
 
We are pleased to announce the launch of a brand new event: Clinical Trials in Rare Diseases will take place on 13th-14th September 2023 in Princeton!
This event will explore the challenges when working with Orphan Drugs and Rare Diseases, and the benefits from a development viewpoint. It will explore the benefits of early planning and engagement with regulatory authorities, as well as looking into case studies on what has and has not been an effective strategy in Rare Disease trials.

https://www.sctweb.org/membership.cfm 可以考虑注册此会员，终身学习，年费220美元。


and &bmset.= IGE01FL
As a reminder, data stewardship is paramount to achieving the Profitability and Cash Flow goals, including not only essential data such as Clarity but also that we maintain our timesheets on time and with complete truth and accuracy as this directly supports accurate utilization metrics.

Over the next few weeks, you will have goal-setting conversations with your line manager. You will be encouraged to develop individual SMART (Specific, Measurable, Achievable, Relevant and Time-bound) goals that align with our PD Goals for the year. Goals should be entered in Mosaic no later than March 31. We are aware the dropdown category of “Operational Excellence” is not available in Mosaic. Please incorporate these goals under the “Customers” category

Rather, reflect on them and let them influence how you can contribute to the department's direction in your personal goals for 2023 as well as focusing on your primary skill, experience, or behavior competency targets for the coming year.


Ensure that study finances are managed proactively and consistently, while driving the completion of deliverables and maintaining quality. Also, make sure that the study is appropriately resourced, and that unit forecasting is done accurately. Finally, manage OOS and hours variances for the duration of the trial.

Here's a possible rewrite of the paragraph you provided:

"Ensure that study finances are managed proactively and consistently, while driving the completion of deliverables and maintaining quality. Also, make sure that the study is appropriately resourced, and that unit forecasting is done accurately. Finally, manage OOS and hours variances for the duration of the trial."

Does this help? Let me know if you have any other questions.

Here's a possible rewrite of the paragraph you provided:

"Take ownership of your personal utilization target and have proactive discussions with your PeM/RM to identify billable activities as needed. This is especially important if there is any study delay or other reason that your target is at risk of not being met."

Does this help? Let me know if you have any other questions.

Strengthen our customer (sponsors, sites, investigators, and employees) relationships with a relentless focus on delighting the customer at every interaction .Partner with our customers to anticipate and deliver innovative and integrated end-to-end solutions to meet their evolving needs and shape the future of clinical research (ex. Lean Delivery Model, importance of FSP solutions Decentralized Trials, Patient Diversity)

• Drive excellence against speed, quality and cost commitments and ensure industry leadership in end-to-end delivery 
• Ensure continuous improvement leveraging PPI
• Embed a culture of ongoing data stewardship to enable a risk-based mindset across all delivery models
• Deliver greater predictability in indirect costs (example: IGF tool compliance

reading current literature and attending meetings to keeping abreast with methodological or conceptual developments in fields like biostatistics, life sciences etc.

engage with feedback
1. what you are doing well;
2. what you need to improve; and
3. how you need to improve.


• Ensure that study finances are managed proactively and consistently, while driving the completion of deliverables and maintaining quality. Also, make sure that the study is appropriately resourced, and that unit forecasting is done accurately. Finally, manage OOS and hours variances for the duration of the trial.
• Take ownership of my personal utilization target and have proactive discussions with my PeM/RM to identify billable activities as needed. This is especially important if there is any study delay or other reason that my target is at risk of not being met.

2023-04-04 周二
 
With summer vacations just around the corner here is a refresher for existing staff and a new tidbit of information for new hires.
 
We maintain a calendar of PTO for RTP staff so that you have one central location to check if a coworker is out of the office on PTO and when they will return. If you don’t follow the instructions below its possible to prevent others from booking their PTO.  If you have any questions on viewing the calendar or appropriate use you can address them to your manager or myself.
 
 
To add your PTO to the ‘RS RTP Bios PTO’ calendar do the following:
 
	1) From your  Outlook calendar double click the start date of your PTO to bring up a meeting. Home ->New Appointment
	2) Make the subject of the meeting your name or “your name – PTO”
	3) Check the All day Event box
	4) Set the start end dates
	5) Set the “Show As” to free time. Show As-> "Free"u
	6) Turn off any reminder. Reminder->"None"

	New version:

	Options->Show As:Free->Reminder:None
	7) Go to the Scheduling assistant page(on main menu): The third menu.
	8) Add “RS RTP BIOS PTO” as one of the attendees. Be sure it is marked as a “Resource (Room or Equipment)”. Icon is a green circle with house in it.(can not see the home icon anymore,maybe updated.2023-12-4 found that in the Location domain, input "RS RTP", the option list will show up, select  "RS RTP Bios PTO". Alternative way: select "RS RTP Bios PTO" under the Resource(Room or Equipment) drop down list,by inputing "RS" to initiate searching )

	In the above highlighted box, search"RS RTP BIOS PTO",Select it to ADD as one of the attendees.
	9) Add any other people you would like to receive the notification.
	10) Hit send

 
After you send the meeting feel free to go back to the event and change it to show out of the office or busy and add a reminder just do not send an update. After you make the change simply save the change. If you do send an update it will show the recipients calendar as “out of the office” or “Busy” as well (likely your manager and the PTO Calendar will not be joining you on your vacation ).
 
Thanks,
Ted &  RTP Management
 
Autoreply email: 
Send automatic out of office replies from Outlook - Outlook
	1. Select File > Automatic Replies. Note: For Outlook 2007 choose Tools > Out of Office Assistant.
	2. In the Automatic Replies box, select Send automatic replies.Optionally, set a date range for your automatic replies. This will turn off automatic replies at the date and time you enter for the end time. Otherwise, you'll need to turn off automatic ...

Hi All,

Just a friendly reminder that I will take my PTO leave from Thursday, 4/20  to Tuesday, 5/2 and will have limited access to emails. 
For study related questions, please reach out to my backup as follow:
 
Sponsor	BC Number	Back up person(s) 
Sanofi	103557-01	Jessie Fussell
Sanofi	106176-01	Jessie Fussell
Eli Lilly	116083-02	Meiling Pan/Jessie Fussell

 
BR
Zhenhua Yuan


Hi,   
I will take my PTO leave from 12/18 to 12/26.  I will check emails at free time, please call or text me at 9193605701 if there is anything urgent.   Thanks! 
BR
Zhenhua Yuan


Hello,

I will take my PTO leave from April 25th(Thursday) to 26th(Friday). I will be checking emails occasionally. Please feel free to call or text me at 919-360-5701 for anything urgent.Thanks!

BR
Zhenhua Yuan
Click "File"->




Hello
I will be PTO on 7/14. I will be checking emails a few times. Please feel free to call or text me at 618-525-6782 for anything urgent. 
 
 
Thank you,
 
Anna
 
Hi All,
 
Good Morning. This is a reminder that I’ll be OOO next Wednesday to Friday March 13-15th. Please refer to my back-ups for the following studies:
 
  C16021CCS: Lan Ding
  TAK981-1502: Ji Zhang
  DEN301: Joy Wu
 
For urgent matters during this time, please reach out to my line manager Dipa. I will respond to emails upon my return on March 18th.
 
Thanks,
 
Huirong

Hello all, 
My kids are off school for president’s day next Monday. I will take PTO on the same day. For any urgent issues, I can be reached at my cell phone in my signature. 
 
Haoyue Zeigler

Hi all, 
For my PTO tomorrow, Eszter will be my backup to help with SR of TLF outputs. 
Eszter -  I have assigned some TLFs, ADaMs to you in the DRM AERO tracker BTI SharePoint Folders - Takeda TKTAK0791006 - All Documents. Please feel free to take on anything else if you happen to finish these. 
 
For any validation stat macro updates, feel free to reach out to Zhenhua since he is the original validation stat macro author.
 
Thank you,
Upcoming PTO: 19th Jan, Friday
Palpasa Manandhar

How to create a shortcut folder for an project:
Right click on the folder name->click "Create shortcut"

2023-08-01 Midyear Review
What’s New
	Ø Complete the midyear tasks in Workday.
	Ø Use the Open Model to help frame your conversations. 
	Ø Review your performance and development goals as part of the Midyear form in Workday.
Matrix Managers can review and approve the midyear form in Workday.




Celgene Corporation 030 112752-01
Takeda Pharmaceuticals International ITP 91761-01 





Takeda Pharmaceuticals International 303 90335-01
BPL: Lian Hu

Overview
CRG designates and observes 7 holidays per year by granting eligible employees time off with pay. The holidays observed by CRG are:
 
Holiday	Number of Days	2023 Dates
New Year’s Day	1	January 2
Memorial Day	1	May 29
Independence Day	1	July 4
Labor Day	1	September 4
Thanksgiving Holiday	2	November 23 & 24
Christmas Holiday	1	December 25
 
 Employees who are required to work on a holiday will receive an alternate day off, to be taken within 6 months following the holiday.
 
Floating Holiday
In addition to the CRG observed holidays, you are allowed three floating holidays per calendar year. The floating holidays must be used in the calendar year in which it is awarded and approved in advance by the manager. Unused floating holidays will not be paid out at termination and terminating employees may not take a floating holiday during their notice period (unless payout or use is required by local/state law).
 
Non-observed Holidays
If you wish to observe certain days for religious or commemorative purposes that are not listed as a CRG observed holiday, you may use your floating holidays or PTO provided the absence is approved in advance by the manager.
 
Eligibility
All full-time regular and full-time fixed term employees are eligible for holiday pay. You must have a hire date prior to July 1st in order to be eligible for the floating holiday during the calendar year in which you are hired.
 
Pay
You will record your holiday hours on your timesheet by selecting “Public/Company Holiday US” in the Time Type drop down.
 
You are required to work your regularly scheduled hours the workday preceding and the workday following the holiday in order to be eligible to receive pay for the designated holiday, with the following exceptions:
	• the holiday falls within the first 5 working days of an employee’s approved medical leave of absence;
	• the employee has received prior approval from his/her manager to take one or both days as Paid Time Off (PTO); or
	• the employee is absent one or both days because of an excused absence (e.g. jury duty, military leave).
 
If you are absent the day before or the day after an observed holiday because of an illness or injury, your manager may, at their discretion, approve the holiday pay.


vdursasmd002.americas.ppdi.local vdursasmd003.americas.ppdi.local vdursasmd004.americas.ppdi.local

2023-12-04 Monday
重新设置SAS connection. 必须先用lspasswd更新密码。然后设置SAS Server connection如下：

Connection Profiles
Place the space delimited list in the Machine field for your Connection Profile setup.
	PROD	TEST
SAS 9.4	vdursasmd005.americas.ppdi.local vdursasmd006.americas.ppdi.local vdursasmd007.americas.ppdi.local (space delimited)	vdursasmd105.americas.ppdi.local vdursasmd106.americas.ppdi.local (space delimited)

我是把vdursasmd005.americas.ppdi.local vdursasmd006.americas.ppdi.local vdursasmd007.americas.ppdi.local 粘贴入Machine domain处。
可行。

Year END PMD: Deadline, 要尽量提前，在度假前写好。
The following sections must have a rating in order to submit the Year-end PMD Self Evaluation:

• 4i Values and Competencies: provide a rating for each of the 4i Values and Competencies of which at least one should be a Development Opportunity (DO) to highlight an area of focus when creating your development plan
• Overall Performance Rating: provide a rating that best summarizes your performance, taking into consideration your results and behaviors for the entire year

The Year-end PMD Self Evaluation must be completed by January 5, 2024. 

• I could not find useful instruction from the webpage you provided. Do you know how to contact the SAS administrator?
• Agent
• 4:39:49 PM
You can send them an email here SAS_Grid_Admins@ppdi.com

2023-12-4 下午lost connection, 重试了好久，没有改变connection profile的情况下，最终还是重新连上了，估计就是系统的问题。
2022 performance review
To be self-motivated. Show self-motivation at work by having a postive attitude, working hard,working as a team,setting goals and meet them.

To Sharpen my working skills. Practice problem solving skills by taking on a new or difficult task, meet with my people manager routinely and ask hwo I can improve my performance, take courses or trainings relevant to my job, read books and articles to learn more about clinical trial. 

To create my own higher standards. Set a higher goal than the normal role expectation and then strive to meet it, it will encourage myself to be a better worker and achieve a satisfied performance.

To differentiate myself from my peers by add value to my team. I will identify my strengths and make them characteristics on which my coworkers can depend.

An article:
Performance Reviews: Exceeding Expectations
Meeting or exceeding your job expectations is the best way to ensure your job security. To do so, you need to know what is expected from you in your position, and then meet those requirements as best you can. You also need to be determined and motivated to do your job well and committed to improving yourself as much as possible.

Here are five tips to help you meet and exceed expectations in your job:

Know what’s expected of you
Create your own high standards
Be self-motivated
Sharpen your skills
Differentiate yourself from your peers
expectations

Know what’s expected of you
In order to exceed your job expectations, you will first have to understand the purpose of your position and the goals of your company. When you start your job, you should know right away what is expected of you. If you are unclear of your expectations, take time to discuss them in a meeting with your supervisor.

After this meeting, you want to be sure to communicate frequently with your supervisor about his or her expectations for you. This will increase the likelihood that you will exceed those expectations. Don’t wait until your first performance review to ask about what is expected of you, as this may put your job in jeopardy.



Create your own higher standards
You may be wondering, how can I work hard to actually exceed my expectations? First, consider the expectations set for you. Then, make sure that you create your own higher standards! For example, if you are expected to make 30 sales each week, set a personal goal to make 40. If you are supposed to lead four presentations each quarter, ask to lead five. Exceeding expectations in this way will get you noticed and valued quickly. It will also put you on your way to a terrific performance review.

drive strength

Be self-motivated
Employees that take the lead and invest their time and energy into work are noticed and valued quickly. They are the ones who have great performance reviews and are chosen for advancement when the opportunity arises. Here are four tips to help you show self-motivation at work:

Have a great attitude. If you show a great attitude at work, even in tough situations, you exhibit self-motivation. People who do this remain calm when the going gets rough. They also set goals and are focused on achieving them.
Work hard. Those who are self-motivated are often found exceeding expectations. They are usually willing to volunteer more time to their projects, and often handle tough jobs without being asked.
Work as a team. It is easy to pick out the self-motivated people on a team. They are the ones who offer their ideas, keep a positive attitude, and get along with others.
Get the results. People who are self-motivated set goals and meet them. They are more likely to get the results than those who are not motivated to do so. They work hard to meet deadlines and can be regularly relied on for a quality end product.


Sharpen your skills
Another part of exceeding expectations is to keep up with your professional development. So, sharpen your skills to show that you value your job and want to do the best you can. There are many things you can do to keep your professional skills up to date. Here are some ideas of ways to sharpen your skills in your position:

Practice problem solving skills by taking on a new or difficult task
Lead your next group meeting to work on communication skills
Meet with your mentor or supervisor and ask how you can improve your performance
Network, or speak with others in your field about the latest developments
Take a class relevant to your job or receive training in a new area
Read a book, article or magazine to learn more about your field


Differentiate yourself from your peers
Differentiating yourself, or making yourself stand out, from your peers will ensure that you exceed your supervisor’s expectations. After all, you want to stand out in a positive way  so you will be noticed and valued for your hard work. But, if you are trying to stand out from others while they are also trying to stand out from you, how will you ever be noticed?

The simple answer to this question is to make sure you add value to your team and its goals. While many people may be qualified for the same job, not all of them will complete the job in the same way. So, you should identify your strengths and make them characteristics on which others can depend. So, bring your own unique elements to the table and establish yourself as a valuable resource to the company. You will be sure to stand out as a star employee and be on your way to a great performance review.

Get feedback from others. Ask your colleagues, supervisors, or mentors for feedback on your work. This can help you identify areas where you need to improve and give you a boost of confidence when you receive positive feedback.
I strived to step outside of your comfort zone and take on new challenges , attend training and development programs , and actively network with other professionals
Be a good communicator
• Be motivated and inspiring. Leaders need to be able to motivate and inspire others to achieve their goals. This means being positive, enthusiastic, and supportive. You should also be able to set a good example for others to follow.
• Be a good follower. Before you can be a good leader, you need to be a good follower. This means being willing to listen to others, take direction, and work as part of a team.
• Be able to build relationships. Leaders need to be able to build strong relationships with their team members, colleagues, and stakeholders. This means being able to trust and be trusted, communicate effectively, and resolve conflict.
• Be willing to learn and grow. The world of leadership is constantly changing, so it's important to be willing to learn and grow. This means being open to feedback, taking on new challenges, and seeking out new opportunities.

20240101 Self evaluation
The Year-end PMD is an opportunity to evaluate annual performance based on the results accomplished and the behaviors demonstrated (i.e. 4i Values and Competencies) while achieving the goals. It also includes a review of development goals and career plan.
The following resources are available to support the process:
• Year-end PMD resources on the Colleague Service Center and iConnect
• Ratings definitions
• Sample PMD

	1. Customers: Deliver with operational excellence and provide an exceptional customer experience, enabling our customers’ success through differentiated capabilities
• Drive and achieve customer delight, enhancing our relationship equity through a proactive and solution-oriented approach to customer engagement
• Leverage our total company customer value proposition to develop and deliver integrated and innovative solutions that proactively tackle customer challenges and priorities
• Evolve our operating model to be future-ready and patient-centric through innovative technology and digital offerings and services
• Deepen our penetration within high-growth adjacent segments
• Deliver with operational excellence to achieve industry-leading Key Performance Indicators
• Take personal ownership of quality, regulatory compliance and customer satisfaction
	2. Colleagues & Culture: Leverage our diverse, inclusive and collaborative culture, rooted in our 4i Values, to strengthen our competitive advantage
• Continue to improve the overall colleague experience, leading to greater talent attraction, enhanced development and retention
• Increase our impact on society and our business through our Corporate Social Responsibility initiatives
• Take personal ownership of colleague safety, compliance, cybersecurity, data privacy and PPI
• Focus on developing colleagues with an inclusive, enterprise mindset to support the growth of our business and exceed the needs of customers
	3. Revenue: Accelerate market share gain by successfully executing our strategic plan and exceeding our customers' expectations
• Strengthen competitive intensity and commercial effectiveness to expand market presence and accelerate authorizations growth
• Increase share-of-wallet in pharma and biotech customers by leveraging our total company value proposition
• Focus on driving outcomes and delivery against commitments, with speed and quality
• Achieve industry-leading standards of commercial and operational excellence
	4. Profitability & Cash Flow: Drive profitability and cash flow through rigorous prioritization and enhanced productivity
• Use PPI to enhance our speed, quality and productivity, leveraging digital tools including automation and artificial intelligence
• Actively execute on appropriate commercial strategies that drive authorizations volume and sustainable growth
• Continue to invest in highest priority growth initiatives and diligently execute to deliver appropriate returns and create sustained valu

2023 YEAR PERFORMANCE (Bad feedback):
• Goal
Goal
Colleagues & Culture: Leverage our diverse, inclusive and collaborative culture, rooted in our 4i values, to enhance our competiti
• Description
Description
To collaborate effectively with my colleagues, contribute to the fostering of innovative and diversative culture.
To get everyone involving the task on the same page by laying out responsibilities clearly and keeping information such as key deadlines and internal wikis posted and easily accessible to everyone. Be transparent, if something goes wrong, bring attention to it immediately so the team members can work together to solve the problem.
Be a team player but set some ground rules. Be an active listener and respectful of others.
Trust my colleagues to do good work and provide a good support.

Define, develop and accelerate a strategic and agile workforce plan to meet the evolving needs of the business

Manager
• Comment
Comment
Zhenhua works well with colleagues and demonstrated professional relationship. He is a team player who is willing to provide support as needed.
Zhenhua should improve proactive communication when encountering unfamiliar areas, promptly seeking assistance rather than allowing stress to accumulate without progress. Adopting the '20-minute rule' and openly request help would enhance efficiency. He should enhance efficiency in oral communication by being more concise and getting directly to the point.

Employee
• Comment
Comment
Over the last year, I effectively collaborated with my colleagues, consistently maintaining clear communication with team members. I ensured the provision of essential information and resources for the successful implementation of tasks. Additionally, I promptly alerted my co-workers to any project-related issues as soon as they were identified.

• Goal
Goal
Customers: Deliver an exceptional customer experience and enable their success through differentiated capabilities
• Description
Description
Strive to strengthen our relationships with customers (sponsors, cross-functional teams) by satisfying their requirements timely and effectively, retaining a good attitude at every interaction. Reply to customers' emails timely and professionally, solve the issues raised by customers quickly and efficiently, and escalate the issue to higher level management team when it's necessary.
Work with customers closely to deliver innovative and integrated end-to-end solutions that meet their evolving needs. Learn to use novel tools such as Lean Delivery Model to speed up the delivery process and ensure the high quality. 
Check the deliverables carefully to avoid mistakes, act quickly to correct the errors in the deliverables if any mistake happen.



Strengthen our customer (sponsors, sites, investigators, and employees) relationships with a relentless focus on delighting the customer at every interaction

Manager
• Comment
Comment
Zhenhua demonstrates strong problem-solving abilities in statistics and inferential programming. He is dedicated to delivering quality work within timelines. However, he did not have direct interaction with clients this year. I believe Zhenhua should focus on bridging gaps in common biostatistician-relatedtasks, working towards completing tasks independently. This would provide opportunities for him to advance to a lead statistician role and collaborate more extensively with broader teams and clients.
Employee
• Comment
Comment
I prioritized the timely and high-quality completion of my assigned tasks. Over the past year, I dedicated myself to projects assigned to me such as KYMAB ,GPIL, TAK-DEN301 by committing my task with excellence and within the specified timeframe. Our teams received several recognitions and praises from the sponsor for our accomplishments. Additionally, my involvement played a meaningful role in achieving several ahead-of-schedule deliveries for the KYMAB and GPIL study. I have been consistently strived to contribute to the success of the team and advance overall progress.

• Goal
Goal
Operational Excellence: Deliver with speed and quality with a focus on driving outcomes
• Description
Description
Strive to achieve excellence in speed, quality, and cost commitments with the project I work on, contribute to ensuring the industry leadership of PPD.
Improve my productivity by leveraging tools such as Aero-tracker, SAP Toolbox, Templates.
 Develop risk-based mindset, manage the associated risk proactively, even with the help of others.
Provide better predictabilityin indirect costs and find the solution to minimize it.



Drive excellence against speed, quality and cost commitments and ensure industry leadership in end-to-end delivery

Manager
• Comment
Comment
Zhenhua has demonstrated strong statistical skills and commitment in his role, earning praise for his dedication, attention to detail, and willingness to support others. 
He maintains a positive attitude towards work and exhibits a strong drive for excellence. I encourage him to sustain this motivation while addressing current gaps and taking the lead in guiding internal stakeholders within local contexts or projects, in line with the expectations for a Senior Biostatistician level.
Employee
• Comment
Comment
In an effort to enhance my productivity, I explored the utilization of tools like Aero-tracker, SAP Toolbox, and Templates to expedite my work without compromising quality. I committed myself to cultivating a risk-based mindset, proactively managing associated risks. Continuously seeking growth, I engaged in ongoing learning through platforms such as CRG Learning, Biowiki website, and various other online resources to acquire new knowledge and skills.In the past yearI dedicated efforts to attain excellence in meeting project goals, focusing on speed, quality, and cost commitments.

• Goal
Goal
Profitability & Cash Flow: Drive profitability and cashflow through rigorous prioritization, resource and cost management
• Description
Description
Ensure a proactive and consistent approach regarding the management of study finances, driving completion of deliverables and maintaining quality, while ensuring appropriate study resourcing, unit forecasting and management of OOS and hours variances, for the course of the trial.
Ensure Clarity data stewardship is maintained, both in unit forecast (initial and monthly updates) and team tab/resource requests
Demonstrate ownership of your personal utilization target and ensure proactive discussions with you PeM/RM to identify billable activities as needed, due to any study delay or other reason target is at risk of not being met. 
Ensure financial stewardship at the personal, team and corporate level to achieve financial targets.


Manager
• Comment
Comment
Zhenhua demonstrates a proactive approach in requesting additional tasks and assignments, which reflects a positive attitude towards work. However, he has not yet been involved in clarity/budget tasks. I would encourage Zhenhua to optimize his downtime by prioritizing learning tasks that could have an immediate impact, enabling him to work independently and progress towards leadership roles which is required by his current position.
Employee
• Comment
Comment
In the past year, I strived to take ownership of my personal utilization target and engage in proactive discussions with my PeM/RM to identify necessary billable activities, especially in situations where the target is at risk due to study delays or other reasons.Moreover, even I was not assigned the LS/PBL roles, I've endeavored tolearn how to establish a proactive and steadfast strategy in overseeing study finances, prioritizing the timely completion of deliverables, upholding quality standards, and ensuring proper study resourcing, unit forecasting, and effective management of OOS and hours variances throughout the trial duration. 

Manager Summary
• Comment
Comment
Zhenhua consistently demonstrates commitment and diligence in delivering excellence. With a positive attitude and a willingness to support team members, he is a valuable asset to the team. Moving forward, I would like to see him to increase his involvement in project work, think innovatively to provide valuable solutions in challenging situations, and exhibit intellectual curiosity by embracing Practical Process Improvement methodologies.
Employee Summary
• Comment
Comment
Strengths:
 1. Task Completion and Quality: I take pride in consistently completing assigned tasks with a high level of quality and within the given timeframe. This strength reflects my commitment to delivering work that not only meets but often exceeds expectations.
  2. Collaboration with Team Members: Another notable strength is my ability to collaborate effectively with team members. I understand the importance of teamwork, and my communication skills contribute to a positive and productive team dynamic. This ensures a smooth workflow and successful project outcomes.
 
Development Opportunities:
 1.Leadership Skills: While performing well in individual contributions, I recognize the need for further development in leadership skills. I aim to enhance my ability to guide and inspire others, fostering a collaborative environment that encourages team members to reach their full potential.
2. Clinical Trial Process Management: Working mostly as supportive statistician in the past year, there's an opportunity for me to deepen my knowledge and proficiency in managing the clinical trial process. Gaining a comprehensive understanding of the intricacies involved will not only bolster my confidence but also contribute to more effective decision-making and project management.
 
In the upcoming year, my focus will be on refining these developmental areas, thereby contributing to my overall professional growth and the success of our team and projects. I am committed to continuous improvement and look forward to leveraging my strengths while addressing these development opportunities.

Manager Summary
• Comment
Comment
Zhenhua is actively developing his skills in common biostatistical tasks. Moving forward, I would like him to adopt a leadership mindset, seeking opportunities to make meaningful contributions and take on increased responsibilities beyond the role of a team member.
Employee Summary
• Comment
Comment
Goal 1: Build Self-Confidence by Sharpening Professional Skills:
Actions I will take:
1.Conduct a self-assessment to identify specific professional skills that need improvement. This could include technical skills, communication skills, or project management skills.
2. Set Clear Objectives: Define clear and achievable objectives for skill improvement. Break down larger skills into smaller, manageable tasks to track progress effectively.
3. Seek Training and Learning Opportunities: Enroll in relevant training programs, workshops, or online courses to enhance targeted professional skills. Utilize resources such as industry conferences, webinars, PPD Biowiki or mentorship programs.
4. Practice Regularly: Apply newly acquired skills in real-world scenarios. Seek opportunities within current projects or volunteer for tasks that allow the application of the targeted skills.
5. Receive Feedback: Request feedback from colleagues, supervisors, or mentors on my progress. I think that constructive feedback is crucial for refining skills and building confidence.
Goal 2: Develop Leadership Skills.
Actions I will take:
1. Leadership Training Programs: Try to identify and attend leadership training programs or workshops that align with my career goals. Participate actively to gain insights into effective leadership strategies.
2. Mentorship: Seek mentorship from experienced leaders such as my people manager. Learn from their experiences and seek guidance on developing leadership qualities.
3. Take on Leadership Roles: Volunteer for leadership roles within team projects or committees. Practice leadership skills in a controlled environment to build confidence and competence.
4. Communication Improvement: Enhance communication skills, both verbal and written. Effective communication is fundamental to successful leadership.
Goal 3: Following Directions to Perform Well:
Actions I will take:
1. Active Listening: Develop active listening skills to fully understand and comprehend directions. Ask clarifying questions to ensure a complete understanding.
2. Clarify Expectations: Proactively seek clarification on expectations. communicate with supervisors or team leaders to ensure a shared understanding of tasks and goals.
3. Time Management: Improve time management skills to prioritize tasks effectively. Create a schedule that allows for focused work on assigned projects.
4. Feedback Integration: Actively seek feedback on performance. Use feedback to make necessary adjustments and improvements.
5. Accountability: Take ownership of assigned tasks and responsibilities. demonstrate accountability by consistently delivering high-quality work following given directions.
By implementing this development plan, I aim to build self-confidence, enhance leadership skills, and consistently excel in following directions, ultimately contributing to my professional growth and success.

Overall Performance
Manager
• Rating
Rating
• Requires Improvement (RI)
• Comment
Comment
Overall, Zhenhua did not fully meet performance expectations for his level. However, I am committed to supporting him in learning and growing in the coming year. Looking forward for the improvement in 2024.
Employee
• Rating
Rating
• At Standard (AS)
• Comment
Comment
Overall, the past year has been a year of learning and improvement, I have fulfilled the tasks assigned to me with high quality and in scheduled time. I have been actively worked on preparing myself to be LS, I am looking forward to this sustained momentum throughout 2024.


Career Planning
• Question
Question
What are your Short-Term Career Goals (0-2 years)?
Manager
• Comment
Comment
I will continue provide support to his goal.
Employee
• Comment
Comment
My short-term career goal is to be a competent and efficient senior biostatistician and be able to take LS roles for the relatively complicated clinical trials.

• Question
Question
What are your Long-Term Career Goals (3-5 years)?
Manager
• Comment
Comment
It's encouraging to observe Zhenhua's enthusiasm for advancing his career.
Employee
• Comment
Comment
I aspire to achieve the position of principal biostatistician within the next 3-5 years as part of my long-term career objective. Ultimately, I aim to establish myself as an experienced and knowledgeable statistician in the clinical trial domain.

MANCOVA:
 GOPTIONS ACCESSIBLE;
 *************************************************************************;
 *        CLIENT:  Kymab                                                 *;
 *        PROTOCOL:  KY1005CT05                                          *;
 *        PURPOSE:  To validate the ANCOVA macro for production          *;
 *        AUTHOR:  Zhenhua Yuan                                          *;
 *        INPUT FILES:  ADQS, ADMI                                       *;
 *        OUTPUT FILES:  WORK.ANCOVA                                     *;
 *         NOTES:                                                         *;
 *          DATE:  08/DEC/2022                                             *;
 *************************************************************************;
 *  Copyright 2022 Thermo Fisher Scientific Inc. All rights reserved.    *;
 *  All trademarks are the property of Thermo Fisher Scientific and its  *;
 *  subsidiaries unless otherwise specified.                             *;
 *************************************************************************;
         
     
     options symbolgen mprint mlogic;

     %macro vmANCOVA(ADB=,ANLSET=,PARAMCD=,AVISITN_MIN=,AVISITN_MAX=,VAR1=);
         /**Construct the ADQS or ADMI analysis dataset according to the feed in dataset and parameters;*/
         %if &adb.=ADQS %then %do;
         data &adb.;
           set adb.&adb.;
         run;
         %end;
         
         %if &adb.=ADMI %then %do;
         data &adb.;
           set STATOUTR.&adb.;
         run;
         %end;

         data &adb.01;
           set &adb;
           %if &adb.=ADQS %then %do;
             if &ANLSET.="Y" and PARAMCD="&PARAMCD" and &AVISITN_MIN. <= AVISITN <=&AVISITN_MAX. and ANL01FL="Y";
             if PARAMCD ="ADCTTOTA" then do;
                if AVISITN in (16,24);
             end;
           %end;
           %else %if &adb.=ADMI %then %do;
             if &ANLSET.="Y" and PARAMCD="&PARAMCD" and &AVISITN_MIN. <= AVISITN <=&AVISITN_MAX. and D=0 and P=0;
           %end;
         run;
         
         %if &adb.=ADQS %then %do;
           proc sort data=&adb.01; by AVISITN;run;
         %end;
         
         %else %if &adb.=ADMI %then %do;
           proc sort data=&adb.01; by AVISITN IMPNUM;run;
         %end;
         
         /*Use proc mixed to perform the ANCOVA according to the inferential ANCOVA specs */
         ods output lsmeans=vm_lsmeans diffs=vm_diffs;
         proc mixed data=&adb.01(where=(missing(&VAR1.)=0 and missing(BASE)=0 and 
                                 missing(TRT01PN)=0 and missing(REGION1)=0 and
                                 missing(DISSEV)=0));
           class TRT01PN REGION1 DISSEV;
           model &VAR1.=BASE TRT01PN REGION1 DISSEV;
           %if &adb.=ADQS %then %do;
             by AVISITN;
           %end;
           %else %if &adb.=ADMI %then %do;
             by AVISITN IMPNUM;
           %end;
           lsmeans TRT01PN/pdiff=control('5') cl;
         run;
         
         proc sort data=vm_lsmeans;
           by AVISITN TRT01PN;
         run;
         
         proc sort data=vm_diffs;
           by AVISITN TRT01PN;
         run;
         
         /**Build the analysis results dataset for producing the ANCOVA tables for ADQS;*/
         %if &adb.=ADQS %then %do;
           data vm_lsmeans_eff01;
             length result $ 40 est $15;
             set vm_lsmeans;
              resultn=1;
              result="LS Adjusted Mean (SE)[a]";
             est=strip(put(estimate,9.1))||" ("||strip(put(stderr,9.2))||")";
             output;
           run;
        
          data vm_diffs_eff01;
            length result $ 40 est $ 15;
            set vm_diffs;
            resultn=2;
            result="LS Mean Difference vs. Placebo (SE)[a]";
            est=strip(put(estimate,9.1))||" ("||strip(put(stderr,9.2))||")";
            output;
            resultn=3;
            result="95% CI[a]";
            est=strip(put(Lower,9.1))||" :"||strip(put(Upper,9.1));
            output;
                                             
            resultn=4;
            result="P-value[a]";
            if probt>=0.0001 then est=strip(put(Probt,9.4));
            else if probt>0 then est="<0.0001";
            output;
          run;
        %end;
        
        /**Build the analysis results dataset for producing the ANCOVA tables for ADMI;*/
        %else %if &adb.=ADMI %then %do;
        ods output ParameterEstimates=vm_lsmeans_eff00;
        proc mianalyze data=vm_lsmeans;
          modeleffects Estimate;
          stderr StdErr;
          by AVISITN TRT01PN;
        run;
        
        data vm_lsmeans_eff01;
          length result $ 40 est $15;
          set vm_lsmeans_eff00;
          resultn=1;
          result="LS Adjusted Mean (SE)[a]";
          est=strip(put(estimate,9.1))||" ("||strip(put(stderr,9.2))||")";
          output;
        run;
        
        ods output ParameterEstimates=vm_diffs_eff00;
        proc mianalyze data=vm_diffs;
          modeleffects Estimate;
          stderr StdErr;
          by AVISITN TRT01PN;
        run;
        
        PROC SORT DATA=ADMI01 OUT=ADMI01S;
          BY IMPNUM USUBJID AVISITN PARAMCD;
        RUN;

        proc sort data=vm_diffs out=vm_diffs_00s;
           by AVISITN TRT01PN IMPNUM;
        run;

       data vm_diffs_01(keep=AVISITN TRT01PN ESTIMATE StdErr Probt Lower Upper 
                        rename=(Probt=Probt_ni));
         set vm_diffs_00s;
         by AVISITN TRT01PN;
         if first.TRT01PN then output;
       run;

       DATA VM_DIFFS_EFF00a;
         merge VM_DIFFS_EFF00(in=a keep=AVISITN TRT01PN ESTIMATE StdErr LCLMean UCLMean Probt)
               vm_diffs_01(in=b keep=AVISITN TRT01PN Probt_ni Lower Upper);
         by AVISITN TRT01PN;
         if a and b;
         if missing(LCLMean) then LCLMean=Lower;
         if missing(UCLMean) then UCLMean=Upper;
         if missing(Probt)   then Probt=Probt_ni;
       run; 

        data vm_diffs_eff01;
          length result $ 40 est $ 15;
          set vm_diffs_eff00a;
          resultn=2;
          result="LS Mean Difference vs. Placebo (SE)[a]";
          est=strip(put(estimate,9.1))||" ("||strip(put(stderr,9.2))||")";
          output;
          resultn=3;
          result="95% CI[a]";
          est=strip(put(LCLMean,9.1))||" :"||strip(put(UCLMean,9.1));
          output;
          resultn=4;
          result="P-value[a]";
          if probt>=0.0001 then est=strip(put(Probt,9.4));
          else if probt>0 then est="<0.0001";
          output;
        run;
        %end;
        
        /**Stack two analysis result dataset to get the dataset for tables in long format;*/
        data vm_eff01;
          format AVISITN TRT01PN RESULTN RESULT EST;
          set vm_lsmeans_eff01(keep=AVISITN TRT01PN RESULTN RESULT EST)
              vm_diffs_eff01(keep=AVISITN TRT01PN RESULTN RESULT EST);
        run;
        
        proc sort data=vm_eff01;
          by AVISITN RESULTN;
        run;
                                                          
        
        /**Transpose to wide format for generating the tables easily;*/
        proc transpose data=vm_eff01 out=vm_eff01t;
          by AVISITN RESULTN RESULT;
          var est;
          id TRT01PN;
        run;
        
        /** Generate the ANCOVA dataset as designated in the specs;*/
        data ANCOVA;
          format AVISITN RESULTN RESULT _1 _2 _3 _4 _5;
          length _1 $15 _2 $15 _3 $15 _4 $15 _5 $15;
          set vm_eff01t(keep=AVISITN RESULTN RESULT _1 _2 _3 _4 _5);
        run;
        %mend vmANCOVA;


MANCOVA_SUBGRP:
GOPTIONS ACCESSIBLE;

*************************************************************************;
*        CLIENT:  Kymab                                                 *;
*        PROTOCOL:  KY1005CT05                                          *;
*        PURPOSE:  To validate the ANCOVA_SUBGRP macro for production   *;
*        AUTHOR:  Zhenhua Yuan                                          *;
*        INPUT FILES:  ADQS, ADMI                                       *;
*        OUTPUT FILES:  WORK.ANCOVA_SUBGRP                              *;
*   	  NOTES:                                                        *;
*		  DATE:  23/DEC/2022                                            *;
*************************************************************************;
*  Calling example:                                                     *;
* %vmANCOVA_SUBGRP(ADB=ADMI,ANLSET=IFAS01FL,SUBGRP=RACE,PARAMCD=EASISA,  *;    
*  AVISITN_MIN=16,AVISITN_MAX=16,VAR1=PCHG);                            *;
*  Copyright 2022 Thermo Fisher Scientific Inc. All rights reserved.    *;
*  All trademarks are the property of Thermo Fisher Scientific and its  *;
*  subsidiaries unless otherwise specified.                             *;
*************************************************************************;
options symbolgen mprint mlogic;
options compress=no;
/*proc datasets library=WORK kill; run; quit;*/
/*%let ANLSET=IFAS01FL;*/
/*%let ADB=ADMI;*/
/*%let SUBGRP=RACE;*/
/*%let PARAMCD=EASISA;*/
/*%let AVISITN_MIN=16;*/
/*%let AVISITN_MAX=16;*/
/*%let VAR1=PCHG;  */

%macro vmANCOVA_SUBGRP(ADB=,ANLSET=,PARAMCD=,AVISITN_MIN=,AVISITN_MAX=,VAR1=,SUBGRP=);
  /**Construct the ADQS or ADMI analysis dataset according to the feed in dataset and parameters;*/
    %if &adb.=ADQS %then 
      %do;
      data &adb.;
   	    set adb.&adb.;
      run;
      %end;
    %if &adb.=ADMI %then 
      %do;
      data &adb.;
	    set STATOUTR.&adb.;
	  run;
      %end;

     data &adb.01;
  	   set &adb;
		%if &adb.=ADQS %then %do;
           if &ANLSET.="Y" and PARAMCD="&PARAMCD" and &AVISITN_MIN. <= AVISITN <=&AVISITN_MAX. 
              and ANL01FL="Y";
			                 %end;
		%else %if &adb.=ADMI %then %do;
		   if &ANLSET.="Y" and PARAMCD="&PARAMCD" and &AVISITN_MIN. <= AVISITN <=&AVISITN_MAX. 
              and D=0 and P=0;
/*           if upcase("&subgrp.")="RACE" and strip(RACE)="OTHER" then delete;*/
		                           %end;
	run;

    %if &adb.=ADQS %then %do;
	  proc sort data=&adb.01;
		by AVISITN &SUBGRP.;
	  run;
                        %end;
    %else %if &adb.=ADMI %then %do;
      proc sort data=&adb.01;
		by AVISITN IMPNUM &SUBGRP.;
	  run;
                             %end;
   data &adb.01a;
     set &adb.01;
     if missing(&SUBGRP.) then delete;
   run; 

   proc sql;
    create table &adb.01b as
    select *
    from &adb.01a
    group by AVISITN,IMPNUM,&SUBGRP.
    having count(USUBJID)>=5;
	quit;

PROC FREQ DATA=&adb.01b;
  TABLE &SUBGRP. / OUT= want;
RUN;

proc sql;     
 select count(distinct &SUBGRP.) 
 into: nlevels
 from want;
quit;

%if &nlevels ne 1 %then
    %do;
/*Use proc mixed to perform the ANCOVA_SUBGRP according to the inferential ANCOVA_SUBGRP specs */
    ods output lsmeans=vm_lsmeans diffs=vm_diffs ;
	proc mixed data=&adb.01b;
	    %if %upcase(&SUBGRP.)= REGION1 %then %do;
            class TRT01PN(ref='5') &SUBGRP. DISSEV ;
		    model &VAR1.=BASE TRT01PN &SUBGRP. DISSEV;
		   %end;
	    %else %if %upcase(&SUBGRP.)= DISSEV %then %do;
            class TRT01PN(ref='5') REGION1 &SUBGRP. ;
		    model &VAR1.=BASE TRT01PN REGION1 &SUBGRP.;
		   %end;

		 %else %if %upcase(&SUBGRP.)= EASIGR %then %do;
            class TRT01PN(ref='5') REGION1 &SUBGRP. ;
		    model &VAR1.=BASE TRT01PN REGION1 &SUBGRP.;
		   %end;


        %else %do;
		    class TRT01PN(ref='5') REGION1 DISSEV &SUBGRP.;
		    model &VAR1.=BASE TRT01PN REGION1 DISSEV &SUBGRP. ;
		   %end;
		%if &adb.=ADQS %then %do;
		   by AVISITN &SUBGRP.;
		   %end;
		%else %if &adb.=ADMI %then %do;
		   by AVISITN IMPNUM &SUBGRP.;
		   %end;
		lsmeans TRT01PN /pdiff cl alpha=0.05;
	run;

    ods output  Tests3=test3 solutionf=parmsm type3=type3 covb=mixcovb;
	proc mixed data=&adb.01b method=type3;
        %if %upcase(&SUBGRP.)= REGION1 %then %do;
            class TRT01PN(ref='5') &SUBGRP. DISSEV ;
		    model &VAR1.=BASE TRT01PN &SUBGRP. DISSEV TRT01PN*&SUBGRP./solution covb;
		   %end;
	    %else %if %upcase(&SUBGRP.)= DISSEV %then %do;
            class TRT01PN(ref='5') REGION1 &SUBGRP. ;
		    model &VAR1.=BASE TRT01PN REGION1 &SUBGRP. TRT01PN*&SUBGRP./solution covb;
		   %end;

			%else %if %upcase(&SUBGRP.)= EASIGR %then %do;
            class TRT01PN(ref='5') REGION1 &SUBGRP. ;
		    model &VAR1.=BASE TRT01PN REGION1 &SUBGRP. TRT01PN*&SUBGRP./solution covb;
		   %end;
/*		 %else %if %upcase(&SUBGRP.)= EASIGR %then %do;*/
/*            class TRT01PN(ref='5') REGION1 &SUBGRP. ;*/
/*		    model &VAR1.=BASE TRT01PN REGION1 &SUBGRP.;*/
/*		   %end;*/

        %else %do;
  	   	    class TRT01PN(ref='5') REGION1 DISSEV &SUBGRP.;
	    	model &VAR1.=BASE TRT01PN REGION1 DISSEV &SUBGRP. TRT01PN*&SUBGRP./solution covb;
           %end;
		%if &adb.=ADQS %then
			%do;
			   by AVISITN ;
			%end;
		%else %if &adb.=ADMI %then
			%do;
			   by AVISITN IMPNUM;
			%end;
/*		lsmeans TRT01PN TRT01PN*&SUBGRP./pdiff cl alpha=0.05;*/
	run;

* Deal with the LSMEAN,DIFFS and test3 for interaction term pvalue for ADQS; 
    proc sort data=vm_lsmeans;
		by AVISITN &SUBGRP. TRT01PN;
	run;

	proc sort data=vm_diffs;
		by AVISITN &SUBGRP. TRT01PN;
	run;

/**Build the analysis results dataset for producing the ANCOVA_SUBGRP tables for ADQS;*/
  %if &adb.=ADQS %then
	 %do;
	  data _null_;
	    set vm_lsmeans;
		call symput('subgrp_typ',vtype(&SUBGRP.));
      run;

 	  data vm_lsmeans_eff01(drop=&SUBGRP.);
		length Subgrp $ 8 SUBGRPLV $100 result $ 39 est $15;
		set vm_lsmeans;
		  SUBGRP="&SUBGRP.";
          %if &subgrp_typ.= N %then %do;SUBGRPLV=PUT(&SUBGRP.,8.);%end;
	      %else %if &subgrp_typ.= C %then %do;SUBGRPLV=&SUBGRP.;%end;
		  resultn=1;
		  result="LS Adjusted Mean (SE)[a]";
		  est=strip(put(estimate,9.1))||" ("||strip(put(stderr,9.2))||")";
 	   	  output;
	  run;

	  data vm_diffs_eff01(drop=&SUBGRP.);
	    length Subgrp $ 8 SUBGRPLV $100 result $ 39 est $ 15;
		set vm_diffs(where=( _TRT01PN=5));
          SUBGRP="&SUBGRP.";
          %if &subgrp_typ.= N %then %do;SUBGRPLV=PUT(&SUBGRP.,8.);%end;
	      %else %if &subgrp_typ.= C %then %do;SUBGRPLV=&SUBGRP.;%end;
		  resultn=2;
		  result="LS Mean Difference vs. Placebo (SE)[a]";
		  est=strip(put(estimate,9.1))||" ("||strip(put(stderr,9.2))||")";
		  output;
		  resultn=3;
		  result="95 CI[a]";
		  est=strip(put(Lower,9.1))||", "||strip(put(Upper,9.1));
		  output;
		  resultn=4;
		  result="P-value[a]";
			if probt >= 0.0001 then
 		      est=strip(put(Probt,9.4));
			else if probt < 0.0001 then
			  est="<0.0001";
			output;
	  run;

      data vm_test3_eff00(drop=Effect NumDF DenDF FValue ProbF);
	    length Subgrp $ 8 SUBGRPLV $100 result $ 39 est $ 15;
	    set TEST3(where=(EFFECT="TRT01PN*&SUBGRP."));
          SUBGRP="&SUBGRP.";
	      SUBGRPLV="ZZ";
          resultn=5;
	      result="P-value for interaction";
	      if ProbF>=0.0001 then
	   	    est=strip(put(ProbF,9.4));
	      else if ProbF < 0.0001 then
		    est="<0.0001";  
	      TRT01PN = 0;
	      output;
	   run;	
      %end;
/*	*Build the analysis results dataset for producing the ANCOVA_SUBGRP tables for ADMI;*/
   %else %if &adb.=ADMI %then
	  %do; 
   *Using proc mianalyze to combine results;
   *For LSMEANS;
   data vm_lsmeans1;
     length Estimate_C $ 15 StdErr_C $ 15;
     set vm_lsmeans;
     Estimate_C = strip(put(Estimate,9.4));
     StdErr_C =strip(put(StdErr,9.4));
   run;

   proc sort data=vm_lsmeans1 out=vm_lsmeans1s nodupkey;
     by AVISITN TRT01PN &SUBGRP. Estimate_C StdErr_C;
   run; 

*seperate out the subgroup with no imputation;
   data vm_lsmeans_i vm_lsmeans_n;
     set vm_lsmeans1s;
     by AVISITN TRT01PN &SUBGRP.;
     if first.&SUBGRP. and last.&SUBGRP. then output vm_lsmeans_n;
     else output vm_lsmeans_i;
   run;

   data _NULL_;
  	 if 0 then set work.vm_lsmeans_n nobs=n;
	 call symputx('nobs',n);
	 stop;
   run;
   %put nobs=&nobs;

  %if &nobs eq 0 %then %do; 
    proc sort data=vm_lsmeans;by AVISITN TRT01PN &SUBGRP.; run;

    ods output ParameterEstimates=vm_lsmeans_eff00;
	proc mianalyze data=vm_lsmeans;
	  modeleffects Estimate;
	  stderr StdErr;
	  by AVISITN TRT01PN &SUBGRP.;
	run; 

  %end;

  %else %do;
	ods output ParameterEstimates=vm_lsmeans00;
	proc mianalyze data=vm_lsmeans_i;
	  modeleffects Estimate;
	  stderr StdErr;
	  by AVISITN TRT01PN &SUBGRP.;
	run;

	data vm_lsmeans_eff00;
	  set vm_lsmeans00(keep=AVISITN TRT01PN &SUBGRP. Estimate StdErr LCLMean UCLMean Probt)
	      vm_lsmeans_n(keep=AVISITN TRT01PN &SUBGRP. Estimate StdErr LOWER UPPER Probt
                       rename=(LOWER=LCLMean UPPER=UCLMean));
    run;
   %end;

    data _null_;
	  set vm_lsmeans_eff00;
		call symput('subgrp_typ',vtype(&SUBGRP.));
    run;

	data vm_lsmeans_eff01(drop=&SUBGRP.);
	  length Subgrp $8 SUBGRPLV $100 result $ 39 est $15;
	  set vm_lsmeans_eff00;
        SUBGRP="&SUBGRP.";
        %if &subgrp_typ.= N %then %do;SUBGRPLV=PUT(&SUBGRP.,8.);%end;
		%else %if &subgrp_typ.= C %then %do;SUBGRPLV=&SUBGRP.;%end;
		resultn=1;
		result="LS Adjusted Mean (SE)[a]";
		est=strip(put(estimate,9.1))||" ("||strip(put(stderr,9.2))||")";
		output;
	run;

*For DIFFS;
    data vm_diffs1;
     length Estimate_C $ 15 StdErr_C $ 15;
     set vm_diffs(where=( _TRT01PN=5));
     Estimate_C = strip(put(Estimate,9.4));
     StdErr_C =strip(put(StdErr,9.4));
   run;

   proc sort data=vm_diffs1 out=vm_diffs1s nodupkey;
     by AVISITN TRT01PN &SUBGRP. Estimate_C StdErr_C;
   run; 

*seperate out the subgroup with no imputation;
   data vm_diffs_i vm_diffs_n;
     set vm_diffs1s;
     by AVISITN TRT01PN &SUBGRP.;
     if first.&SUBGRP. and last.&SUBGRP. then output vm_diffs_n;
     else output vm_diffs_i;
   run;

   data _NULL_;
  	 if 0 then set work.vm_diffs_n nobs=n;
	 call symputx('nobs',n);
	 stop;
   run;
   %put nobs=&nobs;

  %if &nobs eq 0 %then %do; 
    proc sort data=vm_diffs(where=(_trt01pn=5));
      by AVISITN &SUBGRP. TRT01PN ; 
    run;

    ods output ParameterEstimates=vm_diffs_eff00;
	proc mianalyze data=vm_diffs;
	  modeleffects Estimate;
	  stderr StdErr;
	  by AVISITN &SUBGRP. TRT01PN ;
	run;
  %end;

  %else %do;
	ods output ParameterEstimates=vm_diffs00;
	proc mianalyze data=vm_diffs_i;
	  modeleffects Estimate;
	  stderr StdErr;
	  by AVISITN TRT01PN &SUBGRP.;
	run;

	data vm_diffs_eff00;
	  set vm_diffs00(keep=AVISITN TRT01PN &SUBGRP. Estimate StdErr LCLMean UCLMean Probt)
	      vm_diffs_n(keep=AVISITN TRT01PN &SUBGRP. Estimate StdErr LOWER UPPER Probt
                       rename=(LOWER=LCLMean UPPER=UCLMean));
    run;
  %end;

* For obtaining the pooled p-value for interaction term;
    proc mianalyze parms=parmsM(WHERE=(STDERR^=.) rename=(impnum=_Imputation_))
                   covb(effectvar=rowcol)=mixcovb(rename=(impnum=_Imputation_)) MULT;
      CLASS TRT01PN &SUBGRP.;
      modeleffects TRT01PN*&SUBGRP. ;
	  by AVISITN;
      ODS OUTPUT MULTSTAT=MULTFINTER ;
    run;

 * Produce the elements for the table;
	data vm_diffs_eff01(drop=&SUBGRP.);
	  length Subgrp $8 SUBGRPLV $100 result $ 39 est $ 15;
	  set vm_diffs_eff00;
        SUBGRP="&SUBGRP.";
        %if &subgrp_typ.= N %then %do;SUBGRPLV=PUT(&SUBGRP.,8.);%end;
		%else %if &subgrp_typ.= C %then %do;SUBGRPLV=&SUBGRP.;%end;
		resultn=2;
		result="LS Mean Difference vs. Placebo (SE)[a]";
		est=strip(put(estimate,9.1))||" ("||strip(put(stderr,9.2))||")";
		output;
		resultn=3;
		result="95% CI[a]";
		est=strip(put(LCLMean,9.1))||", "||strip(put(UCLMean,9.1));
		output;
		resultn=4;
		result="P-value[a]";
		if probt>=0.0001 then est=strip(put(Probt,9.4));
		else if probt>0 then est="<0.0001";
		output;
	run;

     data vm_test3_eff00(drop=ProbF);
	   length Subgrp $8 SUBGRPLV $100 result $ 39 est $ 15;
	   set MULTFINTER(drop=AvgVar NumDF DenDF FValue);
       SUBGRP="&SUBGRP.";
	   SUBGRPLV="ZZ";
       resultn=5;
	   result="p-value for interaction";
	   if ProbF>=0.0001 then
	   	 est=strip(put(ProbF,9.4));
	   else if ProbF < 0.0001 then
		 est="<0.0001";
	   TRT01PN = 0;
	   output;
	 run;	
	%end;

   /**Stack two analysis result dataset to get the dataset for tables in long format;*/
      data vm_eff01;
		format SUBGRP SUBGRPLV AVISITN TRT01PN RESULTN RESULT EST;
		set vm_lsmeans_eff01(keep=SUBGRP SUBGRPLV AVISITN TRT01PN RESULTN RESULT EST)
			vm_diffs_eff01(keep=SUBGRP SUBGRPLV AVISITN TRT01PN RESULTN RESULT EST)
			vm_test3_eff00;
	  run;

	proc sort data=vm_eff01;
		by SUBGRP SUBGRPLV AVISITN RESULTN RESULT;
	run;

	/**Transpose to wide format for generating the tables easily;*/
	proc transpose data=vm_eff01 out=vm_eff01t ;
		by SUBGRP SUBGRPLV AVISITN RESULTN RESULT;
		var est;
		id TRT01PN;
	run;

	data vm_eff01y;
	  length SUBGRP $8 SUBGRPLV $100;
	  format SUBGRP $8. SUBGRPLV $100.;
	  set vm_eff01t;
	run;

	data vm_eff02;
	  length SUBGRPLB $100;
	  set vm_eff01y;
      select(SUBGRP);
         when('AGEGR1') SUBGRPLB = "Age (<65, >=65)";
         when('SEX') SUBGRPLB = "Gender (male, female)";
         when('RACE') SUBGRPLB = "Race";
         when('REGION1') SUBGRPLB = "Region";
         when('WTGR1') SUBGRPLB = "Weight (<median, >=median)";
         when('EASIGR') SUBGRPLB = "EASI<=21 vs >EASI 21";
         when('IGABL') SUBGRPLB = "IGA (3 vs 4)";
         when('PRESISFL') SUBGRPLB = "Previous systemic immunosuppressant use (Yes/No)";
         when('PREVIOFL') SUBGRPLB = "Previous biologic use (Yes/No)";
         when('PREDUPFL') SUBGRPLB = "Previous dupilumab use (Yes/No)";
         when('PRECYCFL') SUBGRPLB = "Previous cyclosporine use (Yes/No)";
         when('PREMETFL') SUBGRPLB = "Previous methotrexate use (Yes/No)";
		 when('BSAGR1') SUBGRPLB = "Baseline BSA (<40% and >=40%)";
         when('NRSGR1') SUBGRPLB = "Baseline NRS (<7 and >=7)";
         when('ADDURGR1') SUBGRPLB = "Duration of AD: (<20 years, >=20 years)";
       end;
	run;
	
  /** Generate the ANCOVA_SUBGRP dataset as designated in the specs;*/
	data ANCOVA_SUBGRP;
	  format SUBGRP SUBGRPLB SUBGRPLV AVISITN RESULTN RESULT _1 _2 _3 _4 _5 _0;
	  length SUBGRP $8 SUBGRPLB $100 SUBGRPLV $100 _1 $15 _2 $15 _3 $15 _4 $15 _5 $15;
	  set vm_eff02(keep=SUBGRP SUBGRPLB SUBGRPLV AVISITN RESULTN RESULT _1 _2 _3 _4 _5 _0);
        if strip(SUBGRPLV)="ZZ" then SUBGRPLV="";
	run;
 %end;
 %else %put exit;
%mend vmANCOVA_SUBGRP;
/*%vmANCOVA_SUBGRP(ADB=ADMI, ANLSET=FAS01FL, SUBGRP=EASIGR, PARAMCD=EASISA, AVISITN_MIN=16,AVISITN_MAX=16, VAR1=PCHG);*/
/*%vmANCOVA_SUBGRP(ADB=ADMI,ANLSET=IFAS01FL,SUBGRP=RACE,PARAMCD=EASISA,AVISITN_MIN=16,AVISITN_MAX=16, VAR1=PCHG);*/
/*%vmANCOVA_SUBGRP(ADB=ADMI,ANLSET=IFAS01FL,SUBGRP=REGION1,PARAMCD=EASISA,AVISITN_MIN=16,AVISITN_MAX=16,VAR1=PCHG);*/
/*%vmANCOVA_SUBGRP(ADB=ADMI,ANLSET=IFAS01FL,SUBGRP=WTGR1,PARAMCD=EASISA,AVISITN_MIN=16,AVISITN_MAX=16,VAR1=PCHG);*/
/*%vmANCOVA_SUBGRP(ADB=ADMI,ANLSET=IFAS01FL,SUBGRP=IGABL,PARAMCD=EASISA,AVISITN_MIN=16,AVISITN_MAX=16,VAR1=PCHG);*/
/*%vmANCOVA_SUBGRP(ADB=ADMI,ANLSET=IFAS01FL,SUBGRP=SEX,PARAMCD=EASISA,AVISITN_MIN=16,AVISITN_MAX=16,VAR1=PCHG);*/
/*%vmANCOVA_SUBGRP(ADB=ADMI,ANLSET=IFAS01FL,SUBGRP=PRECYCFL,PARAMCD=EASISA,AVISITN_MIN=16,AVISITN_MAX=16,VAR1=PCHG);*/
/*%vmANCOVA_SUBGRP(ADB=ADMI,ANLSET=IFAS01FL,SUBGRP=PREMETFL,PARAMCD=EASISA,AVISITN_MIN=16,AVISITN_MAX=16,VAR1=PCHG);*/
/*%vmANCOVA_SUBGRP(ADB=ADMI,ANLSET=IFAS01FL,SUBGRP=PRESISFL,PARAMCD=EASISA,AVISITN_MIN=16,AVISITN_MAX=16,VAR1=PCHG);*/
/*%vmANCOVA_SUBGRP(ADB=ADMI,ANLSET=IFAS01FL,SUBGRP=PREVIOFL,PARAMCD=EASISA,AVISITN_MIN=16,AVISITN_MAX=16,VAR1=PCHG);*/
/*%vmANCOVA_SUBGRP(ADB=ADMI,ANLSET=IFAS01FL,SUBGRP=IGABL,PARAMCD=EASISA,AVISITN_MIN=16,AVISITN_MAX=16,VAR1=PCHG);*/

 GOPTIONS ACCESSIBLE;
 *************************************************************************;
 *        CLIENT:  Kymab                                                 *;
 *        PROTOCOL:  KY1005CT05                                          *;
 *        PURPOSE:  To validate the mANCOVA_TIP macro for production          *;
 *        AUTHOR:  Zhenhua Yuan                                          *;
 *        INPUT FILES:  ADQS, ADMI                                       *;
 *        OUTPUT FILES:  WORK.ANCOVA                                     *;
 *         NOTES:                                                         *;
 *          DATE:  16/DEC/2022                                             *;
 *               Updated 24/MAY/2023 by Ryan Simmons
 *************************************************************************;
 *  Copyright 2022 Thermo Fisher Scientific Inc. All rights reserved.    *;
 *  All trademarks are the property of Thermo Fisher Scientific and its  *;
 *  subsidiaries unless otherwise specified.                             *;
 *************************************************************************;
 
/* Tmp libnames for development/testing - comment out or delete before committing program */
/*libname vout "\\wilbtib\wilbtia03\Kymab KY1005CT05\Users\simmonra\Primary Analysis\TLF\VANCOVA_TIP";*/
/*libname pin "\\wilbtib\wilbtia03\Kymab KY1005CT05\Users\max6\Primary Analysis\TLF_copy\ANCOVA_TIP_New";*/
/*libname statoutr "\\wilbtib\wilbtia03\Kymab KY1005CT05\Users\max6\Primary Analysis\Databases\Analysis Database\StatsOut_Dev";*/
         
     options symbolgen mprint mlogic validvarname=any;
     proc datasets lib = work mt = data kill nolist nowarn;
     run;
     quit;
     %macro vmANCOVA_TIP(ADB=,ANLSET=,PARAMCD=,AVISITN_MIN=,AVISITN_MAX=,VAR1=);
         /**Construct the ADQS or ADMI analysis dataset according to the feed in dataset and parameters;*/
         %if &adb.=ADQS %then %do;
         data &adb.;
           set adb.&adb.;
         run;
         %end;
         
         %if &adb.=ADMI %then %do;
         data &adb.;
           set STATOUTR.&adb.;
         run;
         %end;

         data &adb.01;
           set &adb;
           %if &adb.=ADQS %then %do;
             if &ANLSET.="Y" and PARAMCD="&PARAMCD" and &AVISITN_MIN. <= AVISITN <=&AVISITN_MAX. and ANL01FL="Y";
           %end;
           %else %if &adb.=ADMI %then %do;
             if &ANLSET.="Y" and PARAMCD="&PARAMCD" and &AVISITN_MIN. <= AVISITN <=&AVISITN_MAX.;
           %end;
         run;

         /* If running on blinded side, perform following operation: */
         %if (%index(&g_nickname, _U))=0 %then %do;
            data &adb.01;
                set &adb.01;
                if TRT01PN=5 then do;
                    AVAL = AVAL + 2.2;
                    CHG = AVAL - BASE;
                    PCHG = 100*(CHG)/BASE;
                end;
            run;
         %end;
         
         %if &adb.=ADQS %then %do;
           proc sort data=&adb.01; by AVISITN; run;
         %end;
         
         %else %if &adb.=ADMI %then %do;
           proc sort data=&adb.01; by AVISITN D P IMPNUM ;run;
         %end;
         
         /*Use proc mixed to perform the ANCOVA according to the inferential ANCOVA specs */
         ods output lsmeans=vm_lsmeans diffs=vm_diffs;
         proc mixed data=&adb.01;
           class TRT01PN REGION1 DISSEV;
           model &VAR1.=BASE TRT01PN REGION1 DISSEV;
           %if &adb.=ADQS %then %do;
             by AVISITN;
           %end;
           %else %if &adb.=ADMI %then %do;
             by AVISITN D P IMPNUM ;
           %end;
           lsmeans TRT01PN/pdiff=control('5') cl;
         run;
         
         proc sort data=vm_lsmeans;
           by AVISITN D P TRT01PN ;
         run;
         
         proc sort data=vm_diffs;
           by AVISITN D P TRT01PN;
         run;
         
         /**Build the analysis results dataset for producing the ANCOVA tables for ADQS;*/
         %if &adb.=ADQS %then %do;
           data vm_lsmeans_eff01;
             length result $ 30 est $12;
             set vm_lsmeans;
              resultn=1;
              result="LS Adjusted Mean (SE)[a]";
             est=strip(put(estimate,9.1))||" ("||strip(put(stderr,9.2))||")";
             output;
           run;
        
          data vm_diffs_eff01;
            length result $ 39 est $ 12;
            set vm_diffs;
            resultn=2;
            result="LS Mean Difference vs. Placebo (SE)[a]";
            est=strip(put(estimate,9.1))||" ("||strip(put(stderr,9.2))||")";
            output;
            resultn=3;
            result="95% CI[a]";
            est=strip(put(Lower,9.1))||":"||strip(put(Upper,9.1));
            output;
                                             
            resultn=4;
            result="P-value[a]";
            if probt>=0.0001 then est=strip(put(Probt,9.4));
            else if probt>0 then est="<0.0001";
            output;
          run;
        %end;
        
        /**Build the analysis results dataset for producing the ANCOVA tables for ADMI;*/
        %else %if &adb.=ADMI %then %do;
                ods output ParameterEstimates=vm_lsmeans_eff00;
                proc mianalyze data=vm_lsmeans;
                  modeleffects Estimate;
                  stderr StdErr;
                  by AVISITN D P TRT01PN ;
                run;
                
                data vm_lsmeans_eff01;
                  length result $40 est $12;
                  set vm_lsmeans_eff00;
                  resultn=1;
                  result="LS Adjusted Mean (SE)[a]";
                  est=strip(put(estimate,9.1))||" ("||strip(put(stderr,9.2))||")";
                  output;
                run;
                
                ods output ParameterEstimates=vm_diffs_eff00;
                proc mianalyze data=vm_diffs;
                  modeleffects Estimate;
                  stderr StdErr;
                  by AVISITN D P TRT01PN ;
                run;

                proc sort data=vm_diffs out=vm_diffs_00s;
                   by AVISITN D P TRT01PN IMPNUM;
                run;

               data vm_diffs_01(keep=AVISITN D P TRT01PN Estimate StdErr Probt Lower Upper 
                                rename=(Probt=Probt_ni));
                 set vm_diffs_00s;
                 by AVISITN D P TRT01PN;
                 if first.TRT01PN then output;
               run;

               data vm_diffs_eff00a;
                 merge vm_diffs_eff00(in=a keep=AVISITN D P TRT01PN Estimate StdErr LCLMean UCLMean Probt)
                       vm_diffs_01(in=b keep=AVISITN D P TRT01PN Probt_ni Lower Upper);
                 by AVISITN D P TRT01PN;
                 if a and b;
                 if missing(LCLMean) then LCLMean=Lower;
                 if missing(UCLMean) then UCLMean=Upper;
                 if missing(Probt)   then Probt=Probt_ni;
               run; 

               data vm_diffs_eff01;
                  length result $40 est $ 12;
                  set vm_diffs_eff00a;
                  resultn=2;
                  result="LS Mean Difference vs. Placebo (SE)[a]";
                  est=strip(put(estimate,9.1))||" ("||strip(put(stderr,9.2))||")";
                  output;
                  resultn=3;
                  result="95% CI[a]";
                  est=strip(put(LCLMean,9.1))||": "||strip(put(UCLMean,9.1));
                  output;
                  resultn=4;
                  result="P-value[a]";
                  if probt>=0.0001 then est=strip(put(Probt,9.4));
                  else if probt>0 then est="<0.0001";
                  output;
               run;
        %end;
        
        /**Stack two analysis result dataset to get the dataset for tables in long format;*/
        data vm_eff01;
          format AVISITN D P TRT01PN RESULTN RESULT EST;
          set vm_lsmeans_eff01(keep=AVISITN D P TRT01PN RESULTN RESULT EST)
              vm_diffs_eff01(keep=AVISITN D P TRT01PN RESULTN RESULT EST);
        run;

        proc sort data=vm_eff01;
          by AVISITN D P RESULTN;
        run;

        data vm_eff01;
            set vm_eff01;
            attrib TRT01PC length=$2 label=""; 
            TRT01PC = "_" || strip(put(TRT01PN, 8.));
        run;

        proc transpose data=vm_eff01 out=vm_eff01t; 
            by AVISITN D P RESULTN RESULT;
            var EST;
            id TRT01PC;
        run;
                
        /* Create ANCOVA dataset */
        data ANCOVA;
          format AVISITN D P RESULTN RESULT _1 _2 _3 _4 _5;
          length _1 $15 _2 $15 _3 $15 _4 $15 _5 $15 RESULT $40;
          set vm_eff01t(keep=AVISITN D P RESULTN RESULT _1 _2 _3 _4 _5);
        run;

        /* Create VANCOVA_TIPC dataset */
        proc sort data=vm_diffs_eff00a(keep=AVISITN D P TRT01PN Probt) out=vm_diffs_eff00b; 
            by AVISITN TRT01PN D descending P; 
        run;

        proc transpose data=vm_diffs_eff00b out=VANCOVA_TIPC(drop=_:);
            by AVISITN TRT01PN D;
            id P;
            var Probt; 
        run;

        /* Create VANCOVA_TIP dataset */
        data vm_diffs_eff00c(keep=AVISITN D P TRT01PC Probt);
            set vm_diffs_eff00a;
            attrib TRT01PC length=$2 label=""; 
            TRT01PC = "_" || strip(put(TRT01PN, 8.));
        run;

        proc transpose data=vm_diffs_eff00c  out=vm_diffs_eff00d(drop=_NAME_ _LABEL_);
            by AVISITN D P;
            id TRT01PC;
            var Probt; 
        run;

        proc sort data=vm_diffs_eff00d; 
            by descending p d ; 
        run;
        
        /* Find max d and min p */
        %do i=1 %to 4;
            data d_&i.(keep=AVISITN d_&i.);
                set vm_diffs_eff00d(where=(p=0 & _&i.>=0.05));
                by p; 
                if first.p; 
                    d_&i.=d;
            run;

            data p_&i.(keep=AVISITN p_&i.);
                set vm_diffs_eff00d(where=(d=0 & _&i.>=0.05));
                by d; 
                if first.d;
                    p_&i.=p;
            run;
        %end;

        data VANCOVA_TIP(drop=d_: p_:);
            merge ANCOVA d_1 p_1 d_2 p_2 d_3 p_3 d_4 p_4;
            by AVISITN;
            tipD=.; tipP=.;    
            tipD = max(of d_1 - d_4); 
            tipP = min(of p_1 - p_4);   
        run;

        proc sort data=VANCOVA_TIP; 
            by d descending p resultn; 
        run;

%mend vmANCOVA_TIP;
        
%*vmANCOVA_TIP(ADB=ADMI,ANLSET=FAS01FL,PARAMCD=EASISA,AVISITN_MIN=16,AVISITN_MAX=16,VAR1=PCHG);
/**/
/*/* output/compare: ANCOVA_TIP */*/
/*data vout.VANCOVA_TIP;*/
/*    set VANCOVA_TIP;*/
/*run;*/
/**/
/*proc compare data=pin.ancova_tip compare=vout.VANCOVA_TIP listall */
/*out=diff outbase outcomp outdiff outnoequal criterion = 0.0000000001;*/
/*run;*/
/**/
/*%avu_compare_out(*/
/*avu_summary_outlib=here, */
/*avu_summary_dsname=avu_summary_dataset, */
/*deliverable_id=ancova_tip,*/
/*max_attempts=60, */
/*loop_delay_sec=1*/
/*);*/
/**/
/*/* output/compare: ANCOVA_TIPC */*/
/*data vout.VANCOVA_TIPC;*/
/*    set VANCOVA_TIPC;*/
/*run;*/
/**/
/*proc compare data=pin.ancova_tipc compare=VANCOVA_TIPC listall */
/*out=diff outbase outcomp outdiff outnoequal criterion = 0.0000000001;*/
/*run;*/
/**/
/*%avu_compare_out(*/
/*avu_summary_outlib=here, */
/*avu_summary_dsname=avu_summary_dataset, */
/*deliverable_id=ancova_tipc,*/
/*max_attempts=60, */
/*loop_delay_sec=1*/
/*);*/

/* GOPTIONS ACCESSIBLE;*/
 *************************************************************************;
 *        CLIENT:  Kymab                                                 *;
 *        PROTOCOL:  KY1005CT05                                          *;
 *        PURPOSE:  To validate the ANOVA macro for production          *;
 *        AUTHOR Leo Chapman                                          *;
 *        INPUT FILES:  ADQS, ADMI                                       *;
 *        OUTPUT FILES:  WORK.ANOVA                                     *;
 *   	  NOTES:                                                         *;
 *		  DATE:  05/JAN/2023                                             *;
 *************************************************************************;
 *  Copyright 2023 Thermo Fisher Scientific Inc. All rights reserved.    *;
 *  All trademarks are the property of Thermo Fisher Scientific and its  *;
 *  subsidiaries unless otherwise specified.                             *;
 *************************************************************************;
         
         
/*     options symbolgen mprint mlogic;*/



	 *create a template data set first add table ids;

data template1;
	length TID $200;

	 TID="T1402080102";
	 output;
	 TID="T14020801050101";
	 output;
	 TID="T14020801050102";
	 output;
	 TID="T14020801050201";
	 output;
	 TID="T14020801050202";
	 output;
	 TID="T14020801050301";
	 output;
	 TID="T14020801050302";
	 output;
run;

*then add pop and popn;

data template2;
	set template1;

	length pop $200;

	pop="BLIG01FL" ;
	popn=1;
	output;

	pop="BL1301FL" ;
	popn=2;
	output;

	pop="BL2201FL" ;
	popn=3;
	output;

	pop="BL1701FL";
	popn=4;
	output; 

	pop="BLTA01FL";
	popn=5;
	output;
run;

*bring in treatments;
	


%macro vmANOVA(ANLSET=,PARAMCD=,VAR1= ,subgroup = ,table=);
         /**Construct the ADBM Dataset analysis dataset*/
         

	 	data adbm;
			set adb.adbm;

			where lnaval ne . and anl01fl='Y' and paramcd in ('IGE' , 'IL13' , 'IL22' ,'IL17A' , 'TARC') and AVISITN=2;

			call symput('Exist','N');
		run;

	

		data adbm1;
			set adbm;
			where paramcd="&PARAMCD" and &ANLSET="Y";

			if _N_ =2 then do;
				call symput('Exist','Y');
			end;
		run;

%if &table = T1402080102 and &Exist = Y %then %do;
	%if &subgroup eq BLANK %then %do;


ods trace on;
	ods output ModelANOVA=trtest;
	proc glm data=adbm1;
		class trt01pn(ref="5") ; 
		model base = trt01pn;
	run;
	



	ods output ModelANOVA=grpest;
	proc glm  data=adbm1;
		class ptgrp01n(ref="2") ; 
		model base = ptgrp01n ;
	run;
	%end;

	%else %do;
	proc sort data=adbm1;
		by trt01pn;
	run;

	ods output ModelANOVA=trtest;
	proc glm data=adbm1;
		by trt01pn;

		class &subgroup;

		model base=&subgroup;

	run;


	proc sort data=adbm1;
		by ptgrp01n;
	run;

	ods output ModelANOVA=grpest;
	proc glm data=adbm1;
		by ptgrp01n;

		class &subgroup;

		model base=&subgroup;

	run;

	ods trace off;

	%end;
%end;



%if &exist = N %then %do;
	
data fin&table.&paramcd.&anlset.&subgroup;
	subgroup="&subgroup";
	&paramcd="&paramcd";
	TID="&Table";
	anlset="&ANLSET";
	empty='Y';

	trtn=1;
	output;

	trtn=2;
	output;

	trtn=3;
	output;

	trtn=4;
	output;

	trtn=5;
	output;

	trtn=6;
	output;
	run;
%end;

%if &exist = Y %then %do;
		
	data prep&table.&paramcd.&anlset.&subgroup;
		set trtest grpest;
/*		where Parameter not in ('Intercept' , 'Scale');*/
/**/
/*		if Parameter = 'TRT01PN' then do;*/
/*			if level1 ne '5';*/
/**/
/*			trtn= input(level1,best.);*/
/*		end;*/
/**/
/*		if Parameter = 'PTGRP01N' then do;*/
/*			if level1 ne '2';*/
/**/
/*			trtn= 5;*/
/*		end;*/
/**/
/*		keep ProbChiSq  trtn;*/
	run;

%end;

%mend vmANOVA;

	 *no data currently so don't need to do subgroup also param not programmed so no need to do other anlset;
/*	 %vmanova(anlset=BLIG01FL,paramcd=ALTIGE,VAR1=,subgroup=,table=T1402080102);*/
/**/
/*	 %vmanova(anlset=BLIG01FL,paramcd=IL13,VAR1=,subgroup=,table=T1402080102);*/

	 %vmanova(anlset=BL1301FL,paramcd=IL13,VAR1=,subgroup=BLANK,table=T1402080102);

	 %let anlset=BL1301FL;
%let paramcd=IL13;
%let VAR1=;
%let subgroup=BLANK;
%let table=T1402080102;


%macro glm(outname=,ref=,trtvar=);

ods output ModelANOVA=&outname;
	proc glm data=adbm1;
		class &trtvar(ref="&ref"); 
		model base = &trtvar;
	run;

%mend;

ods trace on;
%glm(outname=trtest,ref=5,trtvar=trt01pn);
%glm(outname=grpest,ref=2,trtvar=ptgrp01n);
	
data adbm_resp_EASI;
	set adb.adbm;
	where paramcd='EASIS' and ANL01FL='Y' and BM01fl='Y';
run;

*find subjects who are responders;

data adbm_respcrit1_EASI;
	set adbm_resp_EASI;
	where crit1fl='Y';

	by usubjid;
	if first.usubjid;

	resp='Y';

	keep usubjid resp;
run;

data adbm_resp_EASI_M;
	set adb.adbm;
	where paramcd='EASIS' and ANL01FL='Y' and MBM01fl='Y';
run;


data adbm_respcrit3_EASI_M;
	set adbm_resp_EASI_M;
	where crit3fl='Y';

	by usubjid;
	if first.usubjid;

	resp='Y';

	keep usubjid resp;
run;


%let anlset=BL1301FL;
%let paramcd=IL13;
%let respset=adbm_respcrit1_EASI;
%macro anova_resp(ANLSET=,PARAMCD=,VAR1= ,subgroup = ,table= ,respset=);
         /**Construct the ADBM Dataset analysis dataset*/
         

	 	data adbm;
			set adb.adbm;

			where lnaval ne . and anl01fl='Y' and paramcd in ('IGE' , 'IL13' , 'IL22' ,'IL17A' , 'TARC') and AVISITN=2;

			call symput('Exist','N');
		run;

	

		data adbm1;
			set adbm;
			where paramcd="&PARAMCD" and &ANLSET="Y";

			if _N_ =2 then do;
				call symput('Exist','Y');
			end;
		run;

		*add response data;

		data adbm2;
			merge adbm1(in=a) &Respset;
			by usubjid;
			if a;

			if resp='' then resp='N';
		run;



%if  &Exist = Y %then %do;
	%if &subgroup eq BLANK %then %do;


proc sort data=adbm2;
		by trt01pn;
	run;

ods trace on;
	ods output ModelANOVA=trtest;

proc glm data=adbm2;
		by trt01pn;
		class resp; 
		model base = resp;
	run;
	
	proc sort data=adbm2;
		by ptgrp01n;
	run;

	ods output ModelANOVA=grpest;

proc glm data=adbm2;
		by ptgrp01n;
		class resp; 
		model base = resp;
	run;



	ods output ModelANOVA=grpest;
	proc glm  data=adbm1;
		class ptgrp01n(ref="2") ; 
		model base = ptgrp01n ;
	run;
	%end;
/**/
/*	%else %do;*/
/*	proc sort data=adbm1;*/
/*		by trt01pn;*/
/*	run;*/
/**/
/*	ods output ModelANOVA=trtest;*/
/*	proc glm data=adbm1;*/
/*		by trt01pn;*/
/**/
/*		class &subgroup;*/
/**/
/*		model base=&subgroup;*/
/**/
/*	run;*/
/**/
/**/
/*	proc sort data=adbm1;*/
/*		by ptgrp01n;*/
/*	run;*/
/**/
/*	ods output ModelANOVA=grpest;*/
/*	proc glm data=adbm1;*/
/*		by ptgrp01n;*/
/**/
/*		class &subgroup;*/
/**/
/*		model base=&subgroup;*/
/**/
/*	run;*/
/**/
/*	ods trace off;*/
/**/
/*	%end;*/
%end;



%if &exist = N %then %do;
	
data fin&table.&paramcd.&anlset.&subgroup;
	subgroup="&subgroup";
	&paramcd="&paramcd";
	TID="&Table";
	anlset="&ANLSET";
	empty='Y';

	trtn=1;
	output;

	trtn=2;
	output;

	trtn=3;
	output;

	trtn=4;
	output;

	trtn=5;
	output;

	trtn=6;
	output;
	run;
%end;

%if &exist = Y %then %do;
		
	data prep&table.&paramcd.&anlset.&subgroup;
		set trtest grpest;
/*		where Parameter not in ('Intercept' , 'Scale');*/
/**/
/*		if Parameter = 'TRT01PN' then do;*/
/*			if level1 ne '5';*/
/**/
/*			trtn= input(level1,best.);*/
/*		end;*/
/**/
/*		if Parameter = 'PTGRP01N' then do;*/
/*			if level1 ne '2';*/
/**/
/*			trtn= 5;*/
/*		end;*/
/**/
/*		keep ProbChiSq  trtn;*/
	run;

%end;

%mend vmANOVA_resp;

proc npar1way anova data=adbm1;
	class trt01pn;
	var base;
run; 

proc npar1way anova data=adbm1;
	class PTGRP01N;
	var base;
	output out=data;
run; 

*************************************************************************
*        CLIENT:  Kymab
*      PROTOCOL:  KY1005CT05
*       PURPOSE:  MMRM
*        AUTHOR:  
*   INPUT FILES:  ADQS
*  OUTPUT FILES:  WORK.MMRM
*   	  NOTES:  
*		   DATE:  02/DEC/2022
************************************************************************* 
*		EXAMPLE:
*		
*	*		%vmmrm(ADB=ADQS, ANLSET=FAS01FL, PARAMCD=EASISA, AVISITN_MIN=2, AVISITN_MAX=9, VAR1=PCHG)
************************************************************************* 
*  Copyright 2022 Thermo Fisher Scientific Inc. All rights reserved.
*  All trademarks are the property of Thermo Fisher Scientific and its
*  subsidiaries unless otherwise specified. 
*************************************************************************;
*** Cleare log and output;
DM "log ; clear;";


*** Clear work datasets ***;
proc datasets library=work kill;
run; 
quit;

options mprint;
/*to be dropped*/

/*libname adb "\\wilbtib\wilbtia03\Kymab KY1005CT05\Interim Analysis\Databases\Analysis Database\Output";

data adsl;	
	set adb.adsl(keep=usubjid);
	by usubjid ;
run;*/
/*libname adb "\\wilbtib\wilbtia03\Kymab KY1005CT05\Unversioned Files";*/

%macro vmmrm(ANLSET=,PARAMCD=,AVISITN=,VAR1=);

%let adb=ADQS;

data &adb.;
	set adb.&adb.;
	by usubjid;
	trtpn=trt01pn;
run;

data &adb.1;
	set &adb.;
	if &anlset.="Y" and paramcd="&paramcd." and  trtp ne ''  and  2<=avisitn<=&avisitn. and anl01fl="Y";
		trtpn=trt01pn;
run;

proc sort data=&adb.1; by avisitn ; run;

ods output lsmeans=lsmeans diffs=diffs(where=(_TRTPN=5 and AVISITN=_AVISITN ));

proc mixed data=&adb.1 method=reml;
    class TRTPN(ref='5') AVISITN USUBJID REGION1 DISSEV;
    model &var1. =BASE TRTPN AVISITN TRTPN*AVISITN REGION1 DISSEV /ddfm=kr solution;
    repeated AVISITN/ type=UN subject=usubjid;
    lsmeans TRTPN AVISITN TRTPN*AVISITN /diff cl alpha = 0.05;
    
run;

 
proc sort data=lsmeans; by avisitn trtpn; run;
proc sort data=diffs; by avisitn trtpn; run;


data out0;
	format stat $12. result $30.;
	set lsmeans(in=a) diffs(in=b);
	if a then do;
		resultn=1;
		result="LS Adjusted Mean (SE)[a]";
		stat=strip(put(estimate,9.1))||" ("||strip(put(stderr,9.2))||")";
		output;
	end;
	if b then do;
		resultn=2;
		result="LS Mean Difference vs. Placebo (SE)[a]";
		stat=strip(put(estimate,9.1))||" ("||strip(put(stderr,9.2))||")";
		output;
		resultn=3;
		result="95% CI[a]";
		stat=strip(put(Lower,9.1))||": "||strip(put(Upper,9.1));
		output;
		resultn=4;
		result="P-value[a]";
		if probt>=0.0001 then stat=strip(put(Probt,9.4));
			else if 0<=probt then stat="<0.0001";
		output;
	end;
run;

/*no p-values??*/
proc sort data=out0 ; by avisitn resultn;where trtpn>0;  run;

proc transpose data=out0 out=out1; var stat; by avisitn resultn result; id trtpn; run;

data vmmrm;
	retain AVISITN RESULTN RESULT _1 _2 _3 _4 _5;
	keep AVISITN RESULTN RESULT _1 _2 _3 _4 _5;
/*	set out1;*/
	set out1(where=(avisitn=&avisitn.));
run;


%mend vmmrm;


**%vmmrm(ADB=ADQS,ANLSET=FAS01FL,PARAMCD=EASISC,AVISITN_MIN=2,AVISITN_MAX=16,VAR1=PCHG);
**%vmmrm(ADB=ADQS,ANLSET=FAS01FL,PARAMCD=EASISC,AVISITN_MIN=2,AVISITN_MAX=24,VAR1=PCHG);
*%vmmrm(ANLSET=FAS01FL,PARAMCD=EASISC, AVISITN=24,VAR1=PCHG);

*************************************************************************
*        CLIENT:  Kymab, a Sanofi Company
*      PROTOCOL:  KY1005-CT05/DRI17366
*       PURPOSE:  Produce inferential dataset ADMI
*   INPUT FILES:  ADB - ADSL, ADQS, ADEASI
*  OUTPUT FILES:  statoutw.ADMI
*   USAGE NOTES:  For mANCOVA, mANCOVA_SUBGRP, mANCOVA_TIP 
************************************************************************* 
*  Copyright 2022 Thermo Fisher Scientific Inc. All rights reserved.
*  All trademarks are the property of Thermo Fisher Scientific and its
*  subsidiaries unless otherwise specified. 
*************************************************************************;

proc datasets lib = work mt = data kill nolist nowarn;
run;
quit;

/* Unblinded */
%if (%index(&g_nickname, _U))>0 %then %do;
	           %let MAXD=35;
               %let MINP=-35;
			   %let INCREMENT=3.5;
%end;

/* Blinded */
%if (%index(&g_nickname, _U))=0 %then %do;
	           %let MAXD=2;
               %let MINP=-2;
               %let INCREMENT=0.2;
%end;

data adsl;
	set adb.adsl;
run;

data adsl0;
	set adsl;
	if randdt ne .;
	if /*i*/fas01fl="Y"; /*!*/
run;

data adqs;
	set adb.adqs;
run;

data adeasi;
	set adb.adeasi;
run;

data admi_pre;
run;

%macro admi(PARAMCD=,AVISITN=,D=,P=);

data adqs0;
	set adqs adeasi;
	if /*i*/fas01fl="Y" /*!*/ and paramcd="&paramcd." and anl01fl="Y" and 0<=avisitn<=24;
run;

data wocf;
	set adqs0;
	if avisitn=&avisitn.;
	**keep usubjid dtype;
	rename aval=avalwocf chg=chgwocf;
run;

proc transpose data=adqs0 out=adqs0_tr0;
	by usubjid base;
	id avisitn;
	var /*aval*/ pchg;
run;

data adqs_tr1;
	merge adqs0_tr0 adsl0(keep=usubjid trt01pn dissev region1) wocf(keep=usubjid dtype avalwocf chgwocf);
	by usubjid;
run;

proc sort data=adqs_tr1; by usubjid dtype trt01pn dissev region1; run;

data adqs_wocf adqs_mi;
	set adqs_tr1;
	if dtype="WOCF" and (_&avisitn. ne . or (_&avisitn.=. and base=0)) then output adqs_wocf;
		else if (dtype="" and _&avisitn. ne .) or _&avisitn.=. then output adqs_mi;
run;

proc mi data=adqs_mi seed=293874 /*MINIMUM=0*/ nimpute=40 out=admi0;
	mcmc impute=monotone;
	var /*_0*/ base _2 _4 _8 _12 _16 
	%if &avisitn=24 %then %do;
		_20 _24
	%end;
	;
	**by trt01pn /*dissev region1*/;
run;

data admi1;
	set admi0;
	/*if .<_0<0 then _0=0;
	if .<_2<0 then _2=0;
	if .<_4<0 then _4=0;
	if .<_8<0 then _8=0;
	if .<_12<0 then _12=0;
	if .<_16<0 then _16=0;
	%if &avisitn=24 %then %do;
	if .<_20<0 then _20=0;
	if .<_24<0 then _24=0;
	%end;*/
run;

proc sort data=admi1; by _imputation_ usubjid; run;

proc mi data=admi1 nimpute=1 seed=293874 out=admi2;
	by _imputation_;
	class trt01pn dissev region1;
	monotone method=reg;
	%if &avisitn.=16 %then %do;
	var trt01pn region1 dissev /*_0*/ base _2 _4 _8 _12 _16;
	%end;
	%else %if &avisitn.=24 %then %do;
	var trt01pn region1 dissev /*_0*/ base _2 _4 _8 _12 _16 _20 _24;
	%end;
run;
/*_0 is the baseline value*/
proc sort data=admi2; by usubjid; run;
proc sort data=adqs_tr1; by usubjid; run;

data admi3;
	length avisit param $200. dtype paramcd $8.;
	merge admi2(in=a) adqs_tr1(keep=usubjid _&avisitn. in=b where=(x=.) rename=(_&avisitn.=x)) /*adqs_tr1(keep=usubjid base)*/;
	by usubjid;
	if a;
	if b then DTYPE="MI";
	**AVAL=max(_&avisitn.,0); /*!*/
	**if aval ne . and base ne . then CHG=AVAL-BASE;
	PCHG=_&avisitn.;
	if base not in (. 0) then CHG=PCHG*BASE/100;
		else chg=.;
	if base not in (. 0) then AVAL=CHG+BASE;
		else aval=.;
	**if aval ne . and base ne . then PCHG=100*(AVAL-BASE)/BASE;
	%if &paramcd.=EASISA %then %do;
		PARAMCD="EASISA";
		PARAM="EASI-Score (WOCF)";
	%end;
	%else %if &paramcd.=EASIS %then %do;
		PARAMCD="EASIS";
		PARAM="EASI-Score";
	%end;
	%else %if &paramcd.=EASI01A %then %do;
		PARAMCD="EASI01A";
		PARAM='EASI-Q1 EASI Head & Neck Area (WOCF)';
	%end;
	%else %if &paramcd.=EASI02A %then %do;
		PARAMCD="EASI02A";
		PARAM='EASI-Q2 EASI Upper Ext Area (WOCF)';
	%end;
	%else %if &paramcd.=EASI03A %then %do;
		PARAMCD="EASI03A";
		PARAM='EASI-Q3 EASI Trunk Area (WOCF)';
	%end;
	%else %if &paramcd.=EASI04A %then %do;
		PARAMCD="EASI04A";
		PARAM='EASI-Q4 EASI Lower Ext Area (WOCF)';
	%end;
	%else %if &paramcd.=EASI101A %then %do;
		PARAMCD="EASI101A";
		PARAM='EASI-Q1A EASI Head & Neck Erythema (WOCF)';
	%end;
	%else %if &paramcd.=EASI102A %then %do;
		PARAMCD="EASI102A";
		PARAM='EASI-Q1B EASI Head & Neck Edema/Induration/Papulation (WOCF)';
	%end;
	%else %if &paramcd.=EASI103A %then %do;
		PARAMCD="EASI103A";
		PARAM='EASI-Q1C EASI Head & Neck Excoriation (WOCF)';
	%end;
	%else %if &paramcd.=EASI104A %then %do;
		PARAMCD="EASI104A";
		PARAM='EASI-Q1D EASI Head & Neck Lichenification (WOCF)';
	%end;
	%else %if &paramcd.=EASI201A %then %do;
		PARAMCD="EASI201A";
		PARAM='EASI-Q2A EASI Upper Ext Erythema (WOCF)';
	%end;
	%else %if &paramcd.=EASI202A %then %do;
		PARAMCD="EASI202A";
		PARAM='EASI-Q2B EASI Upper Ext Edema/Induration/Papulation (WOCF)';
	%end;
	%else %if &paramcd.=EASI203A %then %do;
		PARAMCD="EASI203A";
		PARAM='EASI-Q2C EASI Upper Ext Excoriation (WOCF)';
	%end;
	%else %if &paramcd.=EASI204A %then %do;
		PARAMCD="EASI204A";
		PARAM='EASI-Q2D EASI Upper Ext Lichenification (WOCF)';
	%end;
	%else %if &paramcd.=EASI301A %then %do;
		PARAMCD="EASI301A";
		PARAM='EASI-Q3A EASI Trunk Erythema (WOCF)';
	%end;
	%else %if &paramcd.=EASI302A %then %do;
		PARAMCD="EASI302A";
		PARAM='EASI-Q3B EASI Trunk Edema/Induration/Papulation (WOCF)';
	%end;
	%else %if &paramcd.=EASI303A %then %do;
		PARAMCD="EASI303A";
		PARAM='EASI-Q3C EASI Trunk Excoriation (WOCF)';
	%end;
	%else %if &paramcd.=EASI304A %then %do;
		PARAMCD="EASI304A";
		PARAM='EASI-Q3D EASI Trunk Lichenification (WOCF)';
	%end;
	%else %if &paramcd.=EASI401A %then %do;
		PARAMCD="EASI401A";
		PARAM='EASI-Q4A EASI Lower Ext Erythema (WOCF)';
	%end;
	%else %if &paramcd.=EASI402A %then %do;
		PARAMCD="EASI402A";
		PARAM='EASI-Q4B EASI Lower Ext Edema/Induration/Papulation (WOCF)';
	%end;
	%else %if &paramcd.=EASI403A %then %do;
		PARAMCD="EASI403A";
		PARAM='EASI-Q4C EASI Lower Ext Excoriation (WOCF)';
	%end;
	%else %if &paramcd.=EASI404A %then %do;
		PARAMCD="EASI404A";
		PARAM='EASI-Q4D EASI Lower Ext Lichenification (WOCF)';
	%end;
	AVISITN=&avisitn.;
	AVISIT="Week"||" &avisitn.";
	D=&d.;
	P=&p.;
	rename _imputation_=IMPNUM;
	/*if DTYPE="MI" and trt01pn in (1 2 3 4) then do;aval=aval+d;CHG=AVAL-BASE;PCHG=100*(AVAL-BASE)/BASE;END;
		else if DTYPE="MI" and trt01pn=5 then do;aval=aval+p;CHG=AVAL-BASE;PCHG=100*(AVAL-BASE)/BASE;END; */
	/*if .<aval<0 then do; aval=0;CHG=AVAL-BASE;PCHG=100*(AVAL-BASE)/BASE;END;*/
run;

data adqs_wocf1;
	set adqs_wocf;
	%do i=1 %to 40;
		impnum=&i.;
		d=&d.;
		p=&p.;
		output;
	%end;
run;

data admi4;
	set admi3 adqs_wocf1(in=b);
	if b then do;
		/*aval=_&avisitn.;
		chg=aval-base;
		pchg=100*(AVAL-BASE)/BASE;*/
		PCHG=_&avisitn.;
		if chgwocf ne . then chg=chgwocf;
			else if base ne 0 then CHG=PCHG*BASE/100;
				else if base=0 then CHG=.;
		if avalwocf ne . then aval=avalwocf;
			else if base ne 0 then AVAL=CHG+BASE;
				else if base=0 then aval=.;
		avisitn=&avisitn.;
		avisit="Week "||strip(put(&avisitn.,8.));
		paramcd="&paramcd.";
		if paramcd="EASISA" then param="EASI-Score (WOCF)";
			else if paramcd="EASIS" then param="EASI-Score";
				else if paramcd="EASI01A" then PARAM='EASI-Q1 EASI Head & Neck Area (WOCF)';
					else if paramcd="EASI02A" then PARAM='EASI-Q2 EASI Upper Ext Area (WOCF)';
						else if paramcd="EASI03A" then PARAM='EASI-Q3 EASI Trunk Area (WOCF)';
							else if paramcd="EASI04A" then PARAM='EASI-Q4 EASI Lower Ext Area (WOCF)';
								else if paramcd="EASI101A" then PARAM='EASI-Q1A EASI Head & Neck Erythema (WOCF)';
									else if paramcd="EASI102A" then PARAM='EASI-Q1B EASI Head & Neck Edema/Induration/Papulation (WOCF)';
										else if paramcd="EASI103A" then PARAM='EASI-Q1C EASI Head & Neck Excoriation (WOCF)';
											else if paramcd="EASI104A" then PARAM='EASI-Q1D EASI Head & Neck Lichenification (WOCF)';
												else if paramcd="EASI201A" then PARAM='EASI-Q2A EASI Upper Ext Erythema (WOCF)';
													else if paramcd="EASI202A" then PARAM='EASI-Q2B EASI Upper Ext Edema/Induration/Papulation (WOCF)';
														else if paramcd="EASI203A" then PARAM='EASI-Q2C EASI Upper Ext Excoriation (WOCF)';
															else if paramcd="EASI204A" then PARAM='EASI-Q2D EASI Upper Ext Lichenification (WOCF)';
																else if paramcd="EASI301A" then PARAM='EASI-Q3A EASI Trunk Erythema (WOCF)';
																	else if paramcd="EASI302A" then PARAM='EASI-Q3B EASI Trunk Edema/Induration/Papulation (WOCF)';
																		else if paramcd="EASI303A" then PARAM='EASI-Q3C EASI Trunk Excoriation (WOCF)';
																			else if paramcd="EASI304A" then PARAM='EASI-Q3D EASI Trunk Lichenification (WOCF)';
																				else if paramcd="EASI401A" then PARAM='EASI-Q4A EASI Lower Ext Erythema (WOCF)';
																					else if paramcd="EASI402A" then PARAM='EASI-Q4B EASI Lower Ext Edema/Induration/Papulation (WOCF)';
																						else if paramcd="EASI403A" then PARAM='EASI-Q4C EASI Lower Ext Excoriation (WOCF)';
																							else if paramcd="EASI404A" then PARAM='EASI-Q4D EASI Lower Ext Lichenification (WOCF)';
	end;
run;

data admi_pre;
	length studyid $20.;
	retain STUDYID USUBJID D P AVISIT AVISITN PARAM PARAMCD DTYPE IMPNUM AVAL BASE CHG PCHG trt01pn;
	keep STUDYID USUBJID D P AVISIT AVISITN PARAM PARAMCD DTYPE IMPNUM AVAL BASE CHG PCHG trt01pn;
	set admi_pre admi4;
	if impnum=. then delete;
	STUDYID="KY1005CT05";
run;

%mend admi;

%admi(PARAMCD=EASISA,AVISITN=16,D=0,P=0);
%admi(PARAMCD=EASISA,AVISITN=24,D=0,P=0);
%admi(PARAMCD=EASIS,AVISITN=16,D=0,P=0);
%admi(PARAMCD=EASIS,AVISITN=24,D=0,P=0);

%admi(PARAMCD=EASI01A,AVISITN=24,D=0,P=0);
%admi(PARAMCD=EASI02A,AVISITN=24,D=0,P=0);
%admi(PARAMCD=EASI03A,AVISITN=24,D=0,P=0);
%admi(PARAMCD=EASI04A,AVISITN=24,D=0,P=0);
%admi(PARAMCD=EASI101A,AVISITN=24,D=0,P=0);
%admi(PARAMCD=EASI102A,AVISITN=24,D=0,P=0);
%admi(PARAMCD=EASI103A,AVISITN=24,D=0,P=0);
%admi(PARAMCD=EASI104A,AVISITN=24,D=0,P=0);
%admi(PARAMCD=EASI201A,AVISITN=24,D=0,P=0);
%admi(PARAMCD=EASI202A,AVISITN=24,D=0,P=0);
%admi(PARAMCD=EASI203A,AVISITN=24,D=0,P=0);
%admi(PARAMCD=EASI204A,AVISITN=24,D=0,P=0);
%admi(PARAMCD=EASI301A,AVISITN=24,D=0,P=0);
%admi(PARAMCD=EASI302A,AVISITN=24,D=0,P=0);
%admi(PARAMCD=EASI303A,AVISITN=24,D=0,P=0);
%admi(PARAMCD=EASI304A,AVISITN=24,D=0,P=0);
%admi(PARAMCD=EASI401A,AVISITN=24,D=0,P=0);
%admi(PARAMCD=EASI402A,AVISITN=24,D=0,P=0);
%admi(PARAMCD=EASI403A,AVISITN=24,D=0,P=0);
%admi(PARAMCD=EASI404A,AVISITN=24,D=0,P=0);

/* admi_pre: MI results when PARAMCD in (EASISA, EASIS) and AVISITN=16/24 before shift (D=0,P=0) */ 
proc sort data=admi_pre; by STUDYID USUBJID PARAMCD AVISIT trt01pn IMPNUM D P; run;

/* Delta - Shift in Kymab arm and P - Shift in Placebo arm */
data admi_pre1;
	set admi_pre;
	by STUDYID USUBJID PARAMCD AVISIT trt01pn IMPNUM; 
    output;
    if PARAMCD ="EASISA" and AVISITN=16 then do;
        do D= 0 to &MAXD. by &INCREMENT.;
            do P= &MINP. to 0 by &INCREMENT. ; P=round(P, 0.01);        
			output;		
            end;
        end;
	end;
run;

data admi_pre2;
    set admi_pre1;
	if dtype="MI" then do;
		if trt01pn in (1 2 3 4) and d ne 0 then do;
			aval=aval+d;
			CHG=AVAL-BASE;
			if base not in (. 0) then PCHG=100*(AVAL-BASE)/BASE;
		end; 
    	else if trt01pn=5 and p ne 0 then do;
			aval=aval+p;
			CHG=AVAL-BASE;
			if base not in (. 0) then PCHG=100*(AVAL-BASE)/BASE;
		end; 
	end;
run;

proc sort data=admi_pre2 out=admi nodupkey; by STUDYID USUBJID PARAMCD AVISIT DTYPE D P IMPNUM trt01pn; run;

* Merge with the common var from ADSL and output to the STATOUTW LIB;
%adam_dataset_update(
     ds=ADMI,
     libin=work,
     libout=STATOUTW,
     adsllib=adb,
     addcomvar=Y,
     addseq=,
     dropinfmt=Y,
     mapspecfile=Kymab KY1005CT05 ADaM Specs.xlsm,
     maploc=&G_PROJECTPATH.&G_TOPLEVEL.\Documents\Specs\,
     debug=N
  );

*************************************************************************
*        CLIENT:  Kymab, a Sanofi Company
*      PROTOCOL:  KY1005-CT05/DRI17366
*       PURPOSE:  Produce analysis dataset ADTTE
*   INPUT FILES:  ADB - ADSL, ADQS, ADCM
*  OUTPUT FILES:  output.ADTTE
*   USAGE NOTES:  
************************************************************************* 
*  Copyright 2022 Thermo Fisher Scientific Inc. All rights reserved.
*  All trademarks are the property of Thermo Fisher Scientific and its
*  subsidiaries unless otherwise specified. 
*************************************************************************;

proc datasets lib = work mt = data kill nolist nowarn;
run;
quit;

**Assign global macro variable DSETNAME to reflect the name of the final ADaM dataset**;
%let DSETNAME=ADTTE;

%include 'amacros.sas';


* RESAL2DT;
proc sort data=adb.adcm out=resal2dt (keep=usubjid astdt rename=(astdt=resal2dt));
 by usubjid astdt;
 where RESCUE='Y' and astdt ne . and astdt>=rand24dt;
run;
data resal2dt;
 set resal2dt;
 by usubjid resal2dt;
 if first.usubjid;
run;

* RESPR2DT;
proc sort data=adb.adcm out=respr2dt (keep=usubjid astdt rename=(astdt=respr2dt));
 by usubjid astdt;
 where IMPACT='Y' and astdt ne . and astdt>=rand24dt;
run;
data respr2dt;
 set respr2dt;
 by usubjid respr2dt;
 if first.usubjid;
run;


* Merge with ADQS;
data QS;
   merge adb.adqs(where=(paramcd in ('EASIS' 'IGA01')) in=a) resal2dt respr2dt;
   by usubjid;
   if a;

   format startdt mindate1 mindate2 trtranddt mindate2_lempt mindate1_lempt date9.;

   if resal2dt ne . then resal2dt1 = resal2dt + 1;
   if respr2dt ne . then respr2dt1 = respr2dt + 1;
   if eosdt ne . then eosdt1 = eosdt + 1;
   if cutdt ne . then cutdt1 = cutdt + 1;
   if paramcd="EASIS" and LEASI2DT ne . then lempt2dt1 = LEASI2DT + 1;
   if paramcd="IGA01" and LIGA2DT ne . then lempt2dt1 = LIGA2DT + 1;
   startdt = rand24dt;
   if nmiss(resal2dt1, respr2dt1, eosdt1, cutdt1) ne 4 then mindate1 = min(resal2dt1, respr2dt1, eosdt1, cutdt1);
   if nmiss(resal2dt1, respr2dt1, lempt2dt1, cutdt1) ne 4 then mindate1_lempt = min(resal2dt1, respr2dt1, lempt2dt1, cutdt1);
   if nmiss(resal2dt1, respr2dt1, eosdt1) ne 3 then mindate2 = min(resal2dt1, respr2dt1, eosdt1);
   if nmiss(resal2dt1, respr2dt1, lempt2dt1) ne 3 then mindate2_lempt = min(resal2dt1, respr2dt1, lempt2dt1);
   if trtsdt ne . then trtranddt = trtsdt;
   else trtranddt = randdt;
run;

* Unique row per subject;
proc sort data=qs out=qs_subj_easi (keep=usubjid mindate1 startdt mindate1_lempt trtranddt) nodupkey;
   by usubjid mindate1; where paramcd="EASIS";
run;
proc sort data=qs out=qs_subj_iga (keep=usubjid mindate1 startdt mindate1_lempt trtranddt) nodupkey;
   by usubjid mindate1; where paramcd="IGA01";
run;



* Selection from ADQS;
   * For Leasi75;
   data QS1_LEASI75;
      set qs;
   	where PARAMCD="EASIS" and .<rand24dt<adt and PCHGCA2N=2 and .<adt<mindate2;
   	keep usubjid adt startdt trtranddt; 	
   run;
   proc sort data=qs1_LEASI75;by usubjid adt ;run;
/*   LEASI75B;*/
   data QS1_LEASI75B;
      set qs;
   	where PARAMCD="EASIS" and .<rand24dt<adt and PCHGCA2N=2 and .<adt<mindate2_lempt;
   	keep usubjid adt startdt trtranddt; 	
   run;
   proc sort data=qs1_LEASI75B;by usubjid adt ;run;
   * For Liga01;
   data QS1_LIGA01;
      set qs;
   	where PARAMCD="IGA01" and .<rand24dt<adt and AVALCA1N=2 and .<adt<mindate2;
   	keep usubjid adt startdt trtranddt; 	
   run;
   proc sort data=QS1_LIGA01;by usubjid adt ;run;
/* LIGA01B;*/
   data QS1_LIGA01B;
      set qs;
   	where PARAMCD="IGA01" and .<rand24dt<adt and AVALCA1N=2 and .<adt<mindate2_lempt;
   	keep usubjid adt startdt trtranddt; 	
   run;
   proc sort data=QS1_LIGA01B;by usubjid adt ;run;
   * For Leasi50;
   data QS1_LEASI50;
      set qs;
   	where PARAMCD="EASIS" and .<rand24dt<adt and PCHGCA1N=2 and .<adt<mindate2;
   	keep usubjid adt startdt trtranddt; 	
   run;
   proc sort data=qs1_LEASI50;by usubjid adt ;run;
/*LEASI50B;*/
   data QS1_LEASI50B;
      set qs;
   	where PARAMCD="EASIS" and .<rand24dt<adt and PCHGCA1N=2 and .<adt<mindate2_lempt;
   	keep usubjid adt startdt trtranddt; 	
   run;
   proc sort data=qs1_LEASI50B;by usubjid adt ;run;


%macro cnsr(paramcd=, param=, qs_subj=);
   * Event / cnsr = 0 ;
   data event_&paramcd.;
      set qs1_&paramcd.;
      by usubjid adt;
      if first.usubjid;
   	cnsr=0;
   run;

   * No event / cnsr = 1;
   data noevent_&paramcd.;
      merge qs_subj_&qs_subj.(in=a) event_&paramcd.(drop=startdt trtranddt in=b);
      by usubjid;
      if a and not b;

      cnsr = 1;
      adt = mindate1;

      drop mindate1;
   run;

   * All;
   data param_&paramcd.;
      length param $200 paramcd $8;
      set event_&paramcd. noevent_&paramcd.;

      PARAM=&param.;
      PARAMCD="&paramcd.";

   run;
%mend;

%macro cnsr1(paramcd=, param=, qs_subj=);
   * Event / cnsr = 0 ;
   data event_&paramcd.;
      set qs1_&paramcd.;
      by usubjid adt;
      if first.usubjid;
   	cnsr=0;
   run;

   * No event / cnsr = 1;
   data noevent_&paramcd.;
      merge qs_subj_&qs_subj.(in=a) event_&paramcd.(drop=startdt trtranddt in=b);
      by usubjid;
      if a and not b;

      cnsr = 1;
      adt = mindate1_lempt;

      drop mindate1_lempt;
   run;

   * All;
   data param_&paramcd.;
      length param $200 paramcd $8;
      set event_&paramcd. noevent_&paramcd.;

      PARAM=&param.;
      PARAMCD="&paramcd.";

   run;
%mend;
%cnsr(paramcd=LEASI75, param="Time from rerandomization to loss of EASI 75 (weeks)", qs_subj=easi);
%cnsr(paramcd=LIGA01, param="Time from rerandomization to loss of IGA 0/1 (weeks)", qs_subj=iga);
%cnsr(paramcd=LEASI50, param="Time from rerandomization to loss of EASI 50 (weeks)", qs_subj=easi);
%cnsr1(paramcd=LEASI75B, param="Time from rerandomization to loss of EASI 75 - b (weeks)", qs_subj=easi);
%cnsr1(paramcd=LIGA01B, param="Time from rerandomization to loss of IGA 0/1 - b (weeks)", qs_subj=iga);
%cnsr1(paramcd=LEASI50B, param="Time from rerandomization to loss of EASI 50 - b (weeks)", qs_subj=easi);

* All parameters;
data ADTTE1;
   set param_:;

   if nmiss(adt,startdt)=0 and ADT >= STARTDT then aval= (ADT - STARTDT + 1) / 7;
   else aval=.;

   if nmiss(adt,trtranddt)=0 then do;
      if ADT >= trtranddt then ADY = ADT - trtranddt + 1;
      else if ADT < trtranddt then ADY = ADT - trtranddt;
   end;

run;
proc sort data= adtte1;
   by usubjid paramcd;
run;

*RESCP1FL;
proc sort data = qs out = RESCP1FL(keep=usubjid) nodupkey;
   where (.<rescaldt<=rand24dt) or (.<rescprdt<rand24dt);
   by usubjid;
run;

data adtte;
   merge adb.adsl(in=a) adtte1(in=b) RESCP1FL(in=c) resal2dt respr2dt ;
   by usubjid ;
   if b; 

   if c then RESCP1FL='Y';
   else RESCP1FL='N';
run;



**Generate final dataset by updating certain attributes. Optionally merge common variables & create sequence variable as needed**;
%adam_dataset_update(
	ds=&DSETNAME,
	libin=work,
	libout=output,
	adsllib=adb,
	addcomvar=Y,
	addseq=,
	dropinfmt=Y,
	mapspecfile=Kymab KY1005CT05 ADaM Specs.xlsm,
	maploc=&G_PROJECTPATH.&G_TOPLEVEL.\Documents\Specs\,
	debug=N
	);

 GOPTIONS ACCESSIBLE;

***************************************************************************;
*        CLIENT:  Kymab                                                   *;
*        PROTOCOL:  KY1005CT05                                            *;
*        PURPOSE:  To develop the Biomarker ANCOVA program for production *;
*        AUTHOR:  Zhenhua Yuan                                            *;
*        INPUT FILES:  ADBM                                               *;
*        OUTPUT FILES:  WORK.ANCOVA                                       *;
*   	  NOTES:                                                          *;
*		  DATE:  8/Feb/2023                                               *;
***************************************************************************;
*  Calling example:                                                       *;
* %vmANCOVA_SUBGRP(ADB=ADMI,ANLSET=IFAS01FL,SUBGRP=RACEGR1,PARAMCD=EASISA,*;    
*  AVISITN_MIN=16,AVISITN_MAX=16,VAR1=PCHG);                              *;
*  Copyright 2022 Thermo Fisher Scientific Inc. All rights reserved.      *;
*  All trademarks are the property of Thermo Fisher Scientific and its    *;
*  subsidiaries unless otherwise specified.                               *;
***************************************************************************;
options symbolgen mprint mlogic;
options minoperator;
proc datasets library=WORK kill; run; quit;


%macro mANCOVA_BM(BMSET=,PARAMCD=,SUBGRP=);
  /**Bring in the ADBM dataset;*/
  Data ADBM00;
    set ADB.ADBM;
	where BM01FL="Y" and ANL01FL = "Y" and AVISITN = 9 and PARAMCD="&PARAMCD." 
          and missing(LNR2BASE)=0 and &BMSET.="Y";
	if missing(BASE)=0 and BASE>0 then LNBASE=LOG10(BASE);
/*    else delete;*/
  run;

  proc sql noprint;
    select count(*) into :N 
    from ADBM00;
  quit;

  proc sql; 
    select count(distinct &SUBGRP.)
    into :ncount trimmed
    from ADBM00; 
  quit;

  proc sql; 
    select count(usubjid)
    into :nlevel1-:nlevel&ncount.
    from ADBM00
    group by &SUBGRP.; 
  quit; 
/**/
/*  %if %eval(%upcase(&SUBGRP.) in PRESISFL PREVIOFL PREDUPFL PRECYCFL PREMETFL)*/
/*        and (%sysevalf(%sysevalf(&nlevel1./&N.) LE 0.05) OR */
/*             %sysevalf(%sysevalf(&nlevel2./&N.) LE 0.05))*/
/*  %then %return;*/
/*  %else %do;*/
  proc sql;
    create table ADBM00A as
    select *
    from ADBM00
    group by &SUBGRP.
    having count(USUBJID)/&N. > 0.05;
	quit;

  Proc sort data=ADBM00A out=ADBM00S;
    By &subgrp.;
  run;

*Perform ANCOVA model using TRT01PN variable;
 ods output lsmeans=lsm_a diffs=diffs_a ;
	proc mixed data=ADBM00s;
	 class TRT01PN(ref='5') DISSEV &SUBGRP.;
	 model LNR2BASE=LNBASE TRT01PN DISSEV &SUBGRP. TRT01PN*&SUBGRP.;
	 by &SUBGRP.;
     lsmeans TRT01PN /pdiff cl alpha=0.05;
	run;

*Perform ANCOVA model using PTGRP01N variable;
  ods output lsmeans=lsm_b  diffs=diffs_b;
   proc mixed data=ADBM00s;
    class ptgrp01n(ref='2') dissev &SUBGRP.;
    model LNR2BASE = LNBASE ptgrp01n DISSEV &SUBGRP. ptgrp01n*&SUBGRP.;
	by &SUBGRP.;
    lsmeans ptgrp01n/pdiff cl alpha=0.05 ;
  run;

 *Obtain the interaction p-value based on the TRT01PN group;
    ods output  Tests3=test3;
	proc mixed data=ADBM00s method=type3;
      class TRT01PN(ref='5') DISSEV &SUBGRP.;
	  model LNR2BASE=LNBASE TRT01PN DISSEV &SUBGRP. TRT01PN*&SUBGRP./solution;
	run;

* For LSM_A;
   data lsm_a1(drop= effect lower upper tvalue probt alpha df);
     set lsm_a ;
	 if missing(estimate)=0 and missing(stderr)=0 then do;
	   LSMEAN=10**estimate;
	   LSMSE=10**stderr;
	   end;
/*	 else delete;*/
	 rename trt01pn=trtpn estimate=L10MEAN stderr=L10SE;
	 if trt01pn=5 then trt01pn=6;
   run;
    
/*   proc sort data=lsm_a1;*/
/*    by &SUBGRP. trtpn;*/
/*   run;*/
* For LSM_B;
   data lsm_b1(drop= effect lower upper tvalue probt alpha df);
     set lsm_b ;
	 if missing(estimate)=0 and missing(stderr)=0 then do;
	 LSMEAN=10**estimate;
	 LSMSE=10**stderr;
	 end;
/*	 else delete;*/
	 rename ptgrp01n=trtpn estimate=L10MEAN stderr=L10SE;
	 if ptgrp01n=1 then ptgrp01n=5;
	 else if ptgrp01n=2 then delete;
   run;
    

 * For DIFFS_A;
   data DIFFS_a1(drop=estimate _TRT01PN stderr effect lower upper tvalue probt alpha df);
     set DIFFS_a(where=(_TRT01PN=5)) ;
	 if missing(estimate)+missing(stderr)+missing(LOWER)+missing(UPPER)=0 then do;
	 LSMDIFF=10**estimate;
	 LSMDSE=10**stderr;
     LOWERCL=10**LOWER;
	 UPPERCL=10**UPPER;
	 LSMDPVAL=probt;
	 end;
/*	 else delete;*/
	 if trt01pn=5 then trt01pn=6;
	 rename trt01pn=trtpn;
   run;
    
* For DIFFS_B;
   data DIFFS_b1(drop=estimate _PTGRP01N stderr effect lower upper tvalue probt alpha df);
     set DIFFS_b(where=(_PTGRP01N=2)) ;
	 if missing(estimate)+missing(stderr)+missing(LOWER)+missing(UPPER)=0 then do;
	   LSMDIFF=10**estimate;
	   LSMDSE=10**stderr;
       LOWERCL=10**LOWER;
	   UPPERCL=10**UPPER;
	   LSMDPVAL=probt;
	 end;
/*	 else delete;*/
	 if PTGRP01N=1 then PTGRP01N=5;
	 rename PTGRP01N=trtpn ;
   run;

* Merge the LSM and DIFFS datasets;
  data LSM_AB00;
    Set LSM_A1
	    LSM_B1;
  run;

  data DIFFS_AB00;
    set DIFFS_A1
	    DIFFS_B1;
	run;
 
  PROC SORT DATA=LSM_AB00;BY &SUBGRP. TRTPN;RUN;
  PROC SORT DATA=DIFFS_AB00;BY &SUBGRP. TRTPN;RUN;

  data LSM_DIFFS00;
    length SUBGROUP $ 200;
    merge LSM_AB00(in=a )
	      DIFFS_AB00(in=b);
	by &SUBGRP. TRTPN;
	if a or b;
	SUBGROUP="&SUBGRP.";
  run;
	
  
* For Test3;
  data TEST3_A(keep=SUBGROUP ProbF rename=(ProbF=PVALINT));
    length SUBGROUP $ 200;
    SET TEST3(where=(effect="TRT01PN*&SUBGRP."));
    SUBGROUP="&SUBGRP.";
  run;

* Merge TEST3 dataset with the LSM_DIFFS dataset;
  data LSM_DIFFS01;
    merge LSM_DIFFS00(in=a)
          TEST3_A(in=b);
    by SUBGROUP;
	if a;
  run;

* Incorporate the other necessary variables in the above datset;
  data BM_&PARAMCD._&SUBGRP.(rename=(TRTPN=TRTN) drop=&subgrp.);
  	format TID TRTPN PARAMCD POP SUBGROUP SUBGPLVL L10MEAN L10SE LSMEAN LSMSE LSMDIFF LSMDSE 
           LSMDPVAL LOWERCL UPPERCL PVALINT;
	length TID $200 PARAMCD $8 POP $200 SUBGPLVL $200;
    set LSM_DIFFS01;
	TID="T1402080104";
	POP="&BMSET.";
	SUBGPLVL=&SUBGRP.;
	PARAMCD="&PARAMCD.";
  run;
/*  %end;*/
%MEND mANCOVA_BM;

* Use do loop to feed the arguments to the MACRO;
/*create empty dataset*/
/*data BM_BY_SUBGRP00;*/
/*    attrib */
/*    TID length=$200  label="Table ID"*/
/*    TRT length=$30  label="Treatment"*/
/*    TRTN length=8  label="Treatment (N)"*/
/*    PARAMCD length=$8  label="Parameter code"*/
/*    POP length=$200  label="Population"*/
/*    POPN length=8  label="Population (N)"*/
/*    SUBGROUP length=8  label="Subgroup"*/
/*    SUBGPLVL length=$8  label="Subgroup Level"*/
/*    LSMEAN length=8  label="LS Mean"*/
/*    LSMSE length=8  label="LS Mean Standard Error"*/
/*    LSMDIFF length=8  label="LS Mean Difference"*/
/*    LSMDSE length=$8  label="LS Mean Difference Standard Error"*/
/*    LSMDPVAL length=8  label="LS Mean Difference P-value"*/
/*    LOWERCL length=8  label="95% Lower Confidence Limit"*/
/*    UPPERCL length=8  label="95% Upper Confidence Limit"*/
/*    PVALINT length=$8  label="P-value for Treatment-by-Subgroup"*/
/*;*/
/*    stop;*/
/*run;*/

/*%macro BM_SUBGRP(bmlist = );*/
/*  %let n=%sysfunc(countw(&bmlist));*/
/*  %do i=1 %to &n;*/
/*  %let val = %scan(&var,&i);*/
/*   proc means data = &input noprint nway;*/
/*   class &class;*/
/*   vars &val;*/
/*   output out=out&i mean= median= / autoname;*/
/*   run;*/
/*  %end;*/
/*%mend;*/

* For ALTIGE;
%mANCOVA_BM(BMSET=IGE01FL,PARAMCD=ALTIGE,SUBGRP=IGEENDO);
%mANCOVA_BM(BMSET=IGE01FL,PARAMCD=ALTIGE,SUBGRP=AGEGR1);
%mANCOVA_BM(BMSET=IGE01FL,PARAMCD=ALTIGE,SUBGRP=SEX);
%mANCOVA_BM(BMSET=IGE01FL,PARAMCD=ALTIGE,SUBGRP=RACEGR1);
%mANCOVA_BM(BMSET=IGE01FL,PARAMCD=ALTIGE,SUBGRP=REGION1);
%mANCOVA_BM(BMSET=IGE01FL,PARAMCD=ALTIGE,SUBGRP=WTGR1);
%mANCOVA_BM(BMSET=IGE01FL,PARAMCD=ALTIGE,SUBGRP=DSIGA);
%mANCOVA_BM(BMSET=IGE01FL,PARAMCD=ALTIGE,SUBGRP=PRESISFL);
%mANCOVA_BM(BMSET=IGE01FL,PARAMCD=ALTIGE,SUBGRP=PREVIOFL);
%mANCOVA_BM(BMSET=IGE01FL,PARAMCD=ALTIGE,SUBGRP=PREDUPFL);
%mANCOVA_BM(BMSET=IGE01FL,PARAMCD=ALTIGE,SUBGRP=PRECYCFL);
%mANCOVA_BM(BMSET=IGE01FL,PARAMCD=ALTIGE,SUBGRP=PREMETFL);

%mANCOVA_BM(BMSET=IL1301FL,PARAMCD=IL13,SUBGRP=IL13ENDO);
%mANCOVA_BM(BMSET=IL1301FL,PARAMCD=IL13,SUBGRP=AGEGR1);
%mANCOVA_BM(BMSET=IL1301FL,PARAMCD=IL13,SUBGRP=SEX);
%mANCOVA_BM(BMSET=IL1301FL,PARAMCD=IL13,SUBGRP=RACEGR1);
%mANCOVA_BM(BMSET=IL1301FL,PARAMCD=IL13,SUBGRP=REGION1);
%mANCOVA_BM(BMSET=IL1301FL,PARAMCD=IL13,SUBGRP=WTGR1);
%mANCOVA_BM(BMSET=IL1301FL,PARAMCD=IL13,SUBGRP=DSIGA);
%mANCOVA_BM(BMSET=IL1301FL,PARAMCD=IL13,SUBGRP=PRESISFL);
%mANCOVA_BM(BMSET=IL1301FL,PARAMCD=IL13,SUBGRP=PREVIOFL);
%mANCOVA_BM(BMSET=IL1301FL,PARAMCD=IL13,SUBGRP=PREDUPFL);
%mANCOVA_BM(BMSET=IL1301FL,PARAMCD=IL13,SUBGRP=PRECYCFL);
%mANCOVA_BM(BMSET=IL1301FL,PARAMCD=IL13,SUBGRP=PREMETFL);

%mANCOVA_BM(BMSET=IL2201FL,PARAMCD=IL22,SUBGRP=IL22ENDO);
%mANCOVA_BM(BMSET=IL2201FL,PARAMCD=IL22,SUBGRP=AGEGR1);
%mANCOVA_BM(BMSET=IL2201FL,PARAMCD=IL22,SUBGRP=SEX);
%mANCOVA_BM(BMSET=IL2201FL,PARAMCD=IL22,SUBGRP=RACEGR1);
%mANCOVA_BM(BMSET=IL2201FL,PARAMCD=IL22,SUBGRP=REGION1);
%mANCOVA_BM(BMSET=IL2201FL,PARAMCD=IL22,SUBGRP=WTGR1);
%mANCOVA_BM(BMSET=IL2201FL,PARAMCD=IL22,SUBGRP=DSIGA);
%mANCOVA_BM(BMSET=IL2201FL,PARAMCD=IL22,SUBGRP=PRESISFL);
%mANCOVA_BM(BMSET=IL2201FL,PARAMCD=IL22,SUBGRP=PREVIOFL);
%mANCOVA_BM(BMSET=IL2201FL,PARAMCD=IL22,SUBGRP=PREDUPFL);
%mANCOVA_BM(BMSET=IL2201FL,PARAMCD=IL22,SUBGRP=PRECYCFL);
%mANCOVA_BM(BMSET=IL2201FL,PARAMCD=IL22,SUBGRP=PREMETFL);

%mANCOVA_BM(BMSET=IL1701FL,PARAMCD=IL17A,SUBGRP=IL17ENDO);
%mANCOVA_BM(BMSET=IL1701FL,PARAMCD=IL17A,SUBGRP=AGEGR1);
%mANCOVA_BM(BMSET=IL1701FL,PARAMCD=IL17A,SUBGRP=SEX);
%mANCOVA_BM(BMSET=IL1701FL,PARAMCD=IL17A,SUBGRP=RACEGR1);
%mANCOVA_BM(BMSET=IL1701FL,PARAMCD=IL17A,SUBGRP=REGION1);
%mANCOVA_BM(BMSET=IL1701FL,PARAMCD=IL17A,SUBGRP=WTGR1);
%mANCOVA_BM(BMSET=IL1701FL,PARAMCD=IL17A,SUBGRP=DSIGA);
%mANCOVA_BM(BMSET=IL1701FL,PARAMCD=IL17A,SUBGRP=PRESISFL);
%mANCOVA_BM(BMSET=IL1701FL,PARAMCD=IL17A,SUBGRP=PREVIOFL);
%mANCOVA_BM(BMSET=IL1701FL,PARAMCD=IL17A,SUBGRP=PREDUPFL);
%mANCOVA_BM(BMSET=IL1701FL,PARAMCD=IL17A,SUBGRP=PRECYCFL);
%mANCOVA_BM(BMSET=IL1701FL,PARAMCD=IL17A,SUBGRP=PREMETFL);

%mANCOVA_BM(BMSET=TARC01FL,PARAMCD=TARC,SUBGRP=TARCENDO);
%mANCOVA_BM(BMSET=TARC01FL,PARAMCD=TARC,SUBGRP=AGEGR1);
%mANCOVA_BM(BMSET=TARC01FL,PARAMCD=TARC,SUBGRP=SEX);
%mANCOVA_BM(BMSET=TARC01FL,PARAMCD=TARC,SUBGRP=RACEGR1);
%mANCOVA_BM(BMSET=TARC01FL,PARAMCD=TARC,SUBGRP=REGION1);
%mANCOVA_BM(BMSET=TARC01FL,PARAMCD=TARC,SUBGRP=WTGR1);
%mANCOVA_BM(BMSET=TARC01FL,PARAMCD=TARC,SUBGRP=DSIGA);
%mANCOVA_BM(BMSET=TARC01FL,PARAMCD=TARC,SUBGRP=PRESISFL);
%mANCOVA_BM(BMSET=TARC01FL,PARAMCD=TARC,SUBGRP=PREVIOFL);
%mANCOVA_BM(BMSET=TARC01FL,PARAMCD=TARC,SUBGRP=PREDUPFL);
%mANCOVA_BM(BMSET=TARC01FL,PARAMCD=TARC,SUBGRP=PRECYCFL);
%mANCOVA_BM(BMSET=TARC01FL,PARAMCD=TARC,SUBGRP=PREMETFL);
    
* Stack the datasets;

data BM_ANCOVA00;
  set BM_ALTIGE_IGEENDO
      BM_ALTIGE_AGEGR1
      BM_ALTIGE_SEX
      BM_ALTIGE_RACEGR1
      BM_ALTIGE_REGION1
      BM_ALTIGE_WTGR1
      BM_ALTIGE_DSIGA
      BM_ALTIGE_PRESISFL
      BM_ALTIGE_PREVIOFL
      BM_ALTIGE_PREDUPFL
      BM_ALTIGE_PRECYCFL
      BM_ALTIGE_PREMETFL
      BM_IL13_IL13ENDO
      BM_IL13_AGEGR1
      BM_IL13_SEX
      BM_IL13_RACEGR1
      BM_IL13_REGION1
      BM_IL13_WTGR1
      BM_IL13_DSIGA
      BM_IL13_PRESISFL
      BM_IL13_PREVIOFL
      BM_IL13_PREDUPFL
      BM_IL13_PRECYCFL
      BM_IL13_PREMETFL
      BM_IL22_IL22ENDO
      BM_IL22_AGEGR1
      BM_IL22_SEX
      BM_IL22_RACEGR1
      BM_IL22_REGION1
      BM_IL22_WTGR1
      BM_IL22_DSIGA
      BM_IL22_PRESISFL
      BM_IL22_PREVIOFL
      BM_IL22_PREDUPFL
      BM_IL22_PRECYCFL
      BM_IL22_PREMETFL
      BM_IL17A_IL17ENDO
      BM_IL17A_AGEGR1
      BM_IL17A_SEX
      BM_IL17A_RACEGR1
      BM_IL17A_REGION1
      BM_IL17A_WTGR1
      BM_IL17A_DSIGA
      BM_IL17A_PRESISFL
      BM_IL17A_PREVIOFL
      BM_IL17A_PREDUPFL
      BM_IL17A_PRECYCFL
      BM_IL17A_PREMETFL
      BM_TARC_TARCENDO
      BM_TARC_AGEGR1
      BM_TARC_SEX
      BM_TARC_RACEGR1
      BM_TARC_REGION1
      BM_TARC_WTGR1
      BM_TARC_DSIGA
      BM_TARC_PRESISFL
      BM_TARC_PREVIOFL
      BM_TARC_PREDUPFL
      BM_TARC_PRECYCFL
      BM_TARC_PREMETFL;
run;

* Finalize the dataset by incorporating other variables;
data BM_ANCOVA01;
  format TID TRT TRTN PARAMCD POP POPN SUBGROUP SUBGPLVL L10MEAN L10SE LSMEAN LSMSE LSMDIFF 
         LSMDSE LSMDPVAL LOWERCL UPPERCL PVALINT;
  Length TRT $200;
  set BM_ANCOVA00;
  select (TRTN);
    when (1)    TRT="250mg (500mg LD) KY1005";
    when (2)    TRT="250mg (no LD) KY1005";
    when (3)    TRT="125mg KY1005";
    when (4)    TRT="62.5mg KY1005";
    when (5)    TRT="KY1005 Treatment Arms Combined";
    when (6)    TRT="Placebo";
    otherwise   TRT="";
  end;
  select (POP);
    when ("IGE01FL")    POPN=6;
    when ("IL1301FL")   POPN=7;
    when ("IL2201FL")   POPN=8;
    when ("IL1701FL")   POPN=9;
    when ("TARC01FL")   POPN=10;
    otherwise           POPN=.;
  end;
  If PARAMCD="IL13" then PARAMCD="IL-13";
  ELSE IF PARAMCD="IL22" then PARAMCD="IL-22";
  ELSE IF PARAMCD="IL17A" then PARAMCD="IL-17";
  IF SUBGROUP="SEX" then SUBGROUP="GENDER";
  IF SUBGPLVL="M" then SUBGPLVL="Male";
  ELSE IF SUBGPLVL="F" then SUBGPLVL="Female";
  Label TID = "Table ID"
        TRT = "Treatment"
        TRTN = "Treatment (N)"
        PARAMCD = "Parameter code"
        POP = "Population"
        POPN = "Population (N)"
        SUBGROUP = "Subgroup"
        SUBGPLVL = "Subgroup Level"
		L10MEAN = "Log10 LS Mean"
        L10SE = "Log10 Standard Error"
        LSMEAN = "LS Mean"
        LSMSE = "LS Mean Standard Error"
        LSMDIFF = "LS Mean Difference"
        LSMDSE = "LS Mean Difference Standard Error"
        LSMDPVAL = "LS Mean Difference P-value"
        LOWERCL = "95% Lower Confidence Limit"
        UPPERCL = "95% Upper Confidence Limit"
        PVALINT = "P-value for Treatment-by-Subgroup";
run;

Proc DataSets Lib = WORK;
  Modify BM_ANCOVA01;
  Format _all_;
Run ;
Quit ;

data BM_ANCOVA01;
  set BM_ANCOVA01;
  array _nums {*} _numeric_;
  do i = 1 to dim(_nums);
    if missing(_nums{i})=0 then _nums{i} = round(_nums{i},.000001);
  end;
  drop i;
run;

proc sort data=BM_ANCOVA01 out=STATOUTW.ANCOVA; 
 by TID TRTN POPN PARAMCD SUBGROUP SUBGPLVL;
run;

proc contents;run;

*************************************************************************
*        CLIENT:  Kymab
*      PROTOCOL:  KY1005CT05
*       PURPOSE:  CORR_BIO at production side
*        AUTHOR:  ZHENHUA YUAN
*   INPUT FILES:  ADBM
*  OUTPUT FILES:  WORK.CORR_BIO
*   	  NOTES:  
*		   DATE:  14/JAN/2023
************************************************************************* 
*  Copyright 2022 Thermo Fisher Scientific Inc. All rights reserved.
*  All trademarks are the property of Thermo Fisher Scientific and its
*  subsidiaries unless otherwise specified. 
*************************************************************************;
options linesize=max;
options symbolgen mlogic mprint;
/*libname adb "\\wilbtib\wilbtia03\Kymab KY1005CT05\Interim Analysis\Databases\Analysis Database\Output";*/
/*libname adb1 "\\wilbtib\wilbtia03\Kymab KY1005CT05\Users\okelloeo\Interim Analysis\Databases\Analysis Database\Output_Dev";*/


proc datasets lib=work kill nolist nowarn;
quit;

dm "output; clear; log; clear";

data ADBM00;
  set adb.ADBM;
  where BMBL01FL="Y"  and (strip(PARAMCD) in ("ALTIGE","IL13","IL22","IL17A","TARC")) and ABLFL="Y";
RUN;

Proc sort data=ADBM00 out=ADBM00S; By USUBJID;RUN;

proc transpose data = ADBM00S out=ADBM00T;
by USUBJID;
id PARAMCD;
var AVAL;
run;

* Use proc corr to obtain the needed results;
proc corr data=ADBM00T spearman;
ods output SpearmanCorr=corr_base_bm;
	var ALTIGE IL13 IL22 IL17A TARC;
run;

data CORR_BASE_BM_ALTIGE;
  length VS_BM $8;
  set CORR_BASE_BM(KEEP=Variable ALTIGE PALTIGE NALTIGE rename=(ALTIGE=CORRCF PALTIGE=PCORR NALTIGE=N));
  VS_BM="ALTIGE";
run;

data CORR_BASE_BM_IL13;
  length VS_BM $8;
  set CORR_BASE_BM(KEEP=Variable IL13 PIL13 NIL13 rename=(IL13=CORRCF PIL13=PCORR NIL13=N));
  VS_BM="IL13";
run;

data CORR_BASE_BM_IL22;
  length VS_BM $8;
  set CORR_BASE_BM(KEEP=Variable IL22 PIL22 NIL22 rename=(IL22=CORRCF PIL22=PCORR NIL22=N));
  VS_BM="IL22";
run;

data CORR_BASE_BM_IL17A;
  length VS_BM $8;
  set CORR_BASE_BM(KEEP=Variable IL17A PIL17A NIL17A rename=(IL17A=CORRCF PIL17A=PCORR NIL17A=N));
  VS_BM="IL17A";
run;

data CORR_BASE_BM_TARC;
  length VS_BM $8;
  set CORR_BASE_BM(KEEP=Variable TARC PTARC NTARC rename=(TARC=CORRCF PTARC=PCORR NTARC=N));
  VS_BM="TARC";
run;

data CORR_BASE_BM00(where=(missing(PCORR)=0));
  Length CORRTYP $200;
  SET CORR_BASE_BM_ALTIGE
      CORR_BASE_BM_IL13
      CORR_BASE_BM_IL22
	  CORR_BASE_BM_IL17A
	  CORR_BASE_BM_TARC;
  CORRTYP=strip(Variable)||" vs "||VS_BM;
run;

/*PROC SORT data=CORR_BASE_BM00 OUT=CORR_BASE_BM00S nodupkey; by PCORR N;run;*/

proc multtest inpvalues(PCORR)=CORR_BASE_BM00 fdr out=CORR_BASE_BM01;

data CORR_BASE_BM01a;
  format TID CORRTYP N CORRCF PCORR APCORR SIGFL;
  Length TID $200 SIGFL $1;
  set CORR_BASE_BM01(KEEP=CORRTYP N CORRCF PCORR fdr_p rename=(fdr_p=APCORR));
  TID="T1402080107";
  if APCORR LT 0.05 then SIGFL="Y";
  CORRTYP = tranwrd(CORRTYP, "ALTIGE", "Total IgE");
  label TID = "Table ID"
        CORRTYP = "Correlation type"
        N =	"N"
        CORRCF = "Correlation coefficient"
        PCORR =	"P-value for correlation coefficient"
        APCORR = "Adjusted p-value for correlation coefficient"
        SIGFL =	"Significance flag";
run;

Proc DataSets Lib = WORK;
  Modify CORR_BASE_BM01a;
  Format N CORRCF PCORR;
Run ;
Quit ;

proc sort data=CORR_BASE_BM01a out=statoutw.CORR_BIO;
  by TID CORRTYP;
run;

****************End of the program***************************************;

*************************************************************************
*        CLIENT:  Kymab
*      PROTOCOL:  KY1005CT05
*       PURPOSE:  CORR_EASI at production side
*        AUTHOR:  ZHENHUA YUAN
*   INPUT FILES:  ADBM
*  OUTPUT FILES:  WORK.CORR_EASI
*   	  NOTES:  
*		   DATE:  14/JAN/2023
************************************************************************* 
* CALLING EXAMPLE:
* %mMMRM_GMC(bmset=M1301FL,anlset=ANL02FL,paramcd=IL13,avisitn=6);
* %mMMRM_GMC(bmset=M1301FL,anlset=ANL02FL,paramcd=IL13,avisitn=9);
************************************************************************* 
*  Copyright 2022 Thermo Fisher Scientific Inc. All rights reserved.
*  All trademarks are the property of Thermo Fisher Scientific and its
*  subsidiaries unless otherwise specified. 
*************************************************************************;
options linesize=max;
options symbolgen mlogic mprint;
/*libname adb "\\wilbtib\wilbtia03\Kymab KY1005CT05\Interim Analysis\Databases\Analysis Database\Output";*/
/*libname adb1 "\\wilbtib\wilbtia03\Kymab KY1005CT05\Users\okelloeo\Interim Analysis\Databases\Analysis Database\Output_Dev";*/

proc datasets lib=work kill nolist nowarn;
quit;

dm "output; clear; log; clear";

%macro mCORR_EASI(bmset=,bm=,avisitn=);

%if &avisitn=2 %then %do;
data ADBM00;
  set adb.ADBM;
  where &bmset.="Y"  and (strip(PARAMCD) in ("EASIS","&bm.")) and ABLFL="Y";
RUN;

Proc sort data=ADBM00 out=ADBM00S; By USUBJID TRT01PN ptgrp01n PARAMCD;RUN;

proc transpose data = ADBM00S out=ADBM00T(where=(missing(EASIS)=0 and missing(&bm.)=0));
by USUBJID TRT01PN ptgrp01n;
id PARAMCD;
var AVAL;
run;

* No by statement;
proc corr data=ADBM00T spearman;
ods output SpearmanCorr=corr_base_noby SimpleStats=corr_N_noby;
	var EASIS &bm.;
run;

data corr_base_noby_a;
  length Biomarker $30;
  format Biomarker $30.;
  set corr_base_noby(keep=Variable EASIS PEASIS rename=(Variable=Biomarker
                       EASIS=CORRCF PEASIS=PCORR ));
  where Strip(Biomarker) = "&bm.";
  TRT01PN=0;
run; 

data corr_N_noby_a;
  length Biomarker $30;
  format Biomarker $30.;
  set corr_N_noby(keep=Variable NObs rename=(Variable=Biomarker
                       NObs=N));
  where Strip(Biomarker) = "&bm.";
  TRT01PN=0;
run; 

proc sort data=corr_base_noby_a; by TRT01PN Biomarker; run;
proc sort data=corr_N_noby_a; by TRT01PN Biomarker; run;

data corr_base_noby_b;
  merge corr_base_noby_a(in=a)
        corr_N_noby_a;
  by TRT01PN Biomarker;
  if a;
run;

* For by TRT01PN;
proc sql;
    create table ADBM00T1 as
    select *
    from ADBM00T
    group by trt01pn
    having count(USUBJID)>10;
	quit;

Proc sort data=ADBM00T1; by trt01pn;run;

proc corr data=ADBM00T1 spearman;
ods output SpearmanCorr=corr_base_by5trt SimpleStats=corr_N_by5trt;
	var EASIS &bm.;
	by trt01pn;
run;

data corr_base_by5trt_a;
  length Biomarker $30;
  format Biomarker $30.;
  set corr_base_by5trt(keep=TRT01PN Variable EASIS PEASIS rename=(Variable=Biomarker
                       EASIS=CORRCF PEASIS=PCORR));
  where Strip(Biomarker) = "&bm.";
  if TRT01PN=5 then TRT01PN=6;
run; 

data corr_N_by5trt_a;
  length Biomarker $30;
  format Biomarker $30.;
  set corr_N_by5trt(keep=TRT01PN Variable NObs rename=(Variable=Biomarker
                       NObs=N));
  where Strip(Biomarker) = "&bm.";
  if TRT01PN=5 then TRT01PN=6;
run; 

proc sort data=corr_base_by5trt_a; by TRT01PN Biomarker; run;
proc sort data=corr_N_by5trt_a; by TRT01PN Biomarker; run;

data corr_base_by5trt_b;
  merge corr_base_by5trt_a(in=a)
        corr_N_by5trt_a;
  by TRT01PN Biomarker;
  if a;
run;

* Dealing with by=ptgrp01n;
proc sql;
    create table ADBM00T2 as
    select *
    from ADBM00T
    group by ptgrp01n
    having count(USUBJID)>10;
	quit;

Proc sort data=ADBM00T2;by ptgrp01n;run;

proc corr data=ADBM00T2 spearman;
ods output SpearmanCorr=corr_base_by2trt SimpleStats=corr_N_by2trt;;
	var EASIS &bm.;
	by ptgrp01n;
run;

data corr_base_by2trt_a(drop=PTGRP01N);
  length Biomarker $30;
  format Biomarker $30.;
  set corr_base_by2trt(keep=PTGRP01N Variable EASIS PEASIS rename=(Variable=Biomarker
                       EASIS=CORRCF PEASIS=PCORR));
  where Strip(Biomarker) = "&bm.";
  if PTGRP01N=1 then TRT01PN=5;
run; 

/*proc multtest inpvalues(PCORR)=CORR_BASE_BY2TRT_A fdr out=CORR_BASE_BY2TRT_A1;*/

data corr_N_by2trt_a(drop=PTGRP01N);
  length Biomarker $30;
  format Biomarker $30.;
  set corr_N_by2trt(keep=PTGRP01N Variable NObs rename=(Variable=Biomarker
                       NObs=N));
  where Strip(Biomarker) = "&bm.";
  if PTGRP01N=1 then TRT01PN=5;
  else if PTGRP01N=2 then delete;
run; 

data corr_base_by2trt_b;
  merge corr_base_by2trt_a(in=a where=(TRT01PN=5))
        corr_N_by2trt_a;
  by TRT01PN Biomarker;
  if a;
run;

* Stack the above two datasets;
data corr_&AVISITN._&bm.;
  format Biomarker TRT01PN POP AVISITN CORRTYP N CORRCF PCORR;
  LENGTH POP $200 CORRTYP $200;
  SET corr_base_noby_b
      corr_base_by5trt_b
      corr_base_by2trt_b;
  AVISITN=.;
  Biomarker="&bm.";
  POP="&bmset.";
  CORRTYP="Baseline EASI vs Baseline biomarker concentration";
run;

proc multtest inpvalues(PCORR)=corr_&AVISITN._&bm. fdr 
              out=corr_&AVISITN._&bm._adj(rename=(fdr_p=APCORR));
%end;
%else %do;
data ADBM00;
  set adb.adbm;
  where &bmset.="Y" and ANL01FL="Y" and (strip(PARAMCD) in ("EASIS","&bm.")) 
   and AVISITN=&AVISITN. ;
RUN;

PROC SORT DATA=ADBM00; by USUBJID PARAMCD;RUN;

data ADBM00a(where=(missing(R2BASE)=0 and missing(PCHG)=0));
  merge ADBM00(where=(strip(PARAMCD) in ("EASIS")) drop=R2BASE in=a)
        ADBM00(where=(strip(PARAMCD1) in ("&bm.")) Keep=USUBJID PARAMCD R2BASE 
               rename=(PARAMCD=PARAMCD1) in=b);
  by usubjid;
  if a and b;
run;

*Perform proc corr;
*noby;
Proc sort data=ADBM00A out=ADBM00S; By TRT01PN;RUN;

proc corr data=ADBM00S spearman;
ods output SpearmanCorr=corr_post_noby SimpleStats=corr_N_noby;
	var PCHG R2BASE;
run;

data corr_post_noby_a;
  length Biomarker $30;
  format Biomarker $30.;
  set corr_post_noby(keep=Variable PCHG PPCHG  rename=(Variable=Biomarker
                       PCHG=CORRCF PPCHG=PCORR ));
  where Strip(Biomarker) = "R2BASE";
  TRT01PN=0;
run; 

data corr_N_noby_a;
  length Biomarker $30;
  format Biomarker $30.;
  set corr_N_noby(keep=Variable NObs rename=(Variable=Biomarker
                       NObs=N));
  where Strip(Biomarker) = "R2BASE";
run; 

data corr_post_noby_b;
  merge corr_post_noby_a(in=a)
        corr_N_noby_a;
  by Biomarker;
  if a;
run;

*by trt01pn;
proc sql;
    create table ADBM00A1 as
    select *
    from ADBM00A
    group by trt01pn
    having count(USUBJID)>10;
quit;

Proc sort data=ADBM00A1 out=ADBM00S; By TRT01PN;RUN;

proc corr data=ADBM00S spearman;
ods output SpearmanCorr=corr_post_by5trt SimpleStats=corr_N_by5trt;
	var PCHG R2BASE;
	by trt01pn;
run;

data corr_post_by5trt_a;
  length Biomarker $30;
  format Biomarker $30.;
  set corr_post_by5trt(keep=TRT01PN Variable PCHG PPCHG rename=(Variable=Biomarker
                       PCHG=CORRCF PPCHG=PCORR));
  where Strip(Biomarker) = "R2BASE";
  if TRT01PN=5 then TRT01PN=6;
run; 

data corr_N_by5trt_a;
  length Biomarker $30;
  format Biomarker $30.;
  set corr_N_by5trt(keep=TRT01PN Variable NObs rename=(Variable=Biomarker
                       NObs=N));
  where Strip(Biomarker) = "R2BASE";
  if TRT01PN=5 then TRT01PN=6;
run; 

proc sort data=corr_post_by5trt_a; by TRT01PN Biomarker; run;
proc sort data=corr_N_by5trt_a; by TRT01PN Biomarker; run;

data corr_post_by5trt_b;
  merge corr_post_by5trt_a(in=a)
        corr_N_by5trt_a;
  by TRT01PN Biomarker;
  if a;
run;

*BY= ptgrp01n;
proc sql;
    create table ADBM00A2 as
    select *
    from ADBM00A
    group by ptgrp01n
    having count(USUBJID)> 10;
quit;

Proc sort data=ADBM00A2 out=ADBM00S; By ptgrp01n;RUN;

proc sort data=ADBM00S;by ptgrp01n;run;
proc corr data=ADBM00S spearman;
ods output SpearmanCorr=corr_post_by2trt SimpleStats=corr_N_by2trt;;
	var PCHG R2BASE;
	by ptgrp01n;
run;

data corr_post_by2trt_a(drop=PTGRP01N);
  length Biomarker $30;
  format Biomarker $30.;
  set corr_post_by2trt(keep=PTGRP01N Variable PCHG PPCHG rename=(Variable=Biomarker
                       PCHG=CORRCF PPCHG=PCORR));
  where Strip(Biomarker) = "R2BASE";
  if PTGRP01N=1 then TRT01PN=5;
/*  else if PTGRP01N=2 then delete;*/
run; 

/*   proc multtest inpvalues(PCORR)=corr_post_by2trt_a fdr out=corr_post_by2trt_a1;*/

data corr_N_by2trt_a(drop=PTGRP01N);
  length Biomarker $30;
  format Biomarker $30.;
  set corr_N_by2trt(keep=PTGRP01N Variable NObs rename=(Variable=Biomarker
                       NObs=N));
  where Strip(Biomarker) = "R2BASE";
  if PTGRP01N=1 then TRT01PN=5;
  else if PTGRP01N=2 then delete;
run; 

data corr_post_by2trt_b;
  merge corr_post_by2trt_a(in=a where=(TRT01PN=5))
        corr_N_by2trt_a;
  by TRT01PN Biomarker;
  if a;
run;

* Stack the above two datasets;
data corr_&AVISITN._&bm.;
  format Biomarker TRT01PN POP AVISITN CORRTYP N CORRCF PCORR;
  length POP $200 CORRTYP $200 ;
  SET corr_post_noby_b
      corr_post_by5trt_b
      corr_post_by2trt_b;
  AVISITN=&AVISITN.;
  Biomarker="&bm.";
  POP="&bmset.";
  CORRTYP="Percent change from baseline in EASI vs. Fold change from baseline in biomarker concentration";
run;

proc multtest inpvalues(PCORR)=corr_&AVISITN._&bm. fdr 
              out=corr_&AVISITN._&bm._adj(rename=(fdr_p=APCORR));
%end;
%MEND mCORR_EASI;

*Call the macro;
%mCORR_EASI(bmset=BLIG01FL,bm=ALTIGE,AVISITN=2);
%mCORR_EASI(bmset=BL1301FL,bm=IL13,AVISITN=2);
%mCORR_EASI(bmset=BL1701FL,bm=IL17A,AVISITN=2);
%mCORR_EASI(bmset=BL2201FL,bm=IL22,AVISITN=2);
%mCORR_EASI(bmset=BLTA01FL,bm=TARC,AVISITN=2);

%mCORR_EASI(bmset=IGE01FL,bm=ALTIGE,AVISITN=6);
%mCORR_EASI(bmset=IL1301FL,bm=IL13,AVISITN=6);
%mCORR_EASI(bmset=IL1701FL,bm=IL17A,AVISITN=6);
%mCORR_EASI(bmset=IL2201FL,bm=IL22,AVISITN=6);
%mCORR_EASI(bmset=TARC01FL,bm=TARC,AVISITN=6);

%mCORR_EASI(bmset=IGE01FL,bm=ALTIGE,AVISITN=9);
%mCORR_EASI(bmset=IL1301FL,bm=IL13,AVISITN=9);
%mCORR_EASI(bmset=IL1701FL,bm=IL17A,AVISITN=9);
%mCORR_EASI(bmset=IL2201FL,bm=IL22,AVISITN=9);
%mCORR_EASI(bmset=TARC01FL,bm=TARC,AVISITN=9);

%mCORR_EASI(bmset=IGE01FL,bm=ALTIGE,AVISITN=15);
%mCORR_EASI(bmset=IL1301FL,bm=IL13,AVISITN=15);
%mCORR_EASI(bmset=IL1701FL,bm=IL17A,AVISITN=15);
%mCORR_EASI(bmset=IL2201FL,bm=IL22,AVISITN=15);
%mCORR_EASI(bmset=TARC01FL,bm=TARC,AVISITN=15);


*Stack the generated corr datasets;
data CORR_EASI00(Drop=Biomarker rename=(TRT01PN=TRTN)); 
  format Biomarker TID TRT TRT01PN POP POPN AVISIT AVISITN CORRTYP N CORRCF PCORR APCORR SIGFL;
  length TID $200 TRT $200 AVISIT $200 SIGFL $1;
  SET CORR_2_ALTIGE_adj
      CORR_2_IL13_adj
      CORR_2_IL17A_adj
	  CORR_2_IL22_adj
	  CORR_2_TARC_adj
	  CORR_6_ALTIGE_ADJ
      CORR_6_IL13_adj
      CORR_6_IL17A_adj
	  CORR_6_IL22_adj
	  CORR_6_TARC_adj
      CORR_9_ALTIGE_adj
      CORR_9_IL13_adj
      CORR_9_IL17A_adj
	  CORR_9_IL22_adj
	  CORR_9_TARC_adj
      CORR_15_ALTIGE_adj
      CORR_15_IL13_adj
      CORR_15_IL17A_adj
	  CORR_15_IL22_adj
	  CORR_15_TARC_adj;
  TID="T1402080106";
  select (POP);
   when ('BLIG01FL')    POPN=1;
   when ('BL1301FL')    POPN=2;
   when ('BL2201FL')    POPN=3;
   when ('BL1701FL')    POPN=4;
   when ('BLTA01FL')    POPN=5;
   when ('IGE01FL')     POPN=6;
   when ('IL1301FL')    POPN=7;
   when ('IL2201FL')    POPN=8;
   when ('IL1701FL')    POPN=9;
   when ('TARC01FL')    POPN=10;
   otherwise            POPN=.;
  end;
  select (AVISITN);
/*    when (2)    AVISIT="Visit 02 Baseline";*/
    when (6)    AVISIT="Visit 06 Week 4";
    when (9)    AVISIT="Visit 09 Week 16";
    when (15)   AVISIT="Visit 15 Week 24";
    otherwise   AVISIT="";
  end;

  select (TRT01PN);
    when (0)    TRT="Total";
    when (1)    TRT="250mg (500mg LD) KY1005";
    when (2)    TRT="250mg (no LD) KY1005";
    when (3)    TRT="125mg KY1005";
    when (4)    TRT="62.5mg KY1005";
    when (5)    TRT="KY1005 Treatment Arms Combined";
    when (6)    TRT="Placebo";
    otherwise   TRT="";
  end;
  if APCORR=. then APCORR=PCORR;
  if .<APCORR<0.05 then SIGFL="Y";
/*  if N LE 10 then delete;*/
  LABEL  TID  = "Table ID"
         TRT  = "Treatment"
         TRT01PN ="Treatment (N)"
         POP = "Population"
		 POPN = "Population (N)"
		 AVISIT = "Analysis Visit"
		 AVISITN = "Analysis Visit (N)"
		 CORRTYP = "Correlation type"
		 N = "N"
		 CORRCF = "Correlation coefficient"
		 PCORR = "P-value for correlation coefficient"
		 APCORR = "Adjusted p-value for correlation coefficient"
		 SIGFL = "Significance flag";
 run;

*Remove the formats and informats of variable N,CORRCF and PCORR in the SAS dataset;

Proc DataSets Lib = WORK;
  Modify CORR_EASI00;
  Format N CORRCF PCORR;
Run ;
Quit ;

*Generating adjusted p-value;
proc sort data=CORR_EASI00 out=STATOUTW.CORR_EASI;
  by TID TRTN POPN AVISITN CORRTYP;
run;

*************************************************************************
*        CLIENT:  Kymab
*      PROTOCOL:  KY1005CT05
*       PURPOSE:  MMRM_GMC at production side
*        AUTHOR:  ZHENHUA YUAN
*   INPUT FILES:  ADBM
*  OUTPUT FILES:  WORK.MMRM_GMC
*   	  NOTES:  
*		   DATE:  04/JAN/2023
************************************************************************* 
* CALLING EXAMPLE:
* %mMMRM_GMC(bmset=M1301FL,anlset=ANL02FL,paramcd=IL13,avisitn=6);
* %mMMRM_GMC(bmset=M1301FL,anlset=ANL02FL,paramcd=IL13,avisitn=9);
************************************************************************* 
*  Copyright 2022 Thermo Fisher Scientific Inc. All rights reserved.
*  All trademarks are the property of Thermo Fisher Scientific and its
*  subsidiaries unless otherwise specified. 
*************************************************************************;
options linesize=max;
options symbolgen mlogic mprint;
/*libname adb "\\wilbtib\wilbtia03\Kymab KY1005CT05\Interim Analysis\Databases\Analysis Database\Output";*/
/*libname adb1 "\\wilbtib\wilbtia03\Kymab KY1005CT05\Users\okelloeo\Interim Analysis\Databases\Analysis Database\Output_Dev";*/

proc datasets lib=work kill nolist nowarn;
quit;

dm "output; clear; log; clear";

%macro mMMRM_GMC(bmset=,anlset=,paramcd=,avisitn=);
data adbm;
  set adb.adbm;
run;

data adbm00;
  set adb.adbm;
  %if %substr(&bmset.,1,1) eq M %then %do;
  where &bmset. eq 'Y' and  &anlset.="Y" and   2<=&avisitn.<=16 ;
  %end;
  %else %do;
  where &bmset. eq 'Y' and  &anlset.="Y"  and   2<=&avisitn.<=16 ;
  %end;
run;

proc sort data=adbm00; by usubjid trtpn;run;

DATA ADBM_&paramcd.;
  SET ADBM00(WHERE=(paramcd="&paramcd."));
  %if &avisitn. = 6 %then %do;
     if (AVISITN IN (&avisitn.)) ;
  %end;  
  %else %if &avisitn. = 9 %then %do;
     if (AVISITN IN (6,9)) ;
  %end;
  %else %if &avisitn. = 15 %then %do;
     if (AVISITN IN (6,9,15)) ;
  %end;
  if missing(BASE)=0 and BASE>0 then LNBASE=LOG10(BASE);
  else delete;
run;

/*Perform MMRM model using TRTP variable;*/
proc mixed data=ADBM_&paramcd. method=reml;
   /*by  paramcd param  ;*/
    class trtpn(ref='5') avisitn usubjid dissev;
    model LNAVAL =LNBASE trtpn avisitn trtpn*avisitn dissev /solution ddfm=kr;
    repeated avisitn/subject=usubjid type=UN;
    lsmeans trtpn avisitn trtpn*avisitn  /diff alpha=0.05 cl;
    ods output lsmeans=lsm_a  diffs=diff_a;
run;

/*Perform MMRM model using TRTP variable;*/
proc mixed data=ADBM_&paramcd. method=reml;
   /*by  paramcd param  ;*/
    class ptgrp01n(ref='2') avisitn usubjid dissev;
    model LNAVAL = LNBASE ptgrp01n avisitn ptgrp01n*avisitn dissev /solution ddfm=kr;
    repeated avisitn/subject=usubjid type=UN; 
    lsmeans ptgrp01n avisitn ptgrp01n*avisitn  /diff alpha=0.05 cl;
    ods output lsmeans=lsm_b  diffs=diff_b;
run;

/* LSMeans estimates for Specific AVISITN*/
* For LSM_A;
data lsm_a1(drop= effect lower upper tvalue probt alpha df);
    Length PARAMCD $ 8;
    set lsm_a ;
	if &avisitn.=6 then do;
	  if avisitn=&avisitn.  and trtpn in (1,2,3,4,5);
	  end;
	else if &avisitn.=9 then do;
	  if avisitn in (6,9)  and trtpn in (1,2,3,4,5);
	  end;
	else if &avisitn.=15 then do;
	  if avisitn in (6,9,15)  and trtpn in (1,2,3,4,5);
	  end;
	rename estimate=L10MEAN stderr=L10SE;
	LSMEAN=10**estimate;
	SE=10**stderr;
	PVALLSM=probt;
	PARAMCD="&paramcd.";
run;
    
proc sort data=lsm_a1;
  by paramcd trtpn avisitn;
 run;

* For LSM_B;
data lsm_b1(drop=effect lower upper tvalue probt alpha df);
    Length PARAMCD $ 8;
    set lsm_b;
	if &avisitn.=6 then do;
	  if avisitn=&avisitn.  and ptgrp01n in (1,2);
	  end;
	else if &avisitn.=9 then do;
	  if avisitn in (6,9)  and ptgrp01n in (1,2);
	  end;
	else if &avisitn.=15 then do;
	  if avisitn in (6,9,15)  and ptgrp01n in (1,2);
	  end;
	Rename estimate=L10MEAN stderr=L10SE;
	LSMEAN=10**estimate;
	SE=10**stderr;
	PVALLSM=probt;
	PARAMCD="&paramcd.";
run;
    
proc sort data=lsm_b1;
  by paramcd ptgrp01n avisitn;
 run;

/*Diff Estimates for Specific AVISITN*/
* For Diff_a;
data diff_a1(drop=estimate stderr effect lower upper tvalue probt alpha df);
    Length PARAMCD $ 8;
    set diff_a;
	if &avisitn.=6 then do;
	if avisitn=_avisitn=&avisitn. and _trtpn=5;
	  end;
	else if &avisitn.=9 then do;
	  if avisitn=_avisitn and avisitn in (6,9) and _trtpn=5;
	  end;
	else if &avisitn.=15 then do;
	  if avisitn=_avisitn and avisitn in (6,9,15)  and _trtpn=5;
	  end;
    LSMDIFF=10**estimate;
    LOWERCL=10**lower;
    UPPERCL=10**upper;
    PVALLSMD=probt;
	PARAMCD="&paramcd.";
  run;

proc sort data=diff_a1;
  by paramcd trtpn avisitn;
 run;

*For Diff_b;
data diff_b1(drop=estimate stderr effect lower upper tvalue probt alpha df);
    Length PARAMCD $ 8;
    set diff_b;
	if &avisitn.=6 then do;
	  if avisitn=&avisitn  and _ptgrp01n=2;
	  end;
	else if &avisitn.=9 then do;
	  if avisitn=_avisitn and avisitn in (6,9)  and _ptgrp01n= 2;
	  end;
	else if &avisitn.=15 then do;
	  if avisitn=_avisitn and avisitn in (6,9,15)  and _ptgrp01n=2;
	  end;
    LSMDIFF=10**estimate;
    LOWERCL=10**lower;
    UPPERCL=10**upper;
    PVALLSMD=probt;
	PARAMCD="&paramcd.";
  run;

proc sort data=diff_b1;
  by paramcd ptgrp01n avisitn;
 run;

/*merging both LSMEANS and DIFF datasets*******/
*For model_1;
data final_&avisitn._&paramcd._a(keep= paramcd avisitn trtpn L10MEAN L10SE LSMEAN SE PVALLSM
             PARAMCD LSMDIFF LOWERCL UPPERCL PVALLSMD);
  merge lsm_a1(in=A )
        diff_a1(in=B);
  by paramcd trtpn avisitn;
  if A or B;
  if trtpn=5 then trtpn=6;
run;

*For model_2;
data final_&avisitn._&paramcd._b(keep= paramcd avisitn TRTPN L10MEAN L10SE LSMEAN SE PVALLSM 
             PARAMCD LSMDIFF LOWERCL UPPERCL PVALLSMD);
  merge lsm_b1(in=A )
        diff_b1(in=B);
  by paramcd ptgrp01n avisitn;
  if A or B;
  if ptgrp01n=1 then TRTPN=5;else if ptgrp01n=2 then delete;
run;

data final_&avisitn._&paramcd._tot(rename=(TRTPN=TRTN));
  length POP $ 200 POPN 8 RECTYP $ 200 AVISIT $ 200 TRT $ 200;
  set final_&avisitn._&paramcd._a
      final_&avisitn._&paramcd._b;
  POP="&bmset.";
  select (POP);
   when ('IGE01FL')      POPN=6;
   when ('IL1301FL')    POPN=7;
   when ('IL2201FL')    POPN=8;
   when ('IL1701FL')    POPN=9;
   when ('TARC01FL')    POPN=10;
   when ('MIGE01FL')    POPN=11;
   when ('M1301FL')     POPN=12;
   when ('M2201FL')     POPN=13;
   when ('M1701FL')     POPN=14;
   when ('MTAR01FL')    POPN=15;
   otherwise            POPN=.;
  end;
  if POPN in (6,7,8,9,10) then RECTYP='ANL01FL';
  else if POPN in (11,12,13,14,15) then RECTYP='ANL02FL';
  else RECTYP="";
  select (AVISITN);
    when (6)    AVISIT="Visit 06 Week 4";
    when (9)    AVISIT="Visit 09 Week 16";
    when (15)    AVISIT="Visit 15 Week 24";
    otherwise   AVISIT="";
  end;

  select (TRTPN);
    when (1)    TRT="250mg (500mg LD) KY1005";
    when (2)    TRT="250mg (no LD) KY1005";
    when (3)    TRT="125mg KY1005";
    when (4)    TRT="62.5mg KY1005";
    when (5)    TRT="KY1005 Treatment Arms Combined";
    when (6)    TRT="Placebo";
    otherwise   TRT="";
  end;
RUN;
%mend mMMRM_GMC;


%mMMRM_GMC(bmset=IGE01FL,anlset=ANL01FL,paramcd=ALTIGE,avisitn=15);
/*%mMMRM_GMC(bmset=IL1301FL,anlset=ANL01FL,paramcd=IL13,avisitn=6);*/
/*%mMMRM_GMC(bmset=IL1301FL,anlset=ANL01FL,paramcd=IL13,avisitn=9);*/
%mMMRM_GMC(bmset=IL1301FL,anlset=ANL01FL,paramcd=IL13,avisitn=15);
/*%mMMRM_GMC(bmset=IL1701FL,anlset=ANL01FL,paramcd=IL17A,avisitn=6);*/
/*%mMMRM_GMC(bmset=IL1701FL,anlset=ANL01FL,paramcd=IL17A,avisitn=9);*/
%mMMRM_GMC(bmset=IL1701FL,anlset=ANL01FL,paramcd=IL17A,avisitn=15);
/*%mMMRM_GMC(bmset=IL2201FL,anlset=ANL01FL,paramcd=IL22,avisitn=6);*/
/*%mMMRM_GMC(bmset=IL2201FL,anlset=ANL01FL,paramcd=IL22,avisitn=9);*/
%mMMRM_GMC(bmset=IL2201FL,anlset=ANL01FL,paramcd=IL22,avisitn=15);
/*%mMMRM_GMC(bmset=TARC01FL,anlset=ANL01FL,paramcd=TARC,avisitn=4);*/
/*%mMMRM_GMC(bmset=TARC01FL,anlset=ANL01FL,paramcd=TARC,avisitn=9);*/
%mMMRM_GMC(bmset=TARC01FL,anlset=ANL01FL,paramcd=TARC,avisitn=15);

data MMRM_GMC_T1;
  format TID TRT TRTN PARAMCD POP POPN RECTYP AVISIT AVISITN L10MEAN L10SE LSMEAN SE PVALLSM 
         LSMDIFF LOWERCL UPPERCL PVALLSMD;
  Length TID $ 200;
  set FINAL_15_ALTIGE_TOT
      FINAL_15_IL13_TOT
      FINAL_15_IL17A_TOT
      FINAL_15_IL22_TOT
      FINAL_15_TARC_TOT;
  TID="T140208010301";
run;

%mMMRM_GMC(bmset=MIGE01FL,anlset=ANL02FL,paramcd=ALTIGE,avisitn=15); 
/*%mMMRM_GMC(bmset=M1301FL,anlset=ANL02FL,paramcd=IL13,avisitn=6);*/
%mMMRM_GMC(bmset=M1301FL,anlset=ANL02FL,paramcd=IL13,avisitn=15);
/*%mMMRM_GMC(bmset=M1701FL,anlset=ANL02FL,paramcd=IL17A,avisitn=6);*/
%mMMRM_GMC(bmset=M1701FL,anlset=ANL02FL,paramcd=IL17A,avisitn=15);
/*%mMMRM_GMC(bmset=M2201FL,anlset=ANL02FL,paramcd=IL22,avisitn=6);*/
%mMMRM_GMC(bmset=M2201FL,anlset=ANL02FL,paramcd=IL22,avisitn=15);
/*%mMMRM_GMC(bmset=MTAR01FL,anlset=ANL02FL,paramcd=TARC,avisitn=4);*/
%mMMRM_GMC(bmset=MTAR01FL,anlset=ANL02FL,paramcd=TARC,avisitn=15);

data MMRM_GMC_T2;
  format TID TRT TRTN PARAMCD POP POPN RECTYP AVISIT AVISITN L10MEAN L10SE LSMEAN SE PVALLSM
         LSMDIFF LOWERCL UPPERCL PVALLSMD;
  Length TID $ 200;
  set FINAL_15_ALTIGE_TOT
      FINAL_15_IL13_TOT
      FINAL_15_IL17A_TOT
      FINAL_15_IL22_TOT
      FINAL_15_TARC_TOT;
  TID="T140208010302";
run;

data MMRM_GMC;
  set MMRM_GMC_T1
      MMRM_GMC_T2;
  Label TID	= "Table ID"
        TRT	= "Treatment"
        TRTN = "Treatment (N)"
        PARAMCD	= "Parameter code"
        POP	= "Population" 
        POPN = 	"Population (N)"
        RECTYP = "Record Type"
        AVISIT = "Analysis Visit"
        AVISITN	= "Analysis Visit (N)"
		L10MEAN = "Log10 LS Mean"
        L10SE = "Log10 Standard Error"
        LSMEAN = "LS Mean" 
        SE = "Standard Error"
        PVALLSM	= "P-value for LS Mean"
        LSMDIFF	= "LS Mean Difference"
        LOWERCL	= "95% Lower Confidence Limit"
        UPPERCL	= "95% Lower Confidence Limit"
        PVALLSMD = 	"P-value for LS Mean Difference";
run;

Proc DataSets Lib = WORK;
  Modify MMRM_GMC;
  Format _all_;
Run ;
Quit ;

proc sort data=MMRM_GMC out=STATOUTW.MMRM_GMC; by TID POPN TRTN PARAMCD RECTYP AVISITN;run;

data output.MMRM_GMC;
  set STATOUTW.MMRM_GMC;
RUN;

proc contents;run;

*************************************************************************
*        CLIENT:  Kymab
*      PROTOCOL:  KY1005CT05
*       PURPOSE:  MMRM_GMC_RESP at production side
*        AUTHOR:  ZHENHUA YUAN
*   INPUT FILES:  ADBM
*  OUTPUT FILES:  WORK.MMRM_GMC_RESP
*   	  NOTES:  
*		   DATE:  10/JAN/2023
************************************************************************* 
* CALLING EXAMPLE:
* %mMMRM_GMC_RESP(bmset=IL1301FL,anlset=ANL01FL,respvar=resp11,paramcd=IL13,avisitn=9);
* %mMMRM_GMC_RESP(bmset=M1301FL,anlset=ANL02FL,respvar=resp12,paramcd=IL13,avisitn=9);
************************************************************************* 
*  Copyright 2022 Thermo Fisher Scientific Inc. All rights reserved.
*  All trademarks are the property of Thermo Fisher Scientific and its
*  subsidiaries unless otherwise specified. 
*************************************************************************;
options linesize=max;
options symbolgen mlogic mprint;

proc datasets lib=work kill nolist nowarn;
quit;

dm "output; clear; log; clear";

%macro mMMRM_GMC_RESP(bmset=,anlset=,respvar=,paramcd=,avisitn=);

data adbm00;
  set adb.ADBM;
  %if %substr(&bmset.,1,1) eq M %then %do;
  where &bmset. eq 'Y' and  &anlset.="Y" and   2<=&avisitn.<=16 ;
    if CRIT3FL="Y" and PARAMCD = "EASIS" then resp12="Y";
    if CRIT4FL="Y" and PARAMCD = "EASIS" then resp22="Y";
    if CRIT2FL="Y" and PARAMCD = "IGA01" then resp32="Y";
  %end;
  %else %do;
  where &bmset. eq 'Y' and  &anlset.="Y"  and   2<=AVISITN<=16 ;
    if CRIT1FL="Y" and PARAMCD = "EASIS" then resp11="Y";
    if CRIT2FL="Y" and PARAMCD = "EASIS" then resp21="Y";
    if CRIT1FL="Y" and PARAMCD = "IGA01" then resp31="Y";
  %end;
run;

proc sort data=adbm00; by usubjid trtpn;run;

DATA ADBM_&paramcd.;
  SET ADBM00(WHERE=(paramcd="&paramcd."));
  %if &avisitn. = 6 %then %do;
     if (AVISITN IN (&avisitn.)) ;
  %end;  
  %else %if &avisitn. = 9 %then %do;
     if (AVISITN IN (6,9)) ;
  %end;
  %else %if &avisitn. = 15 %then %do;
     if (AVISITN IN (6,9,15)) ;
  %end;
  if missing(BASE)=0 and BASE>0 then LNBASE=LOG10(BASE);
  else delete;
run;

data ADBM_resp_&paramcd.(drop=&respvar.);
  length RESPTYP $ 200;
  merge ADBM_&paramcd.(in=a drop=&respvar.)
        ADBM00(where=(&respvar.="Y") KEEP=USUBJID &respvar. in=b);
  by usubjid;
  if a;
  if &respvar. NE 'Y' then &respvar.="Z";
  RESPTYP=&respvar.;
run;


/*Perform MMRM model using TRTP variable;*/
proc mixed data = ADBM_RESP_&paramcd. method=reml;
    class trtpn resptyp(ref='Z') avisitn usubjid;*(ref='5');
    model LNAVAL =LNBASE trtpn avisitn resptyp resptyp*trtpn*avisitn /solution ddfm=kr;
    repeated avisitn/subject=usubjid type=UN;
    lsmeans trtpn avisitn resptyp resptyp*trtpn*avisitn/diff alpha=0.05 cl;
    ods output lsmeans=lsm_a  diffs=diff_a;
run;

/*Perform MMRM model using ptgrp01n variable;*/
proc mixed data=ADBM_resp_&paramcd. method=reml;
    class ptgrp01n resptyp(ref='Z') avisitn usubjid;*(ref='2');
    model LNAVAL = LNBASE ptgrp01n avisitn resptyp resptyp*ptgrp01n*avisitn/solution ddfm=kr;
    repeated avisitn/subject=usubjid type=UN;
    lsmeans ptgrp01n avisitn resptyp resptyp*ptgrp01n*avisitn/diff alpha=0.05 cl;
    ods output lsmeans=lsm_b  diffs=diff_b;
run;

/* LSMeans estimates for Specific AVISITN*/
* For LSM_A;
data lsm_a1(drop= effect lower upper tvalue probt alpha df);
    Length PARAMCD $ 8;
    set lsm_a ;
	if &avisitn.=6 then do;
	  if avisitn=&avisitn.  and trtpn in (1,2,3,4,5) and resptyp in ("Y","Z");
	  end;
	else if &avisitn.=9 then do;
	  if avisitn in (6,9)  and trtpn in (1,2,3,4,5) and resptyp in ("Y","Z");
	  end;
	else if &avisitn.=15 then do;
	  if avisitn in (6,9,15)  and trtpn in (1,2,3,4,5) and resptyp in ("Y","Z");
	  end;
	rename estimate=L10MEAN stderr=L10SE;
	LSMEAN=10**estimate;
	SE=10**stderr;
	PVALLSM=probt;
	PARAMCD="&paramcd.";
run;
    
proc sort data=lsm_a1;
  by paramcd trtpn avisitn resptyp;
 run;

* For LSM_B;
data lsm_b1(drop= effect lower upper tvalue probt alpha df);
    Length PARAMCD $ 8;
    set lsm_b;
	if &avisitn.=6 then do;
	  if avisitn=&avisitn  and ptgrp01n in (1,2) and resptyp in ("Y","Z");
	  end;
	else if &avisitn.=9 then do;
	  if avisitn in (6,9)  and ptgrp01n in (1,2) and resptyp in ("Y","Z");
	  end;
	else if &avisitn.=15 then do;
	  if avisitn in (6,9,15)  and ptgrp01n in (1,2) and resptyp in ("Y","Z");
	  end;
	rename estimate=L10MEAN stderr=L10SE;
	LSMEAN=10**estimate;
	SE=10**stderr;
	PVALLSM=probt;
	PARAMCD="&paramcd.";
run;
    
proc sort data=lsm_b1;
  by paramcd ptgrp01n avisitn resptyp;
 run;

/*Diff Estimates for Specific AVISITN*/
* For Diff_a;
data diff_a1(drop=estimate stderr effect lower upper tvalue probt alpha df);
    Length PARAMCD $ 8;
    set diff_a;
	if &avisitn.=6 then do;
	if avisitn=_avisitn=&avisitn. and trtpn= _trtpn and _resptyp="Z";
	  end;
	else if &avisitn.=9 then do;
	  if avisitn=_avisitn and avisitn in (6,9) and trtpn= _trtpn and _resptyp="Z";
	  end;
	else if &avisitn.=15 then do;
	  if avisitn=_avisitn and avisitn in (6,9,15)  and trtpn= _trtpn and _resptyp="Z";
	  end;
    LSMDIFF=10**estimate;
    LOWERCL=10**lower;
    UPPERCL=10**upper;
    PVALLSMD=probt;
	PARAMCD="&paramcd.";
  run;

proc sort data=diff_a1;
  by paramcd trtpn avisitn resptyp;
 run;

*For Diff_b;
data diff_b1(drop=estimate stderr effect lower upper tvalue probt alpha df);
    Length PARAMCD $ 8;
    set diff_b;
	if &avisitn.=6 then do;
	  if avisitn=&avisitn.  and ptgrp01n=_ptgrp01n and _resptyp="Z";
	  end;
	else if &avisitn.=9 then do;
	  if avisitn=_avisitn and avisitn in (6,9)  and ptgrp01n=_ptgrp01n and _resptyp="Z";
	  end;
	else if &avisitn.=15 then do;
	  if avisitn=_avisitn and avisitn in (6,9,15)  and ptgrp01n=_ptgrp01n and _resptyp="Z";
	  end;
    LSMDIFF=10**estimate;
    LOWERCL=10**lower;
    UPPERCL=10**upper;
    PVALLSMD=probt;
	PARAMCD="&paramcd.";
  run;

proc sort data=diff_b1;
  by paramcd ptgrp01n avisitn resptyp;
 run;

/*merging both LSMEANS and DIFF datasets*******/
*For model_1;
data final_&avisitn._&paramcd._a(keep= paramcd avisitn trtpn resptyp L10MEAN L10SE LSMEAN SE 
             PVALLSM PARAMCD LSMDIFF LOWERCL UPPERCL PVALLSMD);
  merge lsm_a1(in=A )
        diff_a1(in=B);
  by paramcd trtpn avisitn resptyp;
  if A or B;
  if trtpn=5 then trtpn=6;
run;

*For model_2;
data final_&avisitn._&paramcd._b(keep= paramcd avisitn TRTPN resptyp L10MEAN L10SE LSMEAN SE 
             PVALLSM PARAMCD LSMDIFF LOWERCL UPPERCL PVALLSMD);
  merge lsm_b1(in=A )
        diff_b1(in=B);
  by paramcd ptgrp01n avisitn resptyp;
  if A or B;
  if ptgrp01n=1 then TRTPN=5;else if ptgrp01n=2 then delete;
run;

data final_&avisitn._&paramcd._&respvar.(rename=(TRTPN=TRTN) drop= RESPTYP 
                                         rename=(RESPTYP1=RESPTYP));
  length POP $ 200 POPN 8 RECTYP $ 200 AVISIT $ 200 TRT $ 200 ENDPT $ 200 RESPTEST $ 200
         RESPTYP1 $200;       
  set final_&avisitn._&paramcd._a
      final_&avisitn._&paramcd._b;
  POP="&bmset.";
  select (POP);
   when ('IGE01FL')      POPN=6;
   when ('IL1301FL')    POPN=7;
   when ('IL2201FL')    POPN=8;
   when ('IL1701FL')    POPN=9;
   when ('TARC01FL')    POPN=10;
   when ('MIGE01FL')    POPN=11;
   when ('M1301FL')     POPN=12;
   when ('M2201FL')     POPN=13;
   when ('M1701FL')     POPN=14;
   when ('MTAR01FL')    POPN=15;
   otherwise            POPN=.;
  end;
  if POPN in (6,7,8,9,10) then RECTYP='ANL01FL';
  else if POPN in (11,12,13,14,15) then RECTYP='ANL02FL';
  else RECTYP="";
  select (AVISITN);
    when (6)    AVISIT="Visit 06 Week 4";
    when (9)    AVISIT="Visit 09 Week 16";
    when (15)    AVISIT="Visit 15 Week 24";
    otherwise   AVISIT="";
  end;

  select (TRTPN);
    when (1)    TRT="250mg (500mg LD) KY1005";
    when (2)    TRT="250mg (no LD) KY1005";
    when (3)    TRT="125mg KY1005";
    when (4)    TRT="62.5mg KY1005";
    when (5)    TRT="KY1005 Treatment Arms Combined";
    when (6)    TRT="Placebo";
    otherwise   TRT="";
  end;
  
  if "&respvar." in ("resp31","resp32") then ENDPT="IGA";else ENDPT="EASI";

  if "&respvar."="resp11" then RESPTEST="CRIT1FL";
  else if "&respvar."="resp21" then RESPTEST="CRIT2FL";
  else if "&respvar."="resp12" then RESPTEST="CRIT3FL";
  else if "&respvar."="resp22" then RESPTEST="CRIT4FL";
  else if "&respvar."="resp31" then RESPTEST="CRIT1FL";
  else if "&respvar."="resp32" then RESPTEST="CRIT2FL";

  if RESPTYP="Y" then RESPTYP1="RESPONDER";else RESPTYP1="NONRESPONDER";
RUN;
%mend mMMRM_GMC_RESP;

*For respvar=resp11 and avisitn=15;
%mMMRM_GMC_RESP(bmset=IGE01FL,anlset=ANL01FL,respvar=resp11,paramcd=ALTIGE,avisitn=15);
%mMMRM_GMC_RESP(bmset=IL1301FL,anlset=ANL01FL,respvar=resp11,paramcd=IL13,avisitn=15);
%mMMRM_GMC_RESP(bmset=IL1701FL,anlset=ANL01FL,respvar=resp11,paramcd=IL17A,avisitn=15);
%mMMRM_GMC_RESP(bmset=IL2201FL,anlset=ANL01FL,respvar=resp11,paramcd=IL22,avisitn=15);
%mMMRM_GMC_RESP(bmset=TARC01FL,anlset=ANL01FL,respvar=resp11,paramcd=TARC,avisitn=15);

data MMRM_GMC_RESP_T11V15;
  format TID TRT TRTN PARAMCD POP POPN RECTYP ENDPT RESPTEST RESPTYP AVISIT AVISITN L10MEAN 
         L10SE LSMEAN SE PVALLSM LSMDIFF LOWERCL UPPERCL PVALLSMD;
  Length TID $ 200;
  set Final_15_ALTIGE_RESP11
      Final_15_IL13_RESP11
      Final_15_IL17A_RESP11
      Final_15_IL22_RESP11
      Final_15_TARC_RESP11;
    TID="T14020801050101";
run;

*For respvar=resp12 and avisitn=15;
%mMMRM_GMC_RESP(bmset=MIGE01FL,anlset=ANL02FL,respvar=resp12,paramcd=ALTIGE,avisitn=15);
%mMMRM_GMC_RESP(bmset=M1301FL,anlset=ANL02FL,respvar=resp12,paramcd=IL13,avisitn=15);
%mMMRM_GMC_RESP(bmset=M1701FL,anlset=ANL02FL,respvar=resp12,paramcd=IL17A,avisitn=15);
%mMMRM_GMC_RESP(bmset=M2201FL,anlset=ANL02FL,respvar=resp12,paramcd=IL22,avisitn=15);
%mMMRM_GMC_RESP(bmset=MTAR01FL,anlset=ANL02FL,respvar=resp12,paramcd=TARC,avisitn=15);

data MMRM_GMC_RESP_T12V15;
  format TID TRT TRTN PARAMCD POP POPN RECTYP ENDPT RESPTEST RESPTYP AVISIT AVISITN L10MEAN 
         L10SE LSMEAN SE PVALLSM LSMDIFF LOWERCL UPPERCL PVALLSMD;
  Length TID $ 200;
  set Final_15_ALTIGE_RESP12
      Final_15_IL13_RESP12
      Final_15_IL17A_RESP12
      Final_15_IL22_RESP12
      Final_15_TARC_RESP12;
    TID="T14020801050102";
run;

 
*For respvar=resp21 and avisitn=15;
%mMMRM_GMC_RESP(bmset=IGE01FL,anlset=ANL01FL,respvar=resp21,paramcd=ALTIGE,avisitn=15);
%mMMRM_GMC_RESP(bmset=IL1301FL,anlset=ANL01FL,respvar=resp21,paramcd=IL13,avisitn=15);
%mMMRM_GMC_RESP(bmset=IL1701FL,anlset=ANL01FL,respvar=resp21,paramcd=IL17A,avisitn=15);
%mMMRM_GMC_RESP(bmset=IL2201FL,anlset=ANL01FL,respvar=resp21,paramcd=IL22,avisitn=15);
%mMMRM_GMC_RESP(bmset=TARC01FL,anlset=ANL01FL,respvar=resp21,paramcd=TARC,avisitn=15);

data MMRM_GMC_RESP_T21V15;
  format TID TRT TRTN PARAMCD POP POPN RECTYP ENDPT RESPTEST RESPTYP AVISIT AVISITN L10MEAN 
         L10SE LSMEAN SE PVALLSM LSMDIFF LOWERCL UPPERCL PVALLSMD;
  Length TID $ 200;
  set Final_15_ALTIGE_RESP21
      Final_15_IL13_RESP21
      Final_15_IL17A_RESP21
      Final_15_IL22_RESP21
      Final_15_TARC_RESP21;
    TID="T14020801050201";
run;

*For respvar=resp22 and avisitn=15;
%mMMRM_GMC_RESP(bmset=MIGE01FL,anlset=ANL02FL,respvar=resp22,paramcd=ALTIGE,avisitn=15);
%mMMRM_GMC_RESP(bmset=M1301FL,anlset=ANL02FL,respvar=resp22,paramcd=IL13,avisitn=15);
%mMMRM_GMC_RESP(bmset=M1701FL,anlset=ANL02FL,respvar=resp22,paramcd=IL17A,avisitn=15);
%mMMRM_GMC_RESP(bmset=M2201FL,anlset=ANL02FL,respvar=resp22,paramcd=IL22,avisitn=15);
%mMMRM_GMC_RESP(bmset=MTAR01FL,anlset=ANL02FL,respvar=resp22,paramcd=TARC,avisitn=15);


data MMRM_GMC_RESP_T22V15;
  format TID TRT TRTN PARAMCD POP POPN RECTYP ENDPT RESPTEST RESPTYP AVISIT AVISITN L10MEAN 
         L10SE LSMEAN SE PVALLSM LSMDIFF LOWERCL UPPERCL PVALLSMD;
  Length TID $ 200;
  set Final_15_ALTIGE_RESP22
      Final_15_IL13_RESP22
      Final_15_IL17A_RESP22
      Final_15_IL22_RESP22
      Final_15_TARC_RESP22;
    TID="T14020801050202";
run;

*For respvar=resp31 and avisitn=15;
%mMMRM_GMC_RESP(bmset=IGE01FL,anlset=ANL01FL,respvar=resp31,paramcd=ALTIGE,avisitn=15);
%mMMRM_GMC_RESP(bmset=IL1301FL,anlset=ANL01FL,respvar=resp31,paramcd=IL13,avisitn=15);
%mMMRM_GMC_RESP(bmset=IL1701FL,anlset=ANL01FL,respvar=resp31,paramcd=IL17A,avisitn=15);
%mMMRM_GMC_RESP(bmset=IL2201FL,anlset=ANL01FL,respvar=resp31,paramcd=IL22,avisitn=15);
%mMMRM_GMC_RESP(bmset=TARC01FL,anlset=ANL01FL,respvar=resp31,paramcd=TARC,avisitn=15);


data MMRM_GMC_RESP_T31V15;
  format TID TRT TRTN PARAMCD POP POPN RECTYP ENDPT RESPTEST RESPTYP AVISIT AVISITN L10MEAN 
         L10SE LSMEAN SE PVALLSM LSMDIFF LOWERCL UPPERCL PVALLSMD;
  Length TID $ 200;
  set Final_15_ALTIGE_RESP31
      Final_15_IL13_RESP31
      Final_15_IL17A_RESP31
      Final_15_IL22_RESP31
      Final_15_TARC_RESP31;
    TID="T14020801050301";
run;

*For respvar=resp32 and avisitn=15;
%mMMRM_GMC_RESP(bmset=MIGE01FL,anlset=ANL02FL,respvar=resp32,paramcd=ALTIGE,avisitn=15); 
%mMMRM_GMC_RESP(bmset=M1301FL,anlset=ANL02FL,respvar=resp32,paramcd=IL13,avisitn=15);
%mMMRM_GMC_RESP(bmset=M1701FL,anlset=ANL02FL,respvar=resp32,paramcd=IL17A,avisitn=15);
%mMMRM_GMC_RESP(bmset=M2201FL,anlset=ANL02FL,respvar=resp32,paramcd=IL22,avisitn=15);
%mMMRM_GMC_RESP(bmset=MTAR01FL,anlset=ANL02FL,respvar=resp32,paramcd=TARC,avisitn=15);


data MMRM_GMC_RESP_T32V15;
  format TID TRT TRTN PARAMCD POP POPN RECTYP ENDPT RESPTEST RESPTYP AVISIT AVISITN L10MEAN 
         L10SE LSMEAN SE PVALLSM LSMDIFF LOWERCL UPPERCL PVALLSMD;
  Length TID $ 200;
  set Final_15_ALTIGE_RESP32
      Final_15_IL13_RESP32
      Final_15_IL17A_RESP32
      Final_15_IL22_RESP32
      Final_15_TARC_RESP32;
    TID="T14020801050302";
run;

data MMRM_GMC_RESP;
  set MMRM_GMC_RESP_T11V15
	  MMRM_GMC_RESP_T12V15
	  MMRM_GMC_RESP_T21V15
	  MMRM_GMC_RESP_T22V15
	  MMRM_GMC_RESP_T31V15
      MMRM_GMC_RESP_T32V15;
  Label TID	= "Table ID"
        TRT	= "Treatment"
        TRTN = "Treatment (N)"
        PARAMCD	= "Parameter code"
        POP	= "Population" 
        POPN = 	"Population (N)"
        RECTYP = "Record Type"
        ENDPT =	"Endpoint"
        RESPTEST = "Response Test"
        RESPTYP = "Responder Type"
        AVISIT = "Analysis Visit"
        AVISITN	= "Analysis Visit (N)"
		L10MEAN = "Log10 LS Mean"
        L10SE = "Log10 Standard Error"
        LSMEAN = "LS Mean" 
        SE = "Standard Error"
        PVALLSM	= "P-value for LS Mean"
        LSMDIFF	= "LS Mean Difference"
        LOWERCL	= "95% Lower Confidence Limit"
        UPPERCL	= "95% Lower Confidence Limit"
        PVALLSMD = "P-value for LS Mean Difference";
run;

Proc DataSets Lib = WORK;
  Modify MMRM_GMC_RESP;
  Format _all_;
Run ;
Quit ;

proc sort data=MMRM_GMC_RESP out=STATOUTW.MMRM_GMC_RESP; 
  by TID POPN PARAMCD TRTN RECTYP ENDPT RESPTEST RESPTYP AVISITN;
run;

data output.MMRM_GMC_RESP;
  set STATOUTW.MMRM_GMC_RESP;
run;

*************************************************************************
*        CLIENT:  Kymab
*      PROTOCOL:  KY1005CT05
*       PURPOSE:  MMRM_GMI at production side
*        AUTHOR:  ZHENHUA YUAN
*   INPUT FILES:  ADBM
*  OUTPUT FILES:  WORK.MMRM_GMI
*   	  NOTES:  
*		   DATE:  04/JAN/2023
************************************************************************* 
* CALLING EXAMPLE:
* %mMMRM_GMI(bmset=M1301FL,anlset=ANL02FL,paramcd=IL13,avisitn=6);
* %mMMRM_GMI(bmset=M1301FL,anlset=ANL02FL,paramcd=IL13,avisitn=9);
************************************************************************* 
*  Copyright 2022 Thermo Fisher Scientific Inc. All rights reserved.
*  All trademarks are the property of Thermo Fisher Scientific and its
*  subsidiaries unless otherwise specified. 
*************************************************************************;
options linesize=max;
options symbolgen mlogic mprint;

proc datasets lib=work kill nolist nowarn;
quit;

dm "output; clear; log; clear";

%macro mMMRM_GMI(bmset=,anlset=,paramcd=,avisitn=);
data adbm00;
  set adb.adbm;
  %if %substr(&bmset.,1,1) eq M %then %do;
  where &bmset. eq 'Y' and  &anlset.="Y" and   2<=&avisitn.<=16 ;
  %end;
  %else %do;
  where &bmset. eq 'Y' and  &anlset.="Y"  and   2<=&avisitn.<=16 ;
  %end;
run;

proc sort data=adbm00; by usubjid trtpn;run;

DATA ADBM_&paramcd.;
  SET ADBM00(WHERE=(paramcd="&paramcd."));
  %if &avisitn. = 6 %then %do;
     if (AVISITN IN (&avisitn.)) ;
  %end;  
  %else %if &avisitn. = 9 %then %do;
     if (AVISITN IN (6,9)) ;
  %end;
  %else %if &avisitn. = 15 %then %do;
     if (AVISITN IN (6,9,15)) ;
  %end;
  if missing(BASE)=0 and BASE>0 then LNBASE=LOG10(BASE);
  else delete;
run;

data ADBM_&paramcd.1;
  set ADBM_&paramcd.;
  if missing(LNR2BASE) or missing(trtpn)or missing(avisitn)or missing(dissev) then delete;
RUN;

/*Perform MMRM model using TRTP variable;*/
proc mixed data=ADBM_&paramcd.1 method=reml;
    class trtpn(ref='5') avisitn usubjid dissev;
    model LNR2BASE = trtpn avisitn trtpn*avisitn dissev /solution ddfm=kr;*ddfm=kr satterthwaite;
    repeated avisitn/subject=usubjid type=UN;
    lsmeans trtpn avisitn trtpn*avisitn  /diff alpha=0.05 cl;
    ods output lsmeans=lsm_a  diffs=diff_a;
run;


/*Perform MMRM model using PTGRP01N variable;*/
data ADBM_&paramcd.2;
  set ADBM_&paramcd.;
  if missing(LNR2BASE) or missing(ptgrp01n)or missing(avisitn)or missing(dissev) then delete;
RUN;

proc mixed data=ADBM_&paramcd.2 method=reml;
    class ptgrp01n(ref='2') avisitn usubjid dissev;
    model LNR2BASE = ptgrp01n avisitn ptgrp01n*avisitn dissev /solution ddfm=kr;
    repeated avisitn/subject=usubjid type=UN;
    lsmeans ptgrp01n avisitn ptgrp01n*avisitn  /diff alpha=0.05 cl;
    ods output lsmeans=lsm_b  diffs=diff_b;
run;

/* LSMeans estimates for Specific AVISITN*/
* For LSM_A;
data lsm_a1(drop=effect lower upper tvalue probt alpha df);
    Length PARAMCD $ 8;
    set lsm_a ;
	if &avisitn.=6 then do;
	  if avisitn=&avisitn.  and trtpn in (1,2,3,4,5);
	  end;
	else if &avisitn.=9 then do;
	  if avisitn in (6,9)  and trtpn in (1,2,3,4,5);
	  end;
	else if &avisitn.=15 then do;
	  if avisitn in (6,9,15)  and trtpn in (1,2,3,4,5);
	  end;
	rename estimate=L10MEAN stderr=L10SE;
	LSMEAN=10**estimate;
	SE=10**stderr;
	PVALLSM=probt;
	PARAMCD="&paramcd.";
run;
    
proc sort data=lsm_a1;
  by paramcd trtpn avisitn;
 run;

* For LSM_B;
data lsm_b1(drop= effect lower upper tvalue probt alpha df);
    Length PARAMCD $ 8;
    set lsm_b;
	if &avisitn.=6 then do;
	  if avisitn=&avisitn.  and ptgrp01n in (1,2);
	  end;
	else if &avisitn.=9 then do;
	  if avisitn in (6,9)  and ptgrp01n in (1,2);
	  end;
	else if &avisitn.=15 then do;
	  if avisitn in (6,9,15)  and ptgrp01n in (1,2);
	  end;
	rename estimate=L10MEAN stderr=L10SE;
	LSMEAN=10**estimate;
	SE=10**stderr;
	PVALLSM=probt;
	PARAMCD="&paramcd.";
run;
    
proc sort data=lsm_b1;
  by paramcd ptgrp01n avisitn;
 run;

/*Diff Estimates for Specific AVISITN*/
* For Diff_a;
data diff_a1(drop=estimate stderr effect lower upper tvalue probt alpha df);
    Length PARAMCD $ 8;
    set diff_a;
	if &avisitn.=6 then do;
	if avisitn=_avisitn=&avisitn. and _trtpn=5;
	  end;
	else if &avisitn.=9 then do;
	  if avisitn=_avisitn and avisitn in (6,9) and _trtpn=5;
	  end;
	else if &avisitn.=15 then do;
	  if avisitn=_avisitn and avisitn in (6,9,15)  and _trtpn=5;
	  end;
    LSMDIFF=10**estimate;
    LOWERCL=10**lower;
    UPPERCL=10**upper;
    PVALLSMD=probt;
	PARAMCD="&paramcd.";
  run;

proc sort data=diff_a1;
  by paramcd trtpn avisitn;
 run;

*For Diff_b;
data diff_b1(drop=estimate stderr effect lower upper tvalue probt alpha df);
    Length PARAMCD $ 8;
    set diff_b;
	if &avisitn.=6 then do;
	  if avisitn=&avisitn.  and _ptgrp01n=2;
	  end;
	else if &avisitn.=9 then do;
	  if avisitn=_avisitn and avisitn in (6,9)  and _ptgrp01n= 2;
	  end;
	else if &avisitn.=15 then do;
	  if avisitn=_avisitn and avisitn in (6,9,15)  and _ptgrp01n=2;
	  end;
    LSMDIFF=10**estimate;
    LOWERCL=10**lower;
    UPPERCL=10**upper;
    PVALLSMD=probt;
	PARAMCD="&paramcd.";
  run;

proc sort data=diff_b1;
  by paramcd ptgrp01n avisitn;
 run;

/*merging both LSMEANS and DIFF datasets*******/
*For model_1;
data final_&avisitn._&paramcd._a(keep= paramcd avisitn trtpn L10MEAN L10SE LSMEAN SE PVALLSM 
             PARAMCD LSMDIFF LOWERCL UPPERCL PVALLSMD);
  merge lsm_a1(in=A )
        diff_a1(in=B);
  by paramcd trtpn avisitn;
  if A or B;
  if trtpn=5 then trtpn=6;
run;

*For model_2;
data final_&avisitn._&paramcd._b(keep= paramcd avisitn TRTPN L10MEAN L10SE LSMEAN SE PVALLSM 
             PARAMCD LSMDIFF LOWERCL UPPERCL PVALLSMD);
  merge lsm_b1(in=A ) 
        diff_b1(in=B);
  by paramcd ptgrp01n avisitn;
  if A or B;
  if ptgrp01n=1 then TRTPN=5;else if ptgrp01n=2 then delete;
run;

data final_&avisitn._&paramcd._tot(rename=(TRTPN=TRTN));
  length POP $ 200 POPN 8 RECTYP $ 200 AVISIT $ 200 TRT $ 200;
  set final_&avisitn._&paramcd._a
      final_&avisitn._&paramcd._b;
  POP="&bmset.";
  select (POP);
   when ('IGE01FL')      POPN=6;
   when ('IL1301FL')    POPN=7;
   when ('IL2201FL')    POPN=8;
   when ('IL1701FL')    POPN=9;
   when ('TARC01FL')    POPN=10;
   when ('MIGE01FL')    POPN=11;
   when ('M1301FL')     POPN=12;
   when ('M2201FL')     POPN=13;
   when ('M1701FL')     POPN=14;
   when ('MTAR01FL')    POPN=15;
   otherwise            POPN=.;
  end;
  if POPN in (6,7,8,9,10) then RECTYP='ANL01FL';
  else if POPN in (11,12,13,14,15) then RECTYP='ANL02FL';
  else RECTYP="";
  select (AVISITN);
    when (6)    AVISIT="Visit 06 Week 4";
    when (9)    AVISIT="Visit 09 Week 16";
    when (15)    AVISIT="Visit 15 Week 24";
    otherwise   AVISIT="";
  end;

  select (TRTPN);
    when (1)    TRT="250mg (500mg LD) KY1005";
    when (2)    TRT="250mg (no LD) KY1005";
    when (3)    TRT="125mg KY1005";
    when (4)    TRT="62.5mg KY1005";
    when (5)    TRT="KY1005 Treatment Arms Combined";
    when (6)    TRT="Placebo";
    otherwise   TRT="";
  end;
RUN;
%mend mMMRM_GMI;

%mMMRM_GMI(bmset=IGE01FL,anlset=ANL01FL,paramcd=ALTIGE,avisitn=15);
%mMMRM_GMI(bmset=IL1301FL,anlset=ANL01FL,paramcd=IL13,avisitn=15);
%mMMRM_GMI(bmset=IL1701FL,anlset=ANL01FL,paramcd=IL17A,avisitn=15);
%mMMRM_GMI(bmset=IL2201FL,anlset=ANL01FL,paramcd=IL22,avisitn=15);
%mMMRM_GMI(bmset=TARC01FL,anlset=ANL01FL,paramcd=TARC,avisitn=15);

data MMRM_GMI_T1;
  format TID TRT TRTN PARAMCD POP POPN RECTYP AVISIT AVISITN L10MEAN L10SE LSMEAN SE PVALLSM 
         LSMDIFF LOWERCL UPPERCL PVALLSMD;
  Length TID $ 200;
  set FINAL_15_ALTIGE_TOT
      FINAL_15_IL13_TOT
      FINAL_15_IL17A_TOT
      FINAL_15_IL22_TOT
      FINAL_15_TARC_TOT;
  TID="T140208010301";
run;
 
%mMMRM_GMI(bmset=MIGE01FL,anlset=ANL02FL,paramcd=ALTIGE,avisitn=15);  
%mMMRM_GMI(bmset=M1301FL,anlset=ANL02FL,paramcd=IL13,avisitn=15);
%mMMRM_GMI(bmset=M1701FL,anlset=ANL02FL,paramcd=IL17A,avisitn=15);
%mMMRM_GMI(bmset=M2201FL,anlset=ANL02FL,paramcd=IL22,avisitn=15);
%mMMRM_GMI(bmset=MTAR01FL,anlset=ANL02FL,paramcd=TARC,avisitn=15);

data MMRM_GMI_T2;
  format TID TRT TRTN PARAMCD POP POPN RECTYP AVISIT AVISITN L10MEAN L10SE LSMEAN SE PVALLSM 
         LSMDIFF LOWERCL UPPERCL PVALLSMD;
  Length TID $ 200;
  set FINAL_15_ALTIGE_TOT
      FINAL_15_IL13_TOT
      FINAL_15_IL17A_TOT
      FINAL_15_IL22_TOT
      FINAL_15_TARC_TOT;
  TID="T140208010302";
run;

data MMRM_GMI;
  set MMRM_GMI_T1
      MMRM_GMI_T2;
  Label TID	= "Table ID"
        TRT	= "Treatment"
        TRTN = "Treatment (N)"
        PARAMCD	= "Parameter code"
        POP	= "Population" 
        POPN = 	"Population (N)"
        RECTYP = "Record Type"
        AVISIT = "Analysis Visit"
        AVISITN	= "Analysis Visit (N)"
		L10MEAN = "Log10 LS Mean"
        L10SE = "Log10 Standard Error"
        LSMEAN = "LS Mean" 
        SE = "Standard Error"
        PVALLSM	= "P-value for LS Mean"
        LSMDIFF	= "LS Mean Difference"
        LOWERCL	= "95% Lower Confidence Limit"
        UPPERCL	= "95% Lower Confidence Limit"
        PVALLSMD = 	"P-value for LS Mean Difference";
run;

Proc DataSets Lib = WORK;
  Modify MMRM_GMI;
  Format _all_;
Run ;
Quit ;

proc sort data=MMRM_GMI out= STATOUTW.MMRM_GMI; by TID POPN TRTN PARAMCD RECTYP AVISITN;run;

DATA output.MMRM_GMI;
  set STATOUTW.MMRM_GMI;
RUN;

*************************************************************************
*        CLIENT:  Kymab
*      PROTOCOL:  KY1005CT05
*       PURPOSE:  MMRM_GMI_RESP at production side
*        AUTHOR:  ZHENHUA YUAN
*   INPUT FILES:  ADBM
*  OUTPUT FILES:  WORK.MMRM_GMI_RESP
*   	  NOTES:  
*		   DATE:  10/JAN/2023
************************************************************************* 
* CALLING EXAMPLE:
* %mMMRM_GMI_RESP(bmset=IL1301FL,anlset=ANL01FL,respvar=resp11,paramcd=IL13,avisitn=9);
* %mMMRM_GMI_RESP(bmset=M1301FL,anlset=ANL02FL,respvar=resp12,paramcd=IL13,avisitn=9);
************************************************************************* 
*  Copyright 2022 Thermo Fisher Scientific Inc. All rights reserved.
*  All trademarks are the property of Thermo Fisher Scientific and its
*  subsidiaries unless otherwise specified. 
*************************************************************************;
options linesize=max;
options symbolgen mlogic mprint;

proc datasets lib=work kill nolist nowarn;
quit;

dm "output; clear; log; clear";

%macro mMMRM_GMI_RESP(bmset=,anlset=,respvar=,paramcd=,avisitn=);

data adbm00;
  set adb.ADBM;
  %if %substr(&bmset.,1,1) eq M %then %do;
  where &bmset. eq 'Y' and  &anlset.="Y" and   2<=&avisitn.<=16 ;
    if CRIT3FL="Y" and PARAMCD = "EASIS" then resp12="Y";
    if CRIT4FL="Y" and PARAMCD = "EASIS" then resp22="Y";
    if CRIT2FL="Y" and PARAMCD = "IGA01" then resp32="Y";
  %end;
  %else %do;
  where &bmset. eq 'Y' and  &anlset.="Y"  and   2<=AVISITN<=16 ;
    if CRIT1FL="Y" and PARAMCD = "EASIS" then resp11="Y";
    if CRIT2FL="Y" and PARAMCD = "EASIS" then resp21="Y";
    if CRIT1FL="Y" and PARAMCD = "IGA01" then resp31="Y";
  %end;
run;

proc sort data=adbm00; by usubjid trtpn;run;

DATA ADBM_&paramcd.;
  SET ADBM00(WHERE=(paramcd="&paramcd."));
  %if &avisitn. = 6 %then %do;
     if (AVISITN IN (&avisitn.)) ;
  %end;  
  %else %if &avisitn. = 9 %then %do;
     if (AVISITN IN (6,9)) ;
  %end;
  %else %if &avisitn. = 15 %then %do;
     if (AVISITN IN (6,9,15)) ;
  %end;
  if missing(BASE)=0 and BASE>0 then LNBASE=LOG10(BASE);
  else delete;
run;

data ADBM_resp_&paramcd.(drop=&respvar.);
  length RESPTYP $ 200;
  merge ADBM_&paramcd.(in=a drop=&respvar.)
        ADBM00(where=(&respvar.="Y") KEEP=USUBJID &respvar. in=b);
  by usubjid;
  if a;
  if &respvar. NE 'Y' then &respvar.="Z";
  RESPTYP=&respvar.;
run;

/*Perform MMRM model using TRTP variable;*/
proc mixed data = ADBM_RESP_&paramcd. method=reml;
    class trtpn resptyp(ref='Z') avisitn usubjid;
    model LNR2BASE =trtpn avisitn resptyp resptyp*trtpn*avisitn /solution ddfm=kr;
    repeated avisitn/subject=usubjid type=UN;
    lsmeans trtpn avisitn resptyp resptyp*trtpn*avisitn/diff alpha=0.05 cl;
    ods output lsmeans=lsm_a  diffs=diff_a;
run;

/*Perform MMRM model using ptgrp01n variable;*/
proc mixed data=ADBM_resp_&paramcd. method=reml;
    class ptgrp01n resptyp(ref='Z') avisitn usubjid;
    model LNR2BASE = ptgrp01n avisitn resptyp resptyp*ptgrp01n*avisitn/solution ddfm=kr;
    repeated avisitn/subject=usubjid type=UN;
    lsmeans ptgrp01n avisitn resptyp resptyp*ptgrp01n*avisitn/diff alpha=0.05 cl;
    ods output lsmeans=lsm_b  diffs=diff_b;
run;


/* LSMeans estimates for Specific AVISITN*/
* For LSM_A;
data lsm_a1(drop= effect lower upper tvalue probt alpha df);
    Length PARAMCD $ 8;
    set lsm_a ;
	if &avisitn.=6 then do;
	  if avisitn=&avisitn.  and trtpn in (1,2,3,4,5) and resptyp in ("Y","Z");
	  end;
	else if &avisitn.=9 then do;
	  if avisitn in (6,9)  and trtpn in (1,2,3,4,5) and resptyp in ("Y","Z");
	  end;
	else if &avisitn.=15 then do;
	  if avisitn in (6,9,15)  and trtpn in (1,2,3,4,5) and resptyp in ("Y","Z");
	  end;
    rename estimate=L10MEAN stderr=L10SE;
	LSMEAN=10**estimate;
	SE=10**stderr;
	PVALLSM=probt;
	PARAMCD="&paramcd.";
run;
    
proc sort data=lsm_a1;
  by paramcd trtpn avisitn resptyp;
 run;

* For LSM_B;
data lsm_b1(drop= effect lower upper tvalue probt alpha df);
    Length PARAMCD $ 8;
    set lsm_b;
	if &avisitn.=6 then do;
	  if avisitn=&avisitn  and ptgrp01n in (1,2) and resptyp in ("Y","Z");
	  end;
	else if &avisitn.=9 then do;
	  if avisitn in (6,9)  and ptgrp01n in (1,2) and resptyp in ("Y","Z");
	  end;
	else if &avisitn.=15 then do;
	  if avisitn in (6,9,15)  and ptgrp01n in (1,2) and resptyp in ("Y","Z");
	  end;
	rename estimate=L10MEAN stderr=L10SE;
	LSMEAN=10**estimate;
	SE=10**stderr;
	PVALLSM=probt;
	PARAMCD="&paramcd.";
run;
    
proc sort data=lsm_b1;
  by paramcd ptgrp01n avisitn resptyp;
 run;

/*Diff Estimates for Specific AVISITN*/
* For Diff_a;
data diff_a1(drop=estimate stderr effect lower upper tvalue probt alpha df);
    Length PARAMCD $ 8;
    set diff_a;
	if &avisitn.=6 then do;
	if avisitn=_avisitn=&avisitn. and trtpn= _trtpn and _resptyp="Z";
	  end;
	else if &avisitn.=9 then do;
	  if avisitn=_avisitn and avisitn in (6,9) and trtpn= _trtpn and _resptyp="Z";
	  end;
	else if &avisitn.=15 then do;
	  if avisitn=_avisitn and avisitn in (6,9,15)  and trtpn= _trtpn and _resptyp="Z";
	  end;
    LSMDIFF=10**estimate;
    LOWERCL=10**lower;
    UPPERCL=10**upper;
    PVALLSMD=probt;
	PARAMCD="&paramcd.";
  run;

proc sort data=diff_a1;
  by paramcd trtpn avisitn resptyp;
 run;

*For Diff_b;
data diff_b1(drop=estimate stderr effect lower upper tvalue probt alpha df);
    Length PARAMCD $ 8;
    set diff_b;
	if &avisitn.=6 then do;
	  if avisitn=&avisitn.  and ptgrp01n=_ptgrp01n and _resptyp="Z";
	  end;
	else if &avisitn.=9 then do;
	  if avisitn=_avisitn and avisitn in (6,9)  and ptgrp01n=_ptgrp01n and _resptyp="Z";
	  end;
	else if &avisitn.=15 then do;
	  if avisitn=_avisitn and avisitn in (6,9,15)  and ptgrp01n=_ptgrp01n and _resptyp="Z";
	  end;
    LSMDIFF=10**estimate;
    LOWERCL=10**lower;
    UPPERCL=10**upper;
    PVALLSMD=probt;
	PARAMCD="&paramcd.";
  run;

proc sort data=diff_b1;
  by paramcd ptgrp01n avisitn resptyp;
 run;

/*merging both LSMEANS and DIFF datasets*******/
*For model_1;
data final_&avisitn._&paramcd._a(keep= paramcd avisitn trtpn resptyp L10MEAN L10SE LSMEAN SE 
             PVALLSM PARAMCD LSMDIFF LOWERCL UPPERCL PVALLSMD);
  merge lsm_a1(in=A )
        diff_a1(in=B);
  by paramcd trtpn avisitn resptyp;
  if A or B;
  if trtpn=5 then trtpn=6;
run;

*For model_2;
data final_&avisitn._&paramcd._b(keep= paramcd avisitn TRTPN resptyp L10MEAN L10SE LSMEAN SE 
             PVALLSM PARAMCD LSMDIFF LOWERCL UPPERCL PVALLSMD);
  merge lsm_b1(in=A )
        diff_b1(in=B);
  by paramcd ptgrp01n avisitn resptyp;
  if A or B;
  if ptgrp01n=1 then TRTPN=5;else if ptgrp01n=2 then delete;
run;

data final_&avisitn._&paramcd._&respvar.(rename=(TRTPN=TRTN) drop= RESPTYP 
                                         rename=(RESPTYP1=RESPTYP));
  length POP $ 200 POPN 8 RECTYP $ 200 AVISIT $ 200 TRT $ 200 ENDPT $ 200 RESPTEST $ 200
         RESPTYP1 $200;       
  set final_&avisitn._&paramcd._a
      final_&avisitn._&paramcd._b;
  POP="&bmset.";
  select (POP);
   when ('IGE01FL')      POPN=6;
   when ('IL1301FL')    POPN=7;
   when ('IL2201FL')    POPN=8;
   when ('IL1701FL')    POPN=9;
   when ('TARC01FL')    POPN=10;
   when ('MIGE01FL')    POPN=11;
   when ('M1301FL')     POPN=12;
   when ('M2201FL')     POPN=13;
   when ('M1701FL')     POPN=14;
   when ('MTAR01FL')    POPN=15;
   otherwise            POPN=.;
  end;
  if POPN in (6,7,8,9,10) then RECTYP='ANL01FL';
  else if POPN in (11,12,13,14,15) then RECTYP='ANL02FL';
  else RECTYP="";
  select (AVISITN);
    when (6)    AVISIT="Visit 06 Week 4";
    when (9)    AVISIT="Visit 09 Week 16";
    when (15)    AVISIT="Visit 15 Week 24";
    otherwise   AVISIT="";
  end;

  select (TRTPN);
    when (1)    TRT="250mg (500mg LD) KY1005";
    when (2)    TRT="250mg (no LD) KY1005";
    when (3)    TRT="125mg KY1005";
    when (4)    TRT="62.5mg KY1005";
    when (5)    TRT="KY1005 Treatment Arms Combined";
    when (6)    TRT="Placebo";
    otherwise   TRT="";
  end;
  
  if "&respvar." in ("resp31","resp32") then ENDPT="IGA";else ENDPT="EASI";

  if "&respvar."="resp11" then RESPTEST="CRIT1FL";
  else if "&respvar."="resp21" then RESPTEST="CRIT2FL";
  else if "&respvar."="resp12" then RESPTEST="CRIT3FL";
  else if "&respvar."="resp22" then RESPTEST="CRIT4FL";
  else if "&respvar."="resp31" then RESPTEST="CRIT1FL";
  else if "&respvar."="resp32" then RESPTEST="CRIT2FL";

  if RESPTYP="Y" then RESPTYP1="RESPONDER";else RESPTYP1="NONRESPONDER";
RUN;
%mend mMMRM_GMI_RESP;

/**For respvar=resp11 and avisitn=9;*/
/*%mMMRM_GMI_RESP(bmset=IGE01FL,anlset=ANL01FL,respvar=resp11,paramcd=ALTIGE,avisitn=9);*/
/*%mMMRM_GMI_RESP(bmset=IL1301FL,anlset=ANL01FL,respvar=resp11,paramcd=IL13,avisitn=9);*/
/*%mMMRM_GMI_RESP(bmset=IL1701FL,anlset=ANL01FL,respvar=resp11,paramcd=IL17A,avisitn=9);*/
/*%mMMRM_GMI_RESP(bmset=IL2201FL,anlset=ANL01FL,respvar=resp11,paramcd=IL22,avisitn=9);*/
/*%mMMRM_GMI_RESP(bmset=TARC01FL,anlset=ANL01FL,respvar=resp11,paramcd=TARC,avisitn=9);*/
/**/
/**/
/*data MMRM_GMI_RESP_T11V9;*/
/*  format TID TRT TRTN PARAMCD POP POPN RECTYP ENDPT RESPTEST RESPTYP AVISIT AVISITN L10MEAN */
/*         L10SE LSMEAN SE PVALLSM LSMDIFF LOWERCL UPPERCL PVALLSMD;*/
/*  Length TID $ 200;*/
/*  set Final_9_ALTIGE_RESP11*/
/*      Final_9_IL13_RESP11*/
/*      Final_9_IL17A_RESP11*/
/*      Final_9_IL22_RESP11*/
/*      Final_9_TARC_RESP11;*/
/*    TID="T14020801050101";*/
/*run;*/

*For respvar=resp11 and avisitn=15;
%mMMRM_GMI_RESP(bmset=IGE01FL,anlset=ANL01FL,respvar=resp11,paramcd=ALTIGE,avisitn=15);
%mMMRM_GMI_RESP(bmset=IL1301FL,anlset=ANL01FL,respvar=resp11,paramcd=IL13,avisitn=15);
%mMMRM_GMI_RESP(bmset=IL1701FL,anlset=ANL01FL,respvar=resp11,paramcd=IL17A,avisitn=15);
%mMMRM_GMI_RESP(bmset=IL2201FL,anlset=ANL01FL,respvar=resp11,paramcd=IL22,avisitn=15);
%mMMRM_GMI_RESP(bmset=TARC01FL,anlset=ANL01FL,respvar=resp11,paramcd=TARC,avisitn=15);


data MMRM_GMI_RESP_T11V15;
  format TID TRT TRTN PARAMCD POP POPN RECTYP ENDPT RESPTEST RESPTYP AVISIT AVISITN L10MEAN 
         L10SE LSMEAN SE PVALLSM LSMDIFF LOWERCL UPPERCL PVALLSMD;
  Length TID $ 200;
  set Final_15_ALTIGE_RESP11
      Final_15_IL13_RESP11
      Final_15_IL17A_RESP11
      Final_15_IL22_RESP11
      Final_15_TARC_RESP11;
    TID="T14020801050101";
run;

/**For respvar=resp12 and avisitn=9;*/
/*%mMMRM_GMI_RESP(bmset=MIGE01FL,anlset=ANL02FL,respvar=resp12,paramcd=ALTIGE,avisitn=9);*/
/*%mMMRM_GMI_RESP(bmset=M1301FL,anlset=ANL02FL,respvar=resp12,paramcd=IL13,avisitn=9);*/
/*%mMMRM_GMI_RESP(bmset=M1701FL,anlset=ANL02FL,respvar=resp12,paramcd=IL17A,avisitn=9);*/
/*%mMMRM_GMI_RESP(bmset=M2201FL,anlset=ANL02FL,respvar=resp12,paramcd=IL22,avisitn=9);*/
/*%mMMRM_GMI_RESP(bmset=MTAR01FL,anlset=ANL02FL,respvar=resp12,paramcd=TARC,avisitn=9);*/
/**/
/**/
/*data MMRM_GMI_RESP_T12V9;*/
/*  format TID TRT TRTN PARAMCD POP POPN RECTYP ENDPT RESPTEST RESPTYP AVISIT AVISITN L10MEAN */
/*         L10SE LSMEAN SE PVALLSM LSMDIFF LOWERCL UPPERCL PVALLSMD;*/
/*  Length TID $ 200;*/
/*  set Final_9_ALTIGE_RESP12*/
/*      Final_9_IL13_RESP12*/
/*      Final_9_IL17A_RESP12*/
/*      Final_9_IL22_RESP12*/
/*      Final_9_TARC_RESP12;*/
/*    TID="T14020801050102";*/
/*run;*/

*For respvar=resp12 and avisitn=15;
%mMMRM_GMI_RESP(bmset=MIGE01FL,anlset=ANL02FL,respvar=resp12,paramcd=ALTIGE,avisitn=15);
%mMMRM_GMI_RESP(bmset=M1301FL,anlset=ANL02FL,respvar=resp12,paramcd=IL13,avisitn=15);
%mMMRM_GMI_RESP(bmset=M1701FL,anlset=ANL02FL,respvar=resp12,paramcd=IL17A,avisitn=15);
%mMMRM_GMI_RESP(bmset=M2201FL,anlset=ANL02FL,respvar=resp12,paramcd=IL22,avisitn=15);
%mMMRM_GMI_RESP(bmset=MTAR01FL,anlset=ANL02FL,respvar=resp12,paramcd=TARC,avisitn=15);

data MMRM_GMI_RESP_T12V15;
  format TID TRT TRTN PARAMCD POP POPN RECTYP ENDPT RESPTEST RESPTYP AVISIT AVISITN L10MEAN 
         L10SE LSMEAN SE PVALLSM LSMDIFF LOWERCL UPPERCL PVALLSMD;
  Length TID $ 200;
  set Final_15_ALTIGE_RESP12
      Final_15_IL13_RESP12
      Final_15_IL17A_RESP12
      Final_15_IL22_RESP12
      Final_15_TARC_RESP12;
    TID="T14020801050102";
run;

/**For respvar=resp21 and avisitn=9;*/
/*%mMMRM_GMI_RESP(bmset=IGE01FL,anlset=ANL01FL,respvar=resp21,paramcd=ALTIGE,avisitn=9);*/
/*%mMMRM_GMI_RESP(bmset=IL1301FL,anlset=ANL01FL,respvar=resp21,paramcd=IL13,avisitn=9);*/
/*%mMMRM_GMI_RESP(bmset=IL1701FL,anlset=ANL01FL,respvar=resp21,paramcd=IL17A,avisitn=9);*/
/*%mMMRM_GMI_RESP(bmset=IL2201FL,anlset=ANL01FL,respvar=resp21,paramcd=IL22,avisitn=9);*/
/*%mMMRM_GMI_RESP(bmset=TARC01FL,anlset=ANL01FL,respvar=resp21,paramcd=TARC,avisitn=9);*/
/**/
/**/
/*data MMRM_GMI_RESP_T21V9;*/
/*  format TID TRT TRTN PARAMCD POP POPN RECTYP ENDPT RESPTEST RESPTYP AVISIT AVISITN L10MEAN */
/*         L10SE LSMEAN SE PVALLSM LSMDIFF LOWERCL UPPERCL PVALLSMD;*/
/*  Length TID $ 200;*/
/*  set Final_9_ALTIGE_RESP21*/
/*      Final_9_IL13_RESP21*/
/*      Final_9_IL17A_RESP21*/
/*      Final_9_IL22_RESP21*/
/*      Final_9_TARC_RESP21;*/
/*    TID="T14020801050201";*/
/*run;*/
   
*For respvar=resp21 and avisitn=15;
%mMMRM_GMI_RESP(bmset=IGE01FL,anlset=ANL01FL,respvar=resp21,paramcd=ALTIGE,avisitn=15);
%mMMRM_GMI_RESP(bmset=IL1301FL,anlset=ANL01FL,respvar=resp21,paramcd=IL13,avisitn=15);
%mMMRM_GMI_RESP(bmset=IL1701FL,anlset=ANL01FL,respvar=resp21,paramcd=IL17A,avisitn=15);
%mMMRM_GMI_RESP(bmset=IL2201FL,anlset=ANL01FL,respvar=resp21,paramcd=IL22,avisitn=15);
%mMMRM_GMI_RESP(bmset=TARC01FL,anlset=ANL01FL,respvar=resp21,paramcd=TARC,avisitn=15);

data MMRM_GMI_RESP_T21V15;
  format TID TRT TRTN PARAMCD POP POPN RECTYP ENDPT RESPTEST RESPTYP AVISIT AVISITN L10MEAN 
         L10SE LSMEAN SE PVALLSM LSMDIFF LOWERCL UPPERCL PVALLSMD;
  Length TID $ 200;
  set Final_15_ALTIGE_RESP21
      Final_15_IL13_RESP21
      Final_15_IL17A_RESP21
      Final_15_IL22_RESP21
      Final_15_TARC_RESP21;
    TID="T14020801050201";
run;

/**For respvar=resp22 and avisitn=9;*/
/*%mMMRM_GMI_RESP(bmset=MIGE01FL,anlset=ANL02FL,respvar=resp22,paramcd=ALTIGE,avisitn=9);*/
/*%mMMRM_GMI_RESP(bmset=M1301FL,anlset=ANL02FL,respvar=resp22,paramcd=IL13,avisitn=9);*/
/*%mMMRM_GMI_RESP(bmset=M1701FL,anlset=ANL02FL,respvar=resp22,paramcd=IL17A,avisitn=9);*/
/*%mMMRM_GMI_RESP(bmset=M2201FL,anlset=ANL02FL,respvar=resp22,paramcd=IL22,avisitn=9);*/
/*%mMMRM_GMI_RESP(bmset=MTAR01FL,anlset=ANL02FL,respvar=resp22,paramcd=TARC,avisitn=9);*/
/**/
/**/
/*data MMRM_GMI_RESP_T22V9;*/
/*  format TID TRT TRTN PARAMCD POP POPN RECTYP ENDPT RESPTEST RESPTYP AVISIT AVISITN L10MEAN */
/*         L10SE LSMEAN SE PVALLSM LSMDIFF LOWERCL UPPERCL PVALLSMD;*/
/*  Length TID $ 200;*/
/*  set Final_9_ALTIGE_RESP22*/
/*      Final_9_IL13_RESP22*/
/*      Final_9_IL17A_RESP22*/
/*      Final_9_IL22_RESP22*/
/*      Final_9_TARC_RESP22;*/
/*    TID="T14020801050202";*/
/*run;*/

*For respvar=resp22 and avisitn=15;
%mMMRM_GMI_RESP(bmset=MIGE01FL,anlset=ANL02FL,respvar=resp22,paramcd=ALTIGE,avisitn=15);
%mMMRM_GMI_RESP(bmset=M1301FL,anlset=ANL02FL,respvar=resp22,paramcd=IL13,avisitn=15);
%mMMRM_GMI_RESP(bmset=M1701FL,anlset=ANL02FL,respvar=resp22,paramcd=IL17A,avisitn=15);
%mMMRM_GMI_RESP(bmset=M2201FL,anlset=ANL02FL,respvar=resp22,paramcd=IL22,avisitn=15);
%mMMRM_GMI_RESP(bmset=MTAR01FL,anlset=ANL02FL,respvar=resp22,paramcd=TARC,avisitn=15);


data MMRM_GMI_RESP_T22V15;
  format TID TRT TRTN PARAMCD POP POPN RECTYP ENDPT RESPTEST RESPTYP AVISIT AVISITN L10MEAN 
         L10SE LSMEAN SE PVALLSM LSMDIFF LOWERCL UPPERCL PVALLSMD;
  Length TID $ 200;
  set Final_15_ALTIGE_RESP22
      Final_15_IL13_RESP22
      Final_15_IL17A_RESP22
      Final_15_IL22_RESP22
      Final_15_TARC_RESP22;
    TID="T14020801050202";
run;

/**For respvar=resp31 and avisitn=9;*/
/*%mMMRM_GMI_RESP(bmset=IGE01FL,anlset=ANL01FL,respvar=resp31,paramcd=ALTIGE,avisitn=9);*/
/*%mMMRM_GMI_RESP(bmset=IL1301FL,anlset=ANL01FL,respvar=resp31,paramcd=IL13,avisitn=9);*/
/*%mMMRM_GMI_RESP(bmset=IL1701FL,anlset=ANL01FL,respvar=resp31,paramcd=IL17A,avisitn=9);*/
/*%mMMRM_GMI_RESP(bmset=IL2201FL,anlset=ANL01FL,respvar=resp31,paramcd=IL22,avisitn=9);*/
/*%mMMRM_GMI_RESP(bmset=TARC01FL,anlset=ANL01FL,respvar=resp31,paramcd=TARC,avisitn=9);*/
/**/
/**/
/*data MMRM_GMI_RESP_T31V9;*/
/*  format TID TRT TRTN PARAMCD POP POPN RECTYP ENDPT RESPTEST RESPTYP AVISIT AVISITN L10MEAN */
/*         L10SE LSMEAN SE PVALLSM LSMDIFF LOWERCL UPPERCL PVALLSMD;*/
/*  Length TID $ 200;*/
/*  set Final_9_ALTIGE_RESP31*/
/*      Final_9_IL13_RESP31*/
/*      Final_9_IL17A_RESP31*/
/*      Final_9_IL22_RESP31*/
/*      Final_9_TARC_RESP31;*/
/*    TID="T14020801050301";*/
/*run;*/

*For respvar=resp31 and avisitn=15;
%mMMRM_GMI_RESP(bmset=IGE01FL,anlset=ANL01FL,respvar=resp31,paramcd=ALTIGE,avisitn=15);
%mMMRM_GMI_RESP(bmset=IL1301FL,anlset=ANL01FL,respvar=resp31,paramcd=IL13,avisitn=15);
%mMMRM_GMI_RESP(bmset=IL1701FL,anlset=ANL01FL,respvar=resp31,paramcd=IL17A,avisitn=15);
%mMMRM_GMI_RESP(bmset=IL2201FL,anlset=ANL01FL,respvar=resp31,paramcd=IL22,avisitn=15);
%mMMRM_GMI_RESP(bmset=TARC01FL,anlset=ANL01FL,respvar=resp31,paramcd=TARC,avisitn=15);


data MMRM_GMI_RESP_T31V15;
  format TID TRT TRTN PARAMCD POP POPN RECTYP ENDPT RESPTEST RESPTYP AVISIT AVISITN L10MEAN 
         L10SE LSMEAN SE PVALLSM LSMDIFF LOWERCL UPPERCL PVALLSMD;
  Length TID $ 200;
  set Final_15_ALTIGE_RESP31
      Final_15_IL13_RESP31
      Final_15_IL17A_RESP31
      Final_15_IL22_RESP31
      Final_15_TARC_RESP31;
    TID="T14020801050301";
run;

/**For respvar=resp32 and avisitn=9;*/
/*%mMMRM_GMI_RESP(bmset=MIGE01FL,anlset=ANL02FL,respvar=resp32,paramcd=ALTIGE,avisitn=9); */
/*%mMMRM_GMI_RESP(bmset=M1301FL,anlset=ANL02FL,respvar=resp32,paramcd=IL13,avisitn=9);*/
/*%mMMRM_GMI_RESP(bmset=M1701FL,anlset=ANL02FL,respvar=resp32,paramcd=IL17A,avisitn=9);*/
/*%mMMRM_GMI_RESP(bmset=M2201FL,anlset=ANL02FL,respvar=resp32,paramcd=IL22,avisitn=9);*/
/*%mMMRM_GMI_RESP(bmset=MTAR01FL,anlset=ANL02FL,respvar=resp32,paramcd=TARC,avisitn=9);*/
/**/
/**/
/*data MMRM_GMI_RESP_T32V9;*/
/*  format TID TRT TRTN PARAMCD POP POPN RECTYP ENDPT RESPTEST RESPTYP AVISIT AVISITN L10MEAN */
/*         L10SE LSMEAN SE PVALLSM LSMDIFF LOWERCL UPPERCL PVALLSMD;*/
/*  Length TID $ 200;*/
/*  set Final_9_ALTIGE_RESP32*/
/*      Final_9_IL13_RESP32*/
/*      Final_9_IL17A_RESP32*/
/*      Final_9_IL22_RESP32*/
/*      Final_9_TARC_RESP32;*/
/*    TID="T14020801050302";*/
/*run;*/

*For respvar=resp32 and avisitn=15;
%mMMRM_GMI_RESP(bmset=MIGE01FL,anlset=ANL02FL,respvar=resp32,paramcd=ALTIGE,avisitn=15); 
%mMMRM_GMI_RESP(bmset=M1301FL,anlset=ANL02FL,respvar=resp32,paramcd=IL13,avisitn=15);
%mMMRM_GMI_RESP(bmset=M1701FL,anlset=ANL02FL,respvar=resp32,paramcd=IL17A,avisitn=15);
%mMMRM_GMI_RESP(bmset=M2201FL,anlset=ANL02FL,respvar=resp32,paramcd=IL22,avisitn=15);
%mMMRM_GMI_RESP(bmset=MTAR01FL,anlset=ANL02FL,respvar=resp32,paramcd=TARC,avisitn=15);


data MMRM_GMI_RESP_T32V15;
  format TID TRT TRTN PARAMCD POP POPN RECTYP ENDPT RESPTEST RESPTYP AVISIT AVISITN L10MEAN 
         L10SE LSMEAN SE PVALLSM LSMDIFF LOWERCL UPPERCL PVALLSMD;
  Length TID $ 200;
  set Final_15_ALTIGE_RESP32
      Final_15_IL13_RESP32
      Final_15_IL17A_RESP32
      Final_15_IL22_RESP32
      Final_15_TARC_RESP32;
    TID="T14020801050302";
run;

data MMRM_GMI_RESP;
  set 
/*      MMRM_GMI_RESP_T11V9*/
      MMRM_GMI_RESP_T11V15
/*      MMRM_GMI_RESP_T12V9*/
	  MMRM_GMI_RESP_T12V15
/*      MMRM_GMI_RESP_T21V9*/
	  MMRM_GMI_RESP_T21V15
/*      MMRM_GMI_RESP_T22V9*/
	  MMRM_GMI_RESP_T22V15
/*      MMRM_GMI_RESP_T31V9*/
	  MMRM_GMI_RESP_T31V15
/*      MMRM_GMI_RESP_T32V9*/
      MMRM_GMI_RESP_T32V15;
  Label TID	= "Table ID"
        TRT	= "Treatment"
        TRTN = "Treatment (N)"
        PARAMCD	= "Parameter code"
        POP	= "Population" 
        POPN = 	"Population (N)"
        RECTYP = "Record Type"
        ENDPT =	"Endpoint"
        RESPTEST = "Response Test"
        RESPTYP = "Responder Type"
        AVISIT = "Analysis Visit"
        AVISITN	= "Analysis Visit (N)"
        L10MEAN = "Log10 LS Mean"
        L10SE = "Log10 Standard Error"
        LSMEAN = "LS Mean" 
        SE = "Standard Error"
        PVALLSM	= "P-value for LS Mean"
        LSMDIFF	= "LS Mean Difference"
        LOWERCL	= "95% Lower Confidence Limit"
        UPPERCL	= "95% Lower Confidence Limit"
        PVALLSMD = "P-value for LS Mean Difference";
run;

Proc DataSets Lib = WORK;
  Modify MMRM_GMI_RESP;
  Format _all_;
Run ;
Quit ;

proc sort data=MMRM_GMI_RESP; 
  by TID POPN PARAMCD TRTN RECTYP ENDPT RESPTEST RESPTYP AVISITN;
run;

proc sort data=MMRM_GMI_RESP out=STATOUTW.MMRM_GMI_RESP; 
  by TID POPN PARAMCD TRTN RECTYP ENDPT RESPTEST RESPTYP AVISITN;
run;

data output.MMRM_GMI_RESP;
  set STATOUTW.MMRM_GMI_RESP;
run;

*************************************************************************
*        CLIENT:  Kymab
*      PROTOCOL:  KY1005CT05
*       PURPOSE:  Produce an inferential data set of an MMRM analysis for PCHG in EASI
*        AUTHOR:  ERICK OKELLO
*   INPUT FILES:  ADAM.ADSL, ADAM.ADBM
*  OUTPUT FILES:  STATOUTW.MMRM_PCHG
*   	  NOTES:  
*		   DATE:  05/JAN/2023
************************************************************************* 
*		EXAMPLE:
*
*   %macro tmmrm(anlset=NRMF01FL,paramcd=,var1=,bygrp=,flag=,trtp=,paramcd2=,dataout=);
*   %macro tmmrm(anlset=NRMF01FL,paramcd=,var1=,bygrp=,flag=,trtp=,paramcd2=,dataout=);
************************************************************************* 
*  Copyright 2022 Thermo Fisher Scientific Inc. All rights reserved.
*  All trademarks are the property of Thermo Fisher Scientific and its
*  subsidiaries unless otherwise specified. 
*************************************************************************;

options linesize=max;
options noquotelenmax mlogic mprint;

proc datasets lib=work kill nolist nowarn;
quit;

dm "output; clear; log; clear";

%macro tmmrm(anlset=NRMF01FL,
             paramcd=,
             var1=,
             bygrp=,
             flag=,
             trtp=,
             paramcd2=,
             dataout=);
/*************************fetchign data************************/

**Merge Adsl and Adbm;

data adbm;
merge adb.adsl(in=A keep=usubjid) adb.adbm(in=B);
by usubjid;if B;
run;

data adbm1;
set adbm;
   where  &anlset. eq 'Y' and &trtp. ne '' and  &flag. eq 'Y' and  avisitn in (6,9,15) and paramcd="&paramcd." and not missing(&bygrp.) and pchg ne .;
run;

proc sql;
	select count(*) into :_cnt 
	from adbm1;
quit;

%put &_cnt.;
 %if &_cnt. ^= 0 %then %do;
proc sort data= adbm1 ;
by  &trtp. avisitn &bygrp.;
run;



/*Mixed Model using PROC MIXED;*/

proc mixed data=adbm1 method=reml;
    class &bygrp.(ref='LOW') &trtp. avisitn usubjid;
    model &Var1.=&bygrp. &trtp. avisitn &bygrp.*&trtp.*avisitn /ddfm=kr ;
    repeated avisitn/subject=usubjid type=UN;
    lsmeans /*&bygrp. &trtp. avisitn*/ &bygrp.*&trtp.*avisitn  /diff alpha=0.05 cl;
    ods output lsmeans=lsm  diffs=diff;

run;
 
/*------------- LSMeans estimates at Week 4, Week 16 and Week 24--------------*/

data lsm1(drop=estimate stderr effect lower upper df tvalue probt alpha);
    set lsm ;
	if avisitn in (6,9,15) and &bygrp. ne '';
	if estimate ne . then LSMEAN=round(estimate,0.001);
	if stderr ne . then SE=round(stderr,0.0001);
	if probt ne . then PVALLSM=compress(put(round(probt,0.0001),8.4));
	if .<probt<0.0001 then PVALLSM="<0.0001";
	if probt=. then PVALLSM='';
  
    proc sort ;
    by &trtp. avisitn &bygrp.;
 run;

/*-----------Diff Estimates at Week 4, Week 16 and Week 24-------------*/
data diff1;
    set diff ;
	if avisitn=_avisitn and _avisitn in (6,9,15) and _&bygrp.="LOW" and &trtp.=_&trtp.;
    if estimate ne . then LSMDIFF=round(estimate,0.001);
    if lower ne . then LOWERCL=round(lower,0.001);
    if upper ne . then UPPERCL=round(upper,0.001);
    if probt ne . then PVALLSMD=compress(put(round(probt,0.0001),8.4));
	if .<probt<0.0001 then PVALLSMD="<0.0001";
	if probt=. then PVALLSMD='';
    proc sort ;
    by &trtp. avisitn &bygrp.;
 run;

/*Merging both LSMEANS and DIFF datasets*******/

  data final(keep= avisitn &trtp.  &bygrp. lsmean se  pvallsm lsmdiff lowercl uppercl  pvallsmd);
  merge lsm1(in=A )diff1(in=B);
   by &trtp. avisitn &bygrp.;
  run;

  data final;
    set final;
	%if &trtp.=PTGRP01 %then %do;
	  if ptgrp01="Placebo" then delete;
	%end;
  run;


  data final1;
  set final;
  length TID TRT POP RECTYP ENDOTYPE ENDOLVL $200. PARAMCD $8. POPN TRTN 8.;
  %if &anlset.=NRMF01FL %then %do;
    tid="T14020801050401";
    pop="NRMF01FL";
    popn=16;
    rectyp="&flag.";
  %end;

  %else %do;
    tid="T14020801050402";
    pop="FAS01FL";
    popn=17;
    rectyp="&flag.";
  %end;    

  trt=&trtp.;
  if trt="250mg (500mg LD) KY1005" then trtn=1;
  else if trt="250mg (no LD) KY1005" then trtn=2;
  else if trt="125mg KY1005" then trtn=3;
  else if trt="62.5mg KY1005" then trtn=4;
  else if trt="KY1005 Treatment Arms Combined" then trtn=5;
  else if trt="Placebo" then trtn=6;

  paramcd="&paramcd2.";
  endotype="&bygrp.";
  endolvl=&bygrp.;

if &bygrp.="LOW" then do;
  lsmdiff=.;
  lowercl=.;
  uppercl=.;
  pvallsmd="";
 end;
 keep tid trt trtn paramcd: pop popn rectyp endotype endolvl avisitn
lsmean se pvallsm lsmdiff lowercl uppercl pvallsmd;
run;

proc sort data=final1;
by avisitn;
run;

proc sort data=adb.adbm out=bmdat (keep=avisit avisitn) nodupkey;
by avisitn;
run;

data &dataout.;
  merge final1 (in=a) bmdat;
  by avisitn;
  if a;
run;

data &dataout. (drop=avisit rename=(avisit1=avisit));
  set &dataout.;
  length avisit1 $200.;
  avisit1=avisit;
run;
%end;
%mend tmmrm;

/*ALTIGE*/
%tmmrm(anlset=NRMF01FL,paramcd=EASIS,var1=PCHG,bygrp=IGEENDO,flag=ANL01FL,trtp=TRTP,paramcd2=ALTIGE,dataout=mmrmdat1a);
%tmmrm(anlset=NRMF01FL,paramcd=EASIS,var1=PCHG,bygrp=IGEENDO,flag=ANL01FL,trtp=PTGRP01,paramcd2=ALTIGE,dataout=mmrmdat1b);

%tmmrm(anlset=FAS01FL,paramcd=EASIS,var1=PCHG,bygrp=IGEENDO,flag=ANL02FL,trtp=TRTP,paramcd2=ALTIGE,dataout=mmrmdat1c);
%tmmrm(anlset=FAS01FL,paramcd=EASIS,var1=PCHG,bygrp=IGEENDO,flag=ANL02FL,trtp=PTGRP01,paramcd2=ALTIGE,dataout=mmrmdat1d);

/*IL-13*/
%tmmrm(anlset=NRMF01FL,paramcd=EASIS,var1=PCHG,bygrp=IL13ENDO,flag=ANL01FL,trtp=TRTP,paramcd2=IL-13,dataout=mmrmdat2a);
%tmmrm(anlset=NRMF01FL,paramcd=EASIS,var1=PCHG,bygrp=IL13ENDO,flag=ANL01FL,trtp=PTGRP01,paramcd2=IL-13,dataout=mmrmdat2b);

%tmmrm(anlset=FAS01FL,paramcd=EASIS,var1=PCHG,bygrp=IL13ENDO,flag=ANL02FL,trtp=TRTP,paramcd2=IL-13,dataout=mmrmdat2c);
%tmmrm(anlset=FAS01FL,paramcd=EASIS,var1=PCHG,bygrp=IL13ENDO,flag=ANL02FL,trtp=PTGRP01,paramcd2=IL-13,dataout=mmrmdat2d);

/*IL-22*/
%tmmrm(anlset=NRMF01FL,paramcd=EASIS,var1=PCHG,bygrp=IL22ENDO,flag=ANL01FL,trtp=TRTP,paramcd2=IL-22,dataout=mmrmdat3a);
%tmmrm(anlset=NRMF01FL,paramcd=EASIS,var1=PCHG,bygrp=IL22ENDO,flag=ANL01FL,trtp=PTGRP01,paramcd2=IL-22,dataout=mmrmdat3b);

%tmmrm(anlset=FAS01FL,paramcd=EASIS,var1=PCHG,bygrp=IL22ENDO,flag=ANL02FL,trtp=TRTP,paramcd2=IL-22,dataout=mmrmdat3c);
%tmmrm(anlset=FAS01FL,paramcd=EASIS,var1=PCHG,bygrp=IL22ENDO,flag=ANL02FL,trtp=PTGRP01,paramcd2=IL-22,dataout=mmrmdat3d);

/*IL-17A*/
%tmmrm(anlset=NRMF01FL,paramcd=EASIS,var1=PCHG,bygrp=IL17ENDO,flag=ANL01FL,trtp=TRTP,paramcd2=IL-17,dataout=mmrmdat4a);
%tmmrm(anlset=NRMF01FL,paramcd=EASIS,var1=PCHG,bygrp=IL17ENDO,flag=ANL01FL,trtp=PTGRP01,paramcd2=IL-17,dataout=mmrmdat4b);

%tmmrm(anlset=FAS01FL,paramcd=EASIS,var1=PCHG,bygrp=IL17ENDO,flag=ANL02FL,trtp=TRTP,paramcd2=IL-17,dataout=mmrmdat4c);
%tmmrm(anlset=FAS01FL,paramcd=EASIS,var1=PCHG,bygrp=IL17ENDO,flag=ANL02FL,trtp=PTGRP01,paramcd2=IL-17,dataout=mmrmdat4d);

/*TARC*/
%tmmrm(anlset=NRMF01FL,paramcd=EASIS,var1=PCHG,bygrp=TARCENDO,flag=ANL01FL,trtp=TRTP,paramcd2=TARC,dataout=mmrmdat5a);
%tmmrm(anlset=NRMF01FL,paramcd=EASIS,var1=PCHG,bygrp=TARCENDO,flag=ANL01FL,trtp=PTGRP01,paramcd2=TARC,dataout=mmrmdat5b);

%tmmrm(anlset=FAS01FL,paramcd=EASIS,var1=PCHG,bygrp=TARCENDO,flag=ANL02FL,trtp=TRTP,paramcd2=TARC,dataout=mmrmdat5c);
%tmmrm(anlset=FAS01FL,paramcd=EASIS,var1=PCHG,bygrp=TARCENDO,flag=ANL02FL,trtp=PTGRP01,paramcd2=TARC,dataout=mmrmdat5d);


data all1;
  set %if %sysfunc(exist(mmrmdat1a)) %then %do; mmrmdat1a mmrmdat1b mmrmdat1c mmrmdat1d %end;
  mmrmdat2a mmrmdat2b mmrmdat2c mmrmdat2d mmrmdat3a mmrmdat3b mmrmdat3c mmrmdat3d mmrmdat4a mmrmdat4b mmrmdat4c mmrmdat4d
  mmrmdat5a mmrmdat5b mmrmdat5c mmrmdat5d;
run;



proc datasets nolist lib=work;
  delete adbm: lsm: diff: final: bmdat mmrmdat:;    
quit;

/**Applying Attributes*******/

data all2;
  retain TID TRT TRTN PARAMCD POP POPN RECTYP ENDOTYPE ENDOLVL AVISIT AVISITN LSMEAN SE PVALLSM LSMDIFF LOWERCL UPPERCL PVALLSMD;
  attrib
  TID     label='Table ID' 
  TRT     label='Treatment'          
  TRTN    label='Treatment (N)' 
  PARAMCD label='Parameter code' 
  POP     label='Population' 
  POPN    label='Population (N)' 
  RECTYP  label='Record Type' 
  ENDOTYPE label='Endotype'  
  ENDOLVL label='Endotype Level'
  AVISIT label='Analysis Visit' 
  AVISITN label='Analysis Visit (N)' 
  LSMEAN  label='LS Mean' 
  SE      label='Standard Error' 
  PVALLSM label='P-value for LS Mean'  
  LSMDIFF label='LS Mean Difference' 
  LOWERCL label='95% Lower Confidence Limit' 
  UPPERCL label='95% Upper Confidence Limit' 
  PVALLSMD label='P-value for LS Mean Difference'; 
  set all1;
  format _all_;
run;

**Final data set**;
proc sort data=all2 out=STATOUTW.MMRM_PCHG(label='MMRM for PCHG in EASI') nodupkey;
  by TID POPN PARAMCD TRTN RECTYP ENDOTYPE ENDOLVL RECTYP AVISITN;
run;

proc contents data=statoutw.mmrm_pchg;
run;

TAK1006:
GOPTIONS ACCESSIBLE;
 *************************************************************************;
 *        CLIENT:  Takeda                                                 *;
 *        PROTOCOL:  TKTAK0791006                                         *;
 *        PURPOSE:  To validate the mmrm macro for production             *;
 *        AUTHOR:  Zhenhua Yuan                                           *;
 *        INPUT FILES:  ADEF                                        *;
 *        OUTPUT FILES:  WORK.vmmrm                                     *;
 *         NOTES:                                                         *;
 *          DATE:  18/AUG/2023                                             *;
 *************************************************************************;
 *  Copyright 2023 Thermo Fisher Scientific Inc. All rights reserved.    *;
 *  All trademarks are the property of Thermo Fisher Scientific and its  *;
 *  subsidiaries unless otherwise specified.                             *;
 *************************************************************************;
options linesize=max;
options symbolgen mlogic mprint;
/*libname adb "\\wilbtib\wilbtia03\Kymab KY1005CT05\Interim Analysis\Databases\Analysis Database\Output";*/
/*libname adb1 "\\wilbtib\wilbtia03\Kymab KY1005CT05\Users\okelloeo\Interim Analysis\Databases\Analysis Database\Output_Dev";*/

proc datasets lib=work kill nolist nowarn;
quit;

dm "output; clear; log; clear";

%macro vmMMRM(dataset=,subset=,paramcd=,covstr=,dsout=);
data adef00;
  set adb.adef;
  where &subset. and PARAMCD="&paramcd.";
  pct_bl=(AVAL/BASE)*100;
run;

proc sort data=adef00; by subjid avisitn;run;

DATA ADEF01;
  SET ADEF00;
  where AVISITN > 0;
  if missing(BASE)=0 and BASE>0 then LNBASE=LOG(BASE);
  else delete;
  if missing(pct_bl)=0 and pct_bl>0 then LNPCTBL=LOG(pct_bl);
  else delete;    
run;

/*Perform MMRM model using TRTP variable;*/
proc mixed data=ADEF01 method=reml;
    class avisitn subjid;
    model LNPCTBL =LNBASE avisitn LNBASE*avisitn/solution ddfm=kr;
    repeated avisitn/subject=subjid type=&covstr.;
    lsmeans avisitn/cl;
    ods output lsmeans=lsm_a;
run;

data lsm_a00(drop=Estimate StdErr Lower Upper);
  Length Paramcd $8;
  set lsm_a(keep=AVISITN Estimate StdErr Lower Upper);
/*  Geom_LSMean=exp(Estimate);*/
  PARAMCD="&paramcd.";
  Geom_PCHG=EXP(Estimate)-100;
  SEM_PCHG=EXP(StdErr);
  PCHG_LCL=EXP(Lower)-100;
  PCHG_UCL=EXP(Upper)-100;
run;

data &dsout.;
  set lsm_a00;
  Label PARAMCD	= "Parameter code"
        AVISITN	= "Analysis Visit (N)"
		Geom_PCHG = "Geometric LSmean of Percent Change from Baseline."
		SEM_PCHG = "The standard error of Geometric LSmean of Percent Change from Baseline"
        PCHG_LCL = "Lower 95% limit of Geometric LSmean of Percent Change from Baseline."
        PCHG_UCL = "Upper 95% limit of Geometric LSmean of Percent Change from Baseline." ;
run;
run;

%MEND;        
     
/*%vmMMRM(dataset=adef,subset=%str(FASFL='Y' and ANL03FL='Y' and AVISITN <= 22),paramcd=UPCR24H,covstr=UN,dsout=vmMMRM);*/
/*%vmMMRM(dataset=adef,subset=%str(FASFL='Y' and ANL03FL='Y' and AVISITN <= 22),paramcd=UPCR24H,covstr=AR(1),dsout=vmMMRM);*/

GOPTIONS ACCESSIBLE;
 *************************************************************************;
 *        CLIENT:  Takeda                                                 *;
 *        PROTOCOL:  TKTAK0791006                                         *;
 *        PURPOSE:  To validate the KM macro for production             *;
 *        AUTHOR:  Zhenhua Yuan                                           *;
 *        INPUT FILES:  ADEF                                        *;
 *        OUTPUT FILES:  WORK.vmkm                                     *;
 *         NOTES:                                                         *;
 *          DATE:  18/AUG/2023                                             *;
 *************************************************************************;
 *  Copyright 2023 Thermo Fisher Scientific Inc. All rights reserved.    *;
 *  All trademarks are the property of Thermo Fisher Scientific and its  *;
 *  subsidiaries unless otherwise specified.                             *;
 *************************************************************************;

options symbolgen mprint mlogic;

%MACRO vmKM(dataset=,
            anlset=,
            PARAMCD=,
            KMout=);
data adtte_&paramcd.;
  set adb.&dataset.;
  where &anlset.="Y" and Paramcd="&paramcd.";
run;

ods graphics on;
ods output Quartiles=KM_Quartiles Means=KM_Means CensoredSummary=KM_CNSR
           SurvivalPlot=sp1 ProductLimitEstimates=v_estimates;
proc lifetest data=adtte_&paramcd. plots=(s);
  time AVAL * CNSR(1);  
  title 'Survival Analysis for Time to Eligible for Retreatment-- One group';
run;

Proc transpose data=KM_Quartiles(drop=STRATUM Transform) 
               out=KM_Estimates(Drop=_name_ _label_) prefix=P;
  var Estimate;
  id Percent;
run;

Proc transpose data=KM_Quartiles(drop=STRATUM Transform) 
               out=KM_LCL(Drop=_name_ _label_) prefix=LCL;
  var LowerLimit;
  id Percent;
run;

Proc transpose data=KM_Quartiles(drop=STRATUM Transform) 
               out=KM_UCL(Drop=_name_ _label_) prefix=UCL;
  var UpperLimit;
  id Percent;
run;

/* Minimum and Maximum */
proc sort data=v_estimates out=v_est (keep=aval censor) nodupkey;
	by aval censor;
	where ^missing(censor);
run;

proc sql;
	create table vminmax as 
	select min(AVAL) as min format=8.4, max(AVAL) as max format=8.4
	from v_est
	where ^missing(CENSOR)
/*	group by &trt.*/
/*	order by &trt.*/
	;
quit;

data KM_Means01;
  set KM_Means(keep=Mean StdErr);
  MEAN_LCL=Mean-1.96*StdErr;
  MEAN_UCL=Mean+1.96*StdErr;
  Drop StdErr;
run;

data &KMout.;
  Length Paramcd $8;
  format Paramcd P25 LCL25 UCL25 P50 LCL50 UCL50 P75 LCL75 UCL75 Mean  
         Total Failed Censored PctCens Min Max MEAN_LCL MEAN_UCL;
  merge KM_Estimates
        KM_LCL
        KM_UCL
        KM_Means01
		vminmax
		KM_CNSR;
  Paramcd="&paramcd.";
  label p25="Estimates of the 25th percentile";
  label LCL25="Lower 95% Confidence Limit of the 25th percentile";
  label UCL25="Upper 95% Confidence Limit of the 25th percentile";
  label p50="Estimates of the 50th percentile";
  label LCL50="Lower 95% Confidence Limit of the 50th percentile";
  label UCL50="Upper 95% Confidence Limit of the 50th percentile";
  label p75="Estimates of the 75th percentile";
  label LCL75="Lower 95% Confidence Limit of the 75th percentile";
  label UCL75="Upper 95% Confidence Limit of the 75th percentile";
  label Failed="Number Failed";
  label Censored="Number Censored";
  label PctCens="Percent Censored";
  label Min="Minimum value";
  label Max="Maximum value";
  label MEAN_LCL="Lower 95% Confidence Limit of MEAN";
  label MEAN_UCL="Upper 95% Confidence Limit of MEAN";
run;

 data &KMout._plot ;
   set sp1;
 run;
%MEND;

/*%vmKM(dataset=ADTTE,Anlset=FASFL,PARAMCD=TTERT,KMout=KM_TTERT);*/
/*%
GOPTIONS ACCESSIBLE;
 *************************************************************************;
 *        CLIENT:  Takeda                                                 *;
 *        PROTOCOL:  TKTAK0791006                                         *;
 *        PURPOSE:  To validate the CI macro for production             *;
 *        AUTHOR:  Zhenhua Yuan                                           *;
 *        INPUT FILES:  ADEF                                        *;
 *        OUTPUT FILES:  WORK.vmkm                                     *;
 *         NOTES:                                                         *;
 *          DATE:  18/AUG/2023                                             *;
 *************************************************************************;
 *  Copyright 2023 Thermo Fisher Scientific Inc. All rights reserved.    *;
 *  All trademarks are the property of Thermo Fisher Scientific and its  *;
 *  subsidiaries unless otherwise specified.                             *;
 *************************************************************************;
  options symbolgen mprint mlogic;

/*%LET dataset=ADEF_MK;*/
/*%LET PARAMCD=RESTPY;*/
/*/*%LET subset=%str(PARAMCD="RESTPY" AND FASFL='Y');*/*/
/*%LET response=AVAL;*/
/*%let trt=TRTaN;*/;

%MACRO vmCI(dataset=,
		  subset=,
          PARAMCD=,
          CIout=);
                
  /*read in data and create combined treatment */              
data  &dataset.01  ;
	set  adb.&dataset ;
/*    set &dataset.;*/
	where PARAMCD="&PARAMCD." AND &subset;
	output;
run;
  
proc freq data= &dataset.01;
  tables avisitn;
run;

proc sort data=&dataset.01;
	by AVISITN descending AVAL;
run;

/*Clopper-Pearson 95% CI  */
PROC FREQ DATA= &dataset.01 order=data ;
   TABLES AVISITN*AVAL  /list	SPARSE out=list_out;
RUN;

proc sort data=list_out;
  by  AVISITn AVAL;
run;

ods output BinomialCLs=PROP_CL (drop=table) ;
PROC FREQ DATA= list_out order=data;
   BY AVISITN;
   where ^missing(AVAL);
   TABLES AVAL/BINOMIAL (CL=EXACT level=1) 	;
   weight count/ zeros;
   exact binomial; 
RUN;

%put 'ALERT_C: adding the condition to display CIs for AVAL=1 since there is no AVAL=1 in current data'; 
data &CIout.;
  format PARAMCD AVISITN PROPORTION LOWERCL UPPERCL TYPE;
  set PROP_CL (rename=(lowercl=lowercl_ uppercl=uppercl_));
  PARAMCD="&PARAMCD.";
  PROPORTION=1-PROPORTION;
  UPPERCL=(1-LOWERCL_)*100;
  LOWERCL=(1-UPPERCL_)*100;
  drop lowercl_ uppercl_;
run;
  
%mend;


/*%vmCI(dataset=ADEF,*/
/*subset=%str(PARAMCD="RESTPY" AND FASFL='Y'),*/
/*PARAMCD=RESTPY,*/
/*CIout=vmCI_RESTPY);*/

GOPTIONS ACCESSIBLE;
 *************************************************************************;
 *        CLIENT:  Takeda                                                 *;
 *        PROTOCOL:  TKTAK0791006                                         *;
 *        PURPOSE:  To validate the KM macro for production             *;
 *        AUTHOR:  Zhenhua Yuan                                           *;
 *        INPUT FILES:  ADEF                                        *;
 *        OUTPUT FILES:  WORK.vmkm                                     *;
 *         NOTES:                                                         *;
 *          DATE:  18/AUG/2023                                             *;
 *************************************************************************;
 *  Copyright 2023 Thermo Fisher Scientific Inc. All rights reserved.    *;
 *  All trademarks are the property of Thermo Fisher Scientific and its  *;
 *  subsidiaries unless otherwise specified.                             *;
 *************************************************************************;
  options symbolgen mprint mlogic;

%MACRO vmGeoCV(dataset=,
               SUBSET=,
               PARAMCD=,
               dsout=);

  Data &dataset.01;
    set work.&dataset.;
	where &SUBSET. and PARAMCD="&PARAMCD.";
  RUN;

  PROC SORT DATA=&dataset.01(where=(missing(ATPTN)=0)) OUT=&dataset.01S;BY ATPTN;RUN;

  * calculate Geometric mean and CV;
  ods output ConfLimits=Geom_mean_CV Statistics=T_stats; 
  proc ttest data=&dataset.01S dist=lognormal; 
    by ATPTN;
    var AVAL;
  /*   ods select ConfLimits;*/
  run;

  proc means data=&dataset.01S maxdec=3 N Mean STD MIN MAX MEDIAN;
    by ATPTN;
    var AVAL;
    output out=PK_Stats N=N_T Mean=Mean_T STD=STD_T Min=Min_T Max=Max_T median=Median_T;
  run;

  proc sort data=PK_Stats(drop=_type_ _FREQ_);by ATPTN;run;
  proc sort data=Geom_mean_CV(Drop=Variable UMPULowerCLCV UMPUUpperCLCV);by ATPTN;run;

  data PK_STATS01(rename=(N_T=N Mean_T=Mean STD_T=STD Min_T=Min Max_T=Max Median_T=Median 
                       LowerCLGeomMean=GeomMean_LCL UpperCLGeomMean=GeomMean_UCL
                       CV=GeomCV LowerCLCV=GeomCV_LCL UpperCLCV=GeomCV_UCL));
    length Paramcd $ 8;
    format PARAMCD ATPTN N_T Mean_T STD_T Min_T Max_T Median_T GeomMean LowerCLGeomMean
           UpperCLGeomMean CV LowerCLCV UpperCLCV;
    merge PK_Stats
          Geom_mean_CV;
    BY ATPTN;
    Paramcd="&PARAMCD.";
   run;

   Data &dsout.;
     set PK_STATS01;
	 KEEP PARAMCD ATPTN GeomMean GeomMean_LCL GeomMean_UCL GeomCV;
   run;
  
%Mend;


/*%vmGeoCV(libin=adb,dataset=ADPC,SUBSET=%str(PKFL="N" and AVISITN <= 96),PARAMCD=SERUMPK,dsout=vmGeo_CV);*/
data lipcancer;
   input county observed expected employment SMR;
   if (observed > 0) then expCount = 100*observed/SMR;
   else expCount = expected;
   datalines;
 1  9  1.4 16 652.2
 2 39  8.7 16 450.3
 3 11  3.0 10 361.8
 4  9  2.5 24 355.7
 5 15  4.3 10 352.1
 6  8  2.4 24 333.3
 7 26  8.1 10 320.6
 8  7  2.3  7 304.3
 9  6  2.0  7 303.0
10 20  6.6 16 301.7
11 13  4.4  7 295.5
12  5  1.8 16 279.3
13  3  1.1 10 277.8
14  8  3.3 24 241.7
15 17  7.8  7 216.8
16  9  4.6 16 197.8
17  2  1.1 10 186.9
18  7  4.2  7 167.5
19  9  5.5  7 162.7
20  7  4.4 10 157.7
21 16 10.5  7 153.0
22 31 22.7 16 136.7
23 11  8.8 10 125.4
24  7  5.6  7 124.6
25 19 15.5  1 122.8
26 15 12.5  1 120.1
27  7  6.0  7 115.9
28 10  9.0  7 111.6
29 16 14.4 10 111.3
30 11 10.2 10 107.8
31  5  4.8  7 105.3
32  3  2.9 24 104.2
33  7  7.0 10  99.6
34  8  8.5  7  93.8
35 11 12.3  7  89.3
36  9 10.1  0  89.1
37 11 12.7 10  86.8
38  8  9.4  1  85.6
39  6  7.2 16  83.3
40  4  5.3  0  75.9
41 10 18.8  1  53.3
42  8 15.8 16  50.7
43  2  4.3 16  46.3
44  6 14.6  0  41.0
45 19 50.7  1  37.5
46  3  8.2  7  36.6
47  2  5.6  1  35.8
48  3  9.3  1  32.1
49 28 88.7  0  31.6
50  6 19.6  1  30.6
51  1  3.4  1  29.1
52  1  3.6  0  27.6
53  1  5.7  1  17.4
54  1  7.0  1  14.2
55  0  4.2 16   0.0
56  0  1.8 10   0.0
;

data ADEF_MK;
   input SUBJID$ TRTAN AVISITN PARAMCD$ AVAL FASFL$;
   datalines;
09001-001 1 3 RESTPY 1 Y
09001-001 1 4 RESTPY 1 Y
22001-002 1 3 RESTPY 2 Y
22001-002 1 4 RESTPY 1 Y
29001-003 1 3 RESTPY 2 Y
29001-003 1 4 RESTPY 2 Y
29001-004 1 3 RESTPY 2 Y
29001-004 1 4 RESTPY 1 Y
29002-001 1 3 RESTPY 1 Y
29002-001 1 4 RESTPY 1 Y
51002-006 1 3 RESTPY 2 Y
51002-006 1 4 RESTPY 2 Y
63003-001 1 3 RESTPY 2 Y
63003-001 1 4 RESTPY 1 Y
63003-002 1 3 RESTPY 1 Y
63003-002 1 4 RESTPY 1 Y
63003-003 1 3 RESTPY 1 Y
63003-003 1 4 RESTPY 1 Y
63003-004 1 3 RESTPY 2 Y
63003-004 1 4 RESTPY 2 Y
63003-005 1 3 RESTPY 2 Y
63003-005 1 4 RESTPY 2 Y
63003-006 1 3 RESTPY 2 Y
63003-006 1 4 RESTPY 2 Y
63003-007 1 3 RESTPY 2 Y
63003-007 1 4 RESTPY 2 Y
63003-008 1 3 RESTPY 1 Y
63003-008 1 4 RESTPY 1 Y
63003-009 1 3 RESTPY 2 Y
63003-009 1 4 RESTPY 2 Y
63003-010 1 3 RESTPY 2 Y
63003-010 1 4 RESTPY 2 Y
63003-011 1 3 RESTPY 2 Y
63003-011 1 4 RESTPY 2 Y
63003-012 1 3 RESTPY 1 Y
63003-012 1 4 RESTPY 1 Y
63003-013 1 3 RESTPY 1 Y
63003-013 1 4 RESTPY 1 Y
63003-014 1 3 RESTPY 2 Y
63003-014 1 4 RESTPY 2 Y
63003-015 1 3 RESTPY 2 Y
63003-015 1 4 RESTPY 1 Y
63003-016 1 3 RESTPY 1 Y
63003-016 1 4 RESTPY 1 Y
63003-017 1 3 RESTPY 2 Y
63003-017 1 4 RESTPY 2 Y
63003-018 1 3 RESTPY 2 Y
63003-018 1 4 RESTPY 2 Y
63003-019 1 3 RESTPY 2 Y
63003-019 1 4 RESTPY 2 Y
63003-020 1 3 RESTPY 2 Y
63003-020 1 4 RESTPY 2 Y
63003-021 1 3 RESTPY 2 Y
63003-021 1 4 RESTPY 2 Y
63003-022 1 3 RESTPY 1 Y
63003-022 1 4 RESTPY 1 Y
63003-023 1 3 RESTPY 2 Y
63003-023 1 4 RESTPY 2 Y
63003-024 1 3 RESTPY 2 Y
63003-024 1 4 RESTPY 2 Y
;

data OUTPUT.ADEF_MK;
  set ADEF_MK;
run;


%MACRO CI(dataset=,
          PARAMCD=,
          response=,
          CIout=);
                
  /*read in data and create combined treatment */              
data  &dataset.01  ;
/*	set  adb.&dataset ;*/
    set &dataset.;
	where PARAMCD="RESTPY" AND FASFL='Y';
	output;
run;
  
proc freq data= &dataset.01;
  tables avisitn;
run;

proc sort data=&dataset ;
	by AVISITN descending &response     ;
run;

/*Clopper-Pearson 95% CI  */
PROC FREQ DATA= &dataset.01 order=data ;
   TABLES AVISITN* &response  /list	SPARSE out=list_out;
RUN;

proc sort data=list_out;
  by  AVISITn &response.;
run;

ods output BinomialCLs=PROP_CL (drop=table) ;
PROC FREQ DATA= list_out order=data;
   BY AVISITN;
   where ^missing(&response.);
   TABLES  &response./BINOMIAL (CL=EXACT level=1) 	;
   weight count/ zeros;
   exact binomial; 
RUN;

data &CIout.;
  format PARAMCD AVISITN PROPORTION LOWERCL UPPERCL TYPE;
  set PROP_CL;
  PARAMCD="&PARAMCD.";
run;
  
%mend;


%CI(dataset=ADEF_MK,
PARAMCD=RESTPY,
response=AVAL,
CIout=vmCI_RESTPY);

/*libname prod '\\wilbtib\wilbtib08\Eli_Lilly LILI8FMCGPIL\Users\lizt\\ADaM and TLF\Databases\Analysis Database\StatsOut_Dev';*/
libname prod '\\wilbtia\wilbtib04\Takeda TKTAK0791006\Users\premanm\IA\Macros_TLF';

data mCI_RESTPY;
	set prod.CI_RESTPY;
run;

proc compare data=mCI_RESTPY compare=vmCI_RESTPY
	out=check outbase outcomp outdiff listall criterion = 0.00000001;  
run;

options symbolgen mprint mlogic;

libname MYDATA '\\wilbtia\wilbtib04\Takeda TKTAK0791006\Users\yuanz\IA\TLF\Output_Dev';

data adpc;
 set MYDATA.ADPC;
run;

data adpc_mk;
 set adpc(keep=SUBJID PK01FL ARM TRT01AN EOSSTT AVISITN PARAM PARAMCD AVAL AVALC AVALU);
 where PK01FL="Y" and TRT01AN=1 and EOSSTT ^="DISCONTINUED" and AVISITN in (0,1,2,4,8,12);
 if PARAM="KY1005" then PARAM="Serum Mezagitamab";
 if PARAMCD="KY1005" then PARAMCD="MEZMAB";
run;

proc sort data=adpc_mk out=adpc_mk01 nodupkey;
  by SUBJID AVISITN;
run;

data OUTPUT.ADPC_MK;
  set ADPC_MK01;
run;

%let N = 100;
data Have;
call streaminit(12345);
do i = 1 to &N;
   x = round( rand("LogNormal", 3, 0.8), 0.1);    /* generate positive values */
   output;
end;
run;
 
title "Geometric Mean of Skewed Positive Data";
proc sgplot data=Have;
   histogram x / binwidth=10 binstart=5 showbins;
   refline 20.2 / axis=x label="Geometric/Mean" splitchar="/" labelloc=inside
                  lineattrs=GraphData2(thickness=3);
   xaxis values=(0 to 140 by 10);
   yaxis offsetmax=0.1;
run;



%MACRO vmGeo_CV(dataset=,
            PARAMCD=,
            response=,
            PKout=);

PROC SORT DATA=&dataset. OUT=&dataset.00S;BY AVISITN;RUN;

* calculate Geometric mean and CV;
ods output ConfLimits=Geom_mean_CV Statistics=T_stats; 
proc ttest data=&dataset.00S dist=lognormal; 
   by AVISITN;
   var &response.;
/*   ods select ConfLimits;*/
run;

proc means data=&dataset.00S maxdec=3 N Mean STD MIN MAX MEDIAN;
  by AVISITN;
  var &response.;
  output out=PK_Stats N=N_T Mean=Mean_T STD=STD_T Min=Min_T Max=Max_T median=Median_T;
run;

proc sort data=PK_Stats(drop=_type_ _FREQ_);by AVISITN;run;
proc sort data=Geom_mean_CV(Drop=Variable UMPULowerCLCV UMPUUpperCLCV);by AVISITN;run;

data PK_STATS(rename=(N_T=N Mean_T=Mean STD_T=STD Min_T=Min Max_T=Max Median_T=Median 
                       LowerCLGeomMean=GeomMean_LCL UpperCLGeomMean=GeomMean_UCL
                       CV=GeomCV LowerCLCV=GeomCV_LCL UpperCLCV=GeomCV_UCL));
  length Paramcd $ 8;
  format PARAMCD AVISITN N_T Mean_T STD_T Min_T Max_T Median_T GeomMean LowerCLGeomMean
         UpperCLGeomMean CV LowerCLCV UpperCLCV;
  merge PK_Stats
        Geom_mean_CV;
  BY AVISITN;
  Paramcd="&PARAMCD.";
 run;
  
 Data output.&PKout.;
   set PK_STATS;
 run; 
%Mend;


%vmGeo_CV(dataset=ADPC_MK,PARAMCD=MEZMAB,response=AVAL,PKout=vmGeo_CV);



/*libname prod '\\wilbtib\wilbtib08\Eli_Lilly LILI8FMCGPIL\Users\lizt\\ADaM and TLF\Databases\Analysis Database\StatsOut_Dev';*/
libname prod '\\wilbtia\wilbtib04\Takeda TKTAK0791006\Users\premanm\IA\Macros_TLF';

data mGeo_CV;
	set prod.Geom_Macro;
run;

proc compare data=mGeo_CV compare=output.vmGeo_CV
	out=check outbase outcomp outdiff listall criterion = 0.00000001;  
run
options symbolgen mprint mlogic;

libname MYDATA '\\wilbtia\wilbtib04\Takeda TKTAK0791006\Users\yuanz\IA\TLF\Output_Dev';

data adtte;
 set MYDATA.ADTTE;
run;

data adtte_mk00;
  set adtte(keep=SUBJID FAS01FL ARM TRT01AN EOSSTT PARAM PARAMCD AVAL CNSR);
  where FAS01FL="Y" and EOSSTT ^="DISCONTINUED" and PARAMCD in ("LEASI50","LEASI75");
  if PARAMCD="LEASI50" then do; PARAM="Time to Favorable Proteinuric Response";
                                PARAMCD="TTFPR";end;
  if PARAMCD="LEASI75" then do;PARAM="Time to Eligible for Retreatment";
                               PARAMCD="TTERT";end;
run;

data adtte_mk01;
  set adtte_mk00;
  if PARAMCD="TTERT" then AVAL=(AVAL/4)*5;
  if substr(SUBJID,6,1) = "1" then CNSR=0;
run;

proc sort data=adtte_mk01 out=adtte_mk01s ;
  by SUBJID PARAMCD;
run;

data OUTPUT.ADTTE_MK;
  set ADTTE_MK01S;
  if Substr(subjid,5,1) in ("1","5") and CNSR=0 then AVAL=AVAL*3;
run;



%MACRO vmKM(dataset=,
            PARAMCD=,
            response=,
            KMout=);
data adtte_&paramcd.;
  set output.&dataset.;
  if Paramcd="&paramcd.";
run;

/*ODS HTML;*/
/*ODS GRAPHICS On;*/
/*ODS TRACE ON;*/;
ods output Quartiles=KM_Quartiles Means=KM_Means CensoredSummary=KM_CNSR;
proc lifetest data=adtte_&paramcd. plots=(s);
  time &response. * CNSR(0);  
  title 'Survival Analysis for Time to Eligible for Retreatment-- One group';
run;
/*ODS TRACE OFF;*/
/*ODS HTML CLOSE;*/
/*ODS GRAPHICS OFF;*/
/*quit;*/

Proc transpose data=KM_Quartiles(drop=STRATUM Transform) 
               out=KM_Estimates(Drop=_name_ _label_) prefix=P;
  var Estimate;
  id Percent;
run;

Proc transpose data=KM_Quartiles(drop=STRATUM Transform) 
               out=KM_LCL(Drop=_name_ _label_) prefix=LCL;
  var LowerLimit;
  id Percent;
run;

Proc transpose data=KM_Quartiles(drop=STRATUM Transform) 
               out=KM_UCL(Drop=_name_ _label_) prefix=UCL;
  var UpperLimit;
  id Percent;
run;

data &KMout.;
  Length Paramcd $8;
  format Paramcd P25 LCL25 UCL25 P50 LCL50 UCL50 P75 LCL75 UCL75 Mean StdErr 
         Total Failed Censored PctCens;
  merge KM_Estimates
        KM_LCL
        KM_UCL
        KM_Means(drop=bias stratum)
		KM_CNSR;
  Paramcd="&paramcd.";
  label p25="Estimates of the 25th percentile";
  label LCL25="Lower 95% Confidence Limit of the 25th percentile";
  label UCL25="Upper 95% Confidence Limit of the 25th percentile";
  label p50="Estimates of the 50th percentile";
  label LCL50="Lower 95% Confidence Limit of the 50th percentile";
  label UCL50="Upper 95% Confidence Limit of the 50th percentile";
  label p75="Estimates of the 75th percentile";
  label LCL75="Lower 95% Confidence Limit of the 75th percentile";
  label UCL75="Upper 95% Confidence Limit of the 75th percentile";
  label StdErr="Standard Error";
  label Failed="Number Failed";
  label Censored="Number Censored";
  label PctCens="Percent Censored";
run;

 data &KMout._&paramcd. output.&KMout._&paramcd.;
   set &KMout.;
 run;
%MEND;

%vmKM(dataset=ADTTE_MK,PARAMCD=TTERT,response=AVAL,KMout=KM_Report);
%vmKM(dataset=ADTTE_MK,PARAMCD=TTFPR,response=AVAL,KMout=KM_Report);



/*libname prod '\\wilbtib\wilbtib08\Eli_Lilly LILI8FMCGPIL\Users\lizt\\ADaM and TLF\Databases\Analysis Database\StatsOut_Dev';*/
libname prod '\\wilbtia\wilbtib04\Takeda TKTAK0791006\Users\premanm\IA\Macros_TLF';

data mKM_TTFPR;
	set prod.KM_Macro;
run;

proc compare data=mKM_TTFPR compare=output.KM_report_TTFPR
	out=check outbase outcomp outdiff listall criterion = 0.00000001;  
run;
 * For vmMMRM testing;
*************************************************************************
*        CLIENT:  TAKEDA
*      PROTOCOL:  TAK-079-1006
*       PURPOSE:  MMRM at validation side
*        AUTHOR:  ZHENHUA YUAN
*   INPUT FILES:  ADEFF_MK
*  OUTPUT FILES:  WORK.vmMMRM
*   	  NOTES:  
*		   DATE:  25/AUG/2023
************************************************************************* 
* CALLING EXAMPLE:
* %mMMRM_GMC(bmset=M1301FL,anlset=ANL02FL,paramcd=IL13,avisitn=6);
* %mMMRM_GMC(bmset=M1301FL,anlset=ANL02FL,paramcd=IL13,avisitn=9);
************************************************************************* 
*  Copyright 2022 Thermo Fisher Scientific Inc. All rights reserved.
*  All trademarks are the property of Thermo Fisher Scientific and its
*  subsidiaries unless otherwise specified. 
*************************************************************************;
options linesize=max;
options symbolgen mlogic mprint;
/*libname adb "\\wilbtib\wilbtia03\Kymab KY1005CT05\Interim Analysis\Databases\Analysis Database\Output";*/
/*libname adb1 "\\wilbtib\wilbtia03\Kymab KY1005CT05\Users\okelloeo\Interim Analysis\Databases\Analysis Database\Output_Dev";*/

proc datasets lib=work kill nolist nowarn;
quit;

dm "output; clear; log; clear";

%macro vmMMRM(anlset=,paramcd=);
data adef00;
  set output.adef_mk;
  where &anlset.="Y" and PARAMCD="&paramcd.";
run;

proc sort data=adef00; by subjid avisitn;run;

DATA ADEF01;
  SET ADEF00;
  if missing(BASE)=0 and BASE>0 then LNBASE=LOG(BASE);
  else delete;
  if missing(pct_bl)=0 and pct_bl>0 then LNPCTBL=LOG(pct_bl);
  else delete;    
run;

/*Perform MMRM model using TRTP variable;*/
proc mixed data=ADEF01 method=reml;
    class avisitn subjid;
    model LNPCTBL =LNBASE avisitn LNBASE*avisitn/solution ddfm=kr;
    repeated avisitn/subject=subjid type=UN;
    lsmeans avisitn/cl;
    ods output lsmeans=lsm_a;
run;

data lsm_a00(drop=Estimate StdErr Lower Upper);
  Length Paramcd $8;
  set lsm_a(keep=AVISITN Estimate StdErr Lower Upper);
/*  Geom_LSMean=exp(Estimate);*/
  PARAMCD="&paramcd.";
  Geom_PCHG=EXP(Estimate)-100;
  SEM_PCHG=EXP(StdErr);
  PCHG_LCL=EXP(Lower)-100;
  PCHG_UCL=EXP(Upper)-100;
run;

data output.vmMMRM vmMMRM;
  set lsm_a00;
  Label PARAMCD	= "Parameter code"
        AVISITN	= "Analysis Visit (N)"
		Geom_PCHG = "Geometric LSmean of Percent Change from Baseline."
		SEM_PCHG = "The standard error of Geometric LSmean of Percent Change from Baseline"
        PCHG_LCL = "Lower 95% limit of Geometric LSmean of Percent Change from Baseline."
        PCHG_UCL = "Upper 95% limit of Geometric LSmean of Percent Change from Baseline." ;
run;
run;

%MEND;

%vmMMRM(anlset=ANL01FL,paramcd=UPCR24H);

*Modifiy the ADBM dataset to create the ADEF_MK;
libname MYDATA '\\wilbtia\wilbtib04\Takeda TKTAK0791006\Users\yuanz\IA\TLF\Output_Dev';

data adef00;
 set MYDATA.ADBM;
run;

data adef01;
  set adef00(keep=SUBJID ANL01FL ARM TRT01AN EOSSTT AVISITN PARAM PARAMCD AVAL LNAVAL ABLFL 
    BASE CHG PCHG);
  where ANL01FL="Y" and EOSSTT ^="DISCONTINUED" and AVISITN in (6,9,15) and PARAMCD in ("EASIS");
  if PARAMCD="EASIS" then do; PARAM="UPCR(24H)";
                              PARAMCD="UPCR24H";end;
  pct_bl=(AVAL/BASE)*100;
run;

proc sort data=adef01 out=adef01s ;
  by SUBJID AVISITN;
run;

data ADEF_MK OUTPUT.ADEF_MK;
  set ADEF01S;
run;

/*libname prod '\\wilbtib\wilbtib08\Eli_Lilly LILI8FMCGPIL\Users\lizt\\ADaM and TLF\Databases\Analysis Database\StatsOut_Dev';*/
libname prod '\\wilbtia\wilbtib04\Takeda TKTAK0791006\Users\premanm\IA\Macros_TLF';

data mMMRM;
	set prod.lsout;
run;

proc compare data=mMMRM compare=output.vmMMRM
	out=check outbase outcomp outdiff listall criterion = 0.00000001;  
run;
data rc;
   input Batch Month @@;
   Monthc = Month;
   do i = 1 to 6;
      input Y @@;
      output;
   end;
   datalines;
 1   0  101.2 103.3 103.3 102.1 104.4 102.4
 1   1   98.8  99.4  99.7  99.5    .     .
 1   3   98.4  99.0  97.3  99.8    .     .
 1   6  101.5 100.2 101.7 102.7    .     .
 1   9   96.3  97.2  97.2  96.3    .     .
 1  12   97.3  97.9  96.8  97.7  97.7  96.7
 2   0  102.6 102.7 102.4 102.1 102.9 102.6
 2   1   99.1  99.0  99.9 100.6    .     .
 2   3  105.7 103.3 103.4 104.0    .     .
 2   6  101.3 101.5 100.9 101.4    .     .
 2   9   94.1  96.5  97.2 95.6     .     .
 2  12   93.1  92.8  95.4 92.2   92.2  93.0
 3   0  105.1 103.9 106.1 104.1 103.7 104.6
 3   1  102.2 102.0 100.8  99.8    .     .
 3   3  101.2 101.8 100.8 102.6    .     .
 3   6  101.1 102.0 100.1 100.2    .     .
 3   9  100.9  99.5 102.2 100.8    .     .
 3  12   97.8  98.3  96.9  98.4  96.9  96.5
;

proc mixed data=rc;
   class Batch;
   model Y = Month / s;
   random Int Month / type=un sub=Batch s;
run;

*Make a mock eGFR dataset from ADEF;
libname MYDATA '\\wilbtia\wilbtib04\Takeda TKTAK0791006\Users\yuanz\IA\TLF\Output_Dev';


data EGFR00;
  set MYDATA.adef1;
  keep SUBJID ARM TRTPN FASFL PARAM PARAMCD AVAL ADY AVISITN BASE CHG PCHG;
  where strip(PARAMCD) = "EGFR";
  FASFL="Y";
run;

data EGFR01(drop=i);
 set EGFR00;
   DO i = 0,1, 2, 3, 4, 5,6,7,8,10,12,14,16,18,20,22;
     AVISITN=i;
	 output;
   END;
run;

data EGFR02;
  set EGFR01;
  select (AVISITN);
   when (0)     ADY=1;
   when (1)     ADY=7+ceil(3*rand("uniform"));
   when (2)     ADY=13+ceil(4*rand("uniform"));
   when (3)     ADY=20+ceil(4*rand("uniform"));
   when (4)     ADY=27+ceil(4*rand("uniform"));
   when (5)     ADY=34+ceil(4*rand("uniform"));
   when (6)     ADY=41+ceil(4*rand("uniform"));
   when (7)     ADY=47+ceil(5*rand("uniform"));
   when (8)     ADY=55+ceil(4*rand("uniform"));
   when (10)    ADY=68+ceil(5*rand("uniform"));
   when (12)    ADY=82+ceil(5*rand("uniform"));
   when (14)    ADY=96+ceil(6*rand("uniform"));
   when (16)    ADY=110+ceil(6*rand("uniform"));
   when (18)    ADY=124+ceil(5*rand("uniform"));
   when (20)    ADY=138+ceil(6*rand("uniform"));
   when (22)    ADY=152+ceil(6*rand("uniform"));
   otherwise    ADY=.;
end;
run;

data EGFR_VAL00(drop=i j);
  do i = 100,102,98,96,99,84,79,87,89,92,90,85,91,77,86,93,72,80;
    EGFR_VAL = i;
    do j = 1 to 16;
    	EGFR_VAL=EGFR_VAL - ceil(5*rand("uniform"));
        output;
	end;
  end;
RUN;

data EGFR03(rename=(EGFR_VAL=AVAL));
  format SUBJID ARM TRTPN FASFL PARAM PARAMCD EGFR_VAL ADY AVISITN BASE CHG PCHG;
  merge EGFR02(drop=AVAL)
        EGFR_VAL00;
run;

data EGFR_MK output.EGFR_MK;
  set EGFR03;
run;

%macro vmEGFR(anlset=,paramcd=);
  data EGFR_MK00;
    set output.EGFR_MK;
	where &anlset.="Y" and PARAMCD="&paramcd.";
	T_year=round(ADY/365,0.0001);
  run;

  *calculating annualized EGFR decline;
  *ods graphics on;
/*ods trace on;*/
ods output SolutionF=Fixed_stat SolutionR=Random_stat Tests3=Test_p;
proc mixed data=EGFR_MK00;* plots=all;
 class subjid;
 model AVAL = T_year / s alpha=0.05;
 random Int T_year / type=UN subject=subjid s;
run;
/*ods trace off;*/
*ods graphics off;

data Fixed_stat01 output.vmEGFR;
  set Fixed_stat(keep=Effect Estimate StdErr Lower Upper);
/*  rename Lower=LCL Upper=UCL;*/
run;

%MEND;
  
%vmEGFR(anlset=FASFL,paramcd=EGFR); 


/*libname prod '\\wilbtib\wilbtib08\Eli_Lilly LILI8FMCGPIL\Users\lizt\\ADaM and TLF\Databases\Analysis Database\StatsOut_Dev';*/
libname prod '\\wilbtia\wilbtib04\Takeda TKTAK0791006\Users\premanm\IA\Macros_TLF';

data megfr;
	set prod.megfr;
run;

proc compare data=megfr compare=output.vmEGFR
	out=check outbase outcomp outdiff listall criterion = 0.00000001;  
run;
  

*20230901 check if the macro can run on the adef dataset;
data adef_egfr;
  set adb.adef;
  where paramcd="EGFR";
  keep subjid param paramcd avisitn aval;
run;
GOPTIONS ACCESSIBLE;
 *************************************************************************;
 *        CLIENT:  Takeda                                                 *;
 *        PROTOCOL:  TKTAK0791006                                         *;
 *        PURPOSE:  To validate the mEGFR macro for production             *;
 *        AUTHOR:  Zhenhua Yuan                                           *;
 *        INPUT FILES:  ADEF                                        *;
 *        OUTPUT FILES:  WORK.vmkm                                     *;
 *         NOTES:                                                         *;
 *          DATE:  18/AUG/2023                                             *;
 *************************************************************************;
 *  Copyright 2023 Thermo Fisher Scientific Inc. All rights reserved.    *;
 *  All trademarks are the property of Thermo Fisher Scientific and its  *;
 *  subsidiaries unless otherwise specified.                             *;
 *************************************************************************;
options symbolgen mprint mlogic;

%macro vmEGFR(dataset=,subset=,paramcd=,avisitn=,dsout=);
  data EGFR00;
    set adb.adef;
	where &subset. and PARAMCD="&paramcd.";
	T_year=round(ADY/365.25,0.0001);
  run;

 data EGFR01;
   set EGFR00;
   Where AVISITN <= &avisitn.;
 run;
  *calculating annualized EGFR decline;
  *ods graphics on;
/*ods trace on;*/
ods output SolutionF=Fixed_stat SolutionR=Random_stat Tests3=Test_p;
proc mixed data=EGFR01;* plots=all;
 class subjid;
 model CHG = T_year / s alpha=0.05;
 random Int T_year / type=UN subject=subjid s;
run;
/*ods trace off;*/
*ods graphics off;

data Fixed_stat01;
  length PARAMCD $8 TFRAME $ 40 Results $40;
  format PARAMCD Results Estimate StdErr Lower Upper;
  set Fixed_stat(keep=Effect Estimate StdErr Lower Upper);
  PARAMCD="&paramcd.";
  TFRAME="AVISITN 0 to &avisitn.";
  if effect="Intercept" then Results="Intercept for EGFR";
  if effect="T_year" then Results="Annualized mean change from baseline";
  drop Effect;
run;

data &dsout.;
  set fixed_stat01;
run;

%MEND;
  
%vmEGFR(dataset=adef,subset=%str(FASFL='Y' and ANL01FL='Y' and AVISITN <= 96),
        paramcd=EGFR,avisitn=16,dsout=vmEGFR); 
/**/
/*%vmEGFR(dataset=adef,subset=%str(FASFL='Y' and ANL01FL='Y' and AVISITN <= 96),*/
/*        paramcd=EGFR,avisitn=19,dsout=vmEGFR); */
/**/
/*%vmEGFR(dataset=adef,subset=%str(FASFL='Y' and ANL01FL='Y' and AVISITN <= 96),*/
/*        paramcd=EGFR,avisitn=22,dsout=vmEGFR); */
/**/
/*%vmEGFR(dataset=adef,subset=%str(FASFL='Y' and ANL01FL='Y' and AVISITN <= 96),*/
/*        paramcd=EGFR,avisitn=28,dsout=vmEGFR); */

*******************************************************************************************
*        CLIENT: Takeda 
*      PROTOCOL: TAK-951-2001
*       PURPOSE: Validation side - To create output dataset for time to event tables and figures using KM  
*   INPUT FILES: ADB.ADTTE 
*  OUTPUT FILES: 
*   USAGE NOTES:  
******************************************************************************************* 
*  Copyright 2021 PPD
*  All Rights Reserved. 
*******************************************************************************************;

%macro vkm_stat(dataset=, subset=, trt=, strata_1=);

data &dataset.;
	set adb.&dataset.;
	where &subset.;
	&strata_1._n = input(&strata_1., best.);
run;

ods graphics on;
ods output Quartiles=v_km survivalplot=v_survplot ProductLimitEstimates=v_estimates; 
proc lifetest data=&dataset. method=km alpha=0.05 plots=survival(ATRISK=2 to 24 by 2) outsurv=v_outsurv;
	time AVAL*CNSR(1);
	strata &trt.;
run;

/* Quartiles and 95% CI */
proc sort data=v_km;
	by &trt. percent;
run;

/* Minimum and Maximum */
proc sort data=v_estimates out=v_est (keep=&trt. aval censor) nodupkey;
	by &trt aval censor;
	where ^missing(censor);
run;

proc sql;
	create table vminmax as 
	select min(AVAL) as min format=8.4, max(AVAL) as max format=8.4, &trt.
	from v_est
	where ^missing(CENSOR)
	group by &trt.
	order by &trt.
	;
quit;

data v_minmax1;
	set vminmax (drop=max)
		vminmax (drop=min);
	if ^missing(min) then aval=min;
	else if ^missing(max) then aval=max;
	format aval 8.4;
run;

proc sort data=v_minmax1;
	by &trt aval;
run;

/* Get the corresponding Censored value for minmax */
data v_minmax (drop=aval);
	merge v_minmax1 (in=a)
	      v_est;
	by &trt. aval;
	if a;
run;

/* 24 hour Estimates, 95% CI and No. at risk */ 
/* No. at Risk */
data v_left24h;
	set v_estimates (keep=&trt. AVAL CENSOR left survival where=(^missing(survival) and ^missing(CENSOR)));
	by &trt. aval;
	if last.&trt.;
run;

/* 95% CI and estimates */
data v_95CI;
	set v_outsurv (where=(^missing(survival) and ^missing(_CENSOR_)));
	by &trt. aval;
	if last.&trt.;
	format _all_;
run;

data v_KMEST_RISK;
	merge v_95CI
		  v_left24h (rename=(CENSOR = _CENSOR_));
	by &trt. AVAL _CENSOR_ SURVIVAL;
	format AVAL _CENSOR_ SURVIVAL;
run;

/* Hazard Ratio and 95% CI*/
proc phreg data=&dataset.;
	class &trt. (ref='1') &strata_1._n;
	model AVAL*CNSR(1) = &trt. &strata_1._n/ rl alpha=0.05;
	ods output parameterestimates=vhr95;
run;

/* 80% CI */
proc phreg data=&dataset.;
	class &trt. (ref='1') &strata_1._n;
	model AVAL*CNSR(1) = &trt. &strata_1._n / rl alpha=0.2;
	ods output parameterestimates=vhr80;
run;

data v_hr;
	set vhr95 (in=a where=(parameter="&trt."))
	    vhr80 (in=b where=(parameter="&trt.") drop=hazardratio);
	keep HazardRatio HRlowerCL HRupperCL alpha &trt.;
	format HazardRatio HRlowerCL HRupperCL 8.3;
	
	if a then alpha=0.05;
	else if b then alpha=0.2;

	label HazardRatio = 'Hazard Ratio'
		  HRlowerCL	  = '95% Lower Confidence Limit for Hazard Ratio'
		  HRupperCL    = '95% Upper Confidence Limit for Hazard Ratio'
		;

	&trt. = input(classval0, best.); 
run;

%mend vkm_stat;




